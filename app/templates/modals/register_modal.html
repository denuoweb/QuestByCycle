<!-- modals/register_modal.html -->
<div id="registerModal" class="modal register-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Register</h5>
        <button type="button"
                class="btn-close"
                aria-label="Close"
                data-close-modal="registerModal">
        </button>
      </div>
  
      <div class="modal-body">
        <!-- 1) No query-string on the action -->
        <form id="registerForm"
              method="post"
              action="{{ url_for('auth.register') }}">
          {{ register_form.hidden_tag() }}
  
          <!-- 2) Four hidden fields for full context -->
          <input type="hidden" name="game_id"
                 id="registerGameId" value="">
          <input type="hidden" name="quest_id"
                 id="registerQuestId" value="">
          <input type="hidden" name="next"
                 id="registerNext" value="">
          <input type="hidden" name="show_join_custom"
                 id="registerShowJoinCustom" value="1">
            <input type="hidden" name="custom_game_code"
                 id="registerCustomGameCode" value="">

          <div class="form-group">
          {{ register_form.email.label }}
          {{ register_form.email(class="form-control", id="registerEmail") }}
          {% for err in register_form.email.errors %}
            <span class="text-danger">[{{ err }}]</span>
          {% endfor %}
        </div>

        <div id="existingUserLogin" style="display: none;">
          <div class="alert alert-info">
            This email is already registered. Enter your password to log in.
          </div>
          <div class="form-group">
            <label for="existingUserPassword">Password</label>
            <input type="password" id="existingUserPassword" class="form-control" autocomplete="current-password">
            <div id="loginError" class="text-danger mt-1" style="display: none;"></div>
          </div>
          <div class="form-group">
            <button type="button" id="loginWithExistingBtn" class="btn btn-primary">Login</button>
          </div>
        </div>
  
          <div class="form-group">
            {{ register_form.password.label }}
            {{ register_form.password(class="form-control", id="registerPassword") }}
            {% for err in register_form.password.errors %}
              <span class="text-danger">[{{ err }}]</span>
            {% endfor %}
          </div>
  
          <div class="form-group">
            {{ register_form.confirm_password.label }}
            {{ register_form.confirm_password(class="form-control") }}
            {% for err in register_form.confirm_password.errors %}
              <span class="text-danger">[{{ err }}]</span>
            {% endfor %}
          </div>
  
          <div class="form-group">
            <div class="d-inline-flex align-items-center gap-half">
              {{ register_form.accept_license(class="form-check-input") }}
              <label class="form-check-label"
                     for="{{ register_form.accept_license.id }}">
                {{ register_form.accept_license.label.text }}
              </label>
            </div>
            {% for err in register_form.accept_license.errors %}
              <div class="text-danger mt-quarter">
                [{{ err }}]
              </div>
            {% endfor %}
            <div class="mt-half">
              <a href="#" role="button"
                 data-open-modal="termsModal">Terms of Service</a>, and
              <a href="#" role="button"
                 data-open-modal="privacyModal">Privacy Policy</a>
            </div>
          </div>
  
          <div class="form-group">
            <button type="submit" class="btn btn-primary">Register</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  