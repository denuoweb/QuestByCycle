{% extends "layout.html" %}

{% block content %}
<div class="container">
    <h2>Manage Badges</h2>
    
    <div class="badge-form">
        <form action="{{ url_for('badges.manage_badges') }}" method="post" enctype="multipart/form-data">
            {{ form.hidden_tag() }}
            <div class="form-group">
                {{ form.name.label }} {{ form.name() }}
            </div>
            <div class="form-group">
                {{ form.description.label }} {{ form.description() }}
            </div>
            <div class="form-group">
                {{ form.category.label }} {{ form.category() }}
            </div>
            <div class="form-group">
                {{ form.image.label }} {{ form.image() }}

            </div>
            {{ form.submit() }}
        </form>
    </div>

    <div class="badges-list">
        <h3>Existing Badges</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="badgesBody">
                {% for badge in badges %}
                <tr>
                    <td>
                        {% if badge.image %}
                        <img src="{{ url_for('static', filename=badge.image) }}" alt="Badge Image" height="50">
                        {% else %}
                        No Image
                        {% endif %}
                    </td>
                    <td>{{ badge.name }}</td>
                    <td>{{ badge.description }}</td>
                    <td>{{ badge.category}}</td> <!-- Display the category -->
                    <td>
                        <button class="edit-badge" data-badge-id="{{ badge.id }}" onclick="editBadge('{{ badge.id }}')">Edit</button>
                        <button onclick="deleteBadge('{{ badge.id }}')">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadBadges();
});

function loadBadges() {
    fetch('/badges/badges')
    .then(response => response.json())
    .then(data => {
        const badgesBody = document.getElementById('badgesBody');
        badgesBody.innerHTML = ''; // Clear the table first
        data.badges.forEach(badge => {
            const row = document.createElement('tr');
            row.setAttribute('data-badge-id', badge.id); // Important for identifying rows for edit/delete

            // Handling image display
            const imageHTML = badge.image ? `<img src="/static/${badge.image}" height="50">` : 'No Image';

            row.innerHTML = `
                <td class="badge-image">${imageHTML}</td>
                <td class="badge-name">${badge.name}</td>
                <td class="badge-description">${badge.description}</td>
                <td class="badge-category">${badge.category || 'No Category'}</td>
                <td>
                    <button class="edit-badge" data-badge-id="${badge.id}" onclick="editBadge(${badge.id})">Edit</button>
                    <button onclick="deleteBadge(${badge.id})">Delete</button>
                </td>
            `;
            badgesBody.appendChild(row);
        });
    })
    .catch(error => console.error('Failed to load badges:', error));
}

function editBadge(badgeId) {
    const row = document.querySelector(`tr[data-badge-id='${badgeId}']`);
    if (!row) {
        console.error(`Badge row with ID ${badgeId} not found.`);
        return;
    }
    const nameCell = row.querySelector('.badge-name');
    const descriptionCell = row.querySelector('.badge-description');
    const imageCell = row.querySelector('.badge-image img');
    const imageSrc = imageCell ? imageCell.src : '';
    nameCell.innerHTML = `<input type="text" value="${nameCell.innerText.trim()}" class="form-control badge-name-input">`;
    descriptionCell.innerHTML = `<textarea class="form-control badge-description-textarea">${descriptionCell.innerText.trim()}</textarea>`;
    imageCell.innerHTML = `<input type="file" class="form-control-file badge-image-input">`;
    const editButton = row.querySelector(`button.edit-badge`);
    editButton.innerText = 'Save';
    editButton.onclick = () => saveBadge(badgeId);
}

function saveBadge(badgeId) {
    const row = document.querySelector(`tr[data-badge-id='${badgeId}']`);
    const nameInput = row.querySelector('.badge-name-input');
    const descriptionTextarea = row.querySelector('.badge-description-textarea');
    const imageInput = row.querySelector('.badge-image-input').files[0];
    if (!nameInput || !descriptionTextarea) {
        console.error('Cannot find input fields for name or description.');
        return;
    }

    const formData = new FormData();
    formData.append('name', nameInput.value);
    formData.append('description', descriptionTextarea.value);
    if (imageInput) formData.append('image', imageInput);

    fetch(`/badges/badges/update/${badgeId}`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
        },
    })

    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Badge updated successfully');
            window.location.reload(); // Reload to show updated data
        } else {
            alert('Failed to update badge: ' + data.message);
        }
    })
    .catch(error => console.error('Error updating badge:', error));
}

function deleteBadge(badgeId) {
    if (!confirm("Are you sure you want to delete this badge?")) return;

    fetch(`/badges/delete/${badgeId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
        },
    })
    .then(response => response.json()) // Ensure the server responds with JSON.
    .then(data => {
        if (data.success) {
            alert('Badge deleted successfully');
            window.location.reload();
        } else {
            alert(`Failed to delete badge: ${data.message}`);
        }
    })
    .catch(error => {
        console.error('Error deleting badge:', error);
        alert('Error deleting badge. Please check console for details.');
    });
}

</script>
{% endblock %}
