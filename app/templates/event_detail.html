{% extends "layout.html" %}

{% block content %}
<div class="container">
    <div class="welcomeImage">
        <img src="{{ url_for('static', filename='images/eventBikeHunt.png') }}" alt="Bike Hunt Events" style="max-width: 1000px; max-height: 300px;">
    </div>
    <div class="event-item">
        <h1>{{ event.title }}</h1>
        <p>{{ event.description }}</p>
        <p><strong>Start Date:</strong> {{ event.start_date.strftime("%m-%d-%y") }}</p>
        <p><strong>End Date:</strong> {{ event.end_date.strftime("%m-%d-%y") }}</p>
    </div>
    <div class="event-item">

        {% if has_joined %}
            <p id="total-points">Total Completed Points: {{ total_points }}</p>
            <p>
                {% if current_user.is_admin %}
                    <!-- Add a link to the advanced task configuration page here -->
                    <a href="{{ url_for('tasks.manage_event_tasks', event_id=event.id) }}" class="button" style="margin-left: 10px;">Configure Tasks</a>
                    <a href="{{ url_for('badges.manage_badges', event_id=event.id) }}" class="button" style="margin-left: 10px;">Configure Badges</a>
                {% endif %}
            </p>
            <table class="table">
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Description</th>
                        <th>Points</th>
                        <th>Badge</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td><a href="#" onclick="openTaskDetailModal('{{ task.id }}')">{{ task.title }}</a></td>
                        <td>
                            {{ task.description }}
                            {% if task.tips %}
                                <a href="#" onclick="showModal('{{ task.tips }}')">[...]</a>
                            {% endif %}
                        </td>
                        <td>{{ task.points }}</td>
                        <td>
                            {% if task.badge %}
                                {% if task.badge.image %}
                                    <img src="{{ url_for('static', filename=task.badge.image) }}" alt="Badge" style="width: 50px;">
                                {% endif %}
                            {% else %}
                                None
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <form action="{{ url_for('events.register_event', event_id=event.id) }}" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="button primary">Join Event</button>
            </form>
        {% endif %}
    </div>
</div>

<div id="modal" style="display:none;" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <p id="modal-text">No tips for now.</p>
    </div>
</div>
<!-- Task Detail Modal Structure -->
<div id="taskDetailModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closeTaskDetailModal()">&times;</span>
        <h2 id="modalTaskTitle">Task Title</h2>
        <p id="modalTaskDescription">Description</p>
        <p id="modalTaskTips">Tips</p>
        <p id="modalTaskPoints">Points</p>
        <p id="modalTaskCompletionLimit">Completion Limit</p>
        <p id="modalTaskFrequency">Frequency: </p>
        <p id="modalTaskCategory">Category: </p>
        <p id="modalTaskEnabled">Enabled</p>
        <p id="modalTaskVerificationType">Verification Type</p>
        <p id="modalTaskBadgeName">Badge Name</p>
        <!-- Actions and Completions placeholders -->
        <div id="modalTaskActions"></div>
        <p id="modalTaskCompletions">Total Completions: </p>
        <p id="modalCountdown"></p>
        {% for task in tasks %}
            <!-- Verify Task Button -->
            <button id="verifyButton-{{ task.id }}" class="verifyButton" style="display: block;">Verify Task</button>

            <!-- Hidden Verification Form -->
            <div id="verifyTaskForm-{{ task.id }}" style="display: none;">
                <form enctype="multipart/form-data">
                    <input type="file" name="image" accept="image/*" required>
                    <textarea name="verificationComment" placeholder="Enter a comment..." required></textarea>
                    <button type="submit">Submit Verification</button>
                </form>
            </div>
        {% endfor %}


        <!-- Inside the task detail modal, after the submission form -->
        <div id="submissionCarousel" class="carousel slide" data-ride="carousel">
            <div class="carousel-inner" id="carouselItems">
                <!-- Carousel items will be added here dynamically -->
            </div>
            <a class="carousel-control-prev" href="#submissionCarousel" role="button" data-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next" href="#submissionCarousel" role="button" data-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="sr-only">Next</span>
            </a>
        </div>
    </div>
</div>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll('[id^="verifyButton-"]').forEach(button => {
            button.addEventListener('click', function() {
                if (!this.disabled) {
                    const taskId = this.id.split('-')[1]; // Extract taskId from button id
                    const formId = `verifyTaskForm-${taskId}`;
                    const form = document.getElementById(formId);
                    form.style.display = 'block'; // Show the form only if the button is not disabled
                }
            });
        });
    });

    function canCompleteTask(taskId, canVerify) {
        const verifyButton = document.getElementById(`verifyButton-${taskId}`);
        if (verifyButton) {
            verifyButton.disabled = !canVerify; // Correctly disable or enable the button based on canVerify
        }
    }
    
    function openTaskDetailModal(taskId) {
        // Reset previous modal content
        resetModalContent();

        // Fetch task details and user completion status from the server
        fetch(`/tasks/detail/${taskId}/user_completion`)
            .then(response => response.json())
            .then(data => {
                const task = data.task;
                const userCompletion = data.userCompletion;
                const canVerify = data.canVerify;
                const frequency = task.frequency; // Provided by the backend.
                const lastRelevantCompletionTime = data.lastRelevantCompletionTime; // Now provided in the JSON response.
                const nextEligibleTime = task.nextEligibleTime; // Make sure this matches the JSON attribute

                // Determine if the verify button should be enabled based on completions and limit.
                const verifyButton = document.getElementById(`verifyButton-${taskId}`);
                verifyButton.disabled = !(userCompletion.completions < task.completionLimit);

                if (verifyButton.disabled) {
                    updateCountdownFromLastRelevant(lastRelevantCompletionTime, frequency);
                } else {
                    document.getElementById('modalCountdown').innerText = "Verify button is not disabled.";
                }

                // Populate the modal with task details.
                populateTaskDetails(task, userCompletion.completions, canVerify, taskId, task.nextEligibleTime);

                // Fetch and display submissions related to the task
                fetchSubmissions(taskId);

                // Show the modal.
                document.getElementById('taskDetailModal').style.display = 'block';

            })
            .catch(error => {
                console.error('Error opening task detail modal:', error);
                alert('Failed to load task details.');
            });
    }


    function resetModalContent() {
        // Example: Resetting elements inside the modal. Adjust according to your HTML structure.
        const modalTaskActions = document.getElementById('modalTaskActions');
        if (modalTaskActions) {
            modalTaskActions.innerHTML = '';  // Clear previous task's verify button and form

        }
        document.querySelectorAll('[id^="verifyButton-"]').forEach(button => {
            button.style.display = 'none';
        });
        document.querySelectorAll('[id^="verifyTaskForm-"]').forEach(form => {
            form.style.display = 'none';
        });
        // If you have other dynamic contents, reset them in a similar manner.
    }

    // Function to populate task details in the modal
    function populateTaskDetails(task, userCompletionCount, canVerify, taskId, nextEligibleTime) {
        document.getElementById('modalTaskTitle').innerText = task.title;
        document.getElementById('modalTaskDescription').innerText = task.description;
        document.getElementById('modalTaskTips').innerText = task.tips || 'No tips available';
        document.getElementById('modalTaskPoints').innerText = `Points: ${task.points}`;

        // Updated to format completion limit and frequency
        if (task.completion_limit && task.frequency) {
            let frequencyReadable = task.frequency.replace('Frequency.', ''); // Assuming frequency comes in format 'Frequency.daily'
            frequencyReadable = frequencyReadable[0].toUpperCase() + frequencyReadable.slice(1); // Capitalize first letter
            document.getElementById('modalTaskCompletionLimit').innerText = `Can be completed ${task.completion_limit} times ${frequencyReadable.toLowerCase()}.`;
        } else {
            document.getElementById('modalTaskCompletionLimit').innerText = 'No completion limits set.';
        }

        document.getElementById('modalTaskCategory').innerText = `Category: ${task.category || 'No category'}`;
        document.getElementById('modalTaskEnabled').innerText = `Enabled: ${task.enabled ? 'Yes' : 'No'}`;
        document.getElementById('modalTaskVerificationType').innerText = `Verification Type: ${task.verification_type || 'Not applicable'}`;
        document.getElementById('modalTaskBadgeName').innerText = `Badge: ${task.badge_name || 'No badge'}`;
        document.getElementById('modalTaskCompletions').innerText = `Total Completions: ${userCompletionCount || 0}`;
        console.log(`Populating details for Task ID ${taskId}, canVerify: ${canVerify}`);

        // Update countdown or verification availability based on the backend data
        const countdownDisplay = document.getElementById('modalCountdown');
        if (!canVerify && nextEligibleTime) {
            const nextAvailableTime = new Date(nextEligibleTime);
            if (nextAvailableTime > new Date()) {
                updateCountdown(countdownDisplay, nextAvailableTime);
            } else {
                countdownDisplay.innerText = "nextAvailableTime is greater than current time.";
            }
        } else {
            countdownDisplay.innerText = "You are eligible to verify!";
        }
        
        // Check and toggle the visibility of the verify button
        const verifyButton = document.getElementById(`verifyButton-${taskId}`);
        if (verifyButton) {
            verifyButton.disabled = !canVerify;
            verifyButton.style.display = 'block'; // Ensure the button is always visible
        }
        console.log(`Selected verify button for Task ID ${taskId}`, verifyButton);

        setupSubmissionForm(taskId);
    }

    // Function to fetch and display submissions in the carousel
    function fetchSubmissions(taskId) {
        // Fetch and display submissions for the task
        fetch(`/tasks/task/${taskId}/submissions`)
            .then(response => response.ok ? response.json() : Promise.reject('Failed to load submissions'))
            .then(submissions => {
                const carouselItems = document.getElementById('carouselItems');
                carouselItems.innerHTML = ''; // Clear existing items
                submissions.forEach((submission, index) => {
                    // Dynamically create carousel items with submission images and comments
                    const item = document.createElement('div');
                    item.className = `carousel-item ${index === 0 ? 'active' : ''}`;
                    item.innerHTML = `
                        <img src="${submission.image_url}" class="d-block w-100" alt="Submission Image">
                        <div class="carousel-caption d-none d-md-block">
                            <p>${submission.comment}</p>
                        </div>
                    `;
                    carouselItems.appendChild(item);
                });
                $('#submissionCarousel').carousel();
            })
            .catch(error => console.error('Failed to fetch submissions:', error));
    }

    // Function to set up and handle the task submission form
    function setupSubmissionForm(taskId) {
        const submissionForm = document.getElementById(`verifyTaskForm-${taskId}`);

        if (submissionForm) {
            submissionForm.addEventListener('submit', function(event) {
                submitTaskDetails(event, taskId);
            });
        } else {
            console.error("Form not found for task ID:", taskId);
        }
    }


    function submitTaskDetails(event, taskId) {
        const form = event.target;
        const formData = new FormData(form);

        fetch(`/tasks/task/${taskId}/submit`, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Handle successful submission, e.g., updating UI, showing a message, etc.
                document.getElementById('total-points').innerText = `Total Completed Points: ${data.total_points}`;
                addSubmissionToCarousel(data.image_url, data.comment);
                alert('Submission successful!');
                document.getElementById('taskDetailModal').style.display = 'none'; // Close modal on success if needed
                form.reset(); // Reset the form to clear fields

            } else {
                alert('Submission failed: ' + data.message);
            }
        })
        .catch(error => {
            console.error("Submission error:", error);
            alert('Error during submission: ' + error.message);
        })
        .finally(() => {
            // Re-enable the submit button after processing is complete
            document.getElementById(`verifyButton-${taskId}`).disabled = false;
        });
    }


    // Function to close the task detail modal
    function closeTaskDetailModal() {
        document.getElementById('taskDetailModal').style.display = 'none';
    }
    
    // Close the modal if the user clicks outside of it
    window.onclick = function(event) {
        if (event.target == document.getElementById('taskDetailModal')) {
            closeTaskDetailModal();
        }
    }

    function addSubmissionToCarousel(imageURL, comment) {
        const carouselInner = document.getElementById('carouselItems');
        const newItemHtml = `
            <div class="carousel-item">
                <img src="${imageURL}" class="d-block w-100" alt="Submitted Image">
                <div class="carousel-caption d-none d-md-block">
                    <p>${comment}</p>
                </div>
            </div>
        `;
        carouselInner.innerHTML += newItemHtml;
        // You might need to reinitialize or update your carousel here, depending on the library you're using
    }


    function getNextAvailableTime(lastRelevantDate, frequency) {
        const lastCompletionDate = new Date(lastRelevantDate);
        let nextAvailableDate;

        switch (frequency.toLowerCase()) {
            case 'daily':
                nextAvailableDate = new Date(lastCompletionDate.getTime() + (24 * 60 * 60 * 1000));
                break;
            case 'weekly':
                // For weekly, if testing with 4 minutes
                nextAvailableDate = new Date(lastCompletionDate.getTime() + (4 * 60 * 1000));
                break;
            case 'monthly':
                const month = lastCompletionDate.getMonth();
                nextAvailableDate = new Date(lastCompletionDate.setMonth(month + 1));
                break;
            default:
                nextAvailableDate = new Date(); // Now, if no frequency set or for immediate availability
        }

        return nextAvailableDate;
    }

    // Assuming lastRelevantCompletionTime is passed correctly from the backend
    function updateCountdownFromLastRelevant(nextEligibleTime, frequency) {
    const countdownDisplay = document.getElementById('modalCountdown');
    const nextAvailableTime = new Date(nextEligibleTime);
    const now = new Date();

    if (nextAvailableTime > now) {
        const timeDiff = nextAvailableTime - now;
        countdownDisplay.innerText = `You can verify in ${formatTimeDiff(timeDiff)}`;
    } else {
        countdownDisplay.innerText = "UCLR nextAvailableTime is less than current time.";
    }
}


    function updateCountdown(displayElement, nextEligibleTime) {
        const now = new Date();
        const nextAvailableTime = new Date(nextEligibleTime);
        if (nextAvailableTime > now) {
            const timeDiff = nextAvailableTime - now;
            displayElement.innerText = `You can verify in ${formatTimeDiff(timeDiff)}`;
        } else {
            displayElement.innerText = "UC nextAvailableTime is less than current time.";
        }
    }

    function formatTimeDiff(timeDiff) {
        const days = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((timeDiff / (1000 * 60 * 60)) % 24);
        const minutes = Math.floor((timeDiff / (1000 * 60)) % 60);
        const seconds = Math.floor((timeDiff / 1000) % 60);
        return `${days} days, ${hours} hours, ${minutes} minutes, and ${seconds} seconds`;
    }

    function incrementCompletion(taskId) {
        // Example fetch request to increment task completions
        fetch(`/tasks/adjust_completion/${taskId}/increment`, {
            method: 'POST',
            headers: {
                // Ensure to include the CSRF token in your request headers if you are using CSRF protection
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({}) // You might not need to send any specific data for the action, but include CSRF token if required
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Update UI based on response
            if (data.success) {
                // Update total completions in the modal
                document.getElementById('modalTaskCompletions').innerText = `Total Completions: ${data.new_completions_count}`;

                // Update total points in the modal, assuming data.total_points is the updated points value
                document.getElementById('total-points').innerText = `Total Completed Points: ${data.total_points}`;
                // Optionally, update other parts of the UI to reflect the new completions count
            } else {
                console.error('Increment failed:', data.error);
            }
        })
        .catch(error => console.error('Error incrementing task completions:', error));
    }
</script>
<script>
    // Get the modal
    var modal = document.getElementById("modal");
    
    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close-button")[0];
    
    // Function to open the modal with specific text
    function showModal(text) {
        document.getElementById("modal-text").innerHTML = text;
        modal.style.display = "block";
    }
    
    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
        modal.style.display = "none";
    }
    
    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>
{% endblock %}