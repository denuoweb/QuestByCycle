{% extends "layout.html" %}

{% block content %}
<div class="container">
    <div class="welcomeImage">
        <img src="{{ url_for('static', filename='images/eventBikeHunt.png') }}" alt="Bike Hunt Events" style="max-width: 1000px; max-height: 300px;">
    </div>
    <div class="event-item">
        <h1>{{ event.title }}</h1>
        <p>{{ event.description }}</p>
        <p><strong>Start Date:</strong> {{ event.start_date.strftime("%m-%d-%y") }}</p>
        <p><strong>End Date:</strong> {{ event.end_date.strftime("%m-%d-%y") }}</p>
    </div>
    <div class="event-item">

        {% if has_joined %}
            <p id="total-points">Total Completed Points: {{ total_points }}</p>
            <p>
                {% if current_user.is_admin %}
                    <a href="{{ url_for('events.add_task', event_id=event.id) }}" class="button">Add Task</a>
                {% endif %}
            </p>

            <table class="table">
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Description</th>
                        <th>Points</th>
                        <th>Badge</th>
                        <th>Actions</th>
                        <th>Completions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td>{{ task.title }}</td>
                        <td>
                            {{ task.description }}
                            {% if task.tips %}
                                <a href="#" onclick="showModal('{{ task.tips }}')">[...]</a>
                            {% endif %}
                        </td>
                        <td>{{ task.points }}</td>
                        <td>
                            {% if task.badge %}
                                {% if task.badge.image %}
                                    <img src="{{ url_for('static', filename=task.badge.image) }}" alt="Badge" style="width: 50px;">
                                {% endif %}
                            {% else %}
                                None
                            {% endif %}
                        </td>
                        <td>
                            <form action="{{ url_for('events.adjust_task_completion', task_id=task.id, action='increment') }}" method="post">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <button type="button" id="increment-{{ task.id }}" class="button" onclick="adjustTaskCompletion('{{ task.id }}', 'increment')" {{ 'disabled' if user_tasks_map.get(task.id, {'completions': 0}).completions >= task.completion_limit else '' }}>+</button>
                            </form>
                            <form action="{{ url_for('events.adjust_task_completion', task_id=task.id, action='decrement') }}" method="post">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                <button type="button" id="decrement-{{ task.id }}" class="button" onclick="adjustTaskCompletion('{{ task.id }}', 'decrement')" {{ 'disabled' if user_tasks_map.get(task.id, {'completions': 0}).completions <= 0 else '' }}>-</button>
                            </form>
                        </td>
                        <td><span id="completion-count-{{ task.id }}">{{ user_tasks_map[task.id].completions if task.id in user_tasks_map else 0 }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <form action="{{ url_for('events.register_event', event_id=event.id) }}" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="button primary">Join Event</button>
            </form>
        {% endif %}
    </div>
</div>

<div id="modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <p id="modal-text">No tips for now.</p>
    </div>
</div>

<script>
    // Get the modal
    var modal = document.getElementById("modal");
    
    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close-button")[0];
    
    // Function to open the modal with specific text
    function showModal(text) {
        document.getElementById("modal-text").innerHTML = text;
        modal.style.display = "block";
    }
    
    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
        modal.style.display = "none";
    }
    
    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
        });

        function adjustTaskCompletion(taskId, action) {
            fetch(`/events/adjust_completion/${taskId}/${action}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content'),
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`completion-count-${taskId}`).innerText = data.new_completions_count;
                    document.getElementById(`total-points`).innerText = `Total Completed Points: ${data.total_points}`;
                    const incrementButton = document.getElementById(`increment-${taskId}`);
                    const decrementButton = document.getElementById(`decrement-${taskId}`);
                    incrementButton.disabled = data.disable_increment;
                    decrementButton.disabled = data.disable_decrement;
                }
            })
            .catch(error => console.error('Error:', error));
        }
        </script>
{% endblock %}