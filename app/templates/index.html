{% extends "layout.html" %}

{% block content %}
<div class="container">
    {% if not current_user.is_authenticated %}
    <div class="welcomeImage">
        <img src="{{ url_for('static', filename='images/welcomeQuestByCycle.png') }}" alt="Welcome to Bike Hunt" style="max-width: 600px; max-height: 300px;">
    </div>
    <div class="introduction">
        <strong><p>QuestByCycle is a community-wide motivational game designed to encourage cycling and outdoor activities. Participants can join the game, complete tasks, and earn points/‚Äùreduce carbon‚Äù in the atmosphere to climb up the leaderboard. It's a fun way to stay active, explore your surroundings, and connect with fellow cycling enthusiasts.</p></strong>
    </div>
    {% endif %}

    <div class="content-flex-container">
        <div class="game-item">
            <div id="taskImageCarousel" class="carousel slide" data-ride="carousel">
                <div class="carousel-inner">
                    {% for image in carousel_images %}
                    <div class="carousel-item{% if loop.first %} active{% endif %}" style="height: 300px;">
                        <img src="{{ url_for('static', filename=image) }}" class="d-block w-100 h-100" alt="Carousel Image" style="height: 300px; width: 100%; object-fit: cover;">
                    </div>
                    {% endfor %}
                </div>
                <a class="carousel-control-prev" href="#taskImageCarousel" role="button" data-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="sr-only">Previous</span>
                </a>
                <a class="carousel-control-next" href="#taskImageCarousel" role="button" data-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="sr-only">Next</span>
                </a>
            </div>
        </div>

        <div class="game-item">
            {% if profile %}
            <div id="profileDisplay">
                <img src="{{ url_for('static', filename=profile.profile_picture or 'images/default_profile_picture.png') }}" alt="Profile Picture" class="profile-image">
                <p><strong>Name:</strong> {{ profile.display_name }}</p>
                <p><strong>Email:</strong> {{ profile.email }}</p>
                <p><strong>Age Group:</strong> {{ profile.age_group }}</p>
                <p><strong>Interests:</strong> {{ profile.interests }}</p>
            </div>
            <button id="editProfileBtn" onclick="toggleEditProfile()">Edit Profile</button>
            
            <form id="editProfileForm" method="post" action="{{ url_for('main.update_profile') }}" enctype="multipart/form-data" style="display: none;">
                <input type="file" name="profile_picture" accept="image/*"><br>
                <input type="text" name="display_name" value="{{ profile.display_name }}" style="width: 90px;"><br>
                <input type="text" name="age_group" value="{{ profile.age_group }}" style="width: 90px;"><br>
                <input type="text" name="interests" value="{{ profile.interests }}" style="width: 90px;"><br>
                <button type="submit">Save Changes</button><br>
                <button type="button" onclick="deleteProfile({ profile.id });">Delete Profile</button>
            </form>
            <div>
                <h3>Participated Games:</h3>
                <ul>
                    {% for game in user_games %}
                    <li>{{ game.title }}</li>
                    {% endfor %}
                </ul>
            </div>
            <div>
                <h3>Badges Earned:</h3>
                <ul>
                    {% for badge in badges %}
                    <li>
                        {{ badge.name }} - 
                        {% if badge.image %}
                        <img src="{{ url_for('static', filename='images/badge_images/' + badge.image) }}" alt="{{ badge.name }}" class="badge-image-pri-pro">
                        {% else %}
                        <img src="{{ url_for('static', filename='images/badge_images/default_badge.png') }}" alt="Default Badge" class="badge-image-pri-pro">
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div>
                        {% if current_user.is_authenticated %}
                            <a href="{{ url_for('auth.logout') }}" class="button" style="margin-left: 10px;">Logout</a>               
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <p>Login to begin...</p>
                {% endif %}
                {% if not current_user.is_authenticated %}
                    <a href="{{ url_for('auth.login') }}" class="button" style="margin-left: 10px;">Login</a>
                    <a href="{{ url_for('auth.register') }}" class="button" style="margin-left: 10px;">Register</a>
                {% endif %}
            </div>
        <div class="shout-board-column">
            <h2>Current Activities</h2>
            <div class="game-item">
                {% if current_user.is_admin %}
                <form action="{{ url_for('main.shout_board') }}" method="post">
                    {{ form.hidden_tag() }}
                    <div class="form-group">
                        {{ form.message.label }} {{ form.message(rows=3) }}
                    </div>
                    {{ form.submit() }}
                </form>
                {% endif %}
                <div class="shout-messages">
                    {% for activity in activities %}
                    <div class="activity" style="display: flex; align-items: center; margin-bottom: 10px;">
                        {% if activity.__tablename__ == 'shout_board_message' %}
                        <strong style="margin-right: 10px;"><a href="javascript:void(0)" onclick="showUserProfileModal('{{ activity.user.id }}')">{{ activity.user.username }}</a></strong>  
                        <span style="flex-grow: 1;">{{ activity.message }}</span>
                        <button type="button" class="blue_button" id="like-button-{{ activity.id }}" onclick="likeMessage('{{ activity.id }}')">
                            {% if activity.liked_by_user %}Liked{% else %}Like{% endif %}
                        </button>
                        <span id="like-count-{{ activity.id }}">{{ activity.likes.count() }}</span>üëç
                        {% elif activity.__tablename__ == 'user_tasks' %}
                        <strong style="margin-right: 10px;">
                            <a href="javascript:void(0)" onclick="showUserProfileModal('{{ activity.user.id }}')">{{ activity.user.username }}</a>
                        </strong> completed a task:
                        <strong style="margin-right: 10px;">
                            <a href="javascript:void(0);" onclick="openTaskDetailModal('{{ activity.task.id }}')">
                                {{ activity.task.title }}
                            </a>
                        </strong>
                        on {{ activity.completed_at.strftime('%Y-%m-%d %H:%M') }}
                        <button class="blue_button" id="like-button-{{ activity.task.id }}" onclick="likeTask('{{ activity.task.id }}');" class="{{ 'liked-button-style' if activity.task.liked_by_user else '' }}" {{ 'disabled' if activity.task.liked_by_user }}>
                            {{ 'Liked' if activity.task.liked_by_user else 'Like' }}
                        </button>
                        <span id="like-count-{{ activity.task.id }}">{{ activity.task.likes | length }}</span>üëç
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        {% if game %}
        <p><strong>Start Date:</strong> {{ game.start_date.strftime("%m-%d-%y") }}</p>
        <p><strong>End Date:</strong> {{ game.end_date.strftime("%m-%d-%y") }}</p>
        {% else %}
        <p>Game details are not available.</p>
        {% endif %}

        <div class="game-item">
            {% if has_joined %}
            <p id="total-points">Your Total Completed Points: {{ total_points }}</p>
            <p>
                {% if current_user.is_admin %}
                <a href="{{ url_for('tasks.manage_game_tasks', game_id=game.id) }}" class="button" style="margin-left: 10px;">Configure Tasks</a>
                <a href="{{ url_for('badges.manage_badges', game_id=game.id) }}" class="button" style="margin-left: 10px;">Configure Badges</a>
                <a href="{{ url_for('admin.admin_dashboard') }}" class="button" style="margin-left: 10px;">Admin Dashboard</a>
                {% endif %}
                <button id="leaderboardButton" data-game-id="{{ game.id }}" class="button">View Leaderboard</button>

            </p>

            <table class="table">
                <colgroup>
                    <col style="width: 5%;"> <!-- Checkbox column -->
                    <col style="width: 10%;"> <!-- Badge column -->
                    <col style="width: auto;"> <!-- Task title, takes remaining space -->
                    <col style="width: 10%;"> <!-- Points column -->
                </colgroup>
                <thead>
                    <tr>
                        <th></th>
                        <th>Badge</th>
                        <th>Task</th>
                        <th>Points</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in tasks %}
                    <tr>
                        <td class="disabled-checkbox">
                            <input type="checkbox" disabled {{ 'checked' if task.total_completions > 0 else '' }}>
                            <span class="checkbox-custom"></span> <!-- This span acts as the visual element for the checkbox -->
                        </td>
                        <td>
                            {% if task.badge %}
                            {% if task.badge.image %}
                            <img src="{{ url_for('static', filename='images/badge_images/' + task.badge.image) }}" alt="Badge" class="badge-image">
                            {% endif %}
                            {% else %}
                            None
                            {% endif %}
                        </td>
                        <td>
                            <button class="button" onclick="openTaskDetailModal('{{ task.id }}')">{{ task.title }}</button>
                        </td>
                        <td>{{ task.points }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        </div>
    </div>
    <div id="game_IdHolder" data-game-id="{{ selected_game_id | safe }}" style="display:none;"></div>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const leaderboardButton = document.getElementById('leaderboardButton');
            if (leaderboardButton) {
                leaderboardButton.addEventListener('click', function() {
                    const gameId = this.getAttribute('data-game-id');
                    showLeaderboardModal(gameId);
                    updateMeter(gameId);
                });
            }

            const editProfileForm = document.getElementById('editProfileForm');
            const profileDisplay = document.getElementById('profileDisplay');
            const editProfileBtn = document.getElementById('editProfileBtn');

            function toggleEditProfile() {
                if (editProfileForm.style.display === 'none') {
                    editProfileForm.style.display = 'block';
                    profileDisplay.style.display = 'none';
                    editProfileBtn.textContent = 'Cancel Edit';
                } else {
                    editProfileForm.style.display = 'none';
                    profileDisplay.style.display = 'block';
                    editProfileBtn.textContent = 'Edit Profile';
                }
            }
            window.toggleEditProfile = toggleEditProfile; // Make it available globally if needed
        });

        document.getElementById('editProfileForm').addEventListener('submit', function(event) {
            event.preventDefault();
            var formData = new FormData(this);
            fetch('{{ url_for("main.update_profile") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Profile updated successfully.');
                    location.reload();  // Reload the page to reflect changes
                } else {
                    alert('Failed to update profile.');
                }
            })
            .catch(error => alert('Error updating profile: ' + error));
        });

        function updateMeter(gameId) {
            if (!gameId) return;  // Check if gameId is available

            fetch(`/games/get_game_points/${gameId}`)
                .then(response => response.json())
                .then(data => {
                    if (!data || !data.total_game_points || !data.game_goal) {
                        console.error('Data missing from response');
                        return;  // Check if the necessary data is available
                    }

                    const totalPoints = data.total_game_points;
                    const game_Goal = data.game_goal;
                    const heightPercentage = Math.min((totalPoints / game_Goal) * 100, 100); // Ensure it doesn't exceed 100%
                    
                    const meterBar = document.getElementById('meterBar');
                    if (meterBar) {
                        meterBar.style.height = heightPercentage + '%';
                        document.documentElement.style.setProperty('--meter-fill-height', heightPercentage + '%');
                        document.querySelector('.meter-label').innerText = `Group Completion: ${totalPoints} / ${game_Goal}`;
                    } else {
                        console.error('Meter bar element not found');
                    }
                })
                .catch(err => console.error('Failed to update meter:', err));
        }

        function showUserProfileModal(userId) {
            fetch(`/profile/${userId}`)
                .then(response => response.text())
                .then(html => {
                    const userProfileDetails = document.getElementById('userProfileDetails');
                    if (!userProfileDetails) {
                        console.error('User profile details container not found');
                        return;  // Exit if no container is found
                    }
                    userProfileDetails.innerHTML = html;
                    openModal('userProfileModal');
                })
                .catch(error => {
                    console.error('Failed to load user profile:', error);
                    alert('Could not load user profile. Please try again.');
                });
        }
        function toggleEditProfile() {
            var form = document.getElementById('editProfileForm');
            var display = document.getElementById('profileDisplay');
            var editBtn = document.getElementById('editProfileBtn');
            
            if (form.style.display === 'none') {
                form.style.display = 'block';
                display.style.display = 'none';
                editBtn.textContent = 'Cancel Edit';
            } else {
                form.style.display = 'none';
                display.style.display = 'block';
                editBtn.textContent = 'Edit Profile';
            }
        }

        function deleteProfile(profileId) {
            if (confirm("Are you sure you want to delete your profile? This action cannot be undone.")) {
                fetch(`/delete_profile/${profileId}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        alert('Profile deleted successfully.');
                        window.location.href = "{{ url_for('auth.login') }}";  // Redirect after delete
                    } else {
                        alert('Failed to delete profile.');
                    }
                })
                .catch(error => alert('Error deleting profile: ' + error));
            }
        }

        function likeMessage(messageId) {
            const likeButton = document.getElementById(`like-button-${messageId}`);
            const likeCount = document.getElementById(`like-count-${messageId}`);
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            // Immediately disable the button to prevent multiple clicks
            likeButton.disabled = true;

            fetch(`/like-message/${messageId}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update like count
                    likeCount.innerText = data.new_like_count;
                    
                    // Update button text and style as needed
                    likeButton.innerText = 'Liked';
                    
                    // Keep the button disabled to reflect that the like action is complete
                    likeButton.disabled = true;
                } else {
                    // Optional: Handle cases where the like wasn't successful or was a duplicate
                    // For duplicate likes, the button can remain disabled or provide feedback
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Re-enable the button in case of error to allow retrying
                likeButton.disabled = false;
            });
        }

        function likeTask(taskId) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            const likeButton = document.getElementById(`like-button-${taskId}`);
            const likeCountSpan = document.getElementById(`like-count-${taskId}`);

            // Check if the button is already disabled to prevent multiple submissions
            if (likeButton.disabled) {
                return;
            }

            // Immediately disable the button to prevent multiple clicks
            likeButton.disabled = true;

            fetch(`/like_task/${taskId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken,
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    likeButton.textContent = 'Liked';
                    let likeCount = parseInt(likeCountSpan.textContent) || 0;
                    likeCountSpan.textContent = likeCount + 1;
                    likeButton.classList.add('liked-button-style');
                } else {
                    // Handle already liked status
                    likeButton.textContent = 'Liked';
                    alert('Already liked');
                }
            })
            .catch(error => {
                console.error('Error liking the task:', error);
                likeButton.disabled = false;  // Re-enable the button in case of error to allow retrying
            });
        }

    </script>
{% include 'modals/task_detail_modal.html' %}
{% include 'modals/submission_detail_modal.html' %}
{% include 'modals/user_profile_modal.html' %}
{% include 'modals/leaderboard_modal.html' %}

<script src="{{ url_for('static', filename='js/modal_handlers.js') }}"></script>
{% endblock %}