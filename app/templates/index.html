{% extends "layout.html" %}

{% block content %}
    <div class="container">

        <div class="welcomeImage">
            <img src="{{ url_for('static', filename='images/welcomeQuestByCycle.png') }}" alt="Welcome to Bike Hunt" style="max-width: 600px; max-height: 300px;">
        </div>

        <div class="introduction">
            <strong><p>QuestByCycle is a community-wide motivational game designed to encourage cycling and outdoor activities. Participants can join the game, complete tasks, and earn points/‚Äùreduce carbon‚Äù in the atmosphere to climb up the leaderboard. It's a fun way to stay active, explore your surroundings, and connect with fellow cycling enthusiasts.
            </p></strong>
        </div>
        <div class="content-flex-container">

            <div class="games-column">
                <h2>Games</h2>
                {% for game in games %}
                <div class="game-item">
                    <h3>{{ game.title }}</h3>
                    <p>{{ game.description }}</p>
                    <!-- Display total points if available -->
                    {% if total_points is defined %}
                    <p>Your Total Points: {{ total_points }}</p>
                    {% endif %}
                    <a href="{{ url_for('games.game_detail', game_id=game.id) }}" class="blue_button">View Task List</a>
                </div>
                {% endfor %}
            </div>
            <div class="shout-board-column">
                <h2>Current Activities</h2>
                <div class="game-item">
                    {% if current_user.is_admin %}
                        <form action="{{ url_for('main.shout_board') }}" method="post">
                            {{ form.hidden_tag() }}
                            <div class="form-group">
                                {{ form.message.label }} {{ form.message(rows=3) }}
                            </div>
                            {{ form.submit() }}
                        </form>
                    {% endif %}
                    <div class="shout-messages">
                        {% for activity in activities %}
                            {% if activity.__tablename__ == 'shout_board_message' %}
                                <div class="message">
                                    <strong><a href="javascript:void(0)" onclick="showUserProfileModal('{{ activity.user.id }}')">{{ activity.user.username }}</a></strong>: {{ activity.message }}
                                    <button type="button" class="blue_button" id="like-button-{{ activity.id }}" onclick="likeMessage('{{ activity.id }}')">
                                        {% if activity.liked_by_user %}Liked{% else %}Like{% endif %}
                                    </button>
                                    <span id="like-count-{{ activity.id }}">{{ activity.likes.count() }}</span>üëçüèæ
                                </div>
                            {% elif activity.__tablename__ == 'user_tasks' %}
                                <div class="task-completion">
                                    <strong>
                                        <a href="javascript:void(0)" onclick="showUserProfileModal('{{ activity.user.id }}')">{{ activity.user.username }}</a>
                                    </strong> completed a task:
                                    <strong>
                                        <a href="javascript:void(0);" onclick="openTaskDetailModal('{{ activity.task.id }}')">
                                            {{ activity.task.title }}
                                        </a>
                                        </strong>
                                    on {{ activity.completed_at.strftime('%Y-%m-%d %H:%M') }}
                                    <div id="task-info-{{ activity.task.id }}">
                                        <button class="blue_button" id="like-button-{{ activity.task.id }}" 
                                                onclick="likeTask('{{ activity.task.id }}');" 
                                                class="{{ 'liked-button-style' if activity.task.liked_by_user else '' }}"
                                                {{ 'disabled' if activity.task.liked_by_user }}>
                                            {{ 'Liked' if activity.task.liked_by_user else 'Like' }}
                                        </button>
                                        <span id="like-count-{{ activity.task.id }}">{{ activity.task.likes.count() }}</span>üëçüèæ
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function() {});
        
        function showUserProfileModal(userId) {
            fetch(`/profile/${userId}`)
                .then(response => response.text())
                .then(html => {
                    const userProfileDetails = document.getElementById('userProfileDetails');
                    if (!userProfileDetails) {
                        console.error('User profile details container not found');
                        return;  // Exit if no container is found
                    }
                    userProfileDetails.innerHTML = html;
                    openModal('userProfileModal');
                })
                .catch(error => {
                    console.error('Failed to load user profile:', error);
                    alert('Could not load user profile. Please try again.');
                });
        }
        
        function likeMessage(messageId) {
            const likeButton = document.getElementById(`like-button-${messageId}`);
            const likeCount = document.getElementById(`like-count-${messageId}`);
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            // Immediately disable the button to prevent multiple clicks
            likeButton.disabled = true;

            fetch(`/like-message/${messageId}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update like count
                    likeCount.innerText = data.new_like_count;
                    
                    // Update button text and style as needed
                    likeButton.innerText = 'Liked';
                    
                    // Keep the button disabled to reflect that the like action is complete
                    likeButton.disabled = true;
                } else {
                    // Optional: Handle cases where the like wasn't successful or was a duplicate
                    // For duplicate likes, the button can remain disabled or provide feedback
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Re-enable the button in case of error to allow retrying
                likeButton.disabled = false;
            });
        }

        function likeTask(taskId) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            const likeButton = document.getElementById(`like-button-${taskId}`);
            const likeCountSpan = document.getElementById(`like-count-${taskId}`);

            // Check if the button is already disabled to prevent multiple submissions
            if (likeButton.disabled) {
                return;
            }

            // Immediately disable the button to prevent multiple clicks
            likeButton.disabled = true;

            fetch(`/like_task/${taskId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken,
                },
                body: JSON.stringify({})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    likeButton.textContent = 'Liked';
                    let likeCount = parseInt(likeCountSpan.textContent) || 0;
                    likeCountSpan.textContent = likeCount + 1;
                    likeButton.classList.add('liked-button-style');
                } else {
                    // Handle already liked status
                    likeButton.textContent = 'Liked';
                    alert('Already liked');
                }
            })
            .catch(error => {
                console.error('Error liking the task:', error);
                likeButton.disabled = false;  // Re-enable the button in case of error to allow retrying
            });
        }

    </script>

{% include 'modals/task_detail_modal.html' %}
{% include 'modals/submission_detail_modal.html' %}
{% include 'modals/user_profile_modal.html' %}

<script src="{{ url_for('static', filename='js/modal_handlers.js') }}"></script>
<script src="{{ url_for('static', filename='js/task_interaction.js') }}"></script>
<script src="{{ url_for('static', filename='js/game_interaction.js') }}"></script>

{% endblock %}
