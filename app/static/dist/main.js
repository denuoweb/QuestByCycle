const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["chunk-Dg0EZy6e.js","chunk-tv9akqkW.js"])))=>i.map(i=>d[i]);
import{l as u,c as S,g as x,e as A,s as fe,h as be}from"./chunk-tv9akqkW.js";const he="modulepreload",ye=function(e){return"/static/dist/"+e},W={},U=function(t,n,o){let s=Promise.resolve();if(n&&n.length>0){let a=function(l){return Promise.all(l.map(c=>Promise.resolve(c).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),d=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));s=a(n.map(l=>{if(l=ye(l),l in W)return;W[l]=!0;const c=l.endsWith(".css"),m=c?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${m}`))return;const b=document.createElement("link");if(b.rel=c?"stylesheet":he,c||(b.as="script"),b.crossOrigin="",b.href=l,d&&b.setAttribute("nonce",d),document.head.appendChild(b),c)return new Promise((g,f)=>{b.addEventListener("load",g),b.addEventListener("error",()=>f(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(a){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=a,window.dispatchEvent(r),!r.defaultPrevented)throw a}return s.then(a=>{for(const r of a||[])r.status==="rejected"&&i(r.reason);return t().catch(i)})};let D=3e3,j=0;function w(e){var o;const t=document.getElementById(e);if(!t){u.error(`Modal ${e} not found`);return}document.body.appendChild(t),(o=document.querySelector(".container"))==null||o.classList.add("modal-open"),j=window.scrollY||window.pageYOffset,document.body.style.top=`-${j}px`,document.body.style.position="fixed",t.classList.add("active"),t.style.display="flex",D+=10,t.style.zIndex=D;const n=t.querySelector(".modal-backdrop");n&&(n.style.display="block",n.style.zIndex=D-1),document.body.classList.add("body-no-scroll")}function P(e){var o;const t=document.getElementById(e);if(!t)return;const n=t.querySelector(".modal-backdrop");t.style.display="none",n&&(n.style.display="none"),D=Math.max(1050,D-10),document.querySelector('.modal[style*="display: flex"]')||(document.body.classList.remove("body-no-scroll"),(o=document.querySelector(".container"))==null||o.classList.remove("modal-open"),document.body.style.position="",document.body.style.top="",window.scrollTo(0,j)),t.dispatchEvent(new CustomEvent("hidden.bs.modal",{bubbles:!0}))}function te(){const e=document.getElementById("twitterLink");e&&(e.style.display="none",e.href="#");const t=document.getElementById("facebookLink");t&&(t.style.display="none",t.href="#");const n=document.getElementById("instagramLink");n&&(n.style.display="none",n.href="#");const o=document.getElementById("modalQuestActions");o&&(o.innerHTML=""),document.querySelectorAll('[id^="verifyButton-"]').forEach(s=>s.remove()),document.querySelectorAll('[id^="verifyQuestForm-"]').forEach(s=>s.remove()),document.body.classList.remove("body-no-scroll")}function ne({gameId:e,questId:t=""}){const n=document.getElementById("loginForm"),o=document.getElementById("loginGameId"),s=document.getElementById("loginQuestId"),i=document.getElementById("loginNext"),a=document.getElementById("loginShowJoinCustom"),r=`/?game_id=${encodeURIComponent(e)}&show_join_custom=0`;o.value=e,s.value=t,a.value="0",i.value=r;const d=n.getAttribute("action").split("?")[0],l=new URLSearchParams({game_id:e,quest_id:t,show_join_custom:0,next:r});n.setAttribute("action",`${d}?${l.toString()}`),w("loginModal")}function Ee(){const e=document.getElementById("loginGameId").value||"",t=document.getElementById("loginQuestId").value||"",n=document.getElementById("loginNext").value||"",o=document.getElementById("loginShowJoinCustom").value||"",s=(document.getElementById("loginCustomGameCode")||{}).value||"";document.getElementById("registerGameId").value=e,document.getElementById("registerQuestId").value=t,document.getElementById("registerNext").value=n,document.getElementById("registerShowJoinCustom").value=o,document.getElementById("registerCustomGameCode").value=s;const i=document.getElementById("registerForm"),a=i.getAttribute("action").split("?")[0],r=new URLSearchParams;e&&r.set("game_id",e),t&&r.set("quest_id",t),n&&r.set("next",n),o&&r.set("show_join_custom",o),s&&r.set("custom_game_code",s),i.setAttribute("action",`${a}?${r.toString()}`),P("loginModal"),w("registerModal")}function ve(){var i;const e=((i=document.getElementById("loginEmail"))==null?void 0:i.value)||"",t=document.getElementById("forgotEmail");t&&(t.value=e);const n=document.getElementById("forgotEmailError"),o=document.getElementById("forgotSuccess"),s=document.getElementById("forgotButton");n&&(n.style.display="none"),o&&(o.style.display="none"),s&&(s.disabled=!1),w("forgotPasswordModal")}function we(e){const t=document.getElementById("resetForm"),n=document.getElementById("resetToken"),o=t.dataset.baseAction;t.setAttribute("action",o+encodeURIComponent(e)),n.value=e,document.getElementById("resetError").style.display="none",document.getElementById("resetSuccess").style.display="none",document.getElementById("resetButton").disabled=!1,w("resetPasswordModal")}document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(window.location.search);if(e.get("show_reset")==="1"){const t=e.get("token");t?(we(t),history.replaceState(null,"",window.location.pathname)):u.warn("show_reset=1 present but no token in URL")}});document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(window.location.search),t=e.get("show_join_custom")==="1",n=e.has("game_id");t&&!n&&w("joinCustomGameModal")});document.addEventListener("DOMContentLoaded",()=>{const t=new URLSearchParams(window.location.search).get("quest_shortcut");t&&(U(()=>Promise.resolve().then(()=>$t),void 0).then(n=>n.openQuestDetailModal(t)),history.replaceState(null,"",window.location.pathname))});document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(window.location.search);if(!(e.get("show_login")==="1"))return;let n=e.get("game_id")||"";if(!n){const o=e.get("next");if(o)try{const i=new URL(o,window.location.origin).pathname.replace(/^\/+/,"");/^\d+$/.test(i)&&(n=i)}catch(s){u.warn("Failed to parse next URL for gameId:",s)}}ne({gameId:n,questId:""})});document.addEventListener("DOMContentLoaded",()=>{if(!window.location.pathname.startsWith("/auth/login"))return;const e=new URLSearchParams(window.location.search),t=e.get("next");if(!t)return;let n=e.get("game_id")||"";if(!n)try{const s=new URL(t,window.location.origin).pathname.replace(/^\/+/,"");/^\d+$/.test(s)&&(n=s)}catch(o){u.warn("Could not parse next URL for gameId:",o)}n&&ne({gameId:n,questId:""})});async function Be(e,t){try{const n=await fetch(e,{credentials:"same-origin"});if(!n.ok)throw new Error(`HTTP ${n.status}`);const o=await n.text(),s=document.getElementById(t);s&&s.parentNode.removeChild(s);const i=document.createElement("div");i.innerHTML=o.trim();const a=i.firstElementChild;(!a||a.id!==t)&&u.warn(`Expected first element to be #${t}`,a),document.body.appendChild(a),w(t)}catch(n){u.error(`Error loading ${t} from ${e}:`,n),alert("Failed to load data. Please try again later.")}}async function G(e){const t=await fetch(e.action,{method:e.method||"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:new FormData(e),credentials:"same-origin"}),n=await t.json();return{status:t.status,json:n}}document.addEventListener("click",e=>{const t=e.target.closest("[data-close-modal]");if(!t)return;e.preventDefault();const n=t.getAttribute("data-close-modal");n&&P(n)});document.addEventListener("click",e=>{const t=e.target.closest("[data-open-modal]");t&&(e.preventDefault(),w(t.getAttribute("data-open-modal")))});document.addEventListener("click",e=>{const t=e.target.closest("[data-modal-url]");if(!t)return;e.preventDefault();const n=t.getAttribute("data-modal-url"),o=t.getAttribute("data-modal-id");if(!n||!o){u.error("data-modal-url or data-modal-id missing",t);return}Be(n,o)});document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".modal").forEach(e=>{e.parentNode!==document.body&&document.body.appendChild(e)})});function Le(){"serviceWorker"in navigator&&(navigator.serviceWorker.register("/sw.js").then(i=>{i.addEventListener("updatefound",()=>{const a=i.installing;a.addEventListener("statechange",()=>{a.state==="installed"&&navigator.serviceWorker.controller&&confirm("A new version is available. Reload to update?")&&window.location.reload()})}),"SyncManager"in window&&i.sync.register("sync-notifications").catch(a=>u.error("Sync registration failed:",a)),i.periodicSync&&i.periodicSync.register("periodic-notifications",{minInterval:24*60*60*1e3}).catch(a=>u.error("Periodic sync registration failed:",a)),"PushManager"in window&&Notification.permission==="default"&&Notification.requestPermission(),"sync"in i&&i.sync.register("sync-requests").catch(a=>{u.error("Background sync registration failed:",a)})}).catch(i=>u.error("Service Worker registration failed:",i)),navigator.serviceWorker.addEventListener("message",i=>{i.data.type==="UPDATE_AVAILABLE"&&confirm("A new version is available. Reload to update?")&&window.location.reload()}));const e=document.getElementById("install"),t=document.getElementById("manual-install"),n=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);let o=null;const s=document.getElementById("leaderboardNavbarLink");if(t&&(n?t.hidden=!1:t.hidden=!0),e&&(window.addEventListener("beforeinstallprompt",i=>{i.preventDefault(),o=i,e.hidden=!1,e.addEventListener("click",()=>{o&&(o.prompt(),o.userChoice.then(()=>{o=null,e.hidden=!0}))})}),window.beforeinstallprompt||(e.hidden=!0,!n&&t&&(t.hidden=!0)),window.addEventListener("appinstalled",()=>{e.hidden=!0,t&&(t.hidden=!0)}),navigator.getInstalledRelatedApps&&navigator.getInstalledRelatedApps().then(i=>{i.length&&(e.hidden=!0)})),s&&s.addEventListener("click",async i=>{i.preventDefault();const a=s.getAttribute("data-game-id")||0;(await U(()=>import("./chunk-Dg0EZy6e.js"),__vite__mapDeps([0,1]))).showLeaderboardModal(a)}),"windowControlsOverlay"in navigator){let i=function(){const a=navigator.windowControlsOverlay.getTitlebarAreaRect();document.body.style.paddingTop=a.height+"px"};navigator.windowControlsOverlay.addEventListener("geometrychange",i),i()}document.querySelectorAll(".modal").forEach(i=>{i.parentNode!==document.body&&document.body.appendChild(i)})}function _e(e){const t=e.value;t==="join_custom_game"?w("joinCustomGameModal"):window.location.href=t}document.addEventListener("click",e=>{const t=e.target.closest("[data-game-selection]");t&&(e.preventDefault(),_e({value:t.getAttribute("data-game-selection")}))});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("quest-form");e&&e.addEventListener("submit",t=>{document.getElementById("description").value.trim()||(alert("Description is required."),t.preventDefault())})});function _(e){fetch(`/profile/${e}`).then(t=>t.json()).then(t=>{if(!t.riding_preferences_choices){u.error("Riding preferences choices missing.");return}const n=document.getElementById("userProfileDetails");if(!n){u.error("Profile details containers not found");return}const o=t.current_user_id===t.user.id;n.innerHTML=`
          <!-- XS: native select dropdown -->
          <div class="d-block d-sm-none mb-3">
            <select id="profileTabSelect" class="form-select">
              <option value="profile" selected>Profile</option>
              <option value="bike">Bike</option>
              <option value="badges-earned">Badges Earned</option>
              <option value="games-participated">Games Participated</option>
              <option value="quest-submissions">Quest Submissions</option>
            </select>
          </div>

          <!-- SM+ nav-tabs (will scroll horizontally) -->
          <ul class="nav nav-tabs epic-tabs d-none d-sm-flex" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <a class="nav-link active" id="profile-tab" data-bs-toggle="tab"
                href="#profile" role="tab" aria-controls="profile" aria-selected="true">
                <i class="bi bi-person-circle me-2"></i>Profile
              </a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="bike-tab" data-bs-toggle="tab"
                 href="#bike" role="tab" aria-controls="bike" aria-selected="false">
                <i class="bi bi-bicycle me-2"></i>Bike
              </a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="badges-earned-tab" data-bs-toggle="tab"
                 href="#badges-earned" role="tab" aria-controls="badges-earned" aria-selected="false">
                <i class="bi bi-trophy me-2"></i>Badges Earned
              </a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="games-participated-tab" data-bs-toggle="tab"
                 href="#games-participated" role="tab" aria-controls="games-participated" aria-selected="false">
                <i class="bi bi-controller me-2"></i>Games Participated
              </a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="quest-submissions-tab" data-bs-toggle="tab"
                 href="#quest-submissions" role="tab" aria-controls="quest-submissions" aria-selected="false">
                <i class="bi bi-list-quest me-2"></i>Quest Submissions
              </a>
            </li>
          </ul>

          <div class="tab-content bg-light p-4 rounded shadow-sm" id="profileTabsContent">

            <!-- 1) PROFILE pane -->
            <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
              <section class="profile mb-4">
                ${o?`
                  <div id="profileViewMode">
                    ${t.user.profile_picture?`
                      <div class="profile-picture-container position-relative mx-auto mb-3">
                        <img src="/static/${t.user.profile_picture}"
                            class="profile-picture rounded-circle shadow-lg border border-white border-4"
                            alt="Profile Picture">
                      </div>`:""}
                    <p><strong>Display Name:</strong> ${t.user.display_name||""}</p>
                    <p><strong>Age Group:</strong> ${t.user.age_group||""}</p>
                    <p><strong>Interests:</strong> ${t.user.interests||""}</p>
                    <p><strong>Riding Preferences:</strong> ${t.user.riding_preferences.join(", ")}</p>
                    <p><strong>Ride Description:</strong> ${t.user.ride_description||""}</p>
                    <button class="btn btn-primary" id="editProfileBtn">Edit</button>
                  </div>
                  <div id="profileEditMode" class="d-none">
                    <form id="editProfileForm" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                      <div class="form-group mb-3">
                        <label for="profilePictureInput">Profile Picture:</label>
                        <input type="file" class="form-control" id="profilePictureInput"
                                name="profile_picture" accept="image/*">
                      </div>
                      <div class="form-group mb-3">
                        <label for="displayName">Display Name:</label>
                        <input type="text" class="form-control" id="displayName" name="display_name"
                                value="${t.user.display_name||""}" required>
                        <div class="invalid-feedback">Display Name is required.</div>
                      </div>
                      <div class="form-group mb-3">
                        <label for="ageGroup">Age Group:</label>
                        <select class="form-select" id="ageGroup" name="age_group">
                          <option value="teen" ${t.user.age_group==="teen"?"selected":""}>Teen</option>
                          <option value="adult" ${t.user.age_group==="adult"?"selected":""}>Adult</option>
                          <option value="senior" ${t.user.age_group==="senior"?"selected":""}>Senior</option>
                        </select>
                      </div>
                      <div class="form-group mb-3">
                        <label for="interests">Interests:</label>
                        <textarea class="form-control" id="interests" name="interests" rows="3"
                                  placeholder="Describe your interests...">${t.user.interests||""}</textarea>
                      </div>
                      <div class="form-group mb-3">
                        <label><b>Please specify your riding preferences:</b></label>
                        <div id="ridingPreferences">
                          ${t.riding_preferences_choices.map((p,y)=>`
                            <div class="form-check mb-2">
                              <input class="form-check-input" type="checkbox"
                                      id="ridingPref-${y}" name="riding_preferences"
                                      value="${p[0]}"
                                      ${t.user.riding_preferences.includes(p[0])?"checked":""}>
                              <label class="form-check-label" for="ridingPref-${y}">${p[1]}</label>
                            </div>
                          `).join("")}
                        </div>
                      </div>
                      <div class="form-group mb-3">
                        <label for="rideDescription">Describe the type of riding you like to do:</label>
                        <textarea class="form-control" id="rideDescription" name="ride_description" rows="3">${t.user.ride_description||""}</textarea>
                      </div>
                      <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="uploadToSocials" name="upload_to_socials"
                                ${t.user.upload_to_socials?"checked":""}>
                        <label class="form-check-label" for="uploadToSocials">Cross post to game's social media?</label>
                      </div>
                      <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="uploadToMastodon" name="upload_to_mastodon"
                                ${t.user.upload_to_mastodon?"checked":""}>
                        <label class="form-check-label" for="uploadToMastodon">Cross post to your federation server?</label>
                      </div>
                      <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-success" id="saveProfileBtn">
                          <i class="bi bi-save me-2"></i>Save Profile
                        </button>
                        <button class="btn btn-secondary" id="cancelProfileBtn">Cancel</button>
                      </div>
                    </form>
                    <hr>
                    <form id="updatePasswordForm" class="d-flex justify-content-between">
                      <button class="btn btn-primary w-100 me-2" id="updatePasswordBtn">
                        <i class="bi bi-shield-lock-fill me-2"></i>Update Password
                      </button>
                    </form>
                    <hr>
                    <form id="deleteAccountForm">
                      <button class="btn btn-danger w-100">
                        <i class="bi bi-trash-fill me-2"></i>Delete My Account
                      </button>
                    </form>
                  </div>`:`
                  <div id="profileViewMode">
                    <p><img src="/static/${t.user.profile_picture}"
                        class="profile-picture rounded-circle shadow-lg border border-white border-4 w-50"
                        alt="Profile Picture"></p>
                    <p><strong>Display Name:</strong> ${t.user.display_name||""}</p>
                    <p><strong>Age Group:</strong> ${t.user.age_group||""}</p>
                    <p><strong>Interests:</strong> ${t.user.interests||""}</p>
                    <p><strong>Riding Preferences:</strong> ${t.user.riding_preferences.join(", ")}</p>
                    <p><strong>Ride Description:</strong> ${t.user.ride_description||""}</p>
                  </div>
                `}
              </section>
            </div>

            <!-- 2) BIKE pane -->
            <div class="tab-pane fade" id="bike" role="tabpanel" aria-labelledby="bike-tab">
              <section class="bike mb-4">
                <h2 class="h2">Bike Details</h2>
                ${o?`
                  <form id="editBikeForm" class="needs-validation" novalidate>
                    <div class="form-group mb-3">
                      <label for="bikePicture">Upload Your Bicycle Picture:</label>
                      <input type="file" class="form-control" id="bikePicture" name="bike_picture" accept="image/*">
                    </div>
                    ${t.user.bike_picture?`
                      <div class="form-group mb-3">
                        <label>Current Bicycle Picture:</label>
                        <img src="/static/${t.user.bike_picture}" class="img-fluid rounded shadow-sm" alt="Bicycle Picture">
                      </div>`:""}
                    <div class="form-group mb-3">
                      <label for="bikeDescription">Bicycle Description:</label>
                      <textarea class="form-control" id="bikeDescription" name="bike_description" rows="3">${t.user.bike_description||""}</textarea>
                    </div>
                    <div class="d-flex justify-content-between">
                      <button class="btn btn-success" id="saveBikeBtn">
                        <i class="bi bi-save me-2"></i>Save Bike Details
                      </button>
                    </div>
                  </form>`:`
                  <p><strong>Bicycle Description:</strong> ${t.user.bike_description||""}</p>`}
              </section>
            </div>

            <!-- 3) BADGES EARNED pane -->
            <div class="tab-pane fade" id="badges-earned" role="tabpanel" aria-labelledby="badges-earned-tab">
              <section class="badges-earned mb-4">
                <h2 class="h2">Badges Earned</h2>
                <div class="badge-grid">
                  ${t.user.badges&&t.user.badges.length?t.user.badges.map(p=>`
                      <div class="badge-card">
                        <img src="/static/images/badge_images/${p.image}" alt="${p.name}" class="badge-icon" style="width:100px;">
                        <div class="badge-caption">
                          <h3>${p.name}</h3>
                          <p>${p.description}</p>
                          <p><strong>Category:</strong> ${p.category}</p>
                        </div>
                      </div>
                    `).join(""):'<p class="text-muted">No badges earned yet.</p>'}
                </div>
              </section>
            </div>

            <!-- 4) GAMES PARTICIPATED pane -->
            <div class="tab-pane fade" id="games-participated" role="tabpanel" aria-labelledby="games-participated-tab">
              <section class="games-participated mb-4">
                <h2 class="h2">Games Participated</h2>
                <div class="row g-3">
                  ${t.participated_games&&t.participated_games.length?t.participated_games.map(p=>`
                      <div class="game-item col-md-6 p-3 border rounded shadow-sm bg-white">
                        <h3 class="h5">${p.title}</h3>
                        <p class="text-muted">${p.description}</p>
                        <p><strong>Start Date:</strong> ${p.start_date}</p>
                        <p><strong>End Date:</strong> ${p.end_date}</p>
                      </div>
                    `).join(""):'<p class="text-muted">No games participated in yet.</p>'}
                </div>
              </section>
            </div>

            <!-- 5) QUEST SUBMISSIONS pane -->
            <div class="tab-pane fade" id="quest-submissions" role="tabpanel" aria-labelledby="quest-submissions-tab">
              <section class="quest-submissions mb-4">
                <h2 class="h2">Quest Submissions</h2>
                <div class="row g-3">
                  ${t.quest_submissions&&t.quest_submissions.length?t.quest_submissions.map(p=>`
                      <div class="submission-item col-md-6 p-3 border rounded shadow-sm bg-white">
                        ${p.image_url?`<img src="${p.image_url}" alt="Submission Image" class="img-fluid rounded mb-2" style="max-height:200px; object-fit:cover;">`:""}
                        <p><strong>Quest:</strong> ${p.quest.title}</p>
                        <p class="text-muted">${p.comment}</p>
                        <p><strong>Submitted At:</strong> ${p.timestamp}</p>
                        <div class="d-flex gap-2">
                          ${p.twitter_url?`<a href="${p.twitter_url}"   target="_blank" class="btn btn-sm btn-twitter"><i class="bi bi-twitter"></i></a>`:""}
                          ${p.fb_url?`<a href="${p.fb_url}"        target="_blank" class="btn btn-sm btn-facebook"><i class="bi bi-facebook"></i></a>`:""}
                          ${p.instagram_url?`<a href="${p.instagram_url}" target="_blank" class="btn btn-sm btn-instagram"><i class="bi bi-instagram"></i></a>`:""}
                        </div>
                        ${o?`<button class="btn btn-danger btn-sm mt-2" data-delete-submission="${p.id}">Delete</button>`:""}
                      </div>
                    `).join(""):'<p class="text-muted">No quest submissions yet.</p>'}
                </div>
              </section>
            </div>

          </div> <!-- /.tab-content -->
        </div> <!-- /.row -->
      `;const s=document.getElementById("userProfileModalLabel");s.textContent=`${t.user.display_name||t.user.username}'s Profile`;const i=document.getElementById("followBtn");i&&(i.style.display="");const a=document.getElementById("followerCount");let r=t.user.follower_count;function d(){a&&(a.textContent=`${r} follower${r===1?"":"s"}`)}if(d(),!o&&i){let y=function(){p?(i.textContent="Following",i.classList.remove("btn-primary"),i.classList.add("btn-outline-primary")):(i.textContent="Follow",i.classList.remove("btn-outline-primary"),i.classList.add("btn-primary"))};i&&(i.style.display="",i.classList.remove("d-none"));let p=t.current_user_following;y(),i.onclick=async()=>{const B=p?"unfollow":"follow",{status:I}=await S(`/profile/${t.user.username}/${B}`,{method:"POST",headers:{"Content-Type":"application/json"}});if(I!==200){u.error("Follow toggle failed");return}p=!p,r+=p?1:-1,y(),d()}}else{const p=document.getElementById("followBtn");p&&(p.style.display="none")}w("userProfileModal");const l=document.getElementById("editProfileBtn");l&&l.addEventListener("click",ke);const c=document.getElementById("saveProfileBtn");c&&c.addEventListener("click",()=>Ie(e));const m=document.getElementById("cancelProfileBtn");m&&m.addEventListener("click",()=>Ce(e));const b=document.getElementById("updatePasswordBtn");b&&b.addEventListener("click",()=>{window.location.href="/auth/update_password"});const g=document.getElementById("saveBikeBtn");g&&g.addEventListener("click",()=>$e(e)),document.querySelectorAll("[data-delete-submission]").forEach(p=>{p.addEventListener("click",()=>{const y=p.getAttribute("data-delete-submission");Se(y,"profileSubmissions",t.user.id)})});const f=document.getElementById("deleteAccountForm");f&&f.addEventListener("submit",p=>{p.preventDefault(),xe()});const h=document.getElementById("profileTabSelect");h&&(h.addEventListener("change",p=>{const y=p.target.value,B=document.querySelector(`#profileTabs a[href="#${y}"]`);B&&new bootstrap.Tab(B).show()}),document.querySelectorAll('#profileTabs a[data-bs-toggle="tab"]').forEach(p=>{p.addEventListener("shown.bs.tab",y=>{h.value=y.target.getAttribute("href").slice(1)})}))}).catch(t=>{u.error("Failed to load profile:",t),alert("Could not load user profile. Please try again.")})}document.querySelectorAll("[data-floating-ui-tooltip]").forEach(e=>{tippy(e,{content:e.getAttribute("data-floating-ui-tooltip"),placement:"top",animation:"scale-subtle"})});document.querySelectorAll(".needs-validation").forEach(e=>{e.addEventListener("submit",t=>{e.checkValidity()||(t.preventDefault(),t.stopPropagation()),e.classList.add("was-validated")},!1)});function ke(){const e=document.getElementById("profileViewMode"),t=document.getElementById("profileEditMode");if(!e||!t){u.error("Profile edit mode elements missing");return}e.classList.toggle("d-none"),t.classList.toggle("d-none")}function Ce(e){_(e)}function Ie(e){const t=document.getElementById("editProfileForm");if(!t){u.error("Edit profile form not found");return}const n=new FormData(t),o=document.getElementById("profilePictureInput");o.files.length>0&&n.append("profile_picture",o.files[0]);const s=[];t.querySelectorAll('input[name="riding_preferences"]:checked').forEach(i=>{s.push(i.value)}),n.delete("riding_preferences"),s.forEach(i=>{n.append("riding_preferences",i)}),S(`/profile/${e}/edit`,{method:"POST",body:n}).then(({json:i})=>{if(i.error){let a=`Error: ${i.error}`;if(i.details){const r=[];Object.values(i.details).forEach(d=>{r.push(d.join(", "))}),r.length&&(a+=` - ${r.join("; ")}`)}alert(a)}else alert("Profile updated successfully."),_(e)}).catch(i=>{u.error("Error updating profile:",i),alert("Failed to update profile. Please try again.")})}function $e(e){const t=document.getElementById("editBikeForm");if(!t){u.error("Edit bike form not found");return}const n=new FormData(t),o=document.getElementById("bikePicture");o.files.length>0&&n.append("bike_picture",o.files[0]),S(`/profile/${e}/edit-bike`,{method:"POST",body:n}).then(({json:s})=>{s.error?alert(`Error: ${s.error}`):(alert("Bike details updated successfully."),_(e))}).catch(s=>{u.error("Error updating bike details:",s),alert("Failed to update bike details. Please try again.")})}function Se(e,t,n){S(`/quests/quest/delete_submission/${e}`,{method:"DELETE"}).then(({json:o})=>{if(o.success)alert("Submission deleted successfully."),_(n);else throw new Error(o.message)}).catch(o=>{u.error("Error deleting submission:",o),alert("Error during deletion: "+o.message)})}function xe(){confirm("Are you sure you want to delete your account? This action cannot be undone.")&&S("/auth/delete_account",{method:"POST",headers:{"Content-Type":"application/json"}}).then(()=>{window.location.href="/"}).catch(e=>{u.error("Error deleting account:",e),alert("Failed to delete account. Please try again.")})}document.addEventListener("click",e=>{const t=e.target.closest("[data-user-profile]");if(!t)return;e.preventDefault();const n=t.getAttribute("data-user-profile");n&&_(n)});let T;document.addEventListener("DOMContentLoaded",()=>{const e=d=>document.querySelector(d);if(!e("#submissionDetailModal"))return;const n=document.getElementById("replyLimitMessage"),o=()=>x(),s=document.querySelector('meta[name="placeholder-image"]').getAttribute("content");T=function(d){const l=e("#submissionDetailModal");l.dataset.submissionId=d.id,l.dataset.questId=d.quest_id||"";const c=Number(l.dataset.currentUserId),m=Number(d.user_id)===c,b=l.dataset.isAdmin==="True"||l.dataset.isAdmin==="true",g=e("#editPhotoBtn"),f=e("#photoEditControls"),h=e("#submissionPhotoInput"),p=e("#savePhotoBtn"),y=e("#cancelPhotoBtn"),B=e("#deleteSubmissionBtn");g.hidden=!m,B.hidden=!(m||b),f.hidden=!0,g.addEventListener("click",()=>{f.hidden=!1,g.hidden=!0}),y.addEventListener("click",()=>{h.value="",f.hidden=!0,g.hidden=!1}),B.addEventListener("click",()=>{if(!confirm("Are you sure you want to delete this submission?"))return;const L=l.dataset.submissionId;fetch(`/quests/quest/delete_submission/${L}`,{method:"DELETE",headers:{"X-CSRF-Token":o()}}).then(v=>v.json()).then(v=>{if(!v.success)throw new Error(v.message||"Delete failed");P("submissionDetailModal"),te(),l.dataset.questId&&refreshQuestDetailModal(l.dataset.questId),alert("Submission deleted successfully.")}).catch(v=>alert("Error deleting submission: "+v.message))}),p.addEventListener("click",()=>{const L=l.dataset.submissionId,v=h.files[0];if(!v)return alert("Please select an image first.");if(v.type.startsWith("video/")&&v.size>10*1024*1024){alert("Video must be 10 MB or smaller.");return}if(v.type.startsWith("image/")&&v.size>8*1024*1024){alert("Image must be 8 MB or smaller.");return}const R=new FormData;v.type.startsWith("video/")?R.append("video",v):R.append("photo",v),fetch(`/quests/submission/${L}/photo`,{method:"PUT",credentials:"same-origin",headers:{"X-CSRFToken":o()},body:R}).then(k=>k.json()).then(k=>{if(!k.success)throw new Error(k.message||"Upload failed");k.video_url?(e("#submissionImage").hidden=!0,e("#submissionVideo").hidden=!1,e("#submissionVideoSource").src=k.video_url,e("#submissionVideo").load()):(e("#submissionVideo").hidden=!0,e("#submissionImage").hidden=!1,e("#submissionImage").src=k.image_url),y.click()}).catch(k=>alert(k.message))}),e("#submissionReplyEdit").hidden=m,e("#postReplyBtn").hidden=m,e("#ownerNotice").hidden=!m;const I=e("#submissionRepliesContainer");m?I.hidden=!0:I.hidden=!1;const E={img:e("#submissionImage"),video:e("#submissionVideo"),videoSource:e("#submissionVideoSource"),imgOverlay:e("#submitterProfileImageOverlay"),commentRead:e("#submissionComment"),commentEdit:e("#submissionCommentEdit"),readBox:e("#commentReadButtons"),editBox:e("#commentEditButtons"),editBtn:e("#editCommentBtn"),profileImg:e("#submitterProfileImage"),profileImgOverlay:e("#submitterProfileImageOverlay"),profileCap:e("#submitterProfileCaption"),profileLink:e("#submitterProfileLink"),social:{tw:e("#twitterLink"),fb:e("#facebookLink"),ig:e("#instagramLink")}};E.profileImg.src=d.user_profile_picture||s,E.profileImgOverlay.src=E.profileImg.src,E.profileCap.textContent=d.user_display_name||d.user_username||"—",E.profileLink.onclick=L=>{L.preventDefault(),_(d.user_id)},E.imgOverlay.parentElement.onclick=E.profileLink.onclick;const ge=s;d.video_url?(E.img.hidden=!0,E.video.hidden=!1,E.videoSource.src=d.video_url,E.video.load()):(E.video.hidden=!0,E.img.hidden=!1,E.img.src=d.url||ge),E.commentRead.textContent=d.comment||"No comment provided.",["tw","fb","ig"].forEach(L=>{const v=L==="tw"?"twitter_url":L==="fb"?"fb_url":"instagram_url";try{new URL(d[v]),E.social[L].href=d[v],E.social[L].style.display="inline-block"}catch{E.social[L].style.display="none"}}),m?(E.editBtn.hidden=!1,E.readBox.hidden=!1):E.editBtn.hidden=E.readBox.hidden=E.commentEdit.hidden=E.editBox.hidden=!0,a(),w("submissionDetailModal")},e("#editCommentBtn").addEventListener("click",()=>{e("#submissionCommentEdit").value=e("#submissionComment").textContent.trim(),i(!0)}),e("#saveCommentBtn").addEventListener("click",()=>{const d=e("#submissionDetailModal").dataset.submissionId;fetch(`/quests/submission/${d}/comment`,{method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":o()},body:JSON.stringify({comment:e("#submissionCommentEdit").value.trim()})}).then(l=>{if(!l.ok)throw new Error(l.status);return l.json()}).then(l=>{if(!l.success)throw new Error(l.message||"Save failed");e("#submissionComment").textContent=l.comment||"No comment provided.",i(!1)}).catch(l=>alert(`Could not save comment: ${l.message}`))}),e("#cancelCommentBtn").addEventListener("click",()=>i(!1));function i(d){e("#submissionComment").hidden=d,e("#commentReadButtons").hidden=d,e("#submissionCommentEdit").hidden=!d,e("#commentEditButtons").hidden=!d}function a(){const d=e("#submissionDetailModal").dataset.submissionId;d&&(fetch(`/quests/submissions/${d}`,{credentials:"same-origin"}).then(l=>l.json()).then(l=>{e("#submissionLikeCount").textContent=l.like_count||0,e("#submissionLikeBtn").classList.toggle("active",l.liked_by_current_user)}),fetch(`/quests/submission/${d}/replies`,{credentials:"same-origin"}).then(l=>l.json()).then(l=>{const c=e("#submissionRepliesList");c.innerHTML="",l.replies.forEach(g=>{const f=document.createElement("div");f.className="reply mb-1",f.innerHTML=`
            <a href="#" class="reply-user-link" data-user-id="${g.user_id}">
              <strong>${g.user_display}</strong>
            </a>: ${g.content}
          `,f.querySelector(".reply-user-link").addEventListener("click",p=>{p.preventDefault(),_(g.user_id)}),c.appendChild(f)});const m=e("#submissionReplyEdit"),b=e("#postReplyBtn");l.replies.length>=10?(m.disabled=!0,b.disabled=!0,n&&(n.style.display="block")):(m.disabled=!1,b.disabled=!1,n&&(n.style.display="none"))}))}e("#submissionLikeBtn").addEventListener("click",()=>{const d=e("#submissionLikeBtn"),l=e("#submissionDetailModal").dataset.submissionId,c=d.classList.contains("active");fetch(`/quests/submission/${l}/like`,{method:c?"DELETE":"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":o()}}).then(m=>{if(!m.ok)throw new Error(m.status);return m.json()}).then(m=>{if(!m.success)throw new Error("Like failed");e("#submissionLikeCount").textContent=m.like_count,d.classList.toggle("active",m.liked)}).catch(m=>alert(m.message))}),e("#postReplyBtn").addEventListener("click",()=>{const d=e("#submissionDetailModal").dataset.submissionId,l=e("#submissionReplyEdit");e("#postReplyBtn");const c=l.value.trim();!d||!c||fetch(`/quests/submission/${d}/replies`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":o()},body:JSON.stringify({content:c})}).then(m=>m.json().then(b=>({ok:m.ok,status:m.status,body:b}))).then(({ok:m,status:b,body:g})=>{if(!g.success){if(g.message==="Reply limit of 10 reached"){r();return}if(b===409&&g.message==="Duplicate reply")return alert("You have already posted that exact reply.");throw new Error(g.message||"Error")}const f=e("#submissionRepliesList"),h=document.createElement("div");h.className="reply mb-1",h.innerHTML=`<strong>${g.reply.user_display}</strong>: ${g.reply.content}`,f.insertBefore(h,f.firstChild),l.value="",f.children.length>=10&&r()}).catch(m=>alert(m.message))});function r(){const d=e("#submissionReplyEdit"),l=e("#postReplyBtn");d.disabled=!0,l.disabled=!0,n&&(n.style.display="block")}});const Te=document.querySelector('meta[name="placeholder-image"]').getAttribute("content");let F=0,oe=null,X=!1,Y=!1;function qe(e){F=0,oe=e;const t=document.getElementById("allSubmissionsContainer");t&&(t.innerHTML=""),w("allSubmissionsModal"),se()}function se(){const e=F*10;fetch(`/quests/quest/all_submissions?game_id=${oe}&offset=${e}&limit=10`).then(t=>t.json()).then(t=>{if(t.error)throw new Error(t.error);X=t.is_admin,Y=t.has_more,De(t.submissions,X,F>0),Me(Y),F+=1}).catch(t=>{u.error("Error fetching all submissions:",t),alert("Error fetching all submissions: "+t.message)})}function De(e,t,n=!1){const o=document.getElementById("allSubmissionsContainer");if(!o){u.error("allSubmissionsContainer element not found.");return}n||(o.innerHTML=""),e.forEach(s=>{const i=document.createElement("div");i.className="submission-card";const a=document.createElement("img");a.src=s.image_url||Te,a.alt="Quest Submission",a.className="submission-image";const r=document.createElement("div");r.className="submission-info";const d=document.createElement("p");d.textContent=`User: ${s.user_display_name||s.user_username}`,d.className="submission-user-details";const l=document.createElement("p"),c=new Date(s.timestamp).toLocaleString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0});l.textContent=`Submitted on: ${c}`,l.className="submission-timestamp";const m=document.createElement("p");m.textContent=`Comment: ${s.comment}`,m.className="submission-comment";const b=document.createElement("p");b.textContent=`Twitter: ${s.twitter_url||"N/A"}`,b.className="submission-comment";const g=document.createElement("p");g.textContent=`Facebook: ${s.fb_url||"N/A"}`,g.className="submission-comment";const f=document.createElement("p");if(f.textContent=`Instagram: ${s.instagram_url||"N/A"}`,f.className="submission-comment",r.appendChild(d),r.appendChild(l),r.appendChild(m),r.appendChild(b),r.appendChild(g),r.appendChild(f),t){const h=document.createElement("button");h.textContent="Delete",h.className="button delete-button",h.addEventListener("click",function(p){p.stopPropagation(),Pe(s.id)}),i.appendChild(h)}i.appendChild(a),i.appendChild(r),i.addEventListener("click",function(){T({url:s.image_url||s.video_url,video_url:s.video_url,comment:s.comment,user_id:s.user_id,user_display_name:s.user_display_name||s.user_username,user_profile_picture:s.user_profile_picture,twitter_url:s.twitter_url,fb_url:s.fb_url,instagram_url:s.instagram_url,verification_type:"image"}),w("submissionDetailModal")}),o.appendChild(i)})}function Pe(e){fetch(`/quests/quest/delete_submission/${e}`,{method:"DELETE",headers:{"X-CSRF-Token":x()}}).then(t=>t.json()).then(t=>{if(t.success)alert("Submission deleted successfully.");else throw new Error(t.message)}).catch(t=>{u.error("Error deleting submission:",t),alert("Error during deletion: "+t.message)})}function Me(e){const t=document.getElementById("loadMoreSubmissions");t&&(t.style.display=e?"block":"none")}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("loadMoreSubmissions");e&&e.addEventListener("click",()=>{se()})});document.addEventListener("DOMContentLoaded",()=>{Ae(),document.querySelectorAll("[data-toggle-form]").forEach(e=>{e.addEventListener("click",()=>Fe(e.dataset.toggleForm))})});function Ae(){const e=document.getElementById("badgesBody");e&&fetch("/badges").then(t=>t.json()).then(t=>{e.innerHTML="",t.badges.forEach(n=>{const o=document.createElement("tr");o.dataset.badgeId=n.id;const s=n.image?`<img src="${n.image}" height="50" alt="Badge Image">`:"No Image";o.innerHTML=`
                    <td class="badge-image-manage">${s}</td>
                    <td class="badge-name">${n.name}</td>
                    <td class="badge-description">${n.description}</td>
                    <td class="badge-category">${n.category||"None"}</td>
                    <td>
                        <button class="edit-badge" data-badge-id="${n.id}">Edit</button>
                        <button class="delete-badge" data-badge-id="${n.id}">Delete</button>
                    </td>
                `,o.querySelector(".edit-badge").addEventListener("click",()=>Ne(n.id)),o.querySelector(".delete-badge").addEventListener("click",()=>Qe(n.id)),e.appendChild(o)})}).catch(t=>u.error("Failed to load badges:",t))}function Fe(e){const t=document.getElementById(e);t&&t.classList.toggle("d-none")}function Re(e){return fetch("/badges/categories").then(t=>t.json()).then(t=>{const n=t.categories||[],o=document.createElement("select");o.className="form-control badge-category-select";const s=document.createElement("option");return s.value="none",s.textContent="None",(!e||e==="none")&&(s.selected=!0),o.appendChild(s),n.forEach(i=>{const a=document.createElement("option");a.value=i,a.textContent=i,i===e&&(a.selected=!0),o.appendChild(a)}),o}).catch(t=>{u.error("Error fetching categories:",t);const n=document.createElement("select");n.className="form-control badge-category-select";const o=document.createElement("option");return o.value="none",o.textContent="None",o.selected=!0,n.appendChild(o),n})}function Ne(e){const t=document.querySelector(`tr[data-badge-id='${e}']`);if(!t){u.error(`Badge row with ID ${e} not found.`);return}const n=t.querySelector(".badge-name"),o=t.querySelector(".badge-description"),s=t.querySelector(".badge-category"),i=t.querySelector(".badge-image-manage");n.textContent="";const a=document.createElement("input");a.type="text",a.value=n.innerText.trim(),a.className="form-control badge-name-input",n.appendChild(a),o.textContent="";const r=document.createElement("textarea");if(r.className="form-control badge-description-textarea",r.value=o.innerText.trim(),o.appendChild(r),i){i.textContent="";const d=document.createElement("input");d.type="file",d.className="form-control-file badge-image-input",i.appendChild(d)}else u.error("Could not find badge-image-manage cell");Re(s.innerText.trim()).then(d=>{s.textContent="",s.appendChild(d);const l=t.querySelector("button.edit-badge");l.innerText="Save",l.onclick=()=>Oe(e)})}function Oe(e){const t=document.querySelector(`tr[data-badge-id='${e}']`),n=new FormData;n.append("name",t.querySelector(".badge-name-input").value.trim()),n.append("description",t.querySelector(".badge-description-textarea").value.trim()),n.append("category",t.querySelector(".badge-category-select").value);const o=t.querySelector(".badge-image-input");o&&o.files.length>0&&n.append("image",o.files[0]);const s=document.querySelector("[name=csrf_token]").value;n.append("csrf_token",s),S(`/badges/update/${e}`,{method:"POST",body:n}).then(({json:i})=>{i.success?(alert("Badge updated successfully"),window.location.reload()):alert("Failed to update badge: "+i.message)}).catch(i=>u.error("Error updating badge:",i))}function Qe(e){confirm("Are you sure you want to delete this badge?")&&S(`/badges/delete/${e}`,{method:"DELETE"}).then(({json:t})=>{t.success?window.location.reload():alert(`Failed to delete badge: ${t.message}`)}).catch(t=>{u.error("Error deleting badge:",t),alert("Error deleting badge. Please check console for details.")})}let q=[];const H=document.querySelector('meta[name="placeholder-image"]').getAttribute("content");function je(e){try{const t=new URL(e,window.location.origin);if(t.protocol==="http:"||t.protocol==="https:")return e}catch{}return H}async function Ue(){const e=document.getElementById("game_IdHolder"),t=e?e.getAttribute("data-game-id"):null,o=`/badges${t&&!isNaN(parseInt(t,10))&&t!=="0"?`?game_id=${t}`:""}`,s=await fetch(o,{credentials:"same-origin"});if(!s.ok)throw new Error("Error fetching badges");return q=(await s.json()).badges,q}async function ie(){if(!q||q.length===0)try{await Ue()}catch(e){u.error("Error loading badges:",e),q=[]}}function Ge(e){return e?`<ul>${e.split(",").map(n=>`<li>${A(n.trim())}</li>`).join("")}</ul>`:""}function He(e){return q.find(t=>t.id==e)}function Ve(e){return{id:e.getAttribute("data-badge-id"),name:e.getAttribute("data-badge-name")||"Badge",description:e.getAttribute("data-badge-description")||"",image:e.getAttribute("data-badge-image")||H}}async function We(e){const t=await fetch(`/quests/detail/${e}/user_completion`);if(!t.ok)throw new Error("Failed to fetch user completions");const n=await t.json();return n.userCompletion?n.userCompletion.completions:0}function Xe(e,t,n,o,s,i,a){const r=document.getElementById("badgeModalTitle"),d=document.getElementById("badgeModalImage"),l=document.getElementById("badgeModalText");if(!r||!d||!l){u.error("Badge modal elements missing");return}r.textContent=e.name,d.src=je(e.image)||H;let c="";if(i){const b=`<a href="#" data-quest-detail="${i}">${A(a)}</a>`;c=`<p>Completion Requirement: ${t>1?t+" times":t+" time"}</p><p>Your Total Completions: ${n}</p><p>${s?"You have earned this badge.":"Complete "+b+" to earn this badge."}</p>`}else c=`<p>Completion Requirements: ${t} (per task)</p><p>Your Total Completions: ${n}</p>${o}<p>${s?"You have earned this badge.":"Complete one of the above tasks to earn this badge."}</p>`;const m=e.description||"No description available.";s?(d.style.filter="none",d.oncontextmenu=null,l.innerHTML=`<p><strong>Awarded!</strong></p>${c}<p>${A(m)}</p>`):(d.style.filter="grayscale(100%) opacity(0.5)",d.oncontextmenu=b=>(b.preventDefault(),!1),l.innerHTML=`<p><strong>Not Awarded Yet</strong></p>${c}<p>${A(m)}</p>`)}async function Ye(e){const t=e.getAttribute("data-badge-id"),n=e.getAttribute("data-task-name"),o=e.getAttribute("data-task-id"),s=e.getAttribute("data-badge-awarded-count"),i=e.getAttribute("data-user-completions"),a=parseInt(s,10),r=parseInt(i,10)||0,d=Ge(n),l=o?o.split(",").map(f=>f.trim()).filter(Boolean):[],c=l.length===1?l[0]:null;await ie();const m=He(t)||Ve(e);let b=r;if(c)try{b=await We(c)}catch(f){u.error("Error fetching user completions:",f)}const g=b>=a;Xe(m,a,b,d,g,c,n),w("badgeModal")}document.addEventListener("DOMContentLoaded",()=>{ie()});document.addEventListener("click",e=>{const t=e.target.closest("[data-open-badge]");t&&(e.preventDefault(),Ye(t))});document.addEventListener("DOMContentLoaded",()=>{});let N;function Je(e){const t=document.getElementById("deleteGameModal"),n=document.getElementById("deleteGameForm"),o=document.getElementById("deleteGameConfirmInput"),s=document.getElementById("deleteGameCountdown"),i=document.getElementById("deleteGameTimer"),a=document.getElementById("deleteGameConfirmBtn");if(!t||!n||!o||!s||!i||!a){u.warn("Delete game modal elements missing");return}t.dataset.gameId=e,n.action=`/games/delete_game/${e}`,o.value="",a.disabled=!0,s.hidden=!0,i.textContent="5",w("deleteGameModal")}function J(){const e=document.getElementById("deleteGameConfirmInput"),t=document.getElementById("deleteGameConfirmBtn"),n=document.getElementById("deleteGameCountdown"),o=document.getElementById("deleteGameTimer"),s=document.getElementById("deleteGameUndo"),i=document.getElementById("deleteGameForm");!e||!t||!n||!o||!s||!i||(e.addEventListener("input",()=>{t.disabled=e.value.trim().toLowerCase()!=="delete"}),t.addEventListener("click",()=>{let a=5;n.hidden=!1,o.textContent=a.toString(),N=setInterval(()=>{a-=1,o.textContent=a.toString(),a<=0&&(clearInterval(N),i.submit())},1e3)}),s.addEventListener("click",()=>{clearInterval(N),n.hidden=!0,o.textContent="5",e.value="",t.disabled=!0}))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",J):J();document.addEventListener("click",e=>{const t=e.target.closest("[data-delete-game-id]");t&&(e.preventDefault(),Je(t.getAttribute("data-delete-game-id")))});document.addEventListener("DOMContentLoaded",()=>{});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("flash-data");if(!e)return;const t=JSON.parse(e.getAttribute("data-messages")||"[]");if(!t.length)return;const[n,o]=t[0],s=document.getElementById("flash-overlay");s.querySelector(".flash-content").textContent=o,s.querySelector(".flash-modal").classList.add(`flash-${n}`),requestAnimationFrame(()=>{s.classList.add("visible")});function i(){s.classList.remove("visible"),e.removeAttribute("data-messages")}s.querySelector(".flash-close").addEventListener("click",i),s.querySelector(".flash-ok-btn").addEventListener("click",i)});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("forgotForm");if(!e)return;const t=document.getElementById("forgotEmailError"),n=document.getElementById("forgotSuccess"),o=document.getElementById("forgotButton"),s=document.getElementById("forgotEmail"),i=document.getElementById("forgotEmailDisplay"),a=document.getElementById("forgotPasswordModal");new MutationObserver(()=>{a.style.display==="block"&&(i.textContent=s.value)}).observe(a,{attributes:!0,attributeFilter:["style"]}),e.addEventListener("submit",d=>{d.preventDefault(),t.style.display="none",n.style.display="none",G(e).then(({json:l})=>{l.success?(n.textContent=l.message,n.style.display="block",o.disabled=!0):(t.textContent=l.error||"An error occurred.",t.style.display="block")}).catch(()=>{e.submit()})})});document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("button[data-game-id]").forEach(n=>{n.addEventListener("click",function(){t(this)})});function t(n){const o=document.getElementById("questCreationForm"),s=n.getAttribute("data-game-id");o?o.addEventListener("submit",function(i){i.preventDefault();const a=document.getElementById("questDescription").value,r=document.querySelector("[name=csrf_token]").value;fetch("/ai/generate_quest",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":r},body:JSON.stringify({description:a,game_id:s})}).then(d=>d.ok?d.json():d.json().then(l=>Promise.reject({status:d.status,statusText:d.statusText,errorMessage:l.error}))).then(d=>{if(d.generated_quest_html){document.getElementById("generatedQuestContent").innerHTML=d.generated_quest_html,w("generateAIQuestModal");const l=document.getElementById("generateAIQuestModalForm");l&&l.setAttribute("data-game-id",s),l&&l.addEventListener("submit",function(f){f.preventDefault();const h=new FormData(l),p=document.querySelector("[name=csrf_token]").value;fetch("/ai/create_quest",{method:"POST",headers:{"X-CSRFToken":p},body:h}).then(y=>y.json()).then(y=>{window.location.href="/",u.log(y)}).catch(y=>{u.error("Error:",y)})});const c=document.getElementById("generateAIImage"),m=document.getElementById("badge_description"),b=document.getElementById("aiBadgeImage"),g=document.getElementById("aiBadgeFilename");if(!c||!m||!b||!g){u.error("One or more elements not found in the DOM");return}c.addEventListener("click",function(){u.log("Generate AI Image button clicked");const f=m.value;if(u.log("Badge Description:",f),!f){alert("Please enter a badge description first.");return}fetch("/ai/generate_badge_image",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":document.querySelector("[name=csrf_token]").value},body:JSON.stringify({badge_description:f})}).then(h=>h.json()).then(h=>{if(u.log("Response data:",h),h.error)alert("Error generating badge image: "+h.error);else{const p=`${h.filename}`,y=`static/images/badge_images/${h.filename}`;b.src=y,b.style.display="block",g.value=p}}).catch(h=>{u.error("Fetch error:",h),alert("Error: "+h)})})}}).catch(d=>{alert("Error generating quest: "+(d.errorMessage||d.statusText))})}):u.error("Form '#questCreationForm' not found.")}});const ze=async()=>{try{const t=await(await fetch("/refresh-csrf")).json();document.querySelector('meta[name="csrf-token"]').setAttribute("content",t.csrf_token)}catch(e){u.error("Error refreshing CSRF token:",e)}};setInterval(ze,9e5);const Ke=async e=>{try{const n=await(await fetch(`/games/get_game_points/${e}`,{credentials:"same-origin"})).json(),o=n.total_game_points,s=n.game_goal,i=s-o,a=Math.min(o/s*100,100),r=document.getElementById("meterBar"),d=document.querySelector(".meter-label");r&&(r.style.height=`${a}%`),document.documentElement.style.setProperty("--meter-fill-height",`${a}%`),d&&(d.innerText=`Remaining Reduction: ${i} / ${s}`)}catch(t){u.error("Failed to update meter:",t)}};function Ze(){const e=document.getElementById("game_IdHolder"),t=document.getElementById("gameNameHeader");if(!e||!t)return;const n=e.getAttribute("data-game-id");fetch(`/games/get_game/${n}`,{credentials:"same-origin"}).then(o=>{if(!o.ok)throw u.error(`Failed fetching game name; URL returned status ${o.status} (${o.statusText})`),t.textContent="Error Loading Game",new Error(`HTTP ${o.status}: ${o.statusText}`);return o.json()}).then(o=>{t.textContent=o.name||"Game Not Found"}).catch(o=>{u.error("Error retrieving game name:",o),t.textContent="Error Loading Game"})}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("leaderboardButton");e&&e.addEventListener("click",async()=>{const r=e.getAttribute("data-game-id");(await U(()=>import("./chunk-Dg0EZy6e.js"),__vite__mapDeps([0,1]))).showLeaderboardModal(r),Ke(r)});const t=document.getElementById("submissionsButton");t&&t.addEventListener("click",()=>{currentUserId!=="none"&&qe(currentUserId)});const n=document.getElementById("contactForm");n&&n.addEventListener("submit",async r=>{r.preventDefault();const d=new FormData(n);fe();try{const l=await fetch(n.action,{method:"POST",body:d,headers:{"X-Requested-With":"XMLHttpRequest"}}),c=await l.json();l.ok&&c.success?(alert("Your message has been sent successfully."),P("contactModal")):alert("Failed to send your message. Please try again.")}catch{alert("Failed to send your message. Please try again.")}finally{be()}}),document.getElementById("message-input")&&(document.querySelector("form").onsubmit=()=>!0),document.querySelectorAll(".activity-message").forEach(r=>{r.innerHTML=r.innerHTML.replace(/<\/?p[^>]*>/g,"")});const s=document.getElementById("questSearchInput"),i=document.getElementById("questCategoryDropdown");s&&s.addEventListener("input",z),i&&i.addEventListener("change",z);const a=document.querySelector("#whats-happening-step");if(a){const r=a.querySelectorAll(".wh-tab-button"),d=a.querySelectorAll(".wh-tab-content");r.forEach(l=>{l.addEventListener("click",()=>{const c=l.getAttribute("data-wh-tab");r.forEach(m=>m.classList.remove("active")),d.forEach(m=>m.classList.remove("active")),l.classList.add("active"),a.querySelector(`#wh-${c}-tab`).classList.add("active")})})}Ze()});function z(){const e=document.getElementById("questSearchInput").value.trim().toLowerCase(),t=document.getElementById("questCategoryDropdown").value;document.querySelectorAll("#questTableBody tr.quest-row").forEach(o=>{const s=o.querySelector(".quest-title").textContent.toLowerCase(),i=o.dataset.category||"Not Set",a=s.includes(e),r=t==="all"||i===t;o.style.display=a&&r?"":"none"})}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("joinCustomGameModal");if(!e)return;document.querySelectorAll("#customGameList .list-group-item").forEach(function(s){s.addEventListener("click",function(){const i=this.getAttribute("data-game-code");confirm("Do you want to join ‘"+this.textContent.trim()+"’?")&&(document.getElementById("customGameCodeInput").value=i,document.getElementById("joinCustomGameForm").submit())})});const t=e.dataset.hasJoined==="1",n=e.dataset.joinDemoUrl;let o=!1;document.getElementById("joinCustomGameForm").addEventListener("submit",()=>{o=!0}),e.addEventListener("hidden.bs.modal",function(){!o&&!t&&(window.location.href=n)})});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("loginForm"),t=document.getElementById("loginModal");if(!e||!t)return;const n=document.getElementById("passwordError"),o=document.getElementById("forgotPasswordLink"),s=t.querySelector("[data-register-from-login]"),i=t.dataset.checkUrl;e.addEventListener("submit",c=>{c.preventDefault(),n.style.display="none",o&&(o.style.display="none"),G(e).then(({json:m})=>{m.success?window.location.href=m.redirect:(n.textContent=m.error,n.style.display="block",m.show_forgot&&o&&(o.style.display="block"))}).catch(()=>e.submit())});const a=document.getElementById("loginEmail"),r=document.getElementById("loginButton"),d=document.getElementById("emailError");function l(){r.disabled=!0,d.style.display="none",d.textContent="",o&&(o.style.display="none")}l(),o&&o.addEventListener("click",c=>{c.preventDefault(),ve()}),s&&s.addEventListener("click",c=>{c.preventDefault(),Ee()}),a.addEventListener("blur",()=>{const c=a.value.trim();if(!c)return l();fetch(`${i}?email=${encodeURIComponent(c)}`).then(m=>m.json()).then(m=>{m.exists?r.disabled=!1:(r.disabled=!0,d.textContent="This email is not registered. Please register first.",d.style.display="block")}).catch(()=>r.disabled=!1)}),a.addEventListener("input",l)});let C=null;const et={qr_code:"QR Code",photo:"Photo Upload",comment:"Comment",photo_comment:"Photo Upload and Comment",video:"Video Upload"};let ae=[];function K(){const e=document.getElementById("game_Data");if(!e)return;C=e.dataset.gameId;const t=document.getElementById("deleteAllQuestsBtn");t&&t.addEventListener("click",nt);const n=document.getElementById("importQuestsBtn");n&&n.addEventListener("click",ut),tt().then(()=>M(C))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",K):K();async function tt(){try{const e=await fetch("/badges");if(!e.ok)throw new Error("Failed to fetch badges");ae=(await e.json()).badges||[]}catch(e){u.error("Error fetching badges:",e)}}function re(e){const t=document.querySelector(`#quest-${e}`),n={};t.querySelectorAll(".editable").forEach(o=>{n[o.getAttribute("data-name")]=o.innerHTML}),ot(t),st(t),it(t),at(t),lt(t,e,n)}function nt(){confirm("Are you sure you want to delete all quests? This action cannot be undone.")&&fetch(`/quests/game/${C}/get_title`,{method:"GET",headers:{Accept:"application/json"}}).then(e=>{if(!e.ok)throw new Error("Failed to fetch game title");return e.json()}).then(e=>{const t=e.title;confirm(`This will delete all quests for the game: "${t}". Are you absolutely sure? This action cannot be undone.`)&&fetch(`/quests/game/${C}/delete_all`,{method:"DELETE",headers:{"X-CSRF-Token":x(),Accept:"application/json"}}).then(n=>{if(!n.ok)throw new Error("Failed to delete all quests");return n.json()}).then(n=>{n.success?(alert("All quests deleted successfully"),M(C)):alert(`Failed to delete quests: ${n.message}`)}).catch(n=>{u.error("Error:",n),alert("Failed to delete all quests. Please check the console for more details.")})}).catch(e=>{u.error("Error fetching game title:",e),alert("Failed to fetch game title. Please check the console for more details.")})}function ot(e){const t=e.querySelector('.editable[data-name="verification_type"]'),n=t.getAttribute("data-value").toLowerCase();let o='<select name="verification_type" class="editable-select">';Object.entries(et).forEach(([s,i])=>{const a=n===s.toLowerCase()?"selected":"";o+=`<option value="${s}" ${a}>${i}</option>`}),o+="</select>",t.innerHTML=o}function st(e){const t=e.querySelector('.editable[data-name="frequency"]'),n=t.getAttribute("data-value").toLowerCase();let o='<select name="frequency" class="editable-select">';Object.entries({daily:"Daily",weekly:"Weekly",monthly:"Monthly"}).forEach(([i,a])=>{const r=n===i.toLowerCase()?"selected":"";o+=`<option value="${i}" ${r}>${a}</option>`}),o+="</select>",t.innerHTML=o}function it(e){const t=e.querySelector('.editable[data-name="badge_name"]');let n=t.innerText.trim(),o='<select name="badge_id" class="editable-select"><option value="">None</option>';ae.forEach(s=>{const i=n===s.name?"selected":"";o+=`<option value="${s.id}" ${i}>${s.name}</option>`}),o+="</select>",t.innerHTML=o}function at(e,t){[{name:"title",type:"text"},{name:"description",type:"textarea"},{name:"tips",type:"textarea"},{name:"points",type:"number"},{name:"badge_awarded",type:"number"},{name:"completion_limit",type:"number"},{name:"category",type:"text"},{name:"enabled",type:"select",options:["Yes","No"]},{name:"is_sponsored",type:"select",options:["Yes","No"]}].forEach(o=>{const s=e.querySelector(`.editable[data-name="${o.name}"]`);s&&rt(s,o)})}function rt(e,t){let n=e.getAttribute("data-value")||e.innerHTML.trim(),o;t.type==="select"?(o=document.createElement("select"),o.name=t.name,t.options.forEach(s=>{const i=document.createElement("option");i.value=s,i.text=s,n===i.text&&(i.selected=!0),o.appendChild(i)})):t.type==="textarea"?(o=document.createElement("textarea"),o.name=t.name,o.value=n):(o=document.createElement("input"),o.type=t.type,o.name=t.name,o.value=n),e.innerHTML="",e.appendChild(o)}function lt(e,t,n){const o=e.querySelector(".edit-button");o.innerText="Save",o.onclick=()=>ct(t);const s=document.createElement("button");s.innerText="Cancel",s.className="btn btn-secondary ms-2 cancel-button",s.onclick=()=>{dt(e,n,o,t)},o.parentNode.insertBefore(s,o.nextSibling)}function dt(e,t,n,o){Object.entries(t).forEach(([s,i])=>{const a=e.querySelector(`.editable[data-name="${s}"]`);a&&(a.innerHTML=i)}),n.innerText="Edit",n.onclick=()=>re(o),e.querySelector(".cancel-button").remove()}function ct(e){const t=document.querySelector(`#quest-${e}`);let n={};t.querySelectorAll("input, select, textarea").forEach(o=>{let s=o.value;o.name==="enabled"||o.name==="is_sponsored"?s=o.value==="Yes":o.name==="badge_id"&&s===""&&(s=null),n[o.name]=s}),fetch(`/quests/quest/${e}/update`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":x()},body:JSON.stringify(n)}).then(o=>o.json()).then(o=>{o.success?(alert("Quest updated successfully."),M(C)):alert("Failed to update quest. Error: "+o.message)}).catch(o=>{u.error("Error updating quest:",o),alert("Error updating quest. Please check console for details.")})}function M(e){fetch(`/quests/game/${e}/quests`,{method:"GET",headers:{"Content-Type":"application/json"}}).then(t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}).then(t=>{const n=document.getElementById("questsBody");n.innerHTML="",t.quests.forEach(o=>{const s=document.createElement("div");s.className="card",s.id=`quest-${o.id}`;const i=o.verification_type.toLowerCase(),a=o.badge_name||"None",r=o.frequency||"Not Set",d=o.category||"Not Set",l=o.badge_awarded||"Not Set";s.innerHTML=`
                    <div class="card-body">
                        <h5 class="card-title editable" data-name="title">${o.title}</h5>
                        <div class="card-text editable" data-name="description">${o.description}</div>
                        <div class="card-text editable" data-name="tips">${o.tips||""}</div>
                        <p class="card-text"><strong>Points:</strong> <span class="editable" data-name="points">${o.points}</span></p>
                        <p class="card-text"><strong>Completion Limit:</strong> <span class="editable" data-name="completion_limit">${o.completion_limit}</span></p>
                        <p class="card-text"><strong>Enabled:</strong> <span class="editable" data-name="enabled">${o.enabled?"Yes":"No"}</span></p>
                        <p class="card-text"><strong>Pinned:</strong> <span class="editable" data-name="is_sponsored">${o.is_sponsored?"Yes":"No"}</span></p>
                        <p class="card-text"><strong>Verification:</strong> <span class="editable" data-name="verification_type" data-value="${o.verification_type}">${i}</span></p>
                        <p class="card-text"><strong>Badge:</strong> <span class="editable" data-name="badge_name">${a}</span></p>
                        <p class="card-text"><strong>Badge Awarded:</strong> <span class="editable" data-name="badge_awarded">${l}</span></p>
                        <p class="card-text"><strong>Frequency:</strong> <span class="editable" data-name="frequency" data-value="${o.frequency}">${r}</span></p>
                        <p class="card-text"><strong>Category:</strong> <span class="editable" data-name="category">${d}</span></p>
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-warning edit-button" data-quest-id="${o.id}">Edit</button>
                            <button class="btn btn-danger delete-button" data-quest-id="${o.id}">Delete</button>
                            <button class="btn btn-info qr-button" data-quest-id="${o.id}">Generate QR Code</button>
                        </div>
                    </div>
                `,n.appendChild(s);const c=s.querySelector(".edit-button"),m=s.querySelector(".delete-button"),b=s.querySelector(".qr-button");c&&c.addEventListener("click",()=>re(o.id)),m&&m.addEventListener("click",()=>mt(o.id)),b&&b.addEventListener("click",()=>pt(o.id))})}).catch(t=>u.error("Failed to load quests:",t))}function mt(e){fetch(`/quests/quest/${e}/delete`,{method:"DELETE",headers:{"X-CSRF-Token":x(),Accept:"application/json"}}).then(t=>{if(!t.ok)throw new Error("Failed to delete quest");return t.json()}).then(t=>{t.success?(alert("Quest deleted successfully"),M(C)):alert(`Failed to delete quest: ${t.message}`)}).catch(t=>{u.error("Error:",t),alert("Failed to delete quest. Please check the console for more details.")})}function ut(){const e=document.getElementById("importQuestsForm"),t=new FormData(e);fetch(`/quests/game/${C}/import_quests`,{method:"POST",body:t,headers:{"X-CSRF-Token":x(),Accept:"application/json"}}).then(n=>{if(!n.ok)throw new Error("Network response was not ok");return n.json()}).then(n=>{n.success&&n.redirectUrl?(alert("Quests imported successfully"),M(C)):alert("Failed to import quests: "+n.message)}).catch(n=>{u.error("Error importing quests:",n)})}function pt(e){const t=`/quests/generate_qr/${e}`;fetch(t).then(n=>{if(!n.ok)throw new Error("Failed to generate QR code");return n.blob()}).then(n=>{const o=URL.createObjectURL(n);window.open(o,"_blank")}).catch(n=>{u.error("Error generating QR code:",n),alert("Failed to generate QR code. Please check console for more details.")})}document.addEventListener("DOMContentLoaded",()=>{});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("notifMenu");if(!e)return;const t=document.getElementById("notifBellToggle"),n=e.querySelector("#notifLoading"),o=e.querySelector("li.dropdown-footer"),s=o.querySelector("#loadMoreBtn"),i=e.dataset.url;let a=0,r=1;const d=parseInt(e.dataset.perPage,10)||10,l={follow:({from_user_name:g,from_user_id:f})=>({text:`Now following ${g}`,onClick:()=>_(f)}),followed_by:({follower_name:g,follower_id:f})=>({text:`${g} is now following you`,onClick:()=>_(f)}),submission:({actor_name:g,quest_name:f,submission_id:h})=>({text:`${g} submitted a new “${f}” quest`,onClick:async()=>{const y=await(await fetch(`/quests/submissions/${h}`)).json();T(y)}}),profile_message:({from_user_name:g,content:f,profile_user_id:h})=>({text:`${g} says “${f}”`,onClick:()=>_(h)}),profile_reply:({from_user_name:g,content:f,profile_user_id:h})=>({text:`${g} replied “${f}”`,onClick:()=>_(h)}),submission_like:({liker_name:g,submission_id:f})=>({text:`${g} liked your submission`,onClick:async()=>{const p=await(await fetch(`/quests/submissions/${f}`,{credentials:"same-origin"})).json();T(p)}}),submission_reply:({actor_name:g,content:f,submission_id:h})=>({text:`${g} replied “${f}”`,onClick:async()=>{const y=await(await fetch(`/quests/submissions/${h}`,{credentials:"same-origin"})).json();T(y)}})};function c(g){const f=l[g.type];let h,p;if(f&&g.payload)try{({text:h,onClick:p}=f(g.payload))}catch(I){u.error(`Error in handler for ${g.type}:`,I)}(!h||!p)&&(h=g.payload.summary||JSON.stringify(g.payload),p=()=>{window.location.href="/notifications/"});const y=g.is_read?"":"fw-bold",B=document.createElement("a");return B.href="#",B.className=`dropdown-item ${y}`,B.innerHTML=`
      ${h}
      <small class="text-muted d-block text-center">
        ${new Date(g.when).toLocaleString()}
      </small>`,B.addEventListener("click",async I=>{I.preventDefault();try{await p()}catch(E){u.error(E)}}),B}function m(g){g&&g.parentNode===e&&e.removeChild(g)}async function b(g){g===1&&(Array.from(e.children).forEach(y=>{y!==n&&y!==o&&e.removeChild(y)}),a=0),m(n),m(o),e.appendChild(n),e.appendChild(o),n.style.display="",s.disabled=!0;let f;try{f=await fetch(`${i}?page=${g}&per_page=${d}`,{credentials:"include"})}catch(y){n.textContent="Network error.",u.error(y);return}if(!f.ok){n.textContent="Error loading.",u.error("Status:",f.status,f.statusText);return}const h=await f.json();a=h.page,r=h.total_pages,m(n),m(o);const p=t.querySelector(".badge");p&&p.remove(),h.items.forEach(y=>{e.appendChild(c(y))}),e.appendChild(n),e.appendChild(o),n.style.display="none",s.disabled=a>=r}t.addEventListener("show.bs.dropdown",()=>{a===0&&b(1)}),s.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),a<r&&b(a+1)})});document.addEventListener("DOMContentLoaded",()=>{typeof window>"u"||typeof navigator>"u"||!("serviceWorker"in navigator)||!("PushManager"in window)||navigator.serviceWorker.ready.then(async e=>{try{const t=await fetch("/push/public_key");if(!t.ok)return;let n;try{({public_key:n}=await t.json())}catch(i){u.error("Push setup failed",i);return}if(!n||await e.pushManager.getSubscription())return;const s=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:gt(n)});await fetch("/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscription:s})})}catch(t){u.error("Push setup failed",t)}})});function gt(e){const t="=".repeat((4-e.length%4)%4),n=(e+t).replace(/-/g,"+").replace(/_/g,"/"),o=atob(n),s=new Uint8Array(o.length);for(let i=0;i<o.length;++i)s[i]=o.charCodeAt(i);return s}function ft(e){const t=document.querySelector(`meta[name="${e}"]`);return t?t.content:""}const bt=Number(ft("current-user-id")||0),le=x(),$=document.querySelector('meta[name="placeholder-image"]').getAttribute("content");function de(e){te(),fetch(`/quests/detail/${e}/user_completion`,{credentials:"same-origin"}).then(t=>t.json()).then(t=>{const{quest:n,userCompletion:o,canVerify:s,nextEligibleTime:i}=t;if(!ce(n,o.completions,s,e,i)){u.error("populateQuestDetails – required element missing");return}me(n,o.completions,i,s),w("questDetailModal"),V(),pe(e)}).catch(t=>{u.error("Error opening quest detail modal:",t),alert("Sign in to view quest details.")})}function ht(e){fetch(`/quests/detail/${e}/user_completion`,{credentials:"same-origin"}).then(t=>t.json()).then(t=>{const{quest:n,userCompletion:o,canVerify:s,nextEligibleTime:i}=t;if(!ce(n,o.completions,s,e,i)){u.error("populateQuestDetails – required element missing");return}me(n,o.completions,i,s),V(),pe(e)}).catch(t=>{u.error("Failed to refresh quest detail modal:",t)})}function V(){const e=document.querySelectorAll("img.lazyload"),t=new IntersectionObserver((n,o)=>{n.forEach(s=>{if(s.isIntersecting){const i=s.target;i.src=i.getAttribute("data-src"),i.classList.remove("lazyload"),o.unobserve(i)}})});e.forEach(n=>{t.observe(n)})}function ce(e,t,n,o,s){const i=t>=e.completion_limit?" - complete":"",a={modalQuestTitle:document.getElementById("modalQuestTitle"),modalQuestDescription:document.getElementById("modalQuestDescription"),modalQuestTips:document.getElementById("modalQuestTips"),modalQuestPoints:document.getElementById("modalQuestPoints"),modalQuestCompletionLimit:document.getElementById("modalQuestCompletionLimit"),modalQuestBadgeAwarded:document.getElementById("modalQuestBadgeAwarded"),modalQuestCategory:document.getElementById("modalQuestCategory"),modalQuestVerificationType:document.getElementById("modalQuestVerificationType"),modalQuestBadgeImage:document.getElementById("modalQuestBadgeImage"),modalQuestCompletions:document.getElementById("modalQuestCompletions"),modalCountdown:document.getElementById("modalCountdown")};for(let m in a)if(!a[m])return u.error(`Error: Missing element ${m}`),!1;a.modalQuestTitle.innerText=`${e.title}${i}`,a.modalQuestDescription.textContent=e.description,a.modalQuestTips.textContent=e.tips||"No tips available",a.modalQuestPoints.innerText=`${e.points}`,a.modalQuestCategory.innerText=e.category||"No category set";const r=e.completion_limit>1?`${e.completion_limit} times`:`${e.completion_limit} time`;a.modalQuestCompletionLimit.innerText=`${r} ${e.frequency}`;const d=e.badge_awarded>1?`${e.badge_awarded} times`:`${e.badge_awarded} time`;switch(e.badge_awarded!=null?a.modalQuestBadgeAwarded.innerText=`After ${d}`:a.modalQuestBadgeAwarded.innerText="No badge awarded",e.verification_type){case"photo_comment":a.modalQuestVerificationType.innerText="Must upload a photo to earn points! Comment optional.";break;case"photo":a.modalQuestVerificationType.innerText="Must upload a photo to earn points!";break;case"comment":a.modalQuestVerificationType.innerText="Must upload a comment to earn points!";break;case"qr_code":a.modalQuestVerificationType.innerText="Find the QR code and post a photo to earn points!";break;default:a.modalQuestVerificationType.innerText="Not specified";break}const l=e.badge&&e.badge.image?`/static/images/badge_images/${e.badge.image}`:$;a.modalQuestBadgeImage.setAttribute("data-src",l),a.modalQuestBadgeImage.src=$,a.modalQuestBadgeImage.classList.add("lazyload"),a.modalQuestBadgeImage.alt=e.badge&&e.badge.name?`Badge: ${e.badge.name}`:"Default Badge",a.modalQuestCompletions.innerText=`Total Completions: ${t}`;const c=s&&new Date(s);return!n&&c&&c>new Date?(a.modalCountdown.innerText=`Next eligible time: ${c.toLocaleString()}`,a.modalCountdown.style.color="red"):(a.modalCountdown.innerText="You are currently eligible to verify!",a.modalCountdown.style.color="green"),vt(o,n,e.verification_type),!0}function me(e,t,n,o){const s=document.querySelector(".user-quest-data");if(!s){u.error("Parent element .user-quest-data not found");return}[{id:"modalQuestCompletions",value:`${t||0}`},{id:"modalCountdown",value:""}].forEach(a=>{let r=document.getElementById(a.id);r||(r=document.createElement("p"),r.id=a.id,s.appendChild(r)),r.innerText=a.value}),yt(document.getElementById("modalCountdown"),n,o)}function yt(e,t,n){if(!n&&t){const o=new Date(t),s=new Date;if(o>s){const i=o-s;e.innerText=`Next eligible time: ${Et(i)}`}else e.innerText="You are currently eligible to verify!"}else e.innerText="You are currently eligible to verify!"}function Et(e){const t=Math.floor(e/1e3%60),n=Math.floor(e/(1e3*60)%60),o=Math.floor(e/(1e3*60*60)%24);return`${Math.floor(e/(1e3*60*60*24))}d ${o}h ${n}m ${t}s`}function vt(e,t,n,o){const s=document.querySelector(".user-quest-data");if(!s){u.error("Parent element .user-quest-data not found");return}if(s.innerHTML="",t){const i=document.createElement("div");i.id=`verifyQuestForm-${e}`,i.className="verify-quest-form",i.style.display="block";const a=wt(n.trim().toLowerCase(),e);i.innerHTML=a,s.appendChild(i),Bt(e)}}function wt(e,t){let n=`
    <form enctype="multipart/form-data" class="epic-form" method="post" action="/quests/quest/${t}/submit">
      <input type="hidden" name="csrf_token" value="${le}">
      <h2 style="text-align:center;">Verify Your Quest</h2>
  `;switch(e){case"photo":n+=`
        <div class="form-group">
          <label for="image" class="epic-label">Upload a Photo</label>
          <input type="file" id="image" name="image"
                 class="epic-input" accept="image/*" required>
        </div>
        <div class="form-group">
          <button type="submit">Submit Verification</button>
        </div>
      `;break;case"comment":n+=`
        <div class="form-group">
          <label for="verificationComment" class="epic-label">Enter a Comment</label>
          <textarea id="verificationComment" name="verificationComment"
                    class="epic-textarea" placeholder="Enter a comment..." required></textarea>
        </div>
        <div class="form-group">
          <button type="submit">Submit Verification</button>
        </div>
      `;break;case"photo_comment":n+=`
        <div class="form-group">
          <label for="image" class="epic-label">Upload a Photo</label>
          <input type="file" id="image" name="image"
                 class="epic-input" accept="image/*" required>
        </div>
        <div class="form-group">
          <label for="verificationComment" class="epic-label">Enter a Comment (optional)</label>
          <textarea id="verificationComment" name="verificationComment"
                    class="epic-textarea" placeholder="Enter a comment..."></textarea>
        </div>
        <div class="form-group">
          <button type="submit">Submit Verification</button>
        </div>
      `;break;case"video":n+=`
        <div class="form-group">
          <label for="video" class="epic-label">Upload a Video</label>
          <input type="file" id="video" name="video"
                 class="epic-input" accept="video/*" required>
        </div>
        <div class="form-group">
          <label for="verificationComment" class="epic-label">Add a Comment (optional)</label>
          <textarea id="verificationComment" name="verificationComment"
                    class="epic-textarea" placeholder="Enter an optional comment..."></textarea>
        </div>
        <div class="form-group">
          <button type="submit">Submit Verification</button>
        </div>
      `;break;case"qr_code":n+='<p class="epic-message">Find and scan the QR code. No submission required here.</p>';break;case"pause":n+='<p class="epic-message">Quest is currently paused.</p>';break;default:n+='<p class="epic-message">Submission requirements are not set correctly.</p>';break}return n+="</form>",n}function Bt(e){const t=document.getElementById(`verifyQuestForm-${e}`);if(!t){u.error("Form container not found for quest ID:",e);return}const n=t.querySelector("form");if(!n){u.error("Form element missing for quest ID:",e);return}n.addEventListener("submit",function(o){kt(o,e)})}function O(e,t){e&&(t&&t.trim()?(e.href=t,e.style.display="inline"):e.style.display="none")}function Lt(e){if(!e)return;const t=document.getElementById("total-points");t&&(t.innerText=`Total Completed Points: ${e}`)}function _t(e,t,n){const o=document.querySelector(`#questTableBody tr[data-quest-id="${e}"]`);if(!o)return;const s=o.querySelectorAll(".quest-stats-cell");s.length>=2&&(s[0].innerText=t,s[1].innerText=n)}function ue(e){O(document.getElementById("twitterLink"),e.twitter_url),O(document.getElementById("facebookLink"),e.fb_url),O(document.getElementById("instagramLink"),e.instagram_url)}let Q=!1;async function kt(e,t){if(e.preventDefault(),Q)return;Q=!0;const n=e.target.querySelector('[type="submit"]');n&&(n.disabled=!0);try{const o=e.target.querySelector('input[type="file"]'),s=o?o.files[0]:null;if(s&&s.type.startsWith("video/")&&s.size>10*1024*1024){alert("Video must be 10 MB or smaller.");return}if(s&&s.type.startsWith("image/")&&s.size>8*1024*1024){alert("Image must be 8 MB or smaller.");return}const i=new FormData(e.target);i.append("user_id",bt);const a=await fetch(`/quests/quest/${t}/submit`,{method:"POST",body:i,credentials:"same-origin",headers:{"X-CSRFToken":le}});if(!a.ok){if(a.status===403){const d=await a.json();throw d.message==="This quest cannot be completed outside of the game dates"?new Error("The game has ended and you can no longer submit quests. Join a new game in the game dropdown menu."):new Error(d.message||`Server responded with status ${a.status}`)}throw new Error(`Server responded with status ${a.status}`)}const r=await a.json();if(!r.success)throw new Error(r.message);Lt(r.total_points),ue(r),_t(t,r.new_completion_count,r.total_completion_count),ht(t),e.target.reset()}catch(o){u.error("Submission error:",o),alert(`Error during submission: ${o.message}`)}finally{Q=!1,n&&(n.disabled=!1)}}async function pe(e){try{const t=await fetch(`/quests/quest/${e}/submissions`,{method:"GET",credentials:"same-origin"});if(!t.ok)throw new Error(`Server responded with status ${t.status}`);const n=await t.json(),o=document.getElementById("twitterLink"),s=document.getElementById("facebookLink"),i=document.getElementById("instagramLink");if(n&&n.length){const r=n[0],d=document.getElementById("submissionImage"),l=document.getElementById("submissionVideo"),c=document.getElementById("submissionVideoSource"),m=document.getElementById("submissionComment"),b=document.getElementById("submitterProfileLink"),g=document.getElementById("submitterProfileImage"),f=document.getElementById("submitterProfileCaption");r.video_url?(d.hidden=!0,l.hidden=!1,c.src=r.video_url,l.load()):(l.hidden=!0,d.hidden=!1,d.src=r.image_url||$),m.textContent=r.comment||"No comment provided.",b.href=`/profile/${r.user_id}`,g.src=r.user_profile_picture||$,f.textContent=r.user_display_name||r.user_username||`User ${r.user_id}`,ue(r)}else[o,s,i].forEach(r=>{r&&(r.style.display="none")});const a=n.slice().reverse().map(r=>({id:r.id,url:r.image_url||(r.video_url?null:$),video_url:r.video_url,alt:"Submission Image",comment:r.comment,user_id:r.user_id,user_display_name:r.user_display_name,user_username:r.user_username,user_profile_picture:r.user_profile_picture,twitter_url:r.twitter_url,fb_url:r.fb_url,instagram_url:r.instagram_url,quest_id:e}));Ct(a)}catch(t){u.error("Failed to fetch submissions:",t),alert("Could not load submissions. Please try again.")}}function Z(e){if(!e)return u.error(`Invalid URL detected: ${e}`),!1;try{if(e.startsWith("/"))return!0;const t=new URL(e);if(t.protocol==="http:"||t.protocol==="https:")return[".jpg",".jpeg",".png",".gif",".webp"].some(o=>t.pathname.toLowerCase().endsWith(o))}catch{return u.error(`Invalid URL detected: ${e}`),!1}return!1}function Ct(e){var d;const t=document.getElementById("submissionBoard");if(!t){u.error("submissionBoard element not found");return}t.innerHTML="";const n=((d=document.getElementById("questDetailModal"))==null?void 0:d.getAttribute("data-placeholder-url"))||$,o=Z(n)?n:$,s=l=>l.startsWith("/static/"),i=l=>l.replace(/^\/static\//,""),a=window.innerWidth<=480?70:100,r=a*(window.devicePixelRatio||2);e.forEach(l=>{let c;if(l.video_url)c=document.createElement("video"),c.src=l.video_url,c.preload="metadata",c.muted=!0,c.playsInline=!0,c.style.objectFit="cover";else{c=document.createElement("img");const m=Z(l.url)?l.url:o,b=s(m)?`/resize_image?path=${encodeURIComponent(i(m))}&width=${r}`:m;c.setAttribute("data-src",b),c.classList.add("lazyload"),c.alt=l.alt||"Submission Image"}c.style.width=`${a}px`,c.style.height="auto",c.style.marginRight="10px",l.video_url||(c.onerror=()=>{s(o)?c.src=`/resize_image?path=${encodeURIComponent(i(o))}&width=${r}`:c.src=o}),c.onclick=()=>T(l),t.appendChild(c)}),V()}function It(e){e.querySelectorAll("span, img").forEach(n=>{n.classList.toggle("hidden")})}document.addEventListener("click",e=>{const t=e.target.closest("[data-quest-detail]");if(t){e.preventDefault(),de(t.getAttribute("data-quest-detail"));return}const n=e.target.closest("[data-toggle-content]");n&&n.closest("#questDetailModal")&&(e.preventDefault(),It(n))});const $t=Object.freeze(Object.defineProperty({__proto__:null,openQuestDetailModal:de},Symbol.toStringTag,{value:"Module"}));document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("registerEmail");if(!e)return;const t=document.getElementById("registerModal"),n=(t==null?void 0:t.dataset.checkUrl)||"/auth/check_email",o=document.getElementById("existingUserLogin");o&&(e.addEventListener("blur",()=>{const s=e.value.trim();s&&fetch(`${n}?email=${encodeURIComponent(s)}`).then(i=>i.json()).then(i=>{i.exists?o.style.display="block":o.style.display="none"}).catch(i=>{u.error("Error checking email:",i),o.style.display="none"})}),document.getElementById("loginWithExistingBtn").addEventListener("click",()=>{const s=e.value.trim(),i=document.getElementById("existingUserPassword").value,a=document.getElementById("loginError"),r=document.getElementById("gameIdField").value,d=document.getElementById("questIdField").value,l=document.getElementById("nextField").value,c=new FormData;c.append("email",s),c.append("password",i),c.append("remember_me","true"),r&&c.append("game_id",r),d&&c.append("quest_id",d),l&&c.append("next",l),fetch('{{ url_for("auth.login") }}',{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:c,credentials:"same-origin"}).then(m=>m.json().then(b=>({status:m.status,payload:b}))).then(({status:m,payload:b})=>{b.success?window.location.href=b.redirect:(a.textContent=b.error,a.style.display="block")}).catch(m=>{u.error("Login error:",m),a.textContent="An error occurred. Please try again.",a.style.display="block"})}),e.addEventListener("input",()=>{o.style.display="none",document.getElementById("loginError").style.display="none"}))});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("resetForm");if(!e)return;const t=document.getElementById("resetError"),n=document.getElementById("resetSuccess"),o=document.getElementById("resetButton");e.addEventListener("submit",s=>{s.preventDefault(),t.style.display="none",n.style.display="none",G(e).then(({json:i})=>{i.success?(n.textContent=i.message,n.style.display="block",o.disabled=!0,i.redirect&&setTimeout(()=>{window.location.href=i.redirect},1200)):(t.textContent=i.error||"Unable to reset password.",t.style.display="block")}).catch(i=>{u.error("Reset-password AJAX error:",i),e.submit()})})});document.addEventListener("DOMContentLoaded",()=>{const e="shoutBoardModal",t=document.getElementById("shoutBoardForm"),n=document.getElementById("shoutSubmitBtn"),o=document.getElementById("shoutMessageInput");window.addEventListener("openModal",s=>{s.detail===e&&o&&(o.value="")}),n.addEventListener("click",()=>{const s=o?o.value.trim():"";if(!s){alert("Please enter a message.");return}if(s.length>500){alert("Message must be 500 characters or fewer.");return}const i=new FormData(t);fetch(t.action,{method:"POST",body:i,credentials:"same-origin"}).then(a=>{if(!a.ok)throw new Error(`Server responded ${a.status}`);return a.text()}).then(()=>{P(e),location.reload()}).catch(a=>{u.error("Failed to post shout:",a),alert("Could not post. Please try again.")})})});var ee;(ee=document.getElementById("gameFilter"))==null||ee.addEventListener("change",function(){const e=this.value;e?window.location.href=`/admin/user_management/game/${e}`:window.location.href="/admin/user_management"});document.addEventListener("DOMContentLoaded",()=>{Le()});export{_ as a,w as o,qe as s};
