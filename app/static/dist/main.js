function R(){"serviceWorker"in navigator&&(navigator.serviceWorker.register("/sw.js").then(o=>{o.addEventListener("updatefound",()=>{const a=o.installing;a.addEventListener("statechange",()=>{a.state==="installed"&&navigator.serviceWorker.controller&&confirm("A new version is available. Reload to update?")&&window.location.reload()})}),"SyncManager"in window&&o.sync.register("sync-notifications").catch(a=>console.error("Sync registration failed:",a)),o.periodicSync&&o.periodicSync.register("periodic-notifications",{minInterval:24*60*60*1e3}).catch(a=>console.error("Periodic sync registration failed:",a)),"PushManager"in window&&Notification.permission==="default"&&Notification.requestPermission(),"sync"in o&&o.sync.register("sync-requests").catch(a=>{console.error("Background sync registration failed:",a)})}).catch(o=>console.error("Service Worker registration failed:",o)),navigator.serviceWorker.addEventListener("message",o=>{o.data.type==="UPDATE_AVAILABLE"&&confirm("A new version is available. Reload to update?")&&window.location.reload()}));const e=document.getElementById("install"),t=document.getElementById("manual-install"),s=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);let n=null;const i=document.getElementById("leaderboardNavbarLink");if(s?t.hidden=!1:t.hidden=!0,window.addEventListener("beforeinstallprompt",o=>{o.preventDefault(),n=o,e.hidden=!1,e.addEventListener("click",()=>{n&&(n.prompt(),n.userChoice.then(()=>{n=null,e.hidden=!0}))})}),window.beforeinstallprompt||(e.hidden=!0,s||(t.hidden=!0)),window.addEventListener("appinstalled",()=>{e.hidden=!0,t.hidden=!0}),navigator.getInstalledRelatedApps&&navigator.getInstalledRelatedApps().then(o=>{o.length&&(e.hidden=!0)}),window.handleGameSelection=function(o){const a=o.value;a==="join_custom_game"?typeof window.openModal=="function"?window.openModal("joinCustomGameModal"):window.location.href="/?show_join_custom=1":window.location.href=a},i&&i.addEventListener("click",o=>{o.preventDefault();const a=i.getAttribute("data-game-id")||0;typeof window.showLeaderboardModal=="function"?window.showLeaderboardModal(a):console.error("showLeaderboardModal not defined")}),"windowControlsOverlay"in navigator){let o=function(){const a=navigator.windowControlsOverlay.getTitlebarAreaRect();document.body.style.paddingTop=a.height+"px"};var r=o;navigator.windowControlsOverlay.addEventListener("geometrychange",o),o()}document.querySelectorAll(".modal").forEach(o=>{o.parentNode!==document.body&&document.body.appendChild(o)})}function F(){const e=document.querySelector('meta[name="csrf-token"]');return e?e.getAttribute("content"):""}async function O(e,t={}){const s={credentials:"same-origin",...t},n=await fetch(e,s),i=await n.json().catch(()=>({}));return{status:n.status,json:i}}function N(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}window.getCSRFToken=F;window.fetchJson=O;window.escapeHTML=N;var U=initQuill("#description-editor"),H=initQuill("#tips-editor");document.getElementById("quest-form").onsubmit=function(e){var t=U.root.innerHTML.trim(),s=H.root.innerHTML.trim();if(!t||t==="<p><br></p>")return alert("Description is required."),e.preventDefault(),!1;document.getElementById("description").value=t,document.getElementById("tips").value=s};var x=window.PLACEHOLDER_IMAGE||document.querySelector('meta[name="placeholder-image"]').getAttribute("content");window.PLACEHOLDER_IMAGE=x;let L=0,D=null,M=!1,_=!1;function j(e){L=0,D=e;const t=document.getElementById("allSubmissionsContainer");t&&(t.innerHTML=""),openModal("allSubmissionsModal"),T()}function T(){const e=L*10;fetch(`/quests/quest/all_submissions?game_id=${D}&offset=${e}&limit=10`).then(t=>t.json()).then(t=>{if(t.error)throw new Error(t.error);M=t.is_admin,_=t.has_more,G(t.submissions,M,L>0),W(_),L+=1}).catch(t=>{console.error("Error fetching all submissions:",t),alert("Error fetching all submissions: "+t.message)})}function G(e,t,s=!1){const n=document.getElementById("allSubmissionsContainer");if(!n){console.error("allSubmissionsContainer element not found.");return}s||(n.innerHTML=""),e.forEach(i=>{const r=document.createElement("div");r.className="submission-card";const o=document.createElement("img");o.src=i.image_url||x,o.alt="Quest Submission",o.className="submission-image";const a=document.createElement("div");a.className="submission-info";const l=document.createElement("p");l.textContent=`User: ${i.user_display_name||i.user_username}`,l.className="submission-user-details";const d=document.createElement("p"),p=new Date(i.timestamp).toLocaleString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0});d.textContent=`Submitted on: ${p}`,d.className="submission-timestamp";const u=document.createElement("p");u.textContent=`Comment: ${i.comment}`,u.className="submission-comment";const f=document.createElement("p");f.textContent=`Twitter: ${i.twitter_url||"N/A"}`,f.className="submission-comment";const c=document.createElement("p");c.textContent=`Facebook: ${i.fb_url||"N/A"}`,c.className="submission-comment";const g=document.createElement("p");if(g.textContent=`Instagram: ${i.instagram_url||"N/A"}`,g.className="submission-comment",a.appendChild(l),a.appendChild(d),a.appendChild(u),a.appendChild(f),a.appendChild(c),a.appendChild(g),t){const m=document.createElement("button");m.textContent="Delete",m.className="button delete-button",m.addEventListener("click",function(E){E.stopPropagation(),Q(i.id)}),r.appendChild(m)}r.appendChild(o),r.appendChild(a),r.addEventListener("click",function(){showSubmissionDetail({url:i.image_url||i.video_url,video_url:i.video_url,comment:i.comment,user_id:i.user_id,user_display_name:i.user_display_name||i.user_username,user_profile_picture:i.user_profile_picture,twitter_url:i.twitter_url,fb_url:i.fb_url,instagram_url:i.instagram_url,verification_type:"image"}),openModal("submissionDetailModal")}),n.appendChild(r)})}function Q(e){fetch(`/quests/quest/delete_submission/${e}`,{method:"DELETE",headers:{"X-CSRF-Token":getCSRFToken()}}).then(t=>t.json()).then(t=>{if(t.success)alert("Submission deleted successfully.");else throw new Error(t.message)}).catch(t=>{console.error("Error deleting submission:",t),alert("Error during deletion: "+t.message)})}function W(e){const t=document.getElementById("loadMoreSubmissions");t&&(t.style.display=e?"block":"none")}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("loadMoreSubmissions");e&&e.addEventListener("click",()=>{T()})});window.showAllSubmissionsModal=j;document.addEventListener("DOMContentLoaded",function(){J()});function J(){fetch("/badges").then(e=>e.json()).then(e=>{const t=document.getElementById("badgesBody");t.innerHTML="",e.badges.forEach(s=>{const n=document.createElement("tr");n.setAttribute("data-badge-id",s.id);const i=s.image?`<img src="${s.image}" height="50" alt="Badge Image">`:"No Image";n.innerHTML=`
                    <td class="badge-image-manage">${i}</td>
                    <td class="badge-name">${s.name}</td>
                    <td class="badge-description">${s.description}</td>
                    <td class="badge-category">${s.category||"None"}</td>
                    <td>
                        <button class="edit-badge" onclick="editBadge(${s.id})">Edit</button>
                        <button onclick="deleteBadge(${s.id})">Delete</button>
                    </td>
                `,t.appendChild(n)})}).catch(e=>console.error("Failed to load badges:",e))}window.allBadges=window.allBadges||[];var X=window.PLACEHOLDER_IMAGE||document.querySelector('meta[name="placeholder-image"]').getAttribute("content");window.PLACEHOLDER_IMAGE=X;async function V(){const e=document.getElementById("game_IdHolder"),t=e?e.getAttribute("data-game-id"):null,n=`/badges${t&&!isNaN(parseInt(t,10))&&t!=="0"?`?game_id=${t}`:""}`,i=await fetch(n,{credentials:"same-origin"});if(!i.ok)throw new Error("Error fetching badges");const r=await i.json();return window.allBadges=r.badges,window.allBadges}async function z(){if(!window.allBadges||window.allBadges.length===0)try{await V()}catch(e){console.error("Error loading badges:",e),window.allBadges=[]}}document.addEventListener("DOMContentLoaded",()=>{z()});document.addEventListener("DOMContentLoaded",function(){["description","description2","details","awards","beyond"].forEach(t=>{initQuill(`#${t}`,`#${t}-textarea`)})});let B;document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("deleteGameConfirmInput"),t=document.getElementById("deleteGameConfirmBtn"),s=document.getElementById("deleteGameCountdown"),n=document.getElementById("deleteGameTimer"),i=document.getElementById("deleteGameUndo"),r=document.getElementById("deleteGameForm");e.addEventListener("input",()=>{t.disabled=e.value.trim().toLowerCase()!=="delete"}),t.addEventListener("click",()=>{let o=5;s.hidden=!1,n.textContent=o.toString(),B=setInterval(()=>{o-=1,n.textContent=o.toString(),o<=0&&(clearInterval(B),r.submit())},1e3)}),i.addEventListener("click",()=>{clearInterval(B),s.hidden=!0,n.textContent="5",e.value="",t.disabled=!0})});document.addEventListener("DOMContentLoaded",function(){initQuill("#description","#description-textarea")});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("flash-data");if(!e)return;const t=JSON.parse(e.getAttribute("data-messages")||"[]");if(!t.length)return;const[s,n]=t[0],i=document.getElementById("flash-overlay");i.querySelector(".flash-content").textContent=n,i.querySelector(".flash-modal").classList.add(`flash-${s}`),requestAnimationFrame(()=>{i.classList.add("visible")});function r(){i.classList.remove("visible"),e.removeAttribute("data-messages")}i.querySelector(".flash-close").addEventListener("click",r),i.querySelector(".flash-ok-btn").addEventListener("click",r)});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("forgotForm"),t=document.getElementById("forgotEmailError"),s=document.getElementById("forgotSuccess"),n=document.getElementById("forgotButton"),i=document.getElementById("forgotEmail"),r=document.getElementById("forgotEmailDisplay"),o=document.getElementById("forgotPasswordModal");new MutationObserver(()=>{o.style.display==="block"&&(r.textContent=i.value)}).observe(o,{attributes:!0,attributeFilter:["style"]}),e.addEventListener("submit",l=>{l.preventDefault(),t.style.display="none",s.style.display="none",submitFormJson(e).then(({json:d})=>{d.success?(s.textContent=d.message,s.style.display="block",n.disabled=!0):(t.textContent=d.error||"An error occurred.",t.style.display="block")}).catch(()=>{e.submit()})})});function Y(e){const t="/games/game-info/"+e+"?modal=1";fetchAndShowModal(t,"gameInfoModal")}window.showGameInfoModal=Y;$(document).ready(function(){$("#generateAIQuestModal").modal({show:!1})});document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll("button[data-game-id]").forEach(s=>{s.addEventListener("click",function(){t(this)})});function t(s){const n=document.getElementById("questCreationForm"),i=s.getAttribute("data-game-id");n?n.addEventListener("submit",function(r){r.preventDefault();const o=document.getElementById("questDescription").value,a=document.querySelector("[name=csrf_token]").value;fetch("/ai/generate_quest",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":a},body:JSON.stringify({description:o,game_id:i})}).then(l=>l.ok?l.json():l.json().then(d=>Promise.reject({status:l.status,statusText:l.statusText,errorMessage:d.error}))).then(l=>{if(l.generated_quest_html){document.getElementById("generatedQuestContent").innerHTML=l.generated_quest_html,$("#generateAIQuestModal").modal("show");const d=document.getElementById("generateAIQuestModalForm");d&&d.setAttribute("data-game-id",i),d&&d.addEventListener("submit",function(g){g.preventDefault();const m=new FormData(d),E=document.querySelector("[name=csrf_token]").value;fetch("/ai/create_quest",{method:"POST",headers:{"X-CSRFToken":E},body:m}).then(y=>y.json()).then(y=>{window.location.href="/",console.log(y)}).catch(y=>{console.error("Error:",y)})});const p=document.getElementById("generateAIImage"),u=document.getElementById("badge_description"),f=document.getElementById("aiBadgeImage"),c=document.getElementById("aiBadgeFilename");if(!p||!u||!f||!c){console.error("One or more elements not found in the DOM");return}p.addEventListener("click",function(){console.log("Generate AI Image button clicked");const g=u.value;if(console.log("Badge Description:",g),!g){alert("Please enter a badge description first.");return}fetch("/ai/generate_badge_image",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":document.querySelector("[name=csrf_token]").value},body:JSON.stringify({badge_description:g})}).then(m=>m.json()).then(m=>{if(console.log("Response data:",m),m.error)alert("Error generating badge image: "+m.error);else{const E=`${m.filename}`,y=`static/images/badge_images/${m.filename}`;f.src=y,f.style.display="block",c.value=E}}).catch(m=>{console.error("Fetch error:",m),alert("Error: "+m)})})}}).catch(l=>{alert("Error generating quest: "+(l.errorMessage||l.statusText))})}):console.error("Form '#questCreationForm' not found.")}});const K=async()=>{try{const t=await(await fetch("/refresh-csrf")).json();document.querySelector('meta[name="csrf-token"]').setAttribute("content",t.csrf_token)}catch(e){console.error("Error refreshing CSRF token:",e)}};setInterval(K,9e5);const Z=async e=>{try{const s=await(await fetch(`/games/get_game_points/${e}`,{credentials:"same-origin"})).json(),n=s.total_game_points,i=s.game_goal,r=i-n,o=Math.min(n/i*100,100);document.getElementById("meterBar").style.height=`${o}%`,document.documentElement.style.setProperty("--meter-fill-height",`${o}%`),document.querySelector(".meter-label").innerText=`Remaining Reduction: ${r} / ${i}`}catch(t){console.error("Failed to update meter:",t)}};function ee(){const e=document.getElementById("game_IdHolder"),t=document.getElementById("gameNameHeader");if(!e||!t)return;const s=e.getAttribute("data-game-id");fetch(`/games/get_game/${s}`,{credentials:"same-origin"}).then(n=>{if(!n.ok)throw console.error(`Failed fetching game name; URL returned status ${n.status} (${n.statusText})`),t.textContent="Error Loading Game",new Error(`HTTP ${n.status}: ${n.statusText}`);return n.json()}).then(n=>{t.textContent=n.name||"Game Not Found"}).catch(n=>{console.error("Error retrieving game name:",n),t.textContent="Error Loading Game"})}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("leaderboardButton");e&&e.addEventListener("click",()=>{const a=e.getAttribute("data-game-id");showLeaderboardModal(a),Z(a)});const t=document.getElementById("submissionsButton");t&&t.addEventListener("click",()=>{currentUserId!=="none"&&showMySubmissionsModal(currentUserId)});const s=document.getElementById("contactForm");s&&s.addEventListener("submit",async a=>{a.preventDefault();const l=new FormData(s);showLoadingModal();try{const d=await fetch(s.action,{method:"POST",body:l,headers:{"X-Requested-With":"XMLHttpRequest"}}),p=await d.json();d.ok&&p.success?(alert("Your message has been sent successfully."),closeModal("contactModal")):alert("Failed to send your message. Please try again.")}catch{alert("Failed to send your message. Please try again.")}finally{hideLoadingModal()}}),document.getElementById("quill-editor")&&(initQuill("#quill-editor","#message-input",{placeholder:"Write a message...",modules:{toolbar:[[{header:[1,2,!1]}],["bold","italic","underline"],["link"],[{list:"ordered"},{list:"bullet"}],["clean"]]}}),document.querySelector("form").onsubmit=()=>!0),document.querySelectorAll(".activity-message").forEach(a=>{a.innerHTML=a.innerHTML.replace(/<\/?p[^>]*>/g,"")});const i=document.getElementById("questSearchInput"),r=document.getElementById("questCategoryDropdown");i&&i.addEventListener("input",S),r&&r.addEventListener("change",S);const o=document.querySelector("#whats-happening-step");if(o){const a=o.querySelectorAll(".wh-tab-button"),l=o.querySelectorAll(".wh-tab-content");a.forEach(d=>{d.addEventListener("click",()=>{const p=d.getAttribute("data-wh-tab");a.forEach(u=>u.classList.remove("active")),l.forEach(u=>u.classList.remove("active")),d.classList.add("active"),o.querySelector(`#wh-${p}-tab`).classList.add("active")})})}ee()});function S(){const e=document.getElementById("questSearchInput").value.trim().toLowerCase(),t=document.getElementById("questCategoryDropdown").value;document.querySelectorAll("#questTableBody tr.quest-row").forEach(n=>{const i=n.querySelector(".quest-title").textContent.toLowerCase(),r=n.dataset.category||"Not Set",o=i.includes(e),a=t==="all"||r===t;n.style.display=o&&a?"":"none"})}document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll("#customGameList .list-group-item").forEach(function(i){i.addEventListener("click",function(){const r=this.getAttribute("data-game-code");confirm("Do you want to join ‘"+this.textContent.trim()+"’?")&&(document.getElementById("customGameCodeInput").value=r,document.getElementById("joinCustomGameForm").submit())})});const e=document.getElementById("joinCustomGameModal"),t=e.dataset.hasJoined==="1",s=e.dataset.joinDemoUrl;let n=!1;document.getElementById("joinCustomGameForm").addEventListener("submit",()=>{n=!0}),e.addEventListener("hidden.bs.modal",function(){!n&&!t&&(window.location.href=s)})});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("loginForm"),t=document.getElementById("passwordError"),s=document.getElementById("forgotContainer"),n=document.getElementById("loginModal").dataset.checkUrl;e.addEventListener("submit",l=>{l.preventDefault(),t.style.display="none",s.innerHTML="",submitFormJson(e).then(({json:d})=>{if(d.success)window.location.href=d.redirect;else if(t.textContent=d.error,t.style.display="block",d.show_forgot){const p=document.createElement("a");p.href="javascript:void(0)",p.textContent="Forgot password?",p.className="d-block mt-1",p.onclick=openForgotPasswordModal,s.appendChild(p)}}).catch(()=>e.submit())});const i=document.getElementById("loginEmail"),r=document.getElementById("loginButton"),o=document.getElementById("emailError");function a(){r.disabled=!0,o.style.display="none",o.textContent=""}a(),i.addEventListener("blur",()=>{const l=i.value.trim();if(!l)return a();fetch(`${n}?email=${encodeURIComponent(l)}`).then(d=>d.json()).then(d=>{d.exists?r.disabled=!1:(r.disabled=!0,o.textContent="This email is not registered. Please register first.",o.style.display="block")}).catch(()=>r.disabled=!1)}),i.addEventListener("input",a)});const te=document.getElementById("game_Data").dataset.gameId;let ne=[];document.addEventListener("DOMContentLoaded",async function(){await oe(),se(te)});async function oe(){try{const e=await fetch("/badges");if(!e.ok)throw new Error("Failed to fetch badges");ne=(await e.json()).badges||[]}catch(e){console.error("Error fetching badges:",e)}}function se(e){fetch(`/quests/game/${e}/quests`,{method:"GET",headers:{"Content-Type":"application/json"}}).then(t=>{if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);return t.json()}).then(t=>{const s=document.getElementById("questsBody");s.innerHTML="",t.quests.forEach(n=>{const i=document.createElement("div");i.className="card",i.id=`quest-${n.id}`;const r=n.verification_type.toLowerCase(),o=n.badge_name||"None",a=n.frequency||"Not Set",l=n.category||"Not Set",d=n.badge_awarded||"Not Set";i.innerHTML=`
                    <div class="card-body">
                        <h5 class="card-title editable" data-name="title">${n.title}</h5>
                        <div class="card-text editable quill-editor-container" data-name="description">${n.description}</div>
                        <div class="card-text editable quill-editor-container" data-name="tips">${n.tips||""}</div>
                        <p class="card-text"><strong>Points:</strong> <span class="editable" data-name="points">${n.points}</span></p>
                        <p class="card-text"><strong>Completion Limit:</strong> <span class="editable" data-name="completion_limit">${n.completion_limit}</span></p>
                        <p class="card-text"><strong>Enabled:</strong> <span class="editable" data-name="enabled">${n.enabled?"Yes":"No"}</span></p>
                        <p class="card-text"><strong>Pinned:</strong> <span class="editable" data-name="is_sponsored">${n.is_sponsored?"Yes":"No"}</span></p>
                        <p class="card-text"><strong>Verification:</strong> <span class="editable" data-name="verification_type" data-value="${n.verification_type}">${r}</span></p>
                        <p class="card-text"><strong>Badge:</strong> <span class="editable" data-name="badge_name">${o}</span></p>
                        <p class="card-text"><strong>Badge Awarded:</strong> <span class="editable" data-name="badge_awarded">${d}</span></p>
                        <p class="card-text"><strong>Frequency:</strong> <span class="editable" data-name="frequency" data-value="${n.frequency}">${a}</span></p>
                        <p class="card-text"><strong>Category:</strong> <span class="editable" data-name="category">${l}</span></p>
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-warning edit-button" onclick="editQuest(${n.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteQuest(${n.id})">Delete</button>
                            <button class="btn btn-info" onclick="window.location.href = '/quests/generate_qr/${n.id}'">Generate QR Code</button>
                        </div>
                    </div>
                `,s.appendChild(i)})}).catch(t=>console.error("Failed to load quests:",t))}document.addEventListener("DOMContentLoaded",function(){const e=initQuill("#description","#description-textarea"),t=document.getElementById("description-textarea");e&&t&&(e.root.innerHTML=t.value)});let k=3e3;function I(e){var n;const t=document.getElementById(e);if(!t){console.error(`Modal ${e} not found`);return}document.body.appendChild(t),(n=document.querySelector(".container"))==null||n.classList.add("modal-open"),t.classList.add("active"),t.style.display="flex",k+=10,t.style.zIndex=k;const s=t.querySelector(".modal-backdrop");s&&(s.style.display="block",s.style.zIndex=k-1),document.body.classList.add("body-no-scroll")}function q({gameId:e,questId:t=""}){const s=document.getElementById("loginForm"),n=document.getElementById("loginGameId"),i=document.getElementById("loginQuestId"),r=document.getElementById("loginNext"),o=document.getElementById("loginShowJoinCustom"),a=`/?game_id=${encodeURIComponent(e)}&show_join_custom=0`;n.value=e,i.value=t,o.value="0",r.value=a;const l=s.getAttribute("action").split("?")[0],d=new URLSearchParams({game_id:e,quest_id:t,show_join_custom:0,next:a});s.setAttribute("action",`${l}?${d.toString()}`),I("loginModal")}function ie(e){const t=document.getElementById("resetForm"),s=document.getElementById("resetToken"),n=t.dataset.baseAction;t.setAttribute("action",n+encodeURIComponent(e)),s.value=e,document.getElementById("resetError").style.display="none",document.getElementById("resetSuccess").style.display="none",document.getElementById("resetButton").disabled=!1,I("resetPasswordModal")}document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(window.location.search);if(e.get("show_reset")==="1"){const t=e.get("token");t?(ie(t),history.replaceState(null,"",window.location.pathname)):console.warn("show_reset=1 present but no token in URL")}});document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(window.location.search),t=e.get("show_join_custom")==="1",s=e.has("game_id");t&&!s&&I("joinCustomGameModal")});document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(window.location.search);if(!(e.get("show_login")==="1"))return;let s=e.get("game_id")||"";if(!s){const n=e.get("next");if(n)try{const r=new URL(n,window.location.origin).pathname.replace(/^\/+/,"");/^\d+$/.test(r)&&(s=r)}catch(i){console.warn("Failed to parse next URL for gameId:",i)}}q({gameId:s,questId:""})});document.addEventListener("DOMContentLoaded",()=>{if(!window.location.pathname.startsWith("/auth/login"))return;const e=new URLSearchParams(window.location.search),t=e.get("next");if(!t)return;let s=e.get("game_id")||"";if(!s)try{const i=new URL(t,window.location.origin).pathname.replace(/^\/+/,"");/^\d+$/.test(i)&&(s=i)}catch(n){console.warn("Could not parse next URL for gameId:",n)}s&&q({gameId:s,questId:""})});async function ae(e,t){try{const s=await fetch(e,{credentials:"same-origin"});if(!s.ok)throw new Error(`HTTP ${s.status}`);const n=await s.text(),i=document.getElementById(t);i&&i.parentNode.removeChild(i);const r=document.createElement("div");r.innerHTML=n.trim();const o=r.firstElementChild;(!o||o.id!==t)&&console.warn(`Expected first element to be #${t}`,o),document.body.appendChild(o),I(t)}catch(s){console.error(`Error loading ${t} from ${e}:`,s),alert("Failed to load data. Please try again later.")}}document.addEventListener("click",e=>{const t=e.target.closest("[data-modal-url]");if(!t)return;e.preventDefault();const s=t.getAttribute("data-modal-url"),n=t.getAttribute("data-modal-id");if(!s||!n){console.error("data-modal-url or data-modal-id missing",t);return}ae(s,n)});document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".modal").forEach(e=>{e.parentNode!==document.body&&document.body.appendChild(e)})});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("notifMenu");if(!e)return;const t=document.getElementById("notifBellToggle"),s=e.querySelector("#notifLoading"),n=e.querySelector("li.dropdown-footer"),i=n.querySelector("#loadMoreBtn"),r=e.dataset.url;let o=0,a=1;const l=parseInt(e.dataset.perPage,10)||10,d={follow:({from_user_name:c,from_user_id:g})=>({text:`Now following ${c}`,onclick:`showUserProfileModal(${g}); return false;`}),followed_by:({follower_name:c,follower_id:g})=>({text:`${c} is now following you`,onclick:`showUserProfileModal(${g}); return false;`}),submission:({actor_name:c,quest_name:g,submission_id:m})=>({text:`${c} submitted a new “${g}” quest`,onclick:`fetch('/quests/submissions/${m}').then(r => r.json()).then(img => showSubmissionDetail(img)); return false;`}),profile_message:({from_user_name:c,content:g,profile_user_id:m})=>({text:`${c} says “${g}”`,onclick:`showUserProfileModal(${m}); return false;`}),profile_reply:({from_user_name:c,content:g,profile_user_id:m})=>({text:`${c} replied “${g}”`,onclick:`showUserProfileModal(${m}); return false;`}),submission_like:({liker_name:c,submission_id:g})=>({text:`${c} liked your submission`,onclick:`fetch('/quests/submissions/${g}', { credentials: 'same-origin' }).then(r => r.json()).then(img => showSubmissionDetail(img)); return false;`}),submission_reply:({actor_name:c,content:g,submission_id:m})=>({text:`${c} replied “${g}”`,onclick:`fetch('/quests/submissions/${m}', { credentials: 'same-origin' }).then(r => r.json()).then(img => showSubmissionDetail(img)); return false;`})};function p(c){const g=d[c.type];let m,E;if(g&&c.payload)try{({text:m,onclick:E}=g(c.payload))}catch(h){console.error(`Error in handler for ${c.type}:`,h)}return(!m||!E)&&(m=c.payload.summary||JSON.stringify(c.payload),E="location.href='/notifications/';"),`
      <a href="#" class="dropdown-item ${c.is_read?"":"fw-bold"}" onclick="${E}">
        ${m}
        <small class="text-muted d-block text-center">
          ${new Date(c.when).toLocaleString()}
        </small>
      </a>
    `}function u(c){c&&c.parentNode===e&&e.removeChild(c)}async function f(c){c===1&&(Array.from(e.children).forEach(y=>{y!==s&&y!==n&&e.removeChild(y)}),o=0),u(s),u(n),e.appendChild(s),e.appendChild(n),s.style.display="",i.disabled=!0;let g;try{g=await fetch(`${r}?page=${c}&per_page=${l}`,{credentials:"include"})}catch(y){s.textContent="Network error.",console.error(y);return}if(!g.ok){s.textContent="Error loading.",console.error("Status:",g.status,g.statusText);return}const m=await g.json();o=m.page,a=m.total_pages,u(s),u(n);const E=t.querySelector(".badge");E&&E.remove(),m.items.forEach(y=>{e.insertAdjacentHTML("beforeend",p(y))}),e.appendChild(s),e.appendChild(n),s.style.display="none",i.disabled=o>=a}t.addEventListener("show.bs.dropdown",()=>{o===0&&f(1)}),i.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),o<a&&f(o+1)})});document.addEventListener("DOMContentLoaded",()=>{!("serviceWorker"in navigator)||!("PushManager"in window)||navigator.serviceWorker.ready.then(async e=>{try{const t=await fetch("/push/public_key"),{public_key:s}=await t.json();if(!s||await e.pushManager.getSubscription())return;const i=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:re(s)});await fetch("/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscription:i})})}catch(t){console.error("Push setup failed",t)}})});function re(e){const t="=".repeat((4-e.length%4)%4),s=(e+t).replace(/-/g,"+").replace(/_/g,"/"),n=atob(s),i=new Uint8Array(n.length);for(let r=0;r<n.length;++r)i[r]=n.charCodeAt(r);return i}function A(e){const t=document.querySelector(`meta[name="${e}"]`);return t?t.content:""}Number(A("current-user-id")||0);getCSRFToken();var de=window.PLACEHOLDER_IMAGE||A("placeholder-image");window.PLACEHOLDER_IMAGE=de;window.QUILL_OPTIONS={theme:"snow",modules:{toolbar:[[{font:[]},{size:[]}],["bold","italic","underline","strike"],[{color:[]},{background:[]}],[{script:"sub"},{script:"super"}],[{header:1},{header:2},{header:3},{header:4},{header:5},{header:6},"blockquote","code-block"],[{list:"ordered"},{list:"bullet"},{indent:"-1"},{indent:"+1"}],[{direction:"rtl"},{align:[]}],["link","image","video","formula"],["clean"]]}};window.initQuill=function(e,t,s={}){const n=typeof e=="string"?document.querySelector(e):e;if(!n)return console.error("initQuill: element not found for",e),null;const i=Object.assign({},window.QUILL_OPTIONS,s),r=new Quill(n,i);if(t){const o=typeof t=="string"?document.querySelector(t):t;o&&(o.value&&(r.root.innerHTML=o.value),r.on("text-change",()=>{o.value=r.root.innerHTML}))}return r};document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("registerEmail");e.closest("form");const t=e.closest(".form-group"),s="{{ url_for('auth.check_email') }}",n=document.createElement("div");n.id="existingUserLogin",n.style.display="none",n.innerHTML=`  
    <div class="alert alert-info">This email is already registered. Enter your password to log in.</div>  
    <div class="form-group">  
      <label for="existingUserPassword">Password</label>  
      <input type="password" id="existingUserPassword" class="form-control" autocomplete="current-password">
      <div id="loginError" class="text-danger mt-1" style="display: none;"></div>  
    </div>  
    <div class="form-group">  
      <button type="button" id="loginWithExistingBtn" class="btn btn-primary">Login</button>  
    </div>  
  `,t.insertAdjacentElement("afterend",n),e.addEventListener("blur",()=>{const i=e.value.trim();i&&fetch(`${s}?email=${encodeURIComponent(i)}`).then(r=>r.json()).then(r=>{r.exists?n.style.display="block":n.style.display="none"}).catch(r=>{console.error("Error checking email:",r),n.style.display="none"})}),document.getElementById("loginWithExistingBtn").addEventListener("click",()=>{const i=e.value.trim(),r=document.getElementById("existingUserPassword").value,o=document.getElementById("loginError"),a=document.getElementById("gameIdField").value,l=document.getElementById("questIdField").value,d=document.getElementById("nextField").value,p=new FormData;p.append("email",i),p.append("password",r),p.append("remember_me","true"),a&&p.append("game_id",a),l&&p.append("quest_id",l),d&&p.append("next",d),fetch('{{ url_for("auth.login") }}',{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:p,credentials:"same-origin"}).then(u=>u.json().then(f=>({status:u.status,payload:f}))).then(({status:u,payload:f})=>{f.success?window.location.href=f.redirect:(o.textContent=f.error,o.style.display="block")}).catch(u=>{console.error("Login error:",u),o.textContent="An error occurred. Please try again.",o.style.display="block"})}),e.addEventListener("input",()=>{n.style.display="none",document.getElementById("loginError").style.display="none"})});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("resetForm"),t=document.getElementById("resetError"),s=document.getElementById("resetSuccess"),n=document.getElementById("resetButton");e.addEventListener("submit",i=>{i.preventDefault(),t.style.display="none",s.style.display="none",submitFormJson(e).then(({json:r})=>{r.success?(s.textContent=r.message,s.style.display="block",n.disabled=!0,r.redirect&&setTimeout(()=>{window.location.href=r.redirect},1200)):(t.textContent=r.error||"Unable to reset password.",t.style.display="block")}).catch(r=>{console.error("Reset-password AJAX error:",r),e.submit()})})});document.addEventListener("DOMContentLoaded",()=>{const e="shoutBoardModal",t=document.getElementById("shoutBoardForm"),s=document.getElementById("shoutSubmitBtn");let n=null;window.Quill?n=initQuill("#shoutQuillEditor","#shoutMessageInput",{placeholder:"Write an announcement…"}):console.error("Quill library not found  shoutboard editor will not work."),window.addEventListener("openModal",i=>{i.detail===e&&n&&n.setText("")}),s.addEventListener("click",()=>{if(!n){alert("Editor not ready  please refresh.");return}const i=n.root.innerHTML.trim();if(i===""||i==="<p><br></p>"){alert("Please enter a message.");return}document.getElementById("shoutMessageInput").value=i;const r=new FormData(t);fetch(t.action,{method:"POST",body:r,credentials:"same-origin"}).then(o=>{if(!o.ok)throw new Error(`Server responded ${o.status}`);return o.text()}).then(()=>{closeModal(e),location.reload()}).catch(o=>{console.error("Failed to post shout:",o),alert("Could not post. Please try again.")})})});document.addEventListener("DOMContentLoaded",()=>{const e=o=>document.querySelector(o),t=()=>getCSRFToken(),s=document.querySelector('meta[name="placeholder-image"]').getAttribute("content");window.showSubmissionDetail=function(o){const a=e("#submissionDetailModal");a.dataset.submissionId=o.id,a.dataset.questId=o.quest_id||"";const l=Number(a.dataset.currentUserId),d=Number(o.user_id)===l,p=a.dataset.isAdmin==="True"||a.dataset.isAdmin==="true",u=e("#editPhotoBtn"),f=e("#photoEditControls"),c=e("#submissionPhotoInput"),g=e("#savePhotoBtn"),m=e("#cancelPhotoBtn"),E=e("#deleteSubmissionBtn");u.hidden=!d,E.hidden=!(d||p),f.hidden=!0,u.addEventListener("click",()=>{f.hidden=!1,u.hidden=!0}),m.addEventListener("click",()=>{c.value="",f.hidden=!0,u.hidden=!1}),E.addEventListener("click",()=>{if(!confirm("Are you sure you want to delete this submission?"))return;const w=a.dataset.submissionId;fetch(`/quests/quest/delete_submission/${w}`,{method:"DELETE",headers:{"X-CSRF-Token":t()}}).then(b=>b.json()).then(b=>{if(!b.success)throw new Error(b.message||"Delete failed");closeModal("submissionDetailModal"),resetModalContent(),a.dataset.questId&&refreshQuestDetailModal(a.dataset.questId),alert("Submission deleted successfully.")}).catch(b=>alert("Error deleting submission: "+b.message))}),g.addEventListener("click",()=>{const w=a.dataset.submissionId,b=c.files[0];if(!b)return alert("Please select an image first.");if(b.type.startsWith("video/")&&b.size>10*1024*1024){alert("Video must be 10 MB or smaller.");return}if(b.type.startsWith("image/")&&b.size>8*1024*1024){alert("Image must be 8 MB or smaller.");return}const C=new FormData;b.type.startsWith("video/")?C.append("video",b):C.append("photo",b),fetch(`/quests/submission/${w}/photo`,{method:"PUT",credentials:"same-origin",headers:{"X-CSRFToken":t()},body:C}).then(v=>v.json()).then(v=>{if(!v.success)throw new Error(v.message||"Upload failed");v.video_url?(e("#submissionImage").hidden=!0,e("#submissionVideo").hidden=!1,e("#submissionVideoSource").src=v.video_url,e("#submissionVideo").load()):(e("#submissionVideo").hidden=!0,e("#submissionImage").hidden=!1,e("#submissionImage").src=v.image_url),m.click()}).catch(v=>alert(v.message))}),e("#submissionReplyEdit").hidden=d,e("#postReplyBtn").hidden=d,e("#ownerNotice").hidden=!d;const y=e("#submissionRepliesContainer");d?y.hidden=!0:y.hidden=!1;const h={img:e("#submissionImage"),video:e("#submissionVideo"),videoSource:e("#submissionVideoSource"),imgOverlay:e("#submitterProfileImageOverlay"),commentRead:e("#submissionComment"),commentEdit:e("#submissionCommentEdit"),readBox:e("#commentReadButtons"),editBox:e("#commentEditButtons"),editBtn:e("#editCommentBtn"),profileImg:e("#submitterProfileImage"),profileImgOverlay:e("#submitterProfileImageOverlay"),profileCap:e("#submitterProfileCaption"),profileLink:e("#submitterProfileLink"),social:{tw:e("#twitterLink"),fb:e("#facebookLink"),ig:e("#instagramLink")}};h.profileImg.src=o.user_profile_picture||s,h.profileImgOverlay.src=h.profileImg.src,h.profileCap.textContent=o.user_display_name||o.user_username||"—",h.profileLink.onclick=w=>{w.preventDefault(),showUserProfileModal(o.user_id)},h.imgOverlay.parentElement.onclick=h.profileLink.onclick;const P=s;o.video_url?(h.img.hidden=!0,h.video.hidden=!1,h.videoSource.src=o.video_url,h.video.load()):(h.video.hidden=!0,h.img.hidden=!1,h.img.src=o.url||P),h.commentRead.textContent=o.comment||"No comment provided.",["tw","fb","ig"].forEach(w=>{const b=w==="tw"?"twitter_url":w==="fb"?"fb_url":"instagram_url";try{new URL(o[b]),h.social[w].href=o[b],h.social[w].style.display="inline-block"}catch{h.social[w].style.display="none"}}),d?(h.editBtn.hidden=!1,h.readBox.hidden=!1):h.editBtn.hidden=h.readBox.hidden=h.commentEdit.hidden=h.editBox.hidden=!0,i(),openModal("submissionDetailModal")},e("#editCommentBtn").addEventListener("click",()=>{e("#submissionCommentEdit").value=e("#submissionComment").textContent.trim(),n(!0)}),e("#saveCommentBtn").addEventListener("click",()=>{const o=e("#submissionDetailModal").dataset.submissionId;fetch(`/quests/submission/${o}/comment`,{method:"PUT",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":t()},body:JSON.stringify({comment:e("#submissionCommentEdit").value.trim()})}).then(a=>{if(!a.ok)throw new Error(a.status);return a.json()}).then(a=>{if(!a.success)throw new Error(a.message||"Save failed");e("#submissionComment").textContent=a.comment||"No comment provided.",n(!1)}).catch(a=>alert(`Could not save comment: ${a.message}`))}),e("#cancelCommentBtn").addEventListener("click",()=>n(!1));function n(o){e("#submissionComment").hidden=o,e("#commentReadButtons").hidden=o,e("#submissionCommentEdit").hidden=!o,e("#commentEditButtons").hidden=!o}function i(){const o=e("#submissionDetailModal").dataset.submissionId;o&&(fetch(`/quests/submissions/${o}`,{credentials:"same-origin"}).then(a=>a.json()).then(a=>{e("#submissionLikeCount").textContent=a.like_count||0,e("#submissionLikeBtn").classList.toggle("active",a.liked_by_current_user)}),fetch(`/quests/submission/${o}/replies`,{credentials:"same-origin"}).then(a=>a.json()).then(a=>{const l=e("#submissionRepliesList");l.innerHTML="",a.replies.forEach(f=>{const c=document.createElement("div");c.className="reply mb-1",c.innerHTML=`
            <a href="#" class="reply-user-link" data-user-id="${f.user_id}">
              <strong>${f.user_display}</strong>
            </a>: ${f.content}
          `,c.querySelector(".reply-user-link").addEventListener("click",m=>{m.preventDefault(),showUserProfileModal(f.user_id)}),l.appendChild(c)});const d=e("#submissionReplyEdit"),p=e("#postReplyBtn"),u=e("#replyLimitMessage");if(a.replies.length>=10){if(d.disabled=!0,p.disabled=!0,!u){const f=document.createElement("div");f.id="replyLimitMessage",f.className="text-muted mt-2",f.textContent="Maximum replies reached, sorry.",d.parentNode.insertBefore(f,d)}}else d.disabled=!1,p.disabled=!1,u&&u.remove()}))}e("#submissionLikeBtn").addEventListener("click",()=>{const o=e("#submissionLikeBtn"),a=e("#submissionDetailModal").dataset.submissionId,l=o.classList.contains("active");fetch(`/quests/submission/${a}/like`,{method:l?"DELETE":"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":t()}}).then(d=>{if(!d.ok)throw new Error(d.status);return d.json()}).then(d=>{if(!d.success)throw new Error("Like failed");e("#submissionLikeCount").textContent=d.like_count,o.classList.toggle("active",d.liked)}).catch(d=>alert(d.message))}),e("#postReplyBtn").addEventListener("click",()=>{const o=e("#submissionDetailModal").dataset.submissionId,a=e("#submissionReplyEdit");e("#postReplyBtn");const l=a.value.trim();!o||!l||fetch(`/quests/submission/${o}/replies`,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/json","X-CSRFToken":t()},body:JSON.stringify({content:l})}).then(d=>d.json().then(p=>({ok:d.ok,status:d.status,body:p}))).then(({ok:d,status:p,body:u})=>{if(!u.success){if(u.message==="Reply limit of 10 reached"){r();return}if(p===409&&u.message==="Duplicate reply")return alert("You have already posted that exact reply.");throw new Error(u.message||"Error")}const f=e("#submissionRepliesList"),c=document.createElement("div");c.className="reply mb-1",c.innerHTML=`<strong>${u.reply.user_display}</strong>: ${u.reply.content}`,f.insertBefore(c,f.firstChild),a.value="",f.children.length>=10&&r()}).catch(d=>alert(d.message))});function r(){const o=e("#submissionReplyEdit"),a=e("#postReplyBtn");if(o.disabled=!0,a.disabled=!0,!e("#replyLimitMessage")){const l=document.createElement("div");l.id="replyLimitMessage",l.className="text-muted mt-2",l.textContent="Maximum replies reached, sorry.",o.parentNode.insertBefore(l,o)}}});document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("submitPhotoForm");let t=!1;e.addEventListener("submit",function(n){if(n.preventDefault(),t)return;t=!0;const i=e.querySelector('input[name="photo"]'),r=i?i.files[0]:null;if(r&&r.type.startsWith("video/")&&r.size>10*1024*1024){s("Video must be 10 MB or smaller.","error"),t=!1;return}if(r&&r.type.startsWith("image/")&&r.size>8*1024*1024){s("Image must be 8 MB or smaller.","error"),t=!1;return}showLoadingModal();const o=new FormData(e),a=getCSRFToken();o.append("csrf_token",a),fetch(e.action,{method:"POST",body:o,credentials:"same-origin",headers:{"X-CSRF-Token":a}}).then(l=>l.ok?l.json():l.json().then(d=>{throw new Error(d.message)})).then(l=>{l.success?(s(l.message,"success"),window.location.href=l.redirect_url):s(l.message,"error")}).catch(l=>{console.error("Submission error:",l),s("Error during submission: "+l.message,"error")}).finally(()=>{t=!1,hideLoadingModal()})});function s(n,i){const r=document.getElementById("flash-messages");r?r.innerHTML=`
                <div class="flash-message ${i}">
                    ${n}
                </div>
            `:console.warn("Flash messages container not found.")}});document.getElementById("gameFilter").addEventListener("change",function(){var e=this.value;e?window.location.href="/admin/user_management/game/"+e:window.location.href="/admin/user_management"});document.querySelectorAll("[data-floating-ui-tooltip]").forEach(e=>{tippy(e,{content:e.getAttribute("data-floating-ui-tooltip"),placement:"top",animation:"scale-subtle"})});document.querySelectorAll(".needs-validation").forEach(e=>{e.addEventListener("submit",t=>{e.checkValidity()||(t.preventDefault(),t.stopPropagation()),e.classList.add("was-validated")},!1)});document.addEventListener("DOMContentLoaded",()=>{R()});
