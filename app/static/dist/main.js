const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["chunk-DIr4udqN.js","chunk-DwBZg9zj.js"])))=>i.map(i=>d[i]);
import{l as u,c as v,f as x,g as Ie,s as K,h as Z}from"./chunk-DwBZg9zj.js";const _e="modulepreload",Be=function(e){return"/static/dist/"+e},ee={},V=function(t,a,n){let o=Promise.resolve();if(a&&a.length>0){let r=function(l){return Promise.all(l.map(m=>Promise.resolve(m).then(y=>({status:"fulfilled",value:y}),y=>({status:"rejected",reason:y}))))};document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),d=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));o=r(a.map(l=>{if(l=Be(l),l in ee)return;ee[l]=!0;const m=l.endsWith(".css"),y=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${y}`))return;const g=document.createElement("link");if(g.rel=m?"stylesheet":_e,m||(g.as="script"),g.crossOrigin="",g.href=l,d&&g.setAttribute("nonce",d),document.head.appendChild(g),m)return new Promise((b,c)=>{g.addEventListener("load",b),g.addEventListener("error",()=>c(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(r){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=r,window.dispatchEvent(s),!s.defaultPrevented)throw r}return o.then(r=>{for(const s of r||[])s.status==="rejected"&&i(s.reason);return t().catch(i)})};let D=3e3,j=0;function B(e){var n;const t=document.getElementById(e);if(!t){u.error(`Modal ${e} not found`);return}document.body.appendChild(t),(n=document.querySelector(".container"))==null||n.classList.add("modal-open"),j=window.scrollY||window.pageYOffset,document.body.style.top=`-${j}px`,document.body.style.position="fixed",t.classList.add("active"),t.style.display="flex",D+=10,t.style.zIndex=D;const a=t.querySelector(".modal-backdrop");a&&(a.style.display="block",a.style.zIndex=D-1),document.body.classList.add("body-no-scroll")}function T(e){var n;const t=document.getElementById(e);if(!t)return;const a=t.querySelector(".modal-backdrop");t.style.display="none",a&&(a.style.display="none"),D=Math.max(1050,D-10),document.querySelector('.modal[style*="display: flex"]')||(document.body.classList.remove("body-no-scroll"),(n=document.querySelector(".container"))==null||n.classList.remove("modal-open"),document.body.style.position="",document.body.style.top="",window.scrollTo(0,j)),t.dispatchEvent(new CustomEvent("hidden.bs.modal",{bubbles:!0}))}function ce(){const e=document.getElementById("twitterLink");e&&(e.style.display="none",e.href="#");const t=document.getElementById("facebookLink");t&&(t.style.display="none",t.href="#");const a=document.getElementById("instagramLink");a&&(a.style.display="none",a.href="#");const n=document.getElementById("modalQuestActions");n&&(n.innerHTML=""),document.querySelectorAll('[id^="verifyButton-"]').forEach(o=>o.remove()),document.querySelectorAll('[id^="verifyQuestForm-"]').forEach(o=>o.remove()),document.body.classList.remove("body-no-scroll")}function me(e={}){const t=document.getElementById("registerForm"),a=t.getAttribute("action").split("?")[0],n=[];e.gameId&&n.push(`game_id=${encodeURIComponent(e.gameId)}`),e.questId&&n.push(`quest_id=${encodeURIComponent(e.questId)}`),e.next&&n.push(`next=${encodeURIComponent(e.next)}`),e.showJoinCustom!==void 0&&n.push(`show_join_custom=${encodeURIComponent(e.showJoinCustom)}`),t.setAttribute("action",a+(n.length?`?${n.join("&")}`:"")),e.gameId!==void 0&&(document.getElementById("registerGameId").value=e.gameId),e.questId!==void 0&&(document.getElementById("registerQuestId").value=e.questId),e.next!==void 0&&(document.getElementById("registerNext").value=e.next),e.showJoinCustom!==void 0&&(document.getElementById("registerShowJoinCustom").value=e.showJoinCustom),T("loginModal"),B("registerModal")}function J({gameId:e,questId:t="",nextPath:a=null}){const n=document.getElementById("loginForm"),o=document.getElementById("loginGameId"),i=document.getElementById("loginQuestId"),r=document.getElementById("loginNext"),s=document.getElementById("loginShowJoinCustom"),d=a??`/?game_id=${encodeURIComponent(e)}&show_join_custom=0`;o.value=e,i.value=t,s.value="0",r.value=d;const l=n.getAttribute("action").split("?")[0],m=new URLSearchParams({game_id:e,quest_id:t,show_join_custom:0,next:d});n.setAttribute("action",`${l}?${m.toString()}`),B("loginModal")}function Le(){const e=document.getElementById("loginGameId").value||"",t=document.getElementById("loginQuestId").value||"",a=document.getElementById("loginNext").value||"",n=document.getElementById("loginShowJoinCustom").value||"",o=(document.getElementById("loginCustomGameCode")||{}).value||"";document.getElementById("registerGameId").value=e,document.getElementById("registerQuestId").value=t,document.getElementById("registerNext").value=a,document.getElementById("registerShowJoinCustom").value=n,document.getElementById("registerCustomGameCode").value=o;const i=document.getElementById("registerForm"),r=i.getAttribute("action").split("?")[0],s=new URLSearchParams;e&&s.set("game_id",e),t&&s.set("quest_id",t),a&&s.set("next",a),n&&s.set("show_join_custom",n),o&&s.set("custom_game_code",o),i.setAttribute("action",`${r}?${s.toString()}`),T("loginModal"),B("registerModal")}function ke(){var i;const e=((i=document.getElementById("loginEmail"))==null?void 0:i.value)||"",t=document.getElementById("forgotEmail");t&&(t.value=e);const a=document.getElementById("forgotEmailError"),n=document.getElementById("forgotSuccess"),o=document.getElementById("forgotButton");a&&(a.style.display="none"),n&&(n.style.display="none"),o&&(o.disabled=!1),B("forgotPasswordModal")}function $e(e){const t=document.getElementById("resetForm"),a=document.getElementById("resetToken"),n=t.dataset.baseAction;t.setAttribute("action",n+encodeURIComponent(e)),a.value=e,document.getElementById("resetError").style.display="none",document.getElementById("resetSuccess").style.display="none",document.getElementById("resetButton").disabled=!1,B("resetPasswordModal")}document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(window.location.search);if(e.get("show_reset")==="1"){const t=e.get("token");t?($e(t),history.replaceState(null,"",window.location.pathname)):u.warn("show_reset=1 present but no token in URL")}});document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(window.location.search),t=e.get("show_join_custom")==="1",a=e.has("game_id");t&&!a&&B("joinCustomGameModal")});document.addEventListener("DOMContentLoaded",()=>{const t=new URLSearchParams(window.location.search).get("quest_shortcut");t&&(V(()=>Promise.resolve().then(()=>Ke),void 0).then(a=>a.openQuestDetailModal(t)),history.replaceState(null,"",window.location.pathname))});document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(window.location.search);if(!(e.get("show_login")==="1"))return;const a=e.get("next")||"";let n=e.get("game_id")||"";if(!n&&a)try{const i=new URL(a,window.location.origin).pathname.replace(/^\/+/,"");/^\d+$/.test(i)&&(n=i)}catch(o){u.warn("Failed to parse next URL for gameId:",o)}J({gameId:n,questId:"",nextPath:a})});document.addEventListener("DOMContentLoaded",()=>{if(!window.location.pathname.startsWith("/auth/login"))return;const e=new URLSearchParams(window.location.search),t=e.get("next");if(!t)return;let a=e.get("game_id")||"";if(!a)try{const o=new URL(t,window.location.origin).pathname.replace(/^\/+/,"");/^\d+$/.test(o)&&(a=o)}catch(n){u.warn("Could not parse next URL for gameId:",n)}a&&J({gameId:a,questId:"",nextPath:t})});async function xe(e,t){try{const a=await fetch(e,{credentials:"same-origin"});if(!a.ok)throw new Error(`HTTP ${a.status}`);const n=await a.text(),o=document.getElementById(t);o&&o.parentNode.removeChild(o);const i=document.createElement("div");i.innerHTML=n.trim();const r=i.firstElementChild;(!r||r.id!==t)&&u.warn(`Expected first element to be #${t}`,r),document.body.appendChild(r),B(t)}catch(a){u.error(`Error loading ${t} from ${e}:`,a),alert("Failed to load data. Please try again later.")}}async function W(e){const t=await fetch(e.action,{method:e.method||"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:new FormData(e),credentials:"same-origin"});if(!(t.headers.get("content-type")||"").includes("application/json"))return window.location.href=t.url,{status:t.status,json:{}};const n=await t.json();return{status:t.status,json:n}}document.addEventListener("click",e=>{const t=e.target.closest("[data-close-modal]");if(!t)return;e.preventDefault();const a=t.getAttribute("data-close-modal");a&&T(a)});document.addEventListener("click",e=>{const t=e.target.closest("[data-open-modal]");t&&(e.preventDefault(),B(t.getAttribute("data-open-modal")))});document.addEventListener("click",e=>{const t=e.target.closest("[data-login-game]");if(!t)return;e.preventDefault();const a=t.getAttribute("data-login-game"),n=`/?game_id=${encodeURIComponent(a)}&show_join_custom=0`;me({gameId:a,showJoinCustom:0,next:n})});document.addEventListener("keydown",e=>{const t=e.target.closest("[data-login-game]");if(t&&(e.key==="Enter"||e.key===" ")){e.preventDefault();const a=t.getAttribute("data-login-game"),n=`/?game_id=${encodeURIComponent(a)}&show_join_custom=0`;me({gameId:a,showJoinCustom:0,next:n})}});document.addEventListener("click",e=>{var i,r,s;if(!e.target.closest("[data-open-login-from-register]"))return;e.preventDefault();const a=((i=document.getElementById("registerGameId"))==null?void 0:i.value)||"",n=((r=document.getElementById("registerQuestId"))==null?void 0:r.value)||"",o=((s=document.getElementById("registerNext"))==null?void 0:s.value)||"";T("registerModal"),J({gameId:a,questId:n,nextPath:o})});document.addEventListener("click",e=>{const t=e.target.closest("[data-modal-url]");if(!t)return;e.preventDefault();const a=t.getAttribute("data-modal-url"),n=t.getAttribute("data-modal-id");if(!a||!n){u.error("data-modal-url or data-modal-id missing",t);return}xe(a,n)});document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".modal").forEach(e=>{e.parentNode!==document.body&&document.body.appendChild(e)})});function te(e){e.waiting&&e.waiting.postMessage({type:"SKIP_WAITING"})}function Se(e){try{const t=new URL(e,window.location.origin);return t.origin===window.location.origin&&t.protocol!=="javascript:"}catch{return u.error(`Invalid URL: ${e}`),!1}}function qe(){var r;if("serviceWorker"in navigator){let s=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{s||(s=!0,window.location.reload())});const d=((r=document.querySelector("meta[name='asset-version']"))==null?void 0:r.content)||"";navigator.serviceWorker.register(`/sw.js?v=${d}`).then(l=>{l.addEventListener("updatefound",()=>{const m=l.installing;m.addEventListener("statechange",()=>{m.state==="installed"&&navigator.serviceWorker.controller&&(u.info("Service worker updated; skipping waiting."),te(l))})}),"SyncManager"in window&&l.sync.register("sync-notifications").catch(m=>u.error("Sync registration failed:",m)),l.periodicSync&&l.periodicSync.register("periodic-notifications",{minInterval:24*60*60*1e3}).catch(m=>u.error("Periodic sync registration failed:",m)),"PushManager"in window&&Notification.permission==="default"&&Notification.requestPermission(),"sync"in l&&l.sync.register("sync-requests").catch(m=>{u.error("Background sync registration failed:",m)})}).catch(l=>u.error("Service Worker registration failed:",l)),navigator.serviceWorker.addEventListener("message",l=>{l.data.type==="UPDATE_AVAILABLE"&&navigator.serviceWorker.getRegistration().then(m=>{m&&(u.info("Update available message received; skipping waiting."),te(m))})})}const e=document.getElementById("install"),t=document.getElementById("manual-install"),a=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);let n=null;const o=document.getElementById("leaderboardNavbarLink");t&&(a?t.hidden=!1:t.hidden=!0);const i=document.body.getAttribute("data-user-id");if(i&&i!=="none"){const s=Intl.DateTimeFormat().resolvedOptions().timeZone;v(`/profile/${i}/timezone`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({timezone:s})}).catch(d=>u.error("Failed to send timezone:",d))}if(e&&(window.addEventListener("beforeinstallprompt",s=>{s.preventDefault(),n=s,e.hidden=!1,e.addEventListener("click",()=>{n&&(n.prompt(),n.userChoice.then(()=>{n=null,e.hidden=!0}))})}),window.beforeinstallprompt||(e.hidden=!0,!a&&t&&(t.hidden=!0)),window.addEventListener("appinstalled",()=>{e.hidden=!0,t&&(t.hidden=!0)}),navigator.getInstalledRelatedApps&&navigator.getInstalledRelatedApps().then(s=>{s.length&&(e.hidden=!0)})),o&&o.addEventListener("click",async s=>{s.preventDefault();const d=o.getAttribute("data-game-id")||0;(await V(()=>import("./chunk-DIr4udqN.js"),__vite__mapDeps([0,1]))).showLeaderboardModal(d)}),"windowControlsOverlay"in navigator){let s=function(){const d=navigator.windowControlsOverlay.getTitlebarAreaRect();document.body.style.paddingTop=d.height+"px"};navigator.windowControlsOverlay.addEventListener("geometrychange",s),s()}document.querySelectorAll(".modal").forEach(s=>{s.parentNode!==document.body&&document.body.appendChild(s)})}function Te(e){const t=e.value;t==="join_custom_game"?B("joinCustomGameModal"):Se(t)?window.location.href=t:u.error(`Blocked unsafe URL: ${t}`)}document.addEventListener("click",e=>{const t=e.target.closest("[data-game-selection]");t&&(e.preventDefault(),Te({value:t.getAttribute("data-game-selection")}))});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("quest-form");e&&e.addEventListener("submit",t=>{document.getElementById("description").value.trim()||(alert("Description is required."),t.preventDefault())})});function L(e){const t=document.getElementById("game_IdHolder"),a=t?t.getAttribute("data-game-id"):null,n=a&&!isNaN(parseInt(a,10))&&a!=="0"?`?game_id=${a}`:"";fetch(`/profile/${e}${n}`).then(o=>o.json()).then(o=>{if(!o.riding_preferences_choices){u.error("Riding preferences choices missing.");return}const i=document.getElementById("userProfileDetails");if(!i){u.error("Profile details containers not found");return}const r=o.current_user_id===o.user.id;i.innerHTML=`
          <!-- XS: native select dropdown -->
          <div class="d-block d-sm-none mb-3">
            <select id="profileTabSelect" class="form-select">
              <option value="profile" selected>Profile</option>
              <option value="bike">Bike</option>
              ${o.has_badges?'<option value="badges-earned">Badges Earned</option>':""}
              <option value="games-participated">Games Participated</option>
              <option value="quest-submissions">Quest Submissions</option>
            </select>
          </div>

          <!-- SM+ nav-tabs (will scroll horizontally) -->
          <ul class="nav nav-tabs epic-tabs d-none d-sm-flex" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <a class="nav-link active" id="profile-tab" data-bs-toggle="tab"
                href="#profile" role="tab" aria-controls="profile" aria-selected="true">
                <i class="bi bi-person-circle me-2"></i>Profile
              </a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="bike-tab" data-bs-toggle="tab"
                 href="#bike" role="tab" aria-controls="bike" aria-selected="false">
                <i class="bi bi-bicycle me-2"></i>Bike
              </a>
            </li>
            ${o.has_badges?`
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="badges-earned-tab" data-bs-toggle="tab"
                 href="#badges-earned" role="tab" aria-controls="badges-earned" aria-selected="false">
                <i class="bi bi-trophy me-2"></i>Badges Earned
              </a>
            </li>`:""}
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="games-participated-tab" data-bs-toggle="tab"
                 href="#games-participated" role="tab" aria-controls="games-participated" aria-selected="false">
                <i class="bi bi-controller me-2"></i>Games Participated
              </a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="quest-submissions-tab" data-bs-toggle="tab"
                 href="#quest-submissions" role="tab" aria-controls="quest-submissions" aria-selected="false">
                <i class="bi bi-list-quest me-2"></i>Quest Submissions
              </a>
            </li>
          </ul>

          <div class="tab-content bg-light p-4 rounded shadow-sm" id="profileTabsContent">

            <!-- 1) PROFILE pane -->
            <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
              <section class="profile mb-4">
                ${r?`
                  <div id="profileViewMode">
                    ${o.user.profile_picture?`
                      <div class="profile-picture-container position-relative mx-auto mb-3">
                        <img src="/static/${o.user.profile_picture}"
                            class="profile-picture rounded-circle shadow-lg border border-white border-4"
                            alt="Profile Picture">
                      </div>`:""}
                    <p><strong>Display Name:</strong> ${o.user.display_name||""}</p>
                    <p><strong>Age Group:</strong> ${o.user.age_group||""}</p>
                    <p><strong>Timezone:</strong> ${o.user.timezone||""}</p>
                    <p><strong>Interests:</strong> ${o.user.interests||""}</p>
                    <p><strong>Riding Preferences:</strong> ${o.user.riding_preferences.join(", ")}</p>
                    <p><strong>Ride Description:</strong> ${o.user.ride_description||""}</p>
                    <button class="btn btn-primary" id="editProfileBtn">Edit</button>
                  </div>
                  <div id="profileEditMode" class="d-none">
                    <form id="editProfileForm" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                      <div class="form-group mb-3">
                        <label for="profilePictureInput">Profile Picture:</label>
                        <input type="file" class="form-control" id="profilePictureInput"
                                name="profile_picture" accept="image/*">
                      </div>
                      <div class="form-group mb-3">
                        <label for="displayName">Display Name:</label>
                        <input type="text" class="form-control" id="displayName" name="display_name"
                                value="${o.user.display_name||""}" required>
                        <div class="invalid-feedback">Display Name is required.</div>
                      </div>
                      <div class="form-group mb-3">
                        <label for="ageGroup">Age Group:</label>
                        <select class="form-select" id="ageGroup" name="age_group">
                          <option value="teen" ${o.user.age_group==="teen"?"selected":""}>Teen</option>
                          <option value="adult" ${o.user.age_group==="adult"?"selected":""}>Adult</option>
                          <option value="senior" ${o.user.age_group==="senior"?"selected":""}>Senior</option>
                        </select>
                      </div>
                      <div class="form-group mb-3">
                        <label for="timezone">Timezone:</label>
                        <select class="form-select" id="timezone" name="timezone">
                          ${o.timezone_choices.map(p=>`
                            <option value="${p}" ${o.user.timezone===p?"selected":""}>${p}</option>
                          `).join("")}
                        </select>
                      </div>
                      <div class="form-group mb-3">
                        <label for="interests">Interests:</label>
                        <textarea class="form-control" id="interests" name="interests" rows="3"
                                  placeholder="Describe your interests...">${o.user.interests||""}</textarea>
                      </div>
                      <div class="form-group mb-3">
                        <label><b>Please specify your riding preferences:</b></label>
                        <div id="ridingPreferences">
                          ${o.riding_preferences_choices.map((p,I)=>`
                            <div class="form-check mb-2">
                              <input class="form-check-input" type="checkbox"
                                      id="ridingPref-${I}" name="riding_preferences"
                                      value="${p[0]}"
                                      ${o.user.riding_preferences.includes(p[0])?"checked":""}>
                              <label class="form-check-label" for="ridingPref-${I}">${p[1]}</label>
                            </div>
                          `).join("")}
                        </div>
                      </div>
                      <div class="form-group mb-3">
                        <label for="rideDescription">Describe the type of riding you like to do:</label>
                        <textarea class="form-control" id="rideDescription" name="ride_description" rows="3">${o.user.ride_description||""}</textarea>
                      </div>
                      <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="uploadToSocials" name="upload_to_socials"
                                ${o.user.upload_to_socials?"checked":""}>
                        <label class="form-check-label" for="uploadToSocials">Cross post to game's social media?</label>
                      </div>
                      <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="uploadToMastodon" name="upload_to_mastodon"
                                ${o.user.upload_to_mastodon?"checked":""}>
                        <label class="form-check-label" for="uploadToMastodon">Cross post to your federation server?</label>
                      </div>
                      ${o.user.is_admin?"":`
                      <div class="mb-3">
                        <button type="button" class="btn btn-warning" id="upgradeToAdminBtn"
                                data-bs-toggle="modal" data-bs-target="#upgradeAdminModal">
                          Upgrade to Admin
                        </button>
                      </div>
                      <div class="modal fade" id="upgradeAdminModal" tabindex="-1"
                           aria-labelledby="upgradeAdminModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="upgradeAdminModalLabel">Upgrade to Admin</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"
                                      aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                              <p>PayPal subscription integration coming soon.</p>
                            </div>
                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                          </div>
                        </div>
                      </div>`}
                      <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-success" id="saveProfileBtn">
                          <i class="bi bi-save me-2"></i>Save Profile
                        </button>
                        <button type="button" class="btn btn-secondary" id="cancelProfileBtn">Cancel</button>
                      </div>
                    </form>
                    <hr>
                    <form id="updatePasswordForm" class="d-flex justify-content-between">
                      <button class="btn btn-primary w-100 me-2" id="updatePasswordBtn">
                        <i class="bi bi-shield-lock-fill me-2"></i>Update Password
                      </button>
                    </form>
                    <hr>
                    <form id="deleteAccountForm">
                      <button class="btn btn-danger w-100">
                        <i class="bi bi-trash-fill me-2"></i>Delete My Account
                      </button>
                    </form>
                  </div>`:`
                  <div id="profileViewMode">
                    ${o.user.profile_picture?`
                    <div class="profile-picture-container position-relative mx-auto mb-3">
                      <img src="/static/${o.user.profile_picture}"
                          class="profile-picture rounded-circle shadow-lg border border-white border-4"
                          alt="Profile Picture">
                    </div>`:""}
                    <p><strong>Display Name:</strong> ${o.user.display_name||""}</p>
                    <p><strong>Age Group:</strong> ${o.user.age_group||""}</p>
                    <p><strong>Timezone:</strong> ${o.user.timezone||""}</p>
                    <p><strong>Interests:</strong> ${o.user.interests||""}</p>
                    <p><strong>Riding Preferences:</strong> ${o.user.riding_preferences.join(", ")}</p>
                    <p><strong>Ride Description:</strong> ${o.user.ride_description||""}</p>
                  </div>
                `}
              </section>
            </div>

            <!-- 2) BIKE pane -->
            <div class="tab-pane fade" id="bike" role="tabpanel" aria-labelledby="bike-tab">
              <section class="bike mb-4">
                <h2 class="h2">Bike Details</h2>
                ${r?`
                  <form id="editBikeForm" class="needs-validation" novalidate>
                    <div class="form-group mb-3">
                      <label for="bikePicture">Upload Your Bicycle Picture:</label>
                      <input type="file" class="form-control" id="bikePicture" name="bike_picture" accept="image/*">
                    </div>
                    ${o.user.bike_picture?`
                      <div class="form-group mb-3">
                        <label>Current Bicycle Picture:</label>
                        <img src="/static/${o.user.bike_picture}" class="img-fluid rounded shadow-sm" alt="Bicycle Picture">
                      </div>`:""}
                    <div class="form-group mb-3">
                      <label for="bikeDescription">Bicycle Description:</label>
                      <textarea class="form-control" id="bikeDescription" name="bike_description" rows="3">${o.user.bike_description||""}</textarea>
                    </div>
                    <div class="d-flex justify-content-between">
                      <button class="btn btn-success" id="saveBikeBtn">
                        <i class="bi bi-save me-2"></i>Save Bike Details
                      </button>
                    </div>
                  </form>`:`
                  <p><strong>Bicycle Description:</strong> ${o.user.bike_description||""}</p>`}
              </section>
            </div>

            ${o.has_badges?`
            <!-- 3) BADGES EARNED pane -->
            <div class="tab-pane fade" id="badges-earned" role="tabpanel" aria-labelledby="badges-earned-tab">
              <section class="badges-earned mb-4">
                <h2 class="h2">Badges Earned</h2>
                <div class="badge-grid">
                  ${o.user.badges&&o.user.badges.length?o.user.badges.map(p=>`
                      <div class="badge-card">
                        <img src="/static/images/badge_images/${p.image}" alt="${p.name}" class="badge-icon" style="width:100px;">
                        <div class="badge-caption">
                          <h3>${p.name}</h3>
                          <p>${p.description}</p>
                          <p><strong>Category:</strong> ${p.category}</p>
                        </div>
                      </div>
                    `).join(""):'<p class="text-muted">No badges earned yet.</p>'}
                </div>
              </section>
            </div>
            `:""}

            <!-- 4) GAMES PARTICIPATED pane -->
            <div class="tab-pane fade" id="games-participated" role="tabpanel" aria-labelledby="games-participated-tab">
              <section class="games-participated mb-4">
                <h2 class="h2">Games Participated</h2>
                <div class="row g-3">
                  ${o.participated_games&&o.participated_games.length?o.participated_games.map(p=>`
                      <div class="game-item col-md-6 p-3 border rounded shadow-sm bg-white">
                        <h3 class="h5">${p.title}</h3>
                        <p class="text-muted">${p.description}</p>
                        <p><strong>Start Date:</strong> ${p.start_date}</p>
                        <p><strong>End Date:</strong> ${p.end_date}</p>
                      </div>
                    `).join(""):'<p class="text-muted">No games participated in yet.</p>'}
                </div>
              </section>
            </div>

            <!-- 5) QUEST SUBMISSIONS pane -->
            <div class="tab-pane fade" id="quest-submissions" role="tabpanel" aria-labelledby="quest-submissions-tab">
              <section class="quest-submissions mb-4">
                <h2 class="h2">Quest Submissions</h2>
                <div class="row g-3">
                  ${o.quest_submissions&&o.quest_submissions.length?o.quest_submissions.map(p=>`
                      <div class="submission-item col-md-6 p-3 border rounded shadow-sm bg-white">
                        ${p.image_url?`<img src="${p.image_url}" alt="Submission Image" class="img-fluid rounded mb-2" style="max-height:200px; object-fit:cover;">`:""}
                        <p><strong>Quest:</strong> ${p.quest.title}</p>
                        <p class="text-muted">${p.comment}</p>
                        <p><strong>Submitted At:</strong> ${p.timestamp}</p>
                        <div class="d-flex gap-2">
                          ${p.twitter_url?`<a href="${p.twitter_url}"   target="_blank" class="btn btn-sm btn-twitter"><i class="bi bi-twitter"></i></a>`:""}
                          ${p.fb_url?`<a href="${p.fb_url}"        target="_blank" class="btn btn-sm btn-facebook"><i class="bi bi-facebook"></i></a>`:""}
                          ${p.instagram_url?`<a href="${p.instagram_url}" target="_blank" class="btn btn-sm btn-instagram"><i class="bi bi-instagram"></i></a>`:""}
                        </div>
                        ${r?`<button class="btn btn-danger btn-sm mt-2" data-delete-submission="${p.id}">Delete</button>`:""}
                      </div>
                    `).join(""):'<p class="text-muted">No quest submissions yet.</p>'}
                </div>
              </section>
            </div>

          </div> <!-- /.tab-content -->
        </div> <!-- /.row -->
      `;const s=document.getElementById("userProfileModalLabel");s.textContent=`${o.user.display_name||o.user.username}'s Profile`;const d=document.getElementById("followBtn");d&&(d.style.display="");const l=document.getElementById("followerCount");let m=o.user.follower_count;function y(){l&&(l.textContent=`${m} follower${m===1?"":"s"}`)}if(y(),!r&&d){let I=function(){p?(d.textContent="Following",d.classList.remove("btn-primary"),d.classList.add("btn-outline-primary")):(d.textContent="Follow",d.classList.remove("btn-outline-primary"),d.classList.add("btn-primary"))};d&&(d.style.display="",d.classList.remove("d-none"));let p=o.current_user_following;I(),d.onclick=async()=>{const _=p?"unfollow":"follow",{status:w}=await v(`/profile/${o.user.username}/${_}`,{method:"POST",headers:{"Content-Type":"application/json"}});if(w!==200){u.error("Follow toggle failed");return}p=!p,m+=p?1:-1,I(),y()}}else{const p=document.getElementById("followBtn");p&&(p.style.display="none")}B("userProfileModal");const g=document.getElementById("editProfileBtn");g&&g.addEventListener("click",Pe);const b=document.getElementById("saveProfileBtn");b&&b.addEventListener("click",()=>De(e));const c=document.getElementById("cancelProfileBtn");c&&c.addEventListener("click",p=>{p.preventDefault(),Ae(e)});const f=document.getElementById("updatePasswordBtn");f&&f.addEventListener("click",()=>{window.location.href="/auth/update_password"});const h=document.getElementById("saveBikeBtn");h&&h.addEventListener("click",()=>Me(e)),document.querySelectorAll("[data-delete-submission]").forEach(p=>{p.addEventListener("click",()=>{const I=p.getAttribute("data-delete-submission");Ne(I,"profileSubmissions",o.user.id)})});const E=document.getElementById("deleteAccountForm");E&&E.addEventListener("submit",p=>{p.preventDefault(),Fe()});const C=document.getElementById("profileTabSelect");C&&(C.addEventListener("change",p=>{const I=p.target.value,_=document.querySelector(`#profileTabs a[href="#${I}"]`);_&&new bootstrap.Tab(_).show()}),document.querySelectorAll('#profileTabs a[data-bs-toggle="tab"]').forEach(p=>{p.addEventListener("shown.bs.tab",I=>{C.value=I.target.getAttribute("href").slice(1)})}))}).catch(o=>{u.error("Failed to load profile:",o),alert("Could not load user profile. Please try again.")})}document.querySelectorAll("[data-floating-ui-tooltip]").forEach(e=>{tippy(e,{content:e.getAttribute("data-floating-ui-tooltip"),placement:"top",animation:"scale-subtle"})});document.querySelectorAll(".needs-validation").forEach(e=>{e.addEventListener("submit",t=>{e.checkValidity()||(t.preventDefault(),t.stopPropagation()),e.classList.add("was-validated")},!1)});function Pe(){const e=document.getElementById("profileViewMode"),t=document.getElementById("profileEditMode");if(!e||!t){u.error("Profile edit mode elements missing");return}e.classList.toggle("d-none"),t.classList.toggle("d-none")}function Ae(e){L(e)}function De(e){const t=document.getElementById("editProfileForm");if(!t){u.error("Edit profile form not found");return}const a=new FormData(t),n=document.getElementById("profilePictureInput");n.files.length>0&&a.append("profile_picture",n.files[0]);const o=[];t.querySelectorAll('input[name="riding_preferences"]:checked').forEach(i=>{o.push(i.value)}),a.delete("riding_preferences"),o.forEach(i=>{a.append("riding_preferences",i)}),v(`/profile/${e}/edit`,{method:"POST",body:a}).then(({json:i})=>{if(i.error){let r=`Error: ${i.error}`;if(i.details){const s=[];Object.values(i.details).forEach(d=>{s.push(d.join(", "))}),s.length&&(r+=` - ${s.join("; ")}`)}alert(r)}else alert("Profile updated successfully."),L(e)}).catch(i=>{u.error("Error updating profile:",i),alert("Failed to update profile. Please try again.")})}function Me(e){const t=document.getElementById("editBikeForm");if(!t){u.error("Edit bike form not found");return}const a=new FormData(t),n=document.getElementById("bikePicture");n.files.length>0&&a.append("bike_picture",n.files[0]),v(`/profile/${e}/edit-bike`,{method:"POST",body:a}).then(({json:o})=>{o.error?alert(`Error: ${o.error}`):(alert("Bike details updated successfully."),L(e))}).catch(o=>{u.error("Error updating bike details:",o),alert("Failed to update bike details. Please try again.")})}function Ne(e,t,a){v(`/quests/quest/delete_submission/${e}`,{method:"POST"}).then(({json:n})=>{if(n.success)alert("Submission deleted successfully."),L(a);else throw new Error(n.message)}).catch(n=>{u.error("Error deleting submission:",n),alert("Error during deletion: "+n.message)})}function Fe(){confirm("Are you sure you want to delete your account? This action cannot be undone.")&&v("/auth/delete_account",{method:"POST",headers:{"Content-Type":"application/json"}}).then(()=>{window.location.href="/"}).catch(e=>{u.error("Error deleting account:",e),alert("Failed to delete account. Please try again.")})}document.addEventListener("click",e=>{const t=e.target.closest("[data-user-profile]");if(!t)return;e.preventDefault();const a=t.getAttribute("data-user-profile");a&&L(a)});function Re(e){const t=document.querySelector(`meta[name="${e}"]`);return t?t.content:""}const Oe=Number(Re("current-user-id")||0),Qe=Ie(),$=document.querySelector('meta[name="placeholder-image"]').getAttribute("content");function ue(e){ce(),x(`/quests/detail/${encodeURIComponent(e)}/user_completion`).then(({json:t})=>{const{quest:a,userCompletion:n,canVerify:o,nextEligibleTime:i}=t;if(!pe(a,n.completions,o,e,i)){u.error("populateQuestDetails â€“ required element missing");return}ge(a,n.completions,i,o),B("questDetailModal"),Y(),be(e)}).catch(t=>{u.error("Error opening quest detail modal:",t),alert("Sign in to view quest details.")})}function z(e){x(`/quests/detail/${encodeURIComponent(e)}/user_completion`).then(({json:t})=>{const{quest:a,userCompletion:n,canVerify:o,nextEligibleTime:i}=t;if(!pe(a,n.completions,o,e,i)){u.error("populateQuestDetails - required element missing");return}ge(a,n.completions,i,o),Y(),be(e)}).catch(t=>{u.error("Failed to refresh quest detail modal:",t)})}function Y(){const e=document.querySelectorAll("img.lazyload"),t=new IntersectionObserver((a,n)=>{a.forEach(o=>{if(o.isIntersecting){const i=o.target;i.src=i.getAttribute("data-src"),i.classList.remove("lazyload"),n.unobserve(i)}})});e.forEach(a=>{t.observe(a)})}function pe(e,t,a,n,o){var g,b,c;const i=t>=e.completion_limit?" - complete":"",r={modalQuestTitle:document.getElementById("modalQuestTitle"),modalQuestDescription:document.getElementById("modalQuestDescription"),modalQuestTips:document.getElementById("modalQuestTips"),modalQuestPoints:document.getElementById("modalQuestPoints"),modalQuestCompletionLimit:document.getElementById("modalQuestCompletionLimit"),modalQuestBadgeAwarded:document.getElementById("modalQuestBadgeAwarded"),modalQuestCategory:document.getElementById("modalQuestCategory"),modalQuestVerificationType:document.getElementById("modalQuestVerificationType"),modalQuestBadgeImage:document.getElementById("modalQuestBadgeImage"),modalQuestCompletions:document.getElementById("modalQuestCompletions"),modalCountdown:document.getElementById("modalCountdown")};for(let f in r)if(!r[f])return u.error(`Error: Missing element ${f}`),!1;const s={badge:(g=r.modalQuestBadgeImage)==null?void 0:g.closest(".quest-detail-item"),badgeAwarded:(b=r.modalQuestBadgeAwarded)==null?void 0:b.closest(".quest-detail-item"),category:(c=r.modalQuestCategory)==null?void 0:c.closest(".quest-detail-item")};for(let f in s)if(!s[f])return u.error(`Error: Missing card element ${f}`),!1;r.modalQuestTitle.innerText=`${e.title}${i}`,r.modalQuestDescription.textContent=e.description,r.modalQuestTips.textContent=e.tips||"No tips available",r.modalQuestPoints.innerText=`${e.points}`,r.modalQuestCategory.innerText=e.category||"No category set";const d=e.completion_limit>1?`${e.completion_limit} times`:`${e.completion_limit} time`;r.modalQuestCompletionLimit.innerText=`${d} ${e.frequency}`;const l=e.badge_awarded>1?`${e.badge_awarded} times`:`${e.badge_awarded} time`;switch(e.badge_awarded!=null?r.modalQuestBadgeAwarded.innerText=`After ${l}`:r.modalQuestBadgeAwarded.innerText="No badge awarded",e.verification_type){case"photo_comment":r.modalQuestVerificationType.innerText="Must upload a photo to earn points! Comment optional.";break;case"photo":r.modalQuestVerificationType.innerText="Must upload a photo to earn points!";break;case"comment":r.modalQuestVerificationType.innerText="Must upload a comment to earn points!";break;case"qr_code":r.modalQuestVerificationType.innerText="Find the QR code and post a photo to earn points!";break;default:r.modalQuestVerificationType.innerText="Not specified";break}const m=e.badge&&e.badge.image?`/static/images/badge_images/${e.badge.image}`:$;r.modalQuestBadgeImage.setAttribute("data-src",m),r.modalQuestBadgeImage.src=$,r.modalQuestBadgeImage.classList.add("lazyload"),r.modalQuestBadgeImage.alt=e.badge&&e.badge.name?`Badge: ${e.badge.name}`:"Default Badge",e.badge_option==="none"?(s.badge.classList.add("hidden"),s.badgeAwarded.classList.add("hidden"),s.category.classList.add("hidden")):(s.badge.classList.remove("hidden"),s.badgeAwarded.classList.remove("hidden"),s.category.classList.remove("hidden")),r.modalQuestCompletions.innerText=`Total Completions: ${t}`;const y=o&&new Date(o);return!a&&y&&y>new Date?(r.modalCountdown.innerText=`Next eligible time: ${y.toLocaleString()}`,r.modalCountdown.style.color="red"):(r.modalCountdown.innerText="You are currently eligible to verify!",r.modalCountdown.style.color="green"),je(n,a,e.verification_type),!0}function ge(e,t,a,n){const o=document.querySelector(".user-quest-data");if(!o){u.error("Parent element .user-quest-data not found");return}[{id:"modalQuestCompletions",value:`${t||0}`},{id:"modalCountdown",value:""}].forEach(r=>{let s=document.getElementById(r.id);s||(s=document.createElement("p"),s.id=r.id,o.appendChild(s)),s.innerText=r.value}),Ue(document.getElementById("modalCountdown"),a,n)}function Ue(e,t,a){if(!a&&t){const n=new Date(t),o=new Date;if(n>o){const i=n-o;e.innerText=`Next eligible time: ${Ge(i)}`}else e.innerText="You are currently eligible to verify!"}else e.innerText="You are currently eligible to verify!"}function Ge(e){const t=Math.floor(e/1e3%60),a=Math.floor(e/(1e3*60)%60),n=Math.floor(e/(1e3*60*60)%24);return`${Math.floor(e/(1e3*60*60*24))}d ${n}h ${a}m ${t}s`}function je(e,t,a){const n=document.querySelector(".user-quest-data");if(!n){u.error("Parent element .user-quest-data not found");return}if(n.innerHTML="",t){const o=document.createElement("div");o.id=`verifyQuestForm-${e}`,o.className="verify-quest-form",o.style.display="block";const i=He(a.trim().toLowerCase(),e);o.appendChild(i),n.appendChild(o),Ve(e)}}function He(e,t){const a=document.createElement("form");a.enctype="multipart/form-data",a.className="epic-form",a.method="post",a.action=`/quests/quest/${encodeURIComponent(t)}/submit`;const n=document.createElement("input");n.type="hidden",n.name="csrf_token",n.value=Qe,a.appendChild(n);const o=document.createElement("h2");switch(o.style.textAlign="center",o.textContent="Verify Your Quest",a.appendChild(o),e){case"photo":a.appendChild(R("image","Upload a Photo","image/*")),a.appendChild(N());break;case"comment":a.appendChild(O("verificationComment","Enter a Comment","Enter a comment...",!0)),a.appendChild(N());break;case"photo_comment":a.appendChild(R("image","Upload a Photo","image/*")),a.appendChild(O("verificationComment","Enter a Comment (optional)","Enter a comment...",!1)),a.appendChild(N());break;case"video":a.appendChild(R("video","Upload a Video","video/*")),a.appendChild(O("verificationComment","Add a Comment (optional)","Enter an optional comment...",!1)),a.appendChild(N());break;case"qr_code":{const i=document.createElement("p");i.className="epic-message",i.textContent="Find and scan the QR code. No submission required here.",a.appendChild(i);break}case"pause":{const i=document.createElement("p");i.className="epic-message",i.textContent="Quest is currently paused.",a.appendChild(i);break}default:{const i=document.createElement("p");i.className="epic-message",i.textContent="Submission requirements are not set correctly.",a.appendChild(i)}}return a}function R(e,t,a,n){const o=document.createElement("div");o.className="form-group";const i=document.createElement("label");i.htmlFor=e,i.className="epic-label",i.textContent=t,o.appendChild(i);const r=document.createElement("input");return r.type="file",r.id=e,r.name=e,r.className="epic-input",r.accept=a,r.required=!0,o.appendChild(r),o}function O(e,t,a,n){const o=document.createElement("div");o.className="form-group";const i=document.createElement("label");i.htmlFor=e,i.className="epic-label",i.textContent=t,o.appendChild(i);const r=document.createElement("textarea");return r.id=e,r.name=e,r.className="epic-textarea",r.placeholder=a,n&&(r.required=!0),o.appendChild(r),o}function N(){const e=document.createElement("div");e.className="form-group";const t=document.createElement("button");return t.type="submit",t.textContent="Submit Verification",e.appendChild(t),e}function Ve(e){const t=document.getElementById(`verifyQuestForm-${e}`);if(!t){u.error("Form container not found for quest ID:",e);return}const a=t.querySelector("form");if(!a){u.error("Form element missing for quest ID:",e);return}a.addEventListener("submit",function(n){ze(n,e)})}function Q(e,t){e&&(t&&t.trim()?(e.href=t,e.style.display="inline"):e.style.display="none")}function Je(e){if(typeof e!="number")return;const t=document.getElementById("total-points");if(!t)return;const a=t.querySelector(".points-emphasized");a?a.textContent=e:t.textContent=`Your Carbon Reduction Points: ${e}`}function We(e,t,a){const n=document.querySelector(`#questTableBody tr[data-quest-id="${e}"]`);if(!n)return;const o=n.querySelectorAll(".quest-stats-cell");o.length>=2&&(o[0].innerText=t,o[1].innerText=a)}function fe(e){Q(document.getElementById("twitterLink"),e.twitter_url),Q(document.getElementById("facebookLink"),e.fb_url),Q(document.getElementById("instagramLink"),e.instagram_url)}let U=!1;async function ze(e,t){if(e.preventDefault(),U)return;U=!0;const a=e.target.querySelector('[type="submit"]');a&&(a.disabled=!0);try{const n=e.target.querySelector('input[type="file"]'),o=n?n.files[0]:null;if(o&&o.type.startsWith("video/")&&o.size>10*1024*1024){alert("Video must be 10 MB or smaller.");return}if(o&&o.type.startsWith("image/")&&o.size>8*1024*1024){alert("Image must be 8 MB or smaller.");return}const i=new FormData(e.target);i.append("user_id",Oe);const{status:r,json:s}=await v(`/quests/quest/${encodeURIComponent(t)}/submit`,{method:"POST",body:i});if(r!==200)throw r===403&&s.message==="This quest cannot be completed outside of the game dates"?new Error("The game has ended and you can no longer submit quests. Join a new game in the game dropdown menu."):new Error(s.message||`Server responded with status ${r}`);if(!s.success)throw new Error(s.message);if(!s.success)throw new Error(s.message);Je(s.total_points),fe(s),We(t,s.new_completion_count,s.total_completion_count),z(t),e.target.reset()}catch(n){u.error("Submission error:",n),alert(`Error during submission: ${n.message}`)}finally{U=!1,a&&(a.disabled=!1)}}async function be(e){const t=encodeURIComponent(e);try{const{json:a}=await x(`/quests/quest/${t}/submissions`),n=document.getElementById("twitterLink"),o=document.getElementById("facebookLink"),i=document.getElementById("instagramLink");if(a&&a.length){const s=a[0],d=document.getElementById("submissionImage"),l=document.getElementById("submissionVideo"),m=document.getElementById("submissionVideoSource"),y=document.getElementById("submissionComment"),g=document.getElementById("submitterProfileLink"),b=document.getElementById("submitterProfileImage"),c=document.getElementById("submitterProfileCaption");s.video_url?(d.hidden=!0,l.hidden=!1,m.src=s.video_url,l.load()):(l.hidden=!0,d.hidden=!1,d.src=s.image_url||$),y.textContent=s.comment||"No comment provided.",g.href=`/profile/${encodeURIComponent(s.user_id)}`,b.src=s.user_profile_picture||$,c.textContent=s.user_display_name||s.user_username||`User ${s.user_id}`,fe(s)}else[n,o,i].forEach(s=>{s&&(s.style.display="none")});const r=a.slice().reverse().map(s=>({id:s.id,url:s.image_url||(s.video_url?null:$),video_url:s.video_url,alt:"Submission Image",comment:s.comment,user_id:s.user_id,user_display_name:s.user_display_name,user_username:s.user_username,user_profile_picture:s.user_profile_picture,twitter_url:s.twitter_url,fb_url:s.fb_url,instagram_url:s.instagram_url,quest_id:e}));Ye(r)}catch(a){u.error("Failed to fetch submissions:",a),alert("Could not load submissions. Please try again.")}}function ne(e){if(!e)return u.error(`Invalid URL detected: ${e}`),!1;try{if(e.startsWith("/"))return!0;const t=new URL(e);if(t.protocol==="http:"||t.protocol==="https:")return[".jpg",".jpeg",".png",".gif",".webp"].some(n=>t.pathname.toLowerCase().endsWith(n))}catch{return u.error(`Invalid URL detected: ${e}`),!1}return!1}function Ye(e){var d;const t=document.getElementById("submissionBoard");if(!t){u.error("submissionBoard element not found");return}t.innerHTML="";const a=((d=document.getElementById("questDetailModal"))==null?void 0:d.getAttribute("data-placeholder-url"))||$,n=ne(a)?a:$,o=l=>l.startsWith("/static/"),i=l=>l.replace(/^\/static\//,""),r=window.innerWidth<=480?70:100,s=Math.round(r*(window.devicePixelRatio||2));e.forEach(l=>{let m;if(l.video_url)m=document.createElement("video"),m.src=l.video_url,m.preload="metadata",m.muted=!0,m.playsInline=!0,m.style.objectFit="cover";else{m=document.createElement("img");const y=ne(l.url)?l.url:n,g=o(y)?`/resize_image?path=${encodeURIComponent(i(y))}&width=${s}`:y;m.src=$,m.setAttribute("data-src",g),m.classList.add("lazyload"),m.alt=l.alt||"Submission Image"}m.style.width=`${r}px`,m.style.height="auto",m.style.marginRight="10px",l.video_url||(m.onerror=()=>{o(n)?m.src=`/resize_image?path=${encodeURIComponent(i(n))}&width=${s}`:m.src=encodeURI(n)}),m.onclick=()=>q(l),t.appendChild(m)}),Y()}function Xe(e){e.querySelectorAll("span, img").forEach(a=>{a.classList.toggle("hidden")})}document.addEventListener("click",e=>{const t=e.target.closest("[data-quest-detail]");if(t){e.preventDefault(),ue(t.getAttribute("data-quest-detail"));return}const a=e.target.closest("[data-toggle-content]");a&&a.closest("#questDetailModal")&&(e.preventDefault(),Xe(a))});const Ke=Object.freeze(Object.defineProperty({__proto__:null,openQuestDetailModal:ue,refreshQuestDetailModal:z},Symbol.toStringTag,{value:"Module"}));let q;document.addEventListener("DOMContentLoaded",()=>{const e=s=>document.querySelector(s);if(!e("#submissionDetailModal"))return;const a=document.getElementById("replyLimitMessage"),n=document.querySelector('meta[name="placeholder-image"]').getAttribute("content");q=function(s){const d=e("#submissionDetailModal");d.dataset.submissionId=s.id,d.dataset.questId=s.quest_id||"";const l=Number(d.dataset.currentUserId),m=Number(s.user_id)===l,y=d.dataset.isAdmin==="True"||d.dataset.isAdmin==="true",g=e("#editPhotoBtn"),b=e("#photoEditControls"),c=e("#submissionPhotoInput"),f=e("#savePhotoBtn"),h=e("#cancelPhotoBtn"),E=e("#deleteSubmissionBtn");g.hidden=!m,E.hidden=!(m||y),b.hidden=!0,g.onclick=()=>{b.hidden=!1,g.hidden=!0},h.onclick=()=>{c.value="",b.hidden=!0,g.hidden=!1},E.onclick=()=>{if(!confirm("Are you sure you want to delete this submission?"))return;const _=d.dataset.submissionId;v(`/quests/quest/delete_submission/${_}`,{method:"POST"}).then(({json:w})=>{if(!w.success)throw new Error(w.message||"Delete failed");T("submissionDetailModal"),ce(),d.dataset.questId&&z(d.dataset.questId),alert("Submission deleted successfully.")}).catch(w=>alert("Error deleting submission: "+w.message))},f.onclick=()=>{const _=d.dataset.submissionId,w=c.files[0];if(!w)return alert("Please select an image first.");if(w.type.startsWith("video/")&&w.size>10*1024*1024){alert("Video must be 10 MB or smaller.");return}if(w.type.startsWith("image/")&&w.size>8*1024*1024){alert("Image must be 8 MB or smaller.");return}const A=new FormData;w.type.startsWith("video/")?A.append("video",w):A.append("photo",w),v(`/quests/submission/${_}/photo`,{method:"PUT",body:A}).then(({json:S})=>{if(!S.success)throw new Error(S.message||"Upload failed");S.video_url?(e("#submissionImage").hidden=!0,e("#submissionVideo").hidden=!1,e("#submissionVideoSource").src=S.video_url,e("#submissionVideo").load()):(e("#submissionVideo").hidden=!0,e("#submissionImage").hidden=!1,e("#submissionImage").src=S.image_url),h.click()}).catch(S=>alert(S.message))},e("#submissionReplyEdit").hidden=m,e("#postReplyBtn").hidden=m,e("#ownerNotice").hidden=!m;const C=e("#submissionRepliesContainer");m?C.hidden=!0:C.hidden=!1;const p={img:e("#submissionImage"),video:e("#submissionVideo"),videoSource:e("#submissionVideoSource"),imgOverlay:e("#submitterProfileImageOverlay"),commentRead:e("#submissionComment"),commentEdit:e("#submissionCommentEdit"),readBox:e("#commentReadButtons"),editBox:e("#commentEditButtons"),editBtn:e("#editCommentBtn"),profileImg:e("#submitterProfileImage"),profileImgOverlay:e("#submitterProfileImageOverlay"),profileCap:e("#submitterProfileCaption"),profileLink:e("#submitterProfileLink"),social:{tw:e("#twitterLink"),fb:e("#facebookLink"),ig:e("#instagramLink")}};p.profileImg.src=s.user_profile_picture||n,p.profileImgOverlay.src=p.profileImg.src,p.profileCap.textContent=s.user_display_name||s.user_username||"â€”",p.profileLink.onclick=_=>{_.preventDefault(),L(s.user_id)},p.imgOverlay.parentElement.onclick=p.profileLink.onclick;const I=n;s.video_url?(p.img.hidden=!0,p.video.hidden=!1,p.videoSource.src=s.video_url,p.video.load()):(p.video.hidden=!0,p.img.hidden=!1,p.img.src=s.url||I),p.commentRead.textContent=s.comment||"No comment provided.",["tw","fb","ig"].forEach(_=>{const w=_==="tw"?"twitter_url":_==="fb"?"fb_url":"instagram_url";try{new URL(s[w]),p.social[_].href=s[w],p.social[_].style.display="inline-block"}catch{p.social[_].style.display="none"}}),m?(p.editBtn.hidden=!1,p.readBox.hidden=!1):p.editBtn.hidden=p.readBox.hidden=p.commentEdit.hidden=p.editBox.hidden=!0,i(),B("submissionDetailModal")},e("#editCommentBtn").addEventListener("click",()=>{e("#submissionCommentEdit").value=e("#submissionComment").textContent.trim(),o(!0)}),e("#saveCommentBtn").addEventListener("click",()=>{const s=e("#submissionDetailModal").dataset.submissionId;v(`/quests/submission/${s}/comment`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({comment:e("#submissionCommentEdit").value.trim()})}).then(({json:d})=>{if(!d.success)throw new Error(d.message||"Save failed");e("#submissionComment").textContent=d.comment||"No comment provided.",o(!1)}).catch(d=>alert(`Could not save comment: ${d.message}`))}),e("#cancelCommentBtn").addEventListener("click",()=>o(!1));function o(s){e("#submissionComment").hidden=s,e("#commentReadButtons").hidden=s,e("#submissionCommentEdit").hidden=!s,e("#commentEditButtons").hidden=!s}function i(){const s=e("#submissionDetailModal").dataset.submissionId;s&&(x(`/quests/submissions/${s}`).then(({json:d})=>{e("#submissionLikeCount").textContent=d.like_count||0,e("#submissionLikeBtn").classList.toggle("active",d.liked_by_current_user)}),x(`/quests/submission/${s}/replies`).then(({json:d})=>{const l=e("#submissionRepliesList");l.innerHTML="",d.replies.forEach(g=>{const b=document.createElement("div");b.className="reply mb-1";const c=document.createElement("a");c.href="#",c.className="reply-user-link",c.dataset.userId=g.user_id;const f=document.createElement("strong");f.textContent=g.user_display,c.appendChild(f),b.appendChild(c),b.appendChild(document.createTextNode(`: ${g.content}`)),c.addEventListener("click",h=>{h.preventDefault(),L(g.user_id)}),l.appendChild(b)});const m=e("#submissionReplyEdit"),y=e("#postReplyBtn");d.replies.length>=10?(m.disabled=!0,y.disabled=!0,a&&(a.style.display="block")):(m.disabled=!1,y.disabled=!1,a&&(a.style.display="none"))}))}e("#submissionLikeBtn").addEventListener("click",()=>{const s=e("#submissionLikeBtn"),d=e("#submissionDetailModal").dataset.submissionId,l=s.classList.contains("active");v(`/quests/submission/${d}/like`,{method:l?"DELETE":"POST",headers:{"Content-Type":"application/json"}}).then(({json:m})=>{if(!m.success)throw new Error("Like failed");e("#submissionLikeCount").textContent=m.like_count,s.classList.toggle("active",m.liked)}).catch(m=>alert(m.message))}),e("#postReplyBtn").addEventListener("click",()=>{const s=e("#submissionDetailModal").dataset.submissionId,d=e("#submissionReplyEdit"),l=d.value.trim();!s||!l||v(`/quests/submission/${s}/replies`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:l})}).then(({status:m,json:y})=>{if(!y.success){if(y.message==="Reply limit of 10 reached"){r();return}if(m===409&&y.message==="Duplicate reply")return alert("You have already posted that exact reply.");throw new Error(y.message||"Error")}const g=e("#submissionRepliesList"),b=document.createElement("div");b.className="reply mb-1";const c=document.createElement("strong");c.textContent=y.reply.user_display,b.appendChild(c),b.appendChild(document.createTextNode(`: ${y.reply.content}`)),g.insertBefore(b,g.firstChild),d.value="",g.children.length>=10&&r()}).catch(m=>alert(m.message))});function r(){const s=e("#submissionReplyEdit"),d=e("#postReplyBtn");s.disabled=!0,d.disabled=!0,a&&(a.style.display="block")}});const Ze=document.querySelector('meta[name="placeholder-image"]').getAttribute("content");let F=0,ye=null,oe=!1,ae=!1;function et(e){F=0,ye=e;const t=document.getElementById("allSubmissionsContainer");t&&(t.innerHTML=""),B("allSubmissionsModal"),he()}function he(){const e=F*10;x(`/quests/quest/all_submissions?game_id=${ye}&offset=${e}&limit=10`).then(({json:t})=>{if(t.error)throw new Error(t.error);oe=t.is_admin,ae=t.has_more,tt(t.submissions,oe,F>0),ot(ae),F+=1}).catch(t=>{u.error("Error fetching all submissions:",t),alert("Error fetching all submissions: "+t.message)})}function tt(e,t,a=!1){const n=document.getElementById("allSubmissionsContainer");if(!n){u.error("allSubmissionsContainer element not found.");return}a||(n.innerHTML=""),e.forEach(o=>{const i=document.createElement("div");i.className="submission-card";const r=document.createElement("img");r.src=o.image_url||Ze,r.alt="Quest Submission",r.className="submission-image";const s=document.createElement("div");s.className="submission-info";const d=document.createElement("p");d.textContent=`User: ${o.user_display_name||o.user_username}`,d.className="submission-user-details";const l=document.createElement("p"),m=new Date(o.timestamp).toLocaleString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0});l.textContent=`Submitted on: ${m}`,l.className="submission-timestamp";const y=document.createElement("p");y.textContent=`Comment: ${o.comment}`,y.className="submission-comment";const g=document.createElement("p");g.textContent=`Twitter: ${o.twitter_url||"N/A"}`,g.className="submission-comment";const b=document.createElement("p");b.textContent=`Facebook: ${o.fb_url||"N/A"}`,b.className="submission-comment";const c=document.createElement("p");if(c.textContent=`Instagram: ${o.instagram_url||"N/A"}`,c.className="submission-comment",s.appendChild(d),s.appendChild(l),s.appendChild(y),s.appendChild(g),s.appendChild(b),s.appendChild(c),t){const f=document.createElement("button");f.textContent="Delete",f.className="button delete-button",f.addEventListener("click",function(h){h.stopPropagation(),nt(o.id)}),i.appendChild(f)}i.appendChild(r),i.appendChild(s),i.addEventListener("click",function(){q({id:o.id,quest_id:o.quest_id,url:o.image_url||o.video_url,video_url:o.video_url,comment:o.comment,user_id:o.user_id,user_display_name:o.user_display_name||o.user_username,user_profile_picture:o.user_profile_picture,twitter_url:o.twitter_url,fb_url:o.fb_url,instagram_url:o.instagram_url,verification_type:"image"}),B("submissionDetailModal")}),n.appendChild(i)})}function nt(e){v(`/quests/quest/delete_submission/${e}`,{method:"POST"}).then(({json:t})=>{if(t.success)alert("Submission deleted successfully.");else throw new Error(t.message)}).catch(t=>{u.error("Error deleting submission:",t),alert("Error during deletion: "+t.message)})}function ot(e){const t=document.getElementById("loadMoreSubmissions");t&&(t.style.display=e?"block":"none")}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("loadMoreSubmissions");e&&e.addEventListener("click",()=>{he()})});document.addEventListener("DOMContentLoaded",()=>{at(),document.querySelectorAll("[data-toggle-form]").forEach(e=>{e.addEventListener("click",()=>st(e.dataset.toggleForm))})});function Ee(){const e=document.getElementById("game_IdHolder");if(!e)return null;const t=e.getAttribute("data-game-id");return t&&t!=="0"?t:null}function at(){const e=document.getElementById("badgesBody");if(!e)return;const t=Ee(),a=t?`?game_id=${t}`:"";fetch(`/badges${a}`).then(n=>{if(!n.ok)throw new Error("Failed to fetch badges");if(!(n.headers.get("content-type")||"").includes("application/json"))throw new Error("Invalid badge response");return n.json()}).then(n=>{const o=Array.isArray(n.badges)?n.badges:[];e.innerHTML="",o.forEach(i=>{const r=document.createElement("tr");r.dataset.badgeId=i.id;const s=document.createElement("td");if(s.className="badge-image-manage",i.image){const c=document.createElement("img");c.src=i.image,c.height=50,c.alt="Badge Image",s.appendChild(c)}else s.textContent="No Image";r.appendChild(s);const d=document.createElement("td");d.className="badge-name",d.textContent=i.name,r.appendChild(d);const l=document.createElement("td");l.className="badge-description",l.textContent=i.description,r.appendChild(l);const m=document.createElement("td");m.className="badge-category",m.textContent=i.category||"None",r.appendChild(m);const y=document.createElement("td"),g=document.createElement("button");g.className="edit-badge",g.dataset.badgeId=i.id,g.textContent="Edit",g.addEventListener("click",()=>rt(i.id));const b=document.createElement("button");b.className="delete-badge",b.dataset.badgeId=i.id,b.textContent="Delete",b.addEventListener("click",()=>lt(i.id)),y.appendChild(g),y.appendChild(b),r.appendChild(y),e.appendChild(r)})}).catch(n=>u.error("Failed to load badges:",n))}function st(e){const t=document.getElementById(e);t&&t.classList.toggle("d-none")}function it(e){const t=Ee(),a=t?`?game_id=${t}`:"";return fetch(`/badges/categories${a}`).then(n=>{if(!n.ok)throw new Error("Failed to fetch categories");if(!(n.headers.get("content-type")||"").includes("application/json"))throw new Error("Invalid category response");return n.json()}).then(n=>{const o=Array.isArray(n.categories)?n.categories:[],i=document.createElement("select");i.className="form-control badge-category-select";const r=document.createElement("option");return r.value="none",r.textContent="None",(!e||e==="none")&&(r.selected=!0),i.appendChild(r),o.forEach(s=>{const d=document.createElement("option");d.value=s,d.textContent=s,s===e&&(d.selected=!0),i.appendChild(d)}),i}).catch(n=>{u.error("Error fetching categories:",n);const o=document.createElement("select");o.className="form-control badge-category-select";const i=document.createElement("option");return i.value="none",i.textContent="None",i.selected=!0,o.appendChild(i),o})}function rt(e){const t=document.querySelector(`tr[data-badge-id='${e}']`);if(!t){u.error(`Badge row with ID ${e} not found.`);return}const a=t.querySelector(".badge-name"),n=t.querySelector(".badge-description"),o=t.querySelector(".badge-category"),i=t.querySelector(".badge-image-manage");a.textContent="";const r=document.createElement("input");r.type="text",r.value=a.innerText.trim(),r.className="form-control badge-name-input",a.appendChild(r),n.textContent="";const s=document.createElement("textarea");if(s.className="form-control badge-description-textarea",s.value=n.innerText.trim(),n.appendChild(s),i){i.textContent="";const d=document.createElement("input");d.type="file",d.className="form-control-file badge-image-input",i.appendChild(d)}else u.error("Could not find badge-image-manage cell");it(o.innerText.trim()).then(d=>{o.textContent="",o.appendChild(d);const l=t.querySelector("button.edit-badge");l.innerText="Save",l.onclick=()=>dt(e)})}function dt(e){const t=document.querySelector(`tr[data-badge-id='${e}']`),a=new FormData;a.append("name",t.querySelector(".badge-name-input").value.trim()),a.append("description",t.querySelector(".badge-description-textarea").value.trim()),a.append("category",t.querySelector(".badge-category-select").value);const n=t.querySelector(".badge-image-input");n&&n.files.length>0&&a.append("image",n.files[0]);const o=document.querySelector("[name=csrf_token]").value;a.append("csrf_token",o),v(`/badges/update/${e}`,{method:"POST",body:a}).then(({json:i})=>{i.success?(alert("Badge updated successfully"),window.location.reload()):alert("Failed to update badge: "+i.message)}).catch(i=>u.error("Error updating badge:",i))}function lt(e){confirm("Are you sure you want to delete this badge?")&&v(`/badges/delete/${e}`,{method:"DELETE"}).then(({json:t})=>{t.success?window.location.reload():alert(`Failed to delete badge: ${t.message}`)}).catch(t=>{u.error("Error deleting badge:",t),alert("Error deleting badge. Please check console for details.")})}let P=[];const se=document.querySelector('meta[name="placeholder-image"]'),X=se?se.getAttribute("content"):"";function ct(e){try{const t=new URL(e,window.location.origin);if(t.protocol==="http:"||t.protocol==="https:")return e}catch{}return X}async function mt(){const e=document.getElementById("game_IdHolder"),t=e?e.getAttribute("data-game-id"):null,n=`/badges${t&&!isNaN(parseInt(t,10))&&t!=="0"?`?game_id=${t}`:""}`,o=await fetch(n,{credentials:"same-origin"});if(!o.ok)throw new Error("Error fetching badges");if(!(o.headers.get("content-type")||"").includes("application/json"))throw new Error("Invalid badge response");let r;try{r=await o.json()}catch{throw new Error("Error parsing badge data")}return P=Array.isArray(r.badges)?r.badges:[],P}async function ve(){if(!P||P.length===0)try{await mt()}catch(e){u.error("Error loading badges:",e),P=[]}}function ut(e){if(!e)return null;const t=document.createElement("ul");return e.split(",").forEach(a=>{const n=document.createElement("li");n.textContent=a.trim(),t.appendChild(n)}),t}function pt(e){return P.find(t=>t.id==e)}function gt(e){return{id:e.getAttribute("data-badge-id"),name:e.getAttribute("data-badge-name")||"Badge",description:e.getAttribute("data-badge-description")||"",image:e.getAttribute("data-badge-image")||X}}async function ft(e){const t=await fetch(`/quests/detail/${encodeURIComponent(e)}/user_completion`);if(!t.ok)throw new Error("Failed to fetch user completions");const a=await t.json();return a.userCompletion?a.userCompletion.completions:0}function bt(e,t,a,n,o,i,r){const s=document.getElementById("badgeModalTitle"),d=document.getElementById("badgeModalImage"),l=document.getElementById("badgeModalText");if(!s||!d||!l){u.error("Badge modal elements missing");return}s.textContent=e.name,d.src=ct(e.image)||X,l.textContent="";const m=document.createElement("p"),y=document.createElement("strong");if(y.textContent=o?"Awarded!":"Not Awarded Yet",m.appendChild(y),l.appendChild(m),i){const c=document.createElement("p");c.textContent=`Completion Requirement: ${t>1?t+" times":t+" time"}`,l.appendChild(c);const f=document.createElement("p");f.textContent=`Your Total Completions: ${a}`,l.appendChild(f);const h=document.createElement("p");if(o)h.textContent="You have earned this badge.";else{h.append("Complete ");const E=document.createElement("a");E.href="#",E.dataset.questDetail=i,E.textContent=r,h.appendChild(E),h.append(" to earn this badge.")}l.appendChild(h)}else{const c=document.createElement("p");c.textContent=`Completion Requirements: ${t} (per task)`,l.appendChild(c);const f=document.createElement("p");f.textContent=`Your Total Completions: ${a}`,l.appendChild(f),n&&l.appendChild(n);const h=document.createElement("p");h.textContent=o?"You have earned this badge.":"Complete one of the above tasks to earn this badge.",l.appendChild(h)}const g=e.description||"No description available.",b=document.createElement("p");b.textContent=g,o?(d.style.filter="none",d.oncontextmenu=null):(d.style.filter="grayscale(100%) opacity(0.5)",d.oncontextmenu=c=>(c.preventDefault(),!1)),l.appendChild(b)}async function yt(e){const t=e.getAttribute("data-badge-id"),a=e.getAttribute("data-task-name"),n=e.getAttribute("data-task-id"),o=e.getAttribute("data-badge-awarded-count"),i=e.getAttribute("data-user-completions"),r=parseInt(o,10),s=parseInt(i,10)||0,d=ut(a),l=n?n.split(",").map(c=>c.trim()).filter(Boolean):[],m=l.length===1?l[0]:null;await ve();const y=pt(t)||gt(e);let g=s;if(m)try{g=await ft(m)}catch(c){u.error("Error fetching user completions:",c)}const b=g>=r;bt(y,r,g,d,b,m,a),B("badgeModal")}document.addEventListener("DOMContentLoaded",()=>{ve()});document.addEventListener("click",e=>{const t=e.target.closest("[data-open-badge]");t&&(e.preventDefault(),yt(t))});document.addEventListener("DOMContentLoaded",()=>{});let G;function ht(e){const t=document.getElementById("deleteGameModal"),a=document.getElementById("deleteGameForm"),n=document.getElementById("deleteGameConfirmInput"),o=document.getElementById("deleteGameCountdown"),i=document.getElementById("deleteGameTimer"),r=document.getElementById("deleteGameConfirmBtn");if(!t||!a||!n||!o||!i||!r){u.warn("Delete game modal elements missing");return}t.dataset.gameId=e,a.action=`/games/delete_game/${encodeURIComponent(e)}`,n.value="",r.disabled=!0,o.hidden=!0,i.textContent="5",B("deleteGameModal")}function ie(){const e=document.getElementById("deleteGameConfirmInput"),t=document.getElementById("deleteGameConfirmBtn"),a=document.getElementById("deleteGameCountdown"),n=document.getElementById("deleteGameTimer"),o=document.getElementById("deleteGameUndo"),i=document.getElementById("deleteGameForm");!e||!t||!a||!n||!o||!i||(e.addEventListener("input",()=>{t.disabled=e.value.trim().toLowerCase()!=="delete"}),t.addEventListener("click",()=>{let r=5;a.hidden=!1,n.textContent=r.toString(),G=setInterval(()=>{r-=1,n.textContent=r.toString(),r<=0&&(clearInterval(G),i.submit())},1e3)}),o.addEventListener("click",()=>{clearInterval(G),a.hidden=!0,n.textContent="5",e.value="",t.disabled=!0}))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ie):ie();document.addEventListener("click",e=>{const t=e.target.closest("[data-delete-game-id]");t&&(e.preventDefault(),ht(t.getAttribute("data-delete-game-id")))});document.addEventListener("DOMContentLoaded",()=>{});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("flash-data");if(!e)return;const t=JSON.parse(e.getAttribute("data-messages")||"[]");if(!t.length)return;const[a,n]=t[0],o=document.getElementById("flash-overlay");o.querySelector(".flash-content").textContent=n,o.querySelector(".flash-modal").classList.add(`flash-${a}`),requestAnimationFrame(()=>{o.classList.add("visible")});function i(){o.classList.remove("visible"),e.removeAttribute("data-messages")}o.querySelector(".flash-close").addEventListener("click",i),o.querySelector(".flash-ok-btn").addEventListener("click",i)});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("forgotForm");if(!e)return;const t=document.getElementById("forgotEmailError"),a=document.getElementById("forgotSuccess"),n=document.getElementById("forgotButton"),o=document.getElementById("forgotEmail"),i=document.getElementById("forgotEmailDisplay"),r=document.getElementById("forgotPasswordModal");new MutationObserver(()=>{r.style.display==="block"&&(i.textContent=o.value)}).observe(r,{attributes:!0,attributeFilter:["style"]}),e.addEventListener("submit",d=>{d.preventDefault(),t.style.display="none",a.style.display="none",W(e).then(({json:l})=>{l.success?(a.textContent=l.message,a.style.display="block",n.disabled=!0):(t.textContent=l.error||"An error occurred.",t.style.display="block")}).catch(()=>{e.submit()})})});document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("button[data-game-id]").forEach(a=>{a.addEventListener("click",function(){t(this)})});function t(a){const n=document.getElementById("questCreationForm"),o=a.getAttribute("data-game-id");n?n.addEventListener("submit",function(i){i.preventDefault();const r=document.getElementById("questDescription").value;v("/ai/generate_quest",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({description:r,game_id:o})}).then(({json:s})=>{const d=s;if(d.generated_quest_html){document.getElementById("generatedQuestContent").innerHTML=d.generated_quest_html,B("generateAIQuestModal");const l=document.getElementById("generateAIQuestModalForm");l&&l.setAttribute("data-game-id",o),l&&l.addEventListener("submit",function(c){c.preventDefault();const f=new FormData(l);v("/ai/create_quest",{method:"POST",body:f}).then(({json:h})=>{window.location.href="/",u.log(h)}).catch(h=>{u.error("Error:",h)})});const m=document.getElementById("generateAIImage"),y=document.getElementById("badge_description"),g=document.getElementById("aiBadgeImage"),b=document.getElementById("aiBadgeFilename");if(!m||!y||!g||!b){u.error("One or more elements not found in the DOM");return}m.addEventListener("click",function(){u.log("Generate AI Image button clicked");const c=y.value;if(u.log("Badge Description:",c),!c){alert("Please enter a badge description first.");return}v("/ai/generate_badge_image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({badge_description:c})}).then(({json:f})=>{if(u.log("Response data:",f),f.error)alert("Error generating badge image: "+f.error);else{const h=`${f.filename}`,E=`static/images/badge_images/${f.filename}`;g.src=E,g.style.display="block",b.value=h}}).catch(f=>{u.error("Fetch error:",f),alert("Error: "+f)})})}}).catch(s=>{alert("Error generating quest: "+s.message)})}):u.error("Form '#questCreationForm' not found.")}});const Et=async()=>{try{const t=await(await fetch("/refresh-csrf")).json();document.querySelector('meta[name="csrf-token"]').setAttribute("content",t.csrf_token)}catch(e){u.error("Error refreshing CSRF token:",e)}};setInterval(Et,9e5);const vt=async e=>{try{const a=await(await fetch(`/games/get_game_points/${e}`,{credentials:"same-origin"})).json(),n=a.total_game_points,o=a.game_goal,i=o-n,r=Math.min(n/o*100,100),s=document.getElementById("meterBar"),d=document.querySelector(".meter-label");s&&(s.style.height=`${r}%`),document.documentElement.style.setProperty("--meter-fill-height",`${r}%`),d&&(d.innerText=`Remaining Reduction: ${i} / ${o}`)}catch(t){u.error("Failed to update meter:",t)}};function wt(){const e=document.getElementById("game_IdHolder"),t=document.getElementById("gameNameHeader");if(!e||!t)return;const a=e.getAttribute("data-game-id");fetch(`/games/get_game/${a}`,{credentials:"same-origin"}).then(n=>{if(!n.ok)throw u.error(`Failed fetching game name; URL returned status ${n.status} (${n.statusText})`),t.textContent="Error Loading Game",new Error(`HTTP ${n.status}: ${n.statusText}`);return n.json()}).then(n=>{t.textContent=n.name||"Game Not Found"}).catch(n=>{u.error("Error retrieving game name:",n),t.textContent="Error Loading Game"})}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("leaderboardButton");e&&e.addEventListener("click",async()=>{const g=e.getAttribute("data-game-id");(await V(()=>import("./chunk-DIr4udqN.js"),__vite__mapDeps([0,1]))).showLeaderboardModal(g),vt(g)});const t=document.getElementById("submissionsButton");t&&t.addEventListener("click",()=>{currentUserId!=="none"&&et(currentUserId)});const a=document.getElementById("contactForm");a&&a.addEventListener("submit",async g=>{g.preventDefault();const b=new FormData(a);K();try{const c=await fetch(a.action,{method:"POST",body:b,headers:{"X-Requested-With":"XMLHttpRequest"}}),f=await c.json();c.ok&&f.success?(alert("Your message has been sent successfully."),T("contactModal")):alert("Failed to send your message. Please try again.")}catch{alert("Failed to send your message. Please try again.")}finally{Z()}}),document.getElementById("message-input")&&(document.querySelector("form").onsubmit=()=>!0),document.querySelectorAll(".activity-message").forEach(g=>{g.innerHTML=g.innerHTML.replace(/<\/?p[^>]*>/g,"")});const o=document.getElementById("questSearchInput"),i=document.getElementById("questCategoryDropdown");o&&o.addEventListener("input",re),i&&i.addEventListener("change",re);const r=document.querySelector("#whats-happening-step");if(r){const g=r.querySelectorAll(".wh-tab-button"),b=r.querySelectorAll(".wh-tab-content");g.forEach(c=>{c.addEventListener("click",()=>{const f=c.getAttribute("data-wh-tab");g.forEach(h=>h.classList.remove("active")),b.forEach(h=>h.classList.remove("active")),c.classList.add("active"),r.querySelector(`#wh-${f}-tab`).classList.add("active")})})}const s=document.querySelectorAll(".quest-tab-navigation .quest-tab-button"),d=document.querySelectorAll(".quest-tab-content"),l=document.getElementById("questSearchInput"),m=document.getElementById("questCategoryGroup");s.length&&d.length&&s.forEach(g=>{g.addEventListener("click",()=>{const b=g.getAttribute("data-quest-tab");s.forEach(c=>c.classList.remove("active")),d.forEach(c=>c.classList.remove("active")),g.classList.add("active"),document.getElementById(`${b}-tab`).classList.add("active"),b==="calendar-quests"?(l&&(l.style.display="none"),m&&(m.style.display="none")):(l&&(l.style.display=""),m&&(m.style.display=""))})}),wt();const y=document.getElementById("clearCalendarQuestsBtn");y&&y.addEventListener("click",async()=>{if(!confirm("Delete all upcoming calendar quests?"))return;const g=y.getAttribute("data-game-id");K();try{const{status:b,json:c}=await v(`/quests/game/${g}/clear_calendar`,{method:"DELETE"});b===200&&c.success?window.location.reload():alert(c.message||"Failed to clear quests")}catch(b){u.error("Failed to clear calendar quests",b),alert("Failed to clear calendar quests.")}finally{Z()}})});function re(){const e=document.getElementById("questSearchInput").value.trim().toLowerCase(),t=document.getElementById("questCategoryDropdown").value;document.querySelectorAll("#questTableBody tr.quest-row").forEach(n=>{const o=n.querySelector(".quest-title").textContent.toLowerCase(),i=n.dataset.category||"Not Set",r=o.includes(e),s=t==="all"||i===t;n.style.display=r&&s?"":"none"})}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("joinCustomGameModal");if(!e)return;document.querySelectorAll("#customGameList .list-group-item").forEach(function(o){o.addEventListener("click",function(){const i=this.getAttribute("data-game-code");confirm("Do you want to join â€˜"+this.textContent.trim()+"â€™?")&&(document.getElementById("customGameCodeInput").value=i,document.getElementById("joinCustomGameForm").submit())})});const t=e.dataset.hasJoined==="1",a=e.dataset.joinDemoUrl;let n=!1;document.getElementById("joinCustomGameForm").addEventListener("submit",()=>{n=!0}),e.addEventListener("hidden.bs.modal",function(){!n&&!t&&(window.location.href=a)})});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("loginForm"),t=document.getElementById("loginModal");if(!e||!t)return;const a=document.getElementById("passwordError"),n=document.getElementById("forgotPasswordLink"),o=t.querySelector("[data-register-from-login]"),i=t.dataset.checkUrl;e.addEventListener("submit",m=>{m.preventDefault(),a.style.display="none",n&&(n.style.display="none"),W(e).then(({json:y})=>{y.success?window.location.href=y.redirect:(a.textContent=y.error,a.style.display="block",y.show_forgot&&n&&(n.style.display="block"))}).catch(()=>e.submit())});const r=document.getElementById("loginEmail"),s=document.getElementById("loginButton"),d=document.getElementById("emailError");function l(){s.disabled=!0,d.style.display="none",d.textContent="",n&&(n.style.display="none")}l(),n&&n.addEventListener("click",m=>{m.preventDefault(),ke()}),o&&o.addEventListener("click",m=>{m.preventDefault(),Le()}),r.addEventListener("blur",()=>{const m=r.value.trim();if(!m)return l();fetch(`${i}?email=${encodeURIComponent(m)}`).then(y=>y.json()).then(y=>{y.exists?s.disabled=!1:(s.disabled=!0,d.textContent="This email is not registered. Please register first.",d.style.display="block")}).catch(()=>s.disabled=!1)}),r.addEventListener("input",l)});let k=null;const Ct={qr_code:"QR Code",photo:"Photo Upload",comment:"Comment",photo_comment:"Photo Upload and Comment",video:"Video Upload"},we={none:"No Badge (points only)",individual:"Individual Badge",category:"Category Badge",both:"Both Individual and Category"};let H=[];function de(){const e=document.getElementById("game_Data");if(!e)return;k=e.dataset.gameId;const t=document.getElementById("deleteAllQuestsBtn");t&&t.addEventListener("click",_t);const a=document.getElementById("importQuestsBtn");a&&a.addEventListener("click",Dt),It().then(()=>M(k))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",de):de();async function It(){try{const e=await fetch("/badges");if(!e.ok)throw new Error("Failed to fetch badges");if(!(e.headers.get("content-type")||"").includes("application/json"))throw new Error("Invalid badge response");const a=await e.json();H=Array.isArray(a.badges)?a.badges:[]}catch(e){u.error("Error fetching badges:",e),H=[]}}function Ce(e){const t=document.querySelector(`#quest-${e}`),a={};t.querySelectorAll(".editable").forEach(n=>{a[n.getAttribute("data-name")]=n.innerHTML}),Bt(t),Lt(t),$t(t),kt(t),xt(t),qt(t,e,a)}function _t(){confirm("Are you sure you want to delete all quests? This action cannot be undone.")&&x(`/quests/game/${k}/get_title`).then(({json:e})=>{const t=e.title;confirm(`This will delete all quests for the game: "${t}". Are you absolutely sure? This action cannot be undone.`)&&v(`/quests/game/${k}/delete_all`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})}).then(({json:a})=>{a.success?(alert("All quests deleted successfully"),M(k)):alert(`Failed to delete quests: ${a.message}`)}).catch(a=>{u.error("Error:",a),alert("Failed to delete all quests. Please check the console for more details.")})}).catch(e=>{u.error("Error fetching game title:",e),alert("Failed to fetch game title. Please check the console for more details.")})}function Bt(e){const t=e.querySelector('.editable[data-name="verification_type"]'),a=t.getAttribute("data-value").toLowerCase();let n='<select name="verification_type" class="editable-select">';Object.entries(Ct).forEach(([o,i])=>{const r=a===o.toLowerCase()?"selected":"";n+=`<option value="${o}" ${r}>${i}</option>`}),n+="</select>",t.innerHTML=n}function Lt(e){const t=e.querySelector('.editable[data-name="frequency"]'),a=t.getAttribute("data-value").toLowerCase();let n='<select name="frequency" class="editable-select">';Object.entries({daily:"Daily",weekly:"Weekly",monthly:"Monthly"}).forEach(([i,r])=>{const s=a===i.toLowerCase()?"selected":"";n+=`<option value="${i}" ${s}>${r}</option>`}),n+="</select>",t.innerHTML=n}function kt(e){const t=e.querySelector('.editable[data-name="badge_option"]'),a=t.getAttribute("data-value")||t.innerText.trim();let n='<select name="badge_option" class="editable-select">';Object.entries(we).forEach(([s,d])=>{n+=`<option value="${s}" ${a===s?"selected":""}>${d}</option>`}),n+="</select>",t.innerHTML=n;const o=e.querySelector('select[name="badge_id"]'),i=t.querySelector("select");function r(){["none","category"].includes(i.value)?(o.value="",o.disabled=!0):o.disabled=!1}o&&(r(),i.addEventListener("change",r))}function $t(e){const t=e.querySelector('.editable[data-name="badge_name"]');if(!t)return;const a=(t.textContent||"").trim();let n='<select name="badge_id" class="editable-select"><option value="">None</option>';H.forEach(o=>{const i=a===o.name?"selected":"";n+=`<option value="${o.id}" ${i}>${o.name}</option>`}),n+="</select>",t.innerHTML=n}function xt(e){[{name:"title",type:"text"},{name:"description",type:"textarea"},{name:"tips",type:"textarea"},{name:"points",type:"number"},{name:"badge_awarded",type:"number"},{name:"completion_limit",type:"number"},{name:"category",type:"text"},{name:"enabled",type:"select",options:["Yes","No"]},{name:"is_sponsored",type:"select",options:["Yes","No"]},{name:"from_calendar",type:"select",options:["Yes","No"]},{name:"calendar_event_id",type:"text"},{name:"calendar_event_start",type:"text"}].forEach(a=>{const n=e.querySelector(`.editable[data-name="${a.name}"]`);n&&St(n,a)})}function St(e,t){let a=e.getAttribute("data-value")||e.textContent.trim(),n;t.type==="select"?(n=document.createElement("select"),n.name=t.name,t.options.forEach(o=>{const i=document.createElement("option");i.value=o,i.text=o,a===i.text&&(i.selected=!0),n.appendChild(i)})):t.type==="textarea"?(n=document.createElement("textarea"),n.name=t.name,n.value=a):(n=document.createElement("input"),n.type=t.type,n.name=t.name,n.value=a),e.innerHTML="",e.appendChild(n)}function qt(e,t,a){const n=e.querySelector(".edit-button");n.innerText="Save",n.onclick=()=>Pt(t);const o=document.createElement("button");o.innerText="Cancel",o.className="btn btn-secondary ms-2 cancel-button",o.onclick=()=>{Tt(e,a,n,t)},n.parentNode.insertBefore(o,n.nextSibling)}function Tt(e,t,a,n){Object.entries(t).forEach(([o,i])=>{const r=e.querySelector(`.editable[data-name="${o}"]`);r&&(r.innerHTML=i)}),a.innerText="Edit",a.onclick=()=>Ce(n),e.querySelector(".cancel-button").remove()}function Pt(e){const t=document.querySelector(`#quest-${e}`);let a={};t.querySelectorAll("input, select, textarea").forEach(n=>{let o=n.value;typeof o=="string"&&(o=o.trim()),n.name==="enabled"||n.name==="is_sponsored"||n.name==="from_calendar"?o=n.value==="Yes":(n.name==="badge_id"&&o===""||n.name==="calendar_event_start"&&o===""||n.name==="calendar_event_id"&&o===""||n.name==="badge_awarded"&&o===""||n.name==="category"&&o==="")&&(o=null),a[n.name]=o}),v(`/quests/quest/${e}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(({json:n})=>{n.success?(alert("Quest updated successfully."),M(k)):alert("Failed to update quest. Error: "+n.message)}).catch(n=>{u.error("Error updating quest:",n),alert("Error updating quest. Please check console for details.")})}function M(e){x(`/quests/game/${e}/quests`).then(({json:t})=>{const a=document.getElementById("questsBody");if(!Array.isArray(t.quests)){u.error("Invalid quests response:",t);return}a.innerHTML="",t.quests.forEach(n=>{const o=document.createElement("div");o.className="card",o.id=`quest-${n.id}`;const i=(n.verification_type||"").toLowerCase(),r=n.badge_name||"None",s=n.frequency||"Not Set",d=n.category||"Not Set",l=n.badge_awarded??0,m=we[n.badge_option]||n.badge_option,y=n.from_calendar?"Yes":"No",g=n.calendar_event_id??"Not Set",b=n.calendar_event_start??"Not Set";o.innerHTML=`
                    <div class="card-body">
                        <h5 class="card-title editable" data-name="title">${n.title}</h5>
                        <div class="card-text editable" data-name="description">${n.description}</div>
                        <div class="card-text editable" data-name="tips">${n.tips||""}</div>
                        <p class="card-text"><strong>Points:</strong> <span class="editable" data-name="points">${n.points}</span></p>
                        <p class="card-text"><strong>Completion Limit:</strong> <span class="editable" data-name="completion_limit">${n.completion_limit}</span></p>
                        <p class="card-text"><strong>Enabled:</strong> <span class="editable" data-name="enabled">${n.enabled?"Yes":"No"}</span></p>
                        <p class="card-text"><strong>Pinned:</strong> <span class="editable" data-name="is_sponsored">${n.is_sponsored?"Yes":"No"}</span></p>
                        <p class="card-text"><strong>Verification:</strong> <span class="editable" data-name="verification_type" data-value="${n.verification_type}">${i}</span></p>
                        <p class="card-text"><strong>Badge:</strong> <span class="editable" data-name="badge_name">${r}</span></p>
                        <p class="card-text"><strong>Badge Awarded:</strong> <span class="editable" data-name="badge_awarded">${l}</span></p>
                        <p class="card-text"><strong>Badge Option:</strong> <span class="editable" data-name="badge_option" data-value="${n.badge_option}">${m}</span></p>
                        <p class="card-text"><strong>Frequency:</strong> <span class="editable" data-name="frequency" data-value="${n.frequency}">${s}</span></p>
                        <p class="card-text"><strong>Category:</strong> <span class="editable" data-name="category" data-value="${n.category??""}">${d}</span></p>
                        <p class="card-text"><strong>From Calendar:</strong> <span class="editable" data-name="from_calendar">${y}</span></p>
                        <p class="card-text"><strong>Calendar Event ID:</strong>
                            <span class="editable" data-name="calendar_event_id" data-value="${n.calendar_event_id??""}">${g}</span>
                        </p>
                        <p class="card-text"><strong>Event Start:</strong>
                            <span
                                class="editable"
                                data-name="calendar_event_start"
                                data-value="${n.calendar_event_start??""}"
                            >${b}</span>
                        </p>
                        <p class="card-text"><strong>Quest ID:</strong> ${n.id}</p>
                        <p class="card-text"><strong>Game ID:</strong> ${n.game_id}</p>
                        <p class="card-text"><strong>Badge ID:</strong> ${n.badge_id??"N/A"}</p>
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-warning edit-button" data-quest-id="${n.id}">Edit</button>
                            <button class="btn btn-danger delete-button" data-quest-id="${n.id}">Delete</button>
                            <button class="btn btn-info qr-button" data-quest-id="${n.id}">Generate QR Code</button>
                        </div>
                    </div>
                `,a.appendChild(o);const c=o.querySelector(".edit-button"),f=o.querySelector(".delete-button"),h=o.querySelector(".qr-button");c&&(c.onclick=()=>Ce(n.id)),f&&f.addEventListener("click",()=>At(n.id)),h&&h.addEventListener("click",()=>Mt(n.id))})}).catch(t=>u.error("Failed to load quests:",t))}function At(e){v(`/quests/quest/${e}/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})}).then(({json:t})=>{t.success?(alert("Quest deleted successfully"),M(k)):alert(`Failed to delete quest: ${t.message}`)}).catch(t=>{u.error("Error:",t),alert("Failed to delete quest. Please check the console for more details.")})}function Dt(){const e=document.getElementById("importQuestsForm"),t=new FormData(e);v(`/quests/game/${k}/import_quests`,{method:"POST",body:t}).then(({json:a})=>{a.success&&a.redirectUrl?(alert("Quests imported successfully"),M(k)):alert("Failed to import quests: "+a.message)}).catch(a=>{u.error("Error importing quests:",a)})}function Mt(e){const t=`/quests/generate_qr/${e}`;fetch(t).then(a=>{if(!a.ok)throw new Error("Failed to generate QR code");return a.blob()}).then(a=>{const n=URL.createObjectURL(a);window.open(n,"_blank")}).catch(a=>{u.error("Error generating QR code:",a),alert("Failed to generate QR code. Please check console for more details.")})}document.addEventListener("DOMContentLoaded",()=>{});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("notifMenu");if(!e)return;const t=document.getElementById("notifBellToggle"),a=e.querySelector("#notifLoading"),n=e.querySelector("li.dropdown-footer"),o=n.querySelector("#loadMoreBtn"),i=e.dataset.url;let r=0,s=1;const d=parseInt(e.dataset.perPage,10)||10;let l=0;const m={follow:({from_user_name:c,from_user_id:f})=>({text:`Now following ${c}`,onClick:()=>L(f)}),followed_by:({follower_name:c,follower_id:f})=>({text:`${c} is now following you`,onClick:()=>L(f)}),submission:({actor_name:c,quest_name:f,submission_id:h})=>({text:`${c} submitted a new â€œ${f}â€ quest`,onClick:async()=>{const C=await(await fetch(`/quests/submissions/${h}`)).json();q(C)}}),profile_message:({from_user_name:c,content:f,profile_user_id:h})=>({text:`${c} says â€œ${f}â€`,onClick:()=>L(h)}),profile_reply:({from_user_name:c,content:f,profile_user_id:h})=>({text:`${c} replied â€œ${f}â€`,onClick:()=>L(h)}),submission_like:({liker_name:c,submission_id:f})=>({text:`${c} liked your submission`,onClick:async()=>{const E=await(await fetch(`/quests/submissions/${f}`,{credentials:"same-origin"})).json();q(E)}}),submission_reply:({actor_name:c,content:f,submission_id:h})=>({text:`${c} replied â€œ${f}â€`,onClick:async()=>{const C=await(await fetch(`/quests/submissions/${h}`,{credentials:"same-origin"})).json();q(C)}}),quest_complete:({quest_title:c,submission_id:f})=>({text:`Quest â€œ${c}â€ completed`,onClick:async()=>{const E=await(await fetch(`/quests/submissions/${f}`,{credentials:"same-origin"})).json();q(E)}})};function y(c){const f=m[c.type];let h,E;if(f&&c.payload)try{({text:h,onClick:E}=f(c.payload))}catch(w){u.error(`Error in handler for ${c.type}:`,w)}(!h||!E)&&(h=c.payload.summary||JSON.stringify(c.payload),E=()=>{window.location.href="/notifications/"});const C=c.is_read?"":"fw-bold",p=document.createElement("a");p.href="#",p.className=`dropdown-item ${C}`,p.appendChild(document.createTextNode(h));const I=document.createElement("small");I.className="text-muted d-block text-center",I.textContent=new Date(c.when).toLocaleString(),p.appendChild(I),p.addEventListener("click",async w=>{w.preventDefault();try{await E()}catch(A){u.error(A)}});const _=document.createElement("li");return _.appendChild(p),_}function g(c){c&&c.parentNode===e&&e.removeChild(c)}async function b(c){c===1&&(Array.from(e.children).forEach(C=>{C!==a&&C!==n&&e.removeChild(C)}),r=0,l=0),g(a),g(n),e.appendChild(a),e.appendChild(n),a.style.display="",o.disabled=!0;let f;try{f=await fetch(`${i}?page=${c}&per_page=${d}`,{credentials:"include"})}catch(C){a.textContent="Network error.",u.error(C);return}if(!f.ok){a.textContent="Error loading.",u.error("Status:",f.status,f.statusText);return}const h=await f.json();r=h.page,s=h.total_pages,g(a),g(n);const E=t.querySelector(".badge");E&&E.remove(),h.items.forEach(C=>{if(l>0){const p=document.createElement("li"),I=document.createElement("hr");I.className="dropdown-divider",p.appendChild(I),e.appendChild(p)}e.appendChild(y(C)),l+=1}),e.appendChild(a),e.appendChild(n),a.style.display="none",o.disabled=r>=s}t.addEventListener("show.bs.dropdown",()=>{r===0&&b(1)}),o.addEventListener("click",c=>{c.preventDefault(),c.stopPropagation(),r<s&&b(r+1)})});document.addEventListener("DOMContentLoaded",()=>{var t,a;if(typeof window>"u"||typeof navigator>"u"||!("serviceWorker"in navigator)||!("PushManager"in window))return;const e=(a=(t=document.body)==null?void 0:t.dataset)==null?void 0:a.userId;!e||e==="none"||navigator.serviceWorker.ready.then(async n=>{try{const o=await fetch("/push/public_key");if(!o.ok)return;let i;try{({public_key:i}=await o.json())}catch(d){u.error("Push setup failed",d);return}if(!i||await n.pushManager.getSubscription())return;const s=await n.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:Nt(i)});await fetch("/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscription:s})})}catch(o){u.error("Push setup failed",o)}})});function Nt(e){const t="=".repeat((4-e.length%4)%4),a=(e+t).replace(/-/g,"+").replace(/_/g,"/"),n=atob(a),o=new Uint8Array(n.length);for(let i=0;i<n.length;++i)o[i]=n.charCodeAt(i);return o}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("registerEmail");if(!e)return;const t=document.getElementById("registerModal"),a=(t==null?void 0:t.dataset.checkUrl)||"/auth/check_email",n=(t==null?void 0:t.dataset.loginUrl)||"/auth/login",o=document.getElementById("existingUserLogin");if(!o)return;e.addEventListener("blur",()=>{const r=e.value.trim();r&&fetch(`${a}?email=${encodeURIComponent(r)}`).then(s=>s.json()).then(s=>{s.exists?o.style.display="block":o.style.display="none"}).catch(s=>{u.error("Error checking email:",s),o.style.display="none"})});const i=document.getElementById("loginWithExistingBtn");i&&i.addEventListener("click",()=>{const r=e.value.trim(),s=document.getElementById("existingUserPassword").value,d=document.getElementById("loginError"),l=document.getElementById("registerGameId").value,m=document.getElementById("registerQuestId").value,y=document.getElementById("registerNext").value,g=document.getElementById("registerShowJoinCustom").value,b=new FormData;b.append("email",r),b.append("password",s),b.append("remember_me","true"),l&&b.append("game_id",l),m&&b.append("quest_id",m),y&&b.append("next",y),g&&b.append("show_join_custom",g),fetch(n,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:b,credentials:"same-origin"}).then(c=>(c.headers.get("content-type")||"").includes("application/json")?c.json():(window.location.href=c.url,null)).then(c=>{c&&(c.success?window.location.href=c.redirect:(d.textContent=c.error,d.style.display="block"))}).catch(c=>{u.error("Login error:",c),d.textContent="An error occurred. Please try again.",d.style.display="block"})}),e.addEventListener("input",()=>{o.style.display="none",document.getElementById("loginError").style.display="none"})});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("resetForm");if(!e)return;const t=document.getElementById("resetError"),a=document.getElementById("resetSuccess"),n=document.getElementById("resetButton");e.addEventListener("submit",o=>{o.preventDefault(),t.style.display="none",a.style.display="none",W(e).then(({json:i})=>{i.success?(a.textContent=i.message,a.style.display="block",n.disabled=!0,i.redirect&&setTimeout(()=>{window.location.href=i.redirect},1200)):(t.textContent=i.error||"Unable to reset password.",t.style.display="block")}).catch(i=>{u.error("Reset-password AJAX error:",i),e.submit()})})});document.addEventListener("DOMContentLoaded",()=>{const e="shoutBoardModal",t=document.getElementById("shoutBoardForm"),a=document.getElementById("shoutSubmitBtn"),n=document.getElementById("shoutMessageInput");window.addEventListener("openModal",o=>{o.detail===e&&n&&(n.value="")}),a.addEventListener("click",()=>{const o=n?n.value.trim():"";if(!o){alert("Please enter a message.");return}if(o.length>500){alert("Message must be 500 characters or fewer.");return}const i=new FormData(t);fetch(t.action,{method:"POST",body:i,credentials:"same-origin"}).then(r=>{if(!r.ok)throw new Error(`Server responded ${r.status}`);return r.text()}).then(()=>{T(e),location.reload()}).catch(r=>{u.error("Failed to post shout:",r),alert("Could not post. Please try again.")})})});var le;(le=document.getElementById("gameFilter"))==null||le.addEventListener("change",function(){const e=this.value;e?window.location.href=`/admin/user_management/game/${encodeURIComponent(e)}`:window.location.href="/admin/user_management"});document.addEventListener("DOMContentLoaded",()=>{qe()});export{L as a,B as o,et as s};
