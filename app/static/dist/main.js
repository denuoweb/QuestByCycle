const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["chunk-CO5dhCb3.js","chunk-CQX76gJg.js","chunk-BKUjx4om.js"])))=>i.map(i=>d[i]);
import{o as _,l as m,c as v,_ as V,f as D,s as M,a as O,b as X,h as P,d as oe,r as re}from"./chunk-CQX76gJg.js";import{s as L,a as x}from"./chunk-BKUjx4om.js";function U(e){e.waiting&&e.waiting.postMessage({type:"SKIP_WAITING"})}function se(e){try{const t=new URL(e,window.location.origin);return t.origin===window.location.origin&&t.protocol!=="javascript:"}catch{return m.error(`Invalid URL: ${e}`),!1}}function ie(){var s;if("serviceWorker"in navigator){let d=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{d||(d=!0,window.location.reload())});const l=((s=document.querySelector("meta[name='asset-version']"))==null?void 0:s.content)||"";navigator.serviceWorker.register(`/sw.js?v=${l}`).then(c=>{c.addEventListener("updatefound",()=>{const p=c.installing;p.addEventListener("statechange",()=>{p.state==="installed"&&navigator.serviceWorker.controller&&(m.info("Service worker updated; skipping waiting."),U(c))})}),"SyncManager"in window&&c.sync.register("sync-notifications").catch(p=>m.error("Sync registration failed:",p)),c.periodicSync&&c.periodicSync.register("periodic-notifications",{minInterval:24*60*60*1e3}).catch(p=>m.error("Periodic sync registration failed:",p)),"PushManager"in window&&Notification.permission==="default"&&Notification.requestPermission(),"sync"in c&&c.sync.register("sync-requests").catch(p=>{m.error("Background sync registration failed:",p)})}).catch(c=>m.error("Service Worker registration failed:",c)),navigator.serviceWorker.addEventListener("message",c=>{c.data.type==="UPDATE_AVAILABLE"&&navigator.serviceWorker.getRegistration().then(p=>{p&&(m.info("Update available message received; skipping waiting."),U(p))})})}const e=document.getElementById("install"),t=document.getElementById("manual-install"),o=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);let n=null;const a=document.getElementById("leaderboardNavbarLink");t&&(o?t.hidden=!1:t.hidden=!0);const r=document.body.getAttribute("data-user-id");if(r&&r!=="none"){const d=Intl.DateTimeFormat().resolvedOptions().timeZone;v(`/profile/${r}/timezone`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({timezone:d})}).catch(l=>m.error("Failed to send timezone:",l))}if(e&&(window.addEventListener("beforeinstallprompt",d=>{d.preventDefault(),n=d,e.hidden=!1,e.addEventListener("click",()=>{n&&(n.prompt(),n.userChoice.then(()=>{n=null,e.hidden=!0}))})}),window.beforeinstallprompt||(e.hidden=!0,!o&&t&&(t.hidden=!0)),window.addEventListener("appinstalled",()=>{e.hidden=!0,t&&(t.hidden=!0)}),navigator.getInstalledRelatedApps&&navigator.getInstalledRelatedApps().then(d=>{d.length&&(e.hidden=!0)})),a&&a.addEventListener("click",async d=>{d.preventDefault();const l=a.getAttribute("data-game-id")||0;(await V(()=>import("./chunk-CO5dhCb3.js"),__vite__mapDeps([0,1,2]))).showLeaderboardModal(l)}),"windowControlsOverlay"in navigator){let d=function(){const l=navigator.windowControlsOverlay.getTitlebarAreaRect();document.body.style.paddingTop=l.height+"px"};navigator.windowControlsOverlay.addEventListener("geometrychange",d),d()}document.querySelectorAll(".modal").forEach(d=>{d.parentNode!==document.body&&document.body.appendChild(d)})}function de(e){const t=e.value;t==="join_custom_game"?_("joinCustomGameModal"):se(t)?window.location.href=t:m.error(`Blocked unsafe URL: ${t}`)}document.addEventListener("click",e=>{const t=e.target.closest("[data-game-selection]");t&&(e.preventDefault(),de({value:t.getAttribute("data-game-selection")}))});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("quest-form");e&&e.addEventListener("submit",t=>{document.getElementById("description").value.trim()||(alert("Description is required."),t.preventDefault())})});const ce=document.querySelector('meta[name="placeholder-image"]').getAttribute("content");let q=0,z=null,G=!1,R=!1,A=[];function H(e){q=0,z=e,A=[];const t=document.getElementById("allSubmissionsContainer");t&&(t.innerHTML=""),_("allSubmissionsModal"),K()}function K(){const e=q*10;D(`/quests/quest/all_submissions?game_id=${z}&offset=${e}&limit=10`).then(({json:t})=>{if(t.error)throw new Error(t.error);G=t.is_admin,R=t.has_more,le(t.submissions,G,q>0),ue(R),q+=1}).catch(t=>{m.error("Error fetching all submissions:",t),alert("Error fetching all submissions: "+t.message)})}function le(e,t,o=!1){const n=document.getElementById("allSubmissionsContainer");if(!n){m.error("allSubmissionsContainer element not found.");return}o||(n.innerHTML=""),e.forEach(a=>{const r=document.createElement("div");r.className="submission-card";const s=document.createElement("img");s.src=a.image_url||ce,s.alt="Quest Submission",s.className="submission-image";const d=document.createElement("div");d.className="submission-info";const l=document.createElement("p");l.textContent=`User: ${a.user_display_name||a.user_username}`,l.className="submission-user-details";const c=document.createElement("p"),p=new Date(a.timestamp).toLocaleString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0});c.textContent=`Submitted on: ${p}`,c.className="submission-timestamp";const h=document.createElement("p");h.textContent=`Comment: ${a.comment}`,h.className="submission-comment";const g=document.createElement("p");g.textContent=`Twitter: ${a.twitter_url||"N/A"}`,g.className="submission-comment";const f=document.createElement("p");f.textContent=`Facebook: ${a.fb_url||"N/A"}`,f.className="submission-comment";const i=document.createElement("p");if(i.textContent=`Instagram: ${a.instagram_url||"N/A"}`,i.className="submission-comment",d.appendChild(l),d.appendChild(c),d.appendChild(h),d.appendChild(g),d.appendChild(f),d.appendChild(i),t){const b=document.createElement("button");b.textContent="Delete",b.className="button delete-button",b.addEventListener("click",function(E){E.stopPropagation(),me(a.id)}),r.appendChild(b)}r.appendChild(s),r.appendChild(d);const u={id:a.id,quest_id:a.quest_id,url:a.image_url||a.video_url,video_url:a.video_url,comment:a.comment,user_id:a.user_id,user_display_name:a.user_display_name||a.user_username,user_profile_picture:a.user_profile_picture,twitter_url:a.twitter_url,fb_url:a.fb_url,instagram_url:a.instagram_url,like_count:a.like_count,liked_by_current_user:a.liked_by_current_user,verification_type:"image"},y=A.push(u)-1;r.addEventListener("click",function(){L({...u,read_only:!0,album_items:A,album_index:y})}),n.appendChild(r)})}function me(e){v(`/quests/quest/delete_submission/${e}`,{method:"POST"}).then(({json:t})=>{if(t.success)alert("Submission deleted successfully.");else throw new Error(t.message)}).catch(t=>{m.error("Error deleting submission:",t),alert("Error during deletion: "+t.message)})}function ue(e){const t=document.getElementById("loadMoreSubmissions");t&&(t.style.display=e?"block":"none")}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("loadMoreSubmissions");e&&e.addEventListener("click",()=>{K()})});document.addEventListener("DOMContentLoaded",()=>{ge(),document.querySelectorAll("[data-toggle-form]").forEach(e=>{e.addEventListener("click",()=>pe(e.dataset.toggleForm))})});function Z(){const e=document.getElementById("game_IdHolder");if(!e)return null;const t=e.getAttribute("data-game-id");return t&&t!=="0"?t:null}function ge(){const e=document.getElementById("badgesBody");if(!e)return;const t=Z(),o=t?`?game_id=${t}`:"";fetch(`/badges${o}`).then(n=>{if(!n.ok)throw new Error("Failed to fetch badges");if(!(n.headers.get("content-type")||"").includes("application/json"))throw new Error("Invalid badge response");return n.json()}).then(n=>{const a=Array.isArray(n.badges)?n.badges:[];e.innerHTML="",a.forEach(r=>{const s=document.createElement("tr");s.dataset.badgeId=r.id;const d=document.createElement("td");if(d.className="badge-image-manage",r.image){const i=document.createElement("img");i.src=r.image,i.height=50,i.alt="Badge Image",d.appendChild(i)}else d.textContent="No Image";s.appendChild(d);const l=document.createElement("td");l.className="badge-name",l.textContent=r.name,s.appendChild(l);const c=document.createElement("td");c.className="badge-description",c.textContent=r.description,s.appendChild(c);const p=document.createElement("td");p.className="badge-category",p.textContent=r.category||"None",s.appendChild(p);const h=document.createElement("td"),g=document.createElement("button");g.className="edit-badge",g.dataset.badgeId=r.id,g.textContent="Edit",g.addEventListener("click",()=>ye(r.id));const f=document.createElement("button");f.className="delete-badge",f.dataset.badgeId=r.id,f.textContent="Delete",f.addEventListener("click",()=>be(r.id)),h.appendChild(g),h.appendChild(f),s.appendChild(h),e.appendChild(s)})}).catch(n=>m.error("Failed to load badges:",n))}function pe(e){const t=document.getElementById(e);t&&t.classList.toggle("d-none")}function fe(e){const t=Z(),o=t?`?game_id=${t}`:"";return fetch(`/badges/categories${o}`).then(n=>{if(!n.ok)throw new Error("Failed to fetch categories");if(!(n.headers.get("content-type")||"").includes("application/json"))throw new Error("Invalid category response");return n.json()}).then(n=>{const a=Array.isArray(n.categories)?n.categories:[],r=document.createElement("select");r.className="form-control badge-category-select";const s=document.createElement("option");return s.value="none",s.textContent="None",(!e||e==="none")&&(s.selected=!0),r.appendChild(s),a.forEach(d=>{const l=document.createElement("option");l.value=d,l.textContent=d,d===e&&(l.selected=!0),r.appendChild(l)}),r}).catch(n=>{m.error("Error fetching categories:",n);const a=document.createElement("select");a.className="form-control badge-category-select";const r=document.createElement("option");return r.value="none",r.textContent="None",r.selected=!0,a.appendChild(r),a})}function ye(e){const t=document.querySelector(`tr[data-badge-id='${e}']`);if(!t){m.error(`Badge row with ID ${e} not found.`);return}const o=t.querySelector(".badge-name"),n=t.querySelector(".badge-description"),a=t.querySelector(".badge-category"),r=t.querySelector(".badge-image-manage");o.textContent="";const s=document.createElement("input");s.type="text",s.value=o.innerText.trim(),s.className="form-control badge-name-input",o.appendChild(s),n.textContent="";const d=document.createElement("textarea");if(d.className="form-control badge-description-textarea",d.value=n.innerText.trim(),n.appendChild(d),r){r.textContent="";const l=document.createElement("input");l.type="file",l.className="form-control-file badge-image-input",r.appendChild(l)}else m.error("Could not find badge-image-manage cell");fe(a.innerText.trim()).then(l=>{a.textContent="",a.appendChild(l);const c=t.querySelector("button.edit-badge");c.innerText="Save",c.onclick=()=>he(e)})}function he(e){const t=document.querySelector(`tr[data-badge-id='${e}']`),o=new FormData;o.append("name",t.querySelector(".badge-name-input").value.trim()),o.append("description",t.querySelector(".badge-description-textarea").value.trim()),o.append("category",t.querySelector(".badge-category-select").value);const n=t.querySelector(".badge-image-input");n&&n.files.length>0&&o.append("image",n.files[0]);const a=document.querySelector("[name=csrf_token]").value;o.append("csrf_token",a),v(`/badges/update/${e}`,{method:"POST",body:o}).then(({json:r})=>{r.success?(alert("Badge updated successfully"),window.location.reload()):alert("Failed to update badge: "+r.message)}).catch(r=>m.error("Error updating badge:",r))}function be(e){confirm("Are you sure you want to delete this badge?")&&v(`/badges/delete/${e}`,{method:"DELETE"}).then(({json:t})=>{t.success?window.location.reload():alert(`Failed to delete badge: ${t.message}`)}).catch(t=>{m.error("Error deleting badge:",t),alert("Error deleting badge. Please check console for details.")})}let B=[];const Q=document.querySelector('meta[name="placeholder-image"]'),N=Q?Q.getAttribute("content"):"";function Ee(e){try{const t=new URL(e,window.location.origin);if(t.protocol==="http:"||t.protocol==="https:")return e}catch{}return N}async function ve(){const e=document.getElementById("game_IdHolder"),t=e?e.getAttribute("data-game-id"):null,n=`/badges${t&&!isNaN(parseInt(t,10))&&t!=="0"?`?game_id=${t}`:""}`,a=await fetch(n,{credentials:"same-origin"});if(!a.ok)throw new Error("Error fetching badges");if(!(a.headers.get("content-type")||"").includes("application/json"))throw new Error("Invalid badge response");let s;try{s=await a.json()}catch{throw new Error("Error parsing badge data")}return B=Array.isArray(s.badges)?s.badges:[],B}async function ee(){if(!B||B.length===0)try{await ve()}catch(e){m.error("Error loading badges:",e),B=[]}}function Ce(e){if(!e)return null;const t=document.createElement("ul");return e.split(",").forEach(o=>{const n=document.createElement("li");n.textContent=o.trim(),t.appendChild(n)}),t}function we(e){return B.find(t=>t.id==e)}function Ie(e){return{id:e.getAttribute("data-badge-id"),name:e.getAttribute("data-badge-name")||"Badge",description:e.getAttribute("data-badge-description")||"",image:e.getAttribute("data-badge-image")||N}}async function Be(e){const t=await fetch(`/quests/detail/${encodeURIComponent(e)}/user_completion`);if(!t.ok)throw new Error("Failed to fetch user completions");const o=await t.json();return o.userCompletion?o.userCompletion.completions:0}function Le(e,t,o,n,a,r,s){const d=document.getElementById("badgeModalTitle"),l=document.getElementById("badgeModalImage"),c=document.getElementById("badgeModalText");if(!d||!l||!c){m.error("Badge modal elements missing");return}d.textContent=e.name,l.src=Ee(e.image)||N,c.textContent="";const p=document.createElement("p"),h=document.createElement("strong");if(h.textContent=a?"Awarded!":"Not Awarded Yet",p.appendChild(h),c.appendChild(p),r){const i=document.createElement("p");i.textContent=`Completion Requirement: ${t>1?t+" times":t+" time"}`,c.appendChild(i);const u=document.createElement("p");u.textContent=`Your Total Completions: ${o}`,c.appendChild(u);const y=document.createElement("p");if(a)y.textContent="You have earned this badge.";else{y.append("Complete ");const b=document.createElement("a");b.href="#",b.dataset.questDetail=r,b.textContent=s,y.appendChild(b),y.append(" to earn this badge.")}c.appendChild(y)}else{const i=document.createElement("p");i.textContent=`Completion Requirements: ${t} (per task)`,c.appendChild(i);const u=document.createElement("p");u.textContent=`Your Total Completions: ${o}`,c.appendChild(u),n&&c.appendChild(n);const y=document.createElement("p");y.textContent=a?"You have earned this badge.":"Complete one of the above tasks to earn this badge.",c.appendChild(y)}const g=e.description||"No description available.",f=document.createElement("p");f.textContent=g,a?(l.style.filter="none",l.oncontextmenu=null):(l.style.filter="grayscale(100%) opacity(0.5)",l.oncontextmenu=i=>(i.preventDefault(),!1)),c.appendChild(f)}async function _e(e){const t=e.getAttribute("data-badge-id"),o=e.getAttribute("data-task-name"),n=e.getAttribute("data-task-id"),a=e.getAttribute("data-badge-awarded-count"),r=e.getAttribute("data-user-completions"),s=parseInt(a,10),d=parseInt(r,10)||0,l=Ce(o),c=n?n.split(",").map(i=>i.trim()).filter(Boolean):[],p=c.length===1?c[0]:null;await ee();const h=we(t)||Ie(e);let g=d;if(p)try{g=await Be(p)}catch(i){m.error("Error fetching user completions:",i)}const f=g>=s;Le(h,s,g,l,f,p,o),_("badgeModal")}document.addEventListener("DOMContentLoaded",()=>{ee()});document.addEventListener("click",e=>{const t=e.target.closest("[data-open-badge]");t&&(e.preventDefault(),_e(t))});document.addEventListener("DOMContentLoaded",()=>{});let $;function Se(e){const t=document.getElementById("deleteGameModal"),o=document.getElementById("deleteGameForm"),n=document.getElementById("deleteGameConfirmInput"),a=document.getElementById("deleteGameCountdown"),r=document.getElementById("deleteGameTimer"),s=document.getElementById("deleteGameConfirmBtn");if(!t||!o||!n||!a||!r||!s){m.warn("Delete game modal elements missing");return}t.dataset.gameId=e,o.action=`/games/delete_game/${encodeURIComponent(e)}`,n.value="",s.disabled=!0,a.hidden=!0,r.textContent="5",_("deleteGameModal")}function j(){const e=document.getElementById("deleteGameConfirmInput"),t=document.getElementById("deleteGameConfirmBtn"),o=document.getElementById("deleteGameCountdown"),n=document.getElementById("deleteGameTimer"),a=document.getElementById("deleteGameUndo"),r=document.getElementById("deleteGameForm");!e||!t||!o||!n||!a||!r||(e.addEventListener("input",()=>{t.disabled=e.value.trim().toLowerCase()!=="delete"}),t.addEventListener("click",()=>{let s=5;o.hidden=!1,n.textContent=s.toString(),$=setInterval(()=>{s-=1,n.textContent=s.toString(),s<=0&&(clearInterval($),r.submit())},1e3)}),a.addEventListener("click",()=>{clearInterval($),o.hidden=!0,n.textContent="5",e.value="",t.disabled=!0}))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",j):j();document.addEventListener("click",e=>{const t=e.target.closest("[data-delete-game-id]");t&&(e.preventDefault(),Se(t.getAttribute("data-delete-game-id")))});document.addEventListener("DOMContentLoaded",()=>{});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("flash-data");if(!e)return;const t=JSON.parse(e.getAttribute("data-messages")||"[]");if(!t.length)return;const[o,n]=t[0],a=document.getElementById("flash-overlay");a.querySelector(".flash-content").textContent=n,a.querySelector(".flash-modal").classList.add(`flash-${o}`),requestAnimationFrame(()=>{a.classList.add("visible")});function r(){a.classList.remove("visible"),e.removeAttribute("data-messages")}a.querySelector(".flash-close").addEventListener("click",r),a.querySelector(".flash-ok-btn").addEventListener("click",r)});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("forgotForm");if(!e)return;const t=document.getElementById("forgotEmailError"),o=document.getElementById("forgotSuccess"),n=document.getElementById("forgotButton"),a=document.getElementById("forgotEmail"),r=document.getElementById("forgotEmailDisplay"),s=document.getElementById("forgotPasswordModal");new MutationObserver(()=>{s.style.display==="block"&&(r.textContent=a.value)}).observe(s,{attributes:!0,attributeFilter:["style"]}),e.addEventListener("submit",l=>{l.preventDefault(),t.style.display="none",o.style.display="none",M(e).then(({json:c})=>{c.success?(o.textContent=c.message,o.style.display="block",n.disabled=!0):(t.textContent=c.error||"An error occurred.",t.style.display="block")}).catch(()=>{e.submit()})})});document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("button[data-game-id]").forEach(o=>{o.addEventListener("click",function(){t(this)})});function t(o){const n=document.getElementById("questCreationForm"),a=o.getAttribute("data-game-id");n?n.addEventListener("submit",function(r){r.preventDefault();const s=document.getElementById("questDescription").value;v("/ai/generate_quest",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({description:s,game_id:a})}).then(({json:d})=>{const l=d;if(l.generated_quest_html){document.getElementById("generatedQuestContent").innerHTML=l.generated_quest_html,_("generateAIQuestModal");const c=document.getElementById("generateAIQuestModalForm");c&&c.setAttribute("data-game-id",a),c&&c.addEventListener("submit",function(i){i.preventDefault();const u=new FormData(c);v("/ai/create_quest",{method:"POST",body:u}).then(({json:y})=>{window.location.href="/",m.log(y)}).catch(y=>{m.error("Error:",y)})});const p=document.getElementById("generateAIImage"),h=document.getElementById("badge_description"),g=document.getElementById("aiBadgeImage"),f=document.getElementById("aiBadgeFilename");if(!p||!h||!g||!f){m.error("One or more elements not found in the DOM");return}p.addEventListener("click",function(){m.log("Generate AI Image button clicked");const i=h.value;if(m.log("Badge Description:",i),!i){alert("Please enter a badge description first.");return}v("/ai/generate_badge_image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({badge_description:i})}).then(({json:u})=>{if(m.log("Response data:",u),u.error)alert("Error generating badge image: "+u.error);else{const y=`${u.filename}`,b=`static/images/badge_images/${u.filename}`;g.src=b,g.style.display="block",f.value=y}}).catch(u=>{m.error("Fetch error:",u),alert("Error: "+u)})})}}).catch(d=>{alert("Error generating quest: "+d.message)})}):m.error("Form '#questCreationForm' not found.")}});const xe=async()=>{try{const t=await(await fetch("/refresh-csrf")).json();document.querySelector('meta[name="csrf-token"]').setAttribute("content",t.csrf_token)}catch(e){m.error("Error refreshing CSRF token:",e)}};setInterval(xe,9e5);const qe=async e=>{try{const o=await(await fetch(`/games/get_game_points/${e}`,{credentials:"same-origin"})).json(),n=o.total_game_points,a=o.game_goal,r=a-n,s=Math.min(n/a*100,100),d=document.getElementById("meterBar"),l=document.querySelector(".meter-label");d&&(d.style.height=`${s}%`),document.documentElement.style.setProperty("--meter-fill-height",`${s}%`),l&&(l.innerText=`Remaining Reduction: ${r} / ${a}`)}catch(t){m.error("Failed to update meter:",t)}};function ke(){const e=document.getElementById("game_IdHolder"),t=document.getElementById("gameNameHeader");if(!e||!t)return;const o=e.getAttribute("data-game-id");fetch(`/games/get_game/${o}`,{credentials:"same-origin"}).then(n=>{if(!n.ok)throw m.error(`Failed fetching game name; URL returned status ${n.status} (${n.statusText})`),t.textContent="Error Loading Game",new Error(`HTTP ${n.status}: ${n.statusText}`);return n.json()}).then(n=>{t.textContent=n.name||"Game Not Found"}).catch(n=>{m.error("Error retrieving game name:",n),t.textContent="Error Loading Game"})}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("leaderboardButton");e&&e.addEventListener("click",async()=>{const g=e.getAttribute("data-game-id");(await V(()=>import("./chunk-CO5dhCb3.js"),__vite__mapDeps([0,1,2]))).showLeaderboardModal(g),qe(g)});const t=document.getElementById("submissionsButton");t&&t.addEventListener("click",()=>{currentUserId!=="none"&&H(currentUserId)}),document.querySelectorAll("[data-open-all-submissions]").forEach(g=>{g.addEventListener("click",f=>{f.preventDefault();const i=g.getAttribute("data-game-id");i&&H(i)})});const o=document.getElementById("contactForm");o&&o.addEventListener("submit",async g=>{g.preventDefault();const f=new FormData(o);O();try{const i=await fetch(o.action,{method:"POST",body:f,headers:{"X-Requested-With":"XMLHttpRequest"}}),u=await i.json();i.ok&&u.success?(alert("Your message has been sent successfully."),X("contactModal")):alert("Failed to send your message. Please try again.")}catch{alert("Failed to send your message. Please try again.")}finally{P()}}),document.getElementById("message-input")&&(document.querySelector("form").onsubmit=()=>!0),document.querySelectorAll(".activity-message").forEach(g=>{g.innerHTML=g.innerHTML.replace(/<\/?p[^>]*>/g,"")});const a=document.getElementById("questSearchInput"),r=document.getElementById("questCategoryDropdown");a&&a.addEventListener("input",W),r&&r.addEventListener("change",W);const s=document.querySelector("#whats-happening-step");if(s){const g=s.querySelectorAll(".wh-tab-button"),f=s.querySelectorAll(".wh-tab-content");g.forEach(i=>{i.addEventListener("click",()=>{const u=i.getAttribute("data-wh-tab");g.forEach(y=>y.classList.remove("active")),f.forEach(y=>y.classList.remove("active")),i.classList.add("active"),s.querySelector(`#wh-${u}-tab`).classList.add("active")})})}const d=document.querySelectorAll(".quest-tab-navigation .quest-tab-button"),l=document.querySelectorAll(".quest-tab-content"),c=document.getElementById("questSearchInput"),p=document.getElementById("questCategoryGroup");d.length&&l.length&&d.forEach(g=>{g.addEventListener("click",()=>{const f=g.getAttribute("data-quest-tab");d.forEach(i=>i.classList.remove("active")),l.forEach(i=>i.classList.remove("active")),g.classList.add("active"),document.getElementById(`${f}-tab`).classList.add("active"),f==="calendar-quests"?(c&&(c.style.display="none"),p&&(p.style.display="none")):(c&&(c.style.display=""),p&&(p.style.display=""))})}),ke();const h=document.getElementById("clearCalendarQuestsBtn");h&&h.addEventListener("click",async()=>{if(!confirm("Delete all upcoming calendar quests?"))return;const g=h.getAttribute("data-game-id");O();try{const{status:f,json:i}=await v(`/quests/game/${g}/clear_calendar`,{method:"DELETE"});f===200&&i.success?window.location.reload():alert(i.message||"Failed to clear quests")}catch(f){m.error("Failed to clear calendar quests",f),alert("Failed to clear calendar quests.")}finally{P()}})});function W(){const e=document.getElementById("questSearchInput").value.trim().toLowerCase(),t=document.getElementById("questCategoryDropdown").value;document.querySelectorAll("#questTableBody tr.quest-row").forEach(n=>{const a=n.querySelector(".quest-title").textContent.toLowerCase(),r=n.dataset.category||"Not Set",s=a.includes(e),d=t==="all"||r===t;n.style.display=s&&d?"":"none"})}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("joinCustomGameModal");if(!e)return;document.querySelectorAll("#customGameList .list-group-item").forEach(function(a){a.addEventListener("click",function(){const r=this.getAttribute("data-game-code");confirm("Do you want to join ‘"+this.textContent.trim()+"’?")&&(document.getElementById("customGameCodeInput").value=r,document.getElementById("joinCustomGameForm").submit())})});const t=e.dataset.hasAnyGames==="1",o=e.dataset.joinDemoUrl;let n=!1;document.getElementById("joinCustomGameForm").addEventListener("submit",()=>{n=!0}),e.addEventListener("hidden.bs.modal",function(){!n&&!t&&(window.location.href=o)})});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("loginForm"),t=document.getElementById("loginModal");if(!e||!t)return;const o=document.getElementById("passwordError"),n=document.getElementById("forgotPasswordLink"),a=t.querySelector("[data-register-from-login]"),r=t.dataset.checkUrl;e.addEventListener("submit",p=>{p.preventDefault(),o.style.display="none",n&&(n.style.display="none"),M(e).then(({json:h})=>{h.success?window.location.href=h.redirect:(o.textContent=h.error,o.style.display="block",h.show_forgot&&n&&(n.style.display="block"))}).catch(()=>e.submit())});const s=document.getElementById("loginEmail"),d=document.getElementById("loginButton"),l=document.getElementById("emailError");function c(){d.disabled=!0,l.style.display="none",l.textContent="",n&&(n.style.display="none")}c(),n&&n.addEventListener("click",p=>{p.preventDefault(),oe()}),a&&a.addEventListener("click",p=>{p.preventDefault(),re()}),s.addEventListener("blur",()=>{const p=s.value.trim();if(!p)return c();fetch(`${r}?email=${encodeURIComponent(p)}`).then(h=>h.json()).then(h=>{h.exists?d.disabled=!1:(d.disabled=!0,l.textContent="This email is not registered. Please register first.",l.style.display="block")}).catch(()=>d.disabled=!1)}),s.addEventListener("input",c)});let w=null;const $e={qr_code:"QR Code",photo:"Photo Upload",comment:"Comment",photo_comment:"Photo Upload and Comment",video:"Video Upload"},te={none:"No Badge (points only)",individual:"Individual Badge",category:"Category Badge",both:"Both Individual and Category"};let T=[];function J(){const e=document.getElementById("game_Data");if(!e)return;w=e.dataset.gameId;const t=document.getElementById("deleteAllQuestsBtn");t&&t.addEventListener("click",Te);const o=document.getElementById("importQuestsBtn");o&&o.addEventListener("click",Qe),Ae().then(()=>S(w))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",J):J();async function Ae(){try{const e=await fetch("/badges");if(!e.ok)throw new Error("Failed to fetch badges");if(!(e.headers.get("content-type")||"").includes("application/json"))throw new Error("Invalid badge response");const o=await e.json();T=Array.isArray(o.badges)?o.badges:[]}catch(e){m.error("Error fetching badges:",e),T=[]}}function ne(e){const t=document.querySelector(`#quest-${e}`),o={};t.querySelectorAll(".editable").forEach(n=>{o[n.getAttribute("data-name")]=n.innerHTML}),De(t),Me(t),Fe(t),Ne(t),Oe(t),Ue(t,e,o)}function Te(){confirm("Are you sure you want to delete all quests? This action cannot be undone.")&&D(`/quests/game/${w}/get_title`).then(({json:e})=>{const t=e.title;confirm(`This will delete all quests for the game: "${t}". Are you absolutely sure? This action cannot be undone.`)&&v(`/quests/game/${w}/delete_all`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})}).then(({json:o})=>{o.success?(alert("All quests deleted successfully"),S(w)):alert(`Failed to delete quests: ${o.message}`)}).catch(o=>{m.error("Error:",o),alert("Failed to delete all quests. Please check the console for more details.")})}).catch(e=>{m.error("Error fetching game title:",e),alert("Failed to fetch game title. Please check the console for more details.")})}function De(e){const t=e.querySelector('.editable[data-name="verification_type"]'),o=t.getAttribute("data-value").toLowerCase();let n='<select name="verification_type" class="editable-select">';Object.entries($e).forEach(([a,r])=>{const s=o===a.toLowerCase()?"selected":"";n+=`<option value="${a}" ${s}>${r}</option>`}),n+="</select>",t.innerHTML=n}function Me(e){const t=e.querySelector('.editable[data-name="frequency"]'),o=t.getAttribute("data-value").toLowerCase();let n='<select name="frequency" class="editable-select">';Object.entries({daily:"Daily",weekly:"Weekly",monthly:"Monthly"}).forEach(([r,s])=>{const d=o===r.toLowerCase()?"selected":"";n+=`<option value="${r}" ${d}>${s}</option>`}),n+="</select>",t.innerHTML=n}function Ne(e){const t=e.querySelector('.editable[data-name="badge_option"]'),o=t.getAttribute("data-value")||t.innerText.trim();let n='<select name="badge_option" class="editable-select">';Object.entries(te).forEach(([d,l])=>{n+=`<option value="${d}" ${o===d?"selected":""}>${l}</option>`}),n+="</select>",t.innerHTML=n;const a=e.querySelector('select[name="badge_id"]'),r=t.querySelector("select");function s(){["none","category"].includes(r.value)?(a.value="",a.disabled=!0):a.disabled=!1}a&&(s(),r.addEventListener("change",s))}function Fe(e){const t=e.querySelector('.editable[data-name="badge_name"]');if(!t)return;const o=(t.textContent||"").trim();let n='<select name="badge_id" class="editable-select"><option value="">None</option>';T.forEach(a=>{const r=o===a.name?"selected":"";n+=`<option value="${a.id}" ${r}>${a.name}</option>`}),n+="</select>",t.innerHTML=n}function Oe(e){[{name:"title",type:"text"},{name:"description",type:"textarea"},{name:"tips",type:"textarea"},{name:"points",type:"number"},{name:"badge_awarded",type:"number"},{name:"completion_limit",type:"number"},{name:"category",type:"text"},{name:"enabled",type:"select",options:["Yes","No"]},{name:"is_sponsored",type:"select",options:["Yes","No"]},{name:"from_calendar",type:"select",options:["Yes","No"]},{name:"calendar_event_id",type:"text"},{name:"calendar_event_start",type:"text"}].forEach(o=>{const n=e.querySelector(`.editable[data-name="${o.name}"]`);n&&Pe(n,o)})}function Pe(e,t){let o=e.getAttribute("data-value")||e.textContent.trim(),n;t.type==="select"?(n=document.createElement("select"),n.name=t.name,t.options.forEach(a=>{const r=document.createElement("option");r.value=a,r.text=a,o===r.text&&(r.selected=!0),n.appendChild(r)})):t.type==="textarea"?(n=document.createElement("textarea"),n.name=t.name,n.value=o):(n=document.createElement("input"),n.type=t.type,n.name=t.name,n.value=o),e.innerHTML="",e.appendChild(n)}function Ue(e,t,o){const n=e.querySelector(".edit-button");n.innerText="Save",n.onclick=()=>Re(t);const a=document.createElement("button");a.innerText="Cancel",a.className="btn btn-secondary ms-2 cancel-button",a.onclick=()=>{Ge(e,o,n,t)},n.parentNode.insertBefore(a,n.nextSibling)}function Ge(e,t,o,n){Object.entries(t).forEach(([a,r])=>{const s=e.querySelector(`.editable[data-name="${a}"]`);s&&(s.innerHTML=r)}),o.innerText="Edit",o.onclick=()=>ne(n),e.querySelector(".cancel-button").remove()}function Re(e){const t=document.querySelector(`#quest-${e}`);let o={};t.querySelectorAll("input, select, textarea").forEach(n=>{let a=n.value;typeof a=="string"&&(a=a.trim()),n.name==="enabled"||n.name==="is_sponsored"||n.name==="from_calendar"?a=n.value==="Yes":(n.name==="badge_id"&&a===""||n.name==="calendar_event_start"&&a===""||n.name==="calendar_event_id"&&a===""||n.name==="badge_awarded"&&a===""||n.name==="category"&&a==="")&&(a=null),o[n.name]=a}),v(`/quests/quest/${e}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then(({json:n})=>{n.success?(alert("Quest updated successfully."),S(w)):alert("Failed to update quest. Error: "+n.message)}).catch(n=>{m.error("Error updating quest:",n),alert("Error updating quest. Please check console for details.")})}function S(e){D(`/quests/game/${e}/quests`).then(({json:t})=>{const o=document.getElementById("questsBody");if(!Array.isArray(t.quests)){m.error("Invalid quests response:",t);return}o.innerHTML="",t.quests.forEach(n=>{const a=document.createElement("div");a.className="card",a.id=`quest-${n.id}`;const r=(n.verification_type||"").toLowerCase(),s=n.badge_name||"None",d=n.frequency||"Not Set",l=n.category||"Not Set",c=n.badge_awarded??0,p=te[n.badge_option]||n.badge_option,h=n.from_calendar?"Yes":"No",g=n.calendar_event_id??"Not Set",f=n.calendar_event_start??"Not Set";a.innerHTML=`
                    <div class="card-body">
                        <h5 class="card-title editable" data-name="title">${n.title}</h5>
                        <div class="card-text editable" data-name="description">${n.description}</div>
                        <div class="card-text editable" data-name="tips">${n.tips||""}</div>
                        <p class="card-text"><strong>Points:</strong> <span class="editable" data-name="points">${n.points}</span></p>
                        <p class="card-text"><strong>Completion Limit:</strong> <span class="editable" data-name="completion_limit">${n.completion_limit}</span></p>
                        <p class="card-text"><strong>Enabled:</strong> <span class="editable" data-name="enabled">${n.enabled?"Yes":"No"}</span></p>
                        <p class="card-text"><strong>Pinned:</strong> <span class="editable" data-name="is_sponsored">${n.is_sponsored?"Yes":"No"}</span></p>
                        <p class="card-text"><strong>Verification:</strong> <span class="editable" data-name="verification_type" data-value="${n.verification_type}">${r}</span></p>
                        <p class="card-text"><strong>Badge:</strong> <span class="editable" data-name="badge_name">${s}</span></p>
                        <p class="card-text"><strong>Badge Awarded:</strong> <span class="editable" data-name="badge_awarded">${c}</span></p>
                        <p class="card-text"><strong>Badge Option:</strong> <span class="editable" data-name="badge_option" data-value="${n.badge_option}">${p}</span></p>
                        <p class="card-text"><strong>Frequency:</strong> <span class="editable" data-name="frequency" data-value="${n.frequency}">${d}</span></p>
                        <p class="card-text"><strong>Category:</strong> <span class="editable" data-name="category" data-value="${n.category??""}">${l}</span></p>
                        <p class="card-text"><strong>From Calendar:</strong> <span class="editable" data-name="from_calendar">${h}</span></p>
                        <p class="card-text"><strong>Calendar Event ID:</strong>
                            <span class="editable" data-name="calendar_event_id" data-value="${n.calendar_event_id??""}">${g}</span>
                        </p>
                        <p class="card-text"><strong>Event Start:</strong>
                            <span
                                class="editable"
                                data-name="calendar_event_start"
                                data-value="${n.calendar_event_start??""}"
                            >${f}</span>
                        </p>
                        <p class="card-text"><strong>Quest ID:</strong> ${n.id}</p>
                        <p class="card-text"><strong>Game ID:</strong> ${n.game_id}</p>
                        <p class="card-text"><strong>Badge ID:</strong> ${n.badge_id??"N/A"}</p>
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-warning edit-button" data-quest-id="${n.id}">Edit</button>
                            <button class="btn btn-danger delete-button" data-quest-id="${n.id}">Delete</button>
                            <button class="btn btn-info qr-button" data-quest-id="${n.id}">Generate QR Code</button>
                        </div>
                    </div>
                `,o.appendChild(a);const i=a.querySelector(".edit-button"),u=a.querySelector(".delete-button"),y=a.querySelector(".qr-button");i&&(i.onclick=()=>ne(n.id)),u&&u.addEventListener("click",()=>He(n.id)),y&&y.addEventListener("click",()=>je(n.id))})}).catch(t=>m.error("Failed to load quests:",t))}function He(e){v(`/quests/quest/${e}/delete`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})}).then(({json:t})=>{t.success?(alert("Quest deleted successfully"),S(w)):alert(`Failed to delete quest: ${t.message}`)}).catch(t=>{m.error("Error:",t),alert("Failed to delete quest. Please check the console for more details.")})}function Qe(){const e=document.getElementById("importQuestsForm"),t=new FormData(e);v(`/quests/game/${w}/import_quests`,{method:"POST",body:t}).then(({json:o})=>{o.success&&o.redirectUrl?(alert("Quests imported successfully"),S(w)):alert("Failed to import quests: "+o.message)}).catch(o=>{m.error("Error importing quests:",o)})}function je(e){const t=`/quests/generate_qr/${e}`;fetch(t).then(o=>{if(!o.ok)throw new Error("Failed to generate QR code");return o.blob()}).then(o=>{const n=URL.createObjectURL(o);window.open(n,"_blank")}).catch(o=>{m.error("Error generating QR code:",o),alert("Failed to generate QR code. Please check console for more details.")})}document.addEventListener("DOMContentLoaded",()=>{});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("notifMenu");if(!e)return;const t=document.getElementById("notifBellToggle"),o=e.querySelector("#notifLoading"),n=e.querySelector("li.dropdown-footer"),a=n.querySelector("#loadMoreBtn"),r=e.dataset.url;let s=0,d=1;const l=parseInt(e.dataset.perPage,10)||10;let c=0;const p={follow:({from_user_name:i,from_user_id:u})=>({text:`Now following ${i}`,onClick:()=>x(u)}),followed_by:({follower_name:i,follower_id:u})=>({text:`${i} is now following you`,onClick:()=>x(u)}),submission:({actor_name:i,quest_name:u,submission_id:y})=>({text:`${i} submitted a new “${u}” quest`,onClick:async()=>{const E=await(await fetch(`/quests/submissions/${y}`)).json();L(E)}}),profile_message:({from_user_name:i,content:u,profile_user_id:y})=>({text:`${i} says “${u}”`,onClick:()=>x(y)}),profile_reply:({from_user_name:i,content:u,profile_user_id:y})=>({text:`${i} replied “${u}”`,onClick:()=>x(y)}),submission_like:({liker_name:i,submission_id:u})=>({text:`${i} liked your submission`,onClick:async()=>{const b=await(await fetch(`/quests/submissions/${u}`,{credentials:"same-origin"})).json();L(b)}}),submission_reply:({actor_name:i,content:u,submission_id:y})=>({text:`${i} replied “${u}”`,onClick:async()=>{const E=await(await fetch(`/quests/submissions/${y}`,{credentials:"same-origin"})).json();L(E)}}),quest_complete:({quest_title:i,submission_id:u})=>({text:`Quest “${i}” completed`,onClick:async()=>{const b=await(await fetch(`/quests/submissions/${u}`,{credentials:"same-origin"})).json();L(b)}})};function h(i){const u=p[i.type];let y,b;if(u&&i.payload)try{({text:y,onClick:b}=u(i.payload))}catch(k){m.error(`Error in handler for ${i.type}:`,k)}(!y||!b)&&(y=i.payload.summary||JSON.stringify(i.payload),b=()=>{window.location.href="/notifications/"});const E=i.is_read?"":"fw-bold",C=document.createElement("a");C.href="#",C.className=`dropdown-item ${E}`,C.appendChild(document.createTextNode(y));const I=document.createElement("small");I.className="text-muted d-block text-center",I.textContent=new Date(i.when).toLocaleString(),C.appendChild(I),C.addEventListener("click",async k=>{k.preventDefault();try{await b()}catch(ae){m.error(ae)}});const F=document.createElement("li");return F.appendChild(C),F}function g(i){i&&i.parentNode===e&&e.removeChild(i)}async function f(i){i===1&&(Array.from(e.children).forEach(E=>{E!==o&&E!==n&&e.removeChild(E)}),s=0,c=0),g(o),g(n),e.appendChild(o),e.appendChild(n),o.style.display="",a.disabled=!0;let u;try{u=await fetch(`${r}?page=${i}&per_page=${l}`,{credentials:"include"})}catch(E){o.textContent="Network error.",m.error(E);return}if(!u.ok){o.textContent="Error loading.",m.error("Status:",u.status,u.statusText);return}const y=await u.json();s=y.page,d=y.total_pages,g(o),g(n);const b=t.querySelector(".badge");b&&b.remove(),y.items.forEach(E=>{if(c>0){const C=document.createElement("li"),I=document.createElement("hr");I.className="dropdown-divider",C.appendChild(I),e.appendChild(C)}e.appendChild(h(E)),c+=1}),e.appendChild(o),e.appendChild(n),o.style.display="none",a.disabled=s>=d}t.addEventListener("show.bs.dropdown",()=>{s===0&&f(1)}),a.addEventListener("click",i=>{i.preventDefault(),i.stopPropagation(),s<d&&f(s+1)})});document.addEventListener("DOMContentLoaded",()=>{var t,o;if(typeof window>"u"||typeof navigator>"u"||!("serviceWorker"in navigator)||!("PushManager"in window))return;const e=(o=(t=document.body)==null?void 0:t.dataset)==null?void 0:o.userId;!e||e==="none"||navigator.serviceWorker.ready.then(async n=>{try{const a=await fetch("/push/public_key");if(!a.ok)return;let r;try{({public_key:r}=await a.json())}catch(l){m.error("Push setup failed",l);return}if(!r||await n.pushManager.getSubscription())return;const d=await n.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:We(r)});await fetch("/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscription:d})})}catch(a){m.error("Push setup failed",a)}})});function We(e){const t="=".repeat((4-e.length%4)%4),o=(e+t).replace(/-/g,"+").replace(/_/g,"/"),n=atob(o),a=new Uint8Array(n.length);for(let r=0;r<n.length;++r)a[r]=n.charCodeAt(r);return a}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("registerEmail");if(!e)return;const t=document.getElementById("registerModal"),o=(t==null?void 0:t.dataset.checkUrl)||"/auth/check_email",n=(t==null?void 0:t.dataset.loginUrl)||"/auth/login",a=document.getElementById("existingUserLogin");if(!a)return;e.addEventListener("blur",()=>{const s=e.value.trim();s&&fetch(`${o}?email=${encodeURIComponent(s)}`).then(d=>d.json()).then(d=>{d.exists?a.style.display="block":a.style.display="none"}).catch(d=>{m.error("Error checking email:",d),a.style.display="none"})});const r=document.getElementById("loginWithExistingBtn");r&&r.addEventListener("click",()=>{const s=e.value.trim(),d=document.getElementById("existingUserPassword").value,l=document.getElementById("loginError"),c=document.getElementById("registerGameId").value,p=document.getElementById("registerQuestId").value,h=document.getElementById("registerNext").value,g=document.getElementById("registerShowJoinCustom").value,f=new FormData;f.append("email",s),f.append("password",d),f.append("remember_me","true"),c&&f.append("game_id",c),p&&f.append("quest_id",p),h&&f.append("next",h),g&&f.append("show_join_custom",g),fetch(n,{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:f,credentials:"same-origin"}).then(i=>(i.headers.get("content-type")||"").includes("application/json")?i.json():(window.location.href=i.url,null)).then(i=>{i&&(i.success?window.location.href=i.redirect:(l.textContent=i.error,l.style.display="block"))}).catch(i=>{m.error("Login error:",i),l.textContent="An error occurred. Please try again.",l.style.display="block"})}),e.addEventListener("input",()=>{a.style.display="none",document.getElementById("loginError").style.display="none"})});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("resetForm");if(!e)return;const t=document.getElementById("resetError"),o=document.getElementById("resetSuccess"),n=document.getElementById("resetButton");e.addEventListener("submit",a=>{a.preventDefault(),t.style.display="none",o.style.display="none",M(e).then(({json:r})=>{r.success?(o.textContent=r.message,o.style.display="block",n.disabled=!0,r.redirect&&setTimeout(()=>{window.location.href=r.redirect},1200)):(t.textContent=r.error||"Unable to reset password.",t.style.display="block")}).catch(r=>{m.error("Reset-password AJAX error:",r),e.submit()})})});document.addEventListener("DOMContentLoaded",()=>{const e="shoutBoardModal",t=document.getElementById("shoutBoardForm"),o=document.getElementById("shoutSubmitBtn"),n=document.getElementById("shoutMessageInput");window.addEventListener("openModal",a=>{a.detail===e&&n&&(n.value="")}),o.addEventListener("click",()=>{const a=n?n.value.trim():"";if(!a){alert("Please enter a message.");return}if(a.length>500){alert("Message must be 500 characters or fewer.");return}const r=new FormData(t);fetch(t.action,{method:"POST",body:r,credentials:"same-origin"}).then(s=>{if(!s.ok)throw new Error(`Server responded ${s.status}`);return s.text()}).then(()=>{X(e),location.reload()}).catch(s=>{m.error("Failed to post shout:",s),alert("Could not post. Please try again.")})})});var Y;(Y=document.getElementById("gameFilter"))==null||Y.addEventListener("change",function(){const e=this.value;e?window.location.href=`/admin/user_management/game/${encodeURIComponent(e)}`:window.location.href="/admin/user_management"});document.addEventListener("DOMContentLoaded",()=>{ie()});export{H as s};
