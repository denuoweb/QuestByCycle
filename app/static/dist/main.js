const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["chunk-lhdUMYAb.js","chunk-NMvYiMni.js"])))=>i.map(i=>d[i]);
import{l as m,c as v,f as $,e as A,s as Y,h as J,g as ye}from"./chunk-NMvYiMni.js";const he="modulepreload",Ee=function(e){return"/static/dist/"+e},z={},G=function(t,o,n){let a=Promise.resolve();if(o&&o.length>0){let i=function(c){return Promise.all(c.map(l=>Promise.resolve(l).then(f=>({status:"fulfilled",value:f}),f=>({status:"rejected",reason:f}))))};document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),d=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));a=i(o.map(c=>{if(c=Ee(c),c in z)return;z[c]=!0;const l=c.endsWith(".css"),f=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${f}`))return;const p=document.createElement("link");if(p.rel=l?"stylesheet":he,l||(p.as="script"),p.crossOrigin="",p.href=c,d&&p.setAttribute("nonce",d),document.head.appendChild(p),l)return new Promise((y,g)=>{p.addEventListener("load",y),p.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${c}`)))})}))}function s(i){const r=new Event("vite:preloadError",{cancelable:!0});if(r.payload=i,window.dispatchEvent(r),!r.defaultPrevented)throw i}return a.then(i=>{for(const r of i||[])r.status==="rejected"&&s(r.reason);return t().catch(s)})};let D=3e3,U=0;function L(e){var n;const t=document.getElementById(e);if(!t){m.error(`Modal ${e} not found`);return}document.body.appendChild(t),(n=document.querySelector(".container"))==null||n.classList.add("modal-open"),U=window.scrollY||window.pageYOffset,document.body.style.top=`-${U}px`,document.body.style.position="fixed",t.classList.add("active"),t.style.display="flex",D+=10,t.style.zIndex=D;const o=t.querySelector(".modal-backdrop");o&&(o.style.display="block",o.style.zIndex=D-1),document.body.classList.add("body-no-scroll")}function M(e){var n;const t=document.getElementById(e);if(!t)return;const o=t.querySelector(".modal-backdrop");t.style.display="none",o&&(o.style.display="none"),D=Math.max(1050,D-10),document.querySelector('.modal[style*="display: flex"]')||(document.body.classList.remove("body-no-scroll"),(n=document.querySelector(".container"))==null||n.classList.remove("modal-open"),document.body.style.position="",document.body.style.top="",window.scrollTo(0,U)),t.dispatchEvent(new CustomEvent("hidden.bs.modal",{bubbles:!0}))}function se(){const e=document.getElementById("twitterLink");e&&(e.style.display="none",e.href="#");const t=document.getElementById("facebookLink");t&&(t.style.display="none",t.href="#");const o=document.getElementById("instagramLink");o&&(o.style.display="none",o.href="#");const n=document.getElementById("modalQuestActions");n&&(n.innerHTML=""),document.querySelectorAll('[id^="verifyButton-"]').forEach(a=>a.remove()),document.querySelectorAll('[id^="verifyQuestForm-"]').forEach(a=>a.remove()),document.body.classList.remove("body-no-scroll")}function ie({gameId:e,questId:t=""}){const o=document.getElementById("loginForm"),n=document.getElementById("loginGameId"),a=document.getElementById("loginQuestId"),s=document.getElementById("loginNext"),i=document.getElementById("loginShowJoinCustom"),r=`/?game_id=${encodeURIComponent(e)}&show_join_custom=0`;n.value=e,a.value=t,i.value="0",s.value=r;const d=o.getAttribute("action").split("?")[0],c=new URLSearchParams({game_id:e,quest_id:t,show_join_custom:0,next:r});o.setAttribute("action",`${d}?${c.toString()}`),L("loginModal")}function ve(){const e=document.getElementById("loginGameId").value||"",t=document.getElementById("loginQuestId").value||"",o=document.getElementById("loginNext").value||"",n=document.getElementById("loginShowJoinCustom").value||"",a=(document.getElementById("loginCustomGameCode")||{}).value||"";document.getElementById("registerGameId").value=e,document.getElementById("registerQuestId").value=t,document.getElementById("registerNext").value=o,document.getElementById("registerShowJoinCustom").value=n,document.getElementById("registerCustomGameCode").value=a;const s=document.getElementById("registerForm"),i=s.getAttribute("action").split("?")[0],r=new URLSearchParams;e&&r.set("game_id",e),t&&r.set("quest_id",t),o&&r.set("next",o),n&&r.set("show_join_custom",n),a&&r.set("custom_game_code",a),s.setAttribute("action",`${i}?${r.toString()}`),M("loginModal"),L("registerModal")}function we(){var s;const e=((s=document.getElementById("loginEmail"))==null?void 0:s.value)||"",t=document.getElementById("forgotEmail");t&&(t.value=e);const o=document.getElementById("forgotEmailError"),n=document.getElementById("forgotSuccess"),a=document.getElementById("forgotButton");o&&(o.style.display="none"),n&&(n.style.display="none"),a&&(a.disabled=!1),L("forgotPasswordModal")}function Be(e){const t=document.getElementById("resetForm"),o=document.getElementById("resetToken"),n=t.dataset.baseAction;t.setAttribute("action",n+encodeURIComponent(e)),o.value=e,document.getElementById("resetError").style.display="none",document.getElementById("resetSuccess").style.display="none",document.getElementById("resetButton").disabled=!1,L("resetPasswordModal")}document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(window.location.search);if(e.get("show_reset")==="1"){const t=e.get("token");t?(Be(t),history.replaceState(null,"",window.location.pathname)):m.warn("show_reset=1 present but no token in URL")}});document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(window.location.search),t=e.get("show_join_custom")==="1",o=e.has("game_id");t&&!o&&L("joinCustomGameModal")});document.addEventListener("DOMContentLoaded",()=>{const t=new URLSearchParams(window.location.search).get("quest_shortcut");t&&(G(()=>Promise.resolve().then(()=>St),void 0).then(o=>o.openQuestDetailModal(t)),history.replaceState(null,"",window.location.pathname))});document.addEventListener("DOMContentLoaded",()=>{const e=new URLSearchParams(window.location.search);if(!(e.get("show_login")==="1"))return;let o=e.get("game_id")||"";if(!o){const n=e.get("next");if(n)try{const s=new URL(n,window.location.origin).pathname.replace(/^\/+/,"");/^\d+$/.test(s)&&(o=s)}catch(a){m.warn("Failed to parse next URL for gameId:",a)}}ie({gameId:o,questId:""})});document.addEventListener("DOMContentLoaded",()=>{if(!window.location.pathname.startsWith("/auth/login"))return;const e=new URLSearchParams(window.location.search),t=e.get("next");if(!t)return;let o=e.get("game_id")||"";if(!o)try{const a=new URL(t,window.location.origin).pathname.replace(/^\/+/,"");/^\d+$/.test(a)&&(o=a)}catch(n){m.warn("Could not parse next URL for gameId:",n)}o&&ie({gameId:o,questId:""})});async function Le(e,t){try{const o=await fetch(e,{credentials:"same-origin"});if(!o.ok)throw new Error(`HTTP ${o.status}`);const n=await o.text(),a=document.getElementById(t);a&&a.parentNode.removeChild(a);const s=document.createElement("div");s.innerHTML=n.trim();const i=s.firstElementChild;(!i||i.id!==t)&&m.warn(`Expected first element to be #${t}`,i),document.body.appendChild(i),L(t)}catch(o){m.error(`Error loading ${t} from ${e}:`,o),alert("Failed to load data. Please try again later.")}}async function H(e){const t=await fetch(e.action,{method:e.method||"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:new FormData(e),credentials:"same-origin"}),o=await t.json();return{status:t.status,json:o}}document.addEventListener("click",e=>{const t=e.target.closest("[data-close-modal]");if(!t)return;e.preventDefault();const o=t.getAttribute("data-close-modal");o&&M(o)});document.addEventListener("click",e=>{const t=e.target.closest("[data-open-modal]");t&&(e.preventDefault(),L(t.getAttribute("data-open-modal")))});document.addEventListener("click",e=>{const t=e.target.closest("[data-modal-url]");if(!t)return;e.preventDefault();const o=t.getAttribute("data-modal-url"),n=t.getAttribute("data-modal-id");if(!o||!n){m.error("data-modal-url or data-modal-id missing",t);return}Le(o,n)});document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".modal").forEach(e=>{e.parentNode!==document.body&&document.body.appendChild(e)})});function X(e){e.waiting&&e.waiting.postMessage({type:"SKIP_WAITING"})}function _e(){if("serviceWorker"in navigator){let s=!1;navigator.serviceWorker.addEventListener("controllerchange",()=>{s||(s=!0,window.location.reload())}),navigator.serviceWorker.register("/sw.js").then(i=>{i.addEventListener("updatefound",()=>{const r=i.installing;r.addEventListener("statechange",()=>{r.state==="installed"&&navigator.serviceWorker.controller&&(m.info("Service worker updated; skipping waiting."),X(i))})}),"SyncManager"in window&&i.sync.register("sync-notifications").catch(r=>m.error("Sync registration failed:",r)),i.periodicSync&&i.periodicSync.register("periodic-notifications",{minInterval:24*60*60*1e3}).catch(r=>m.error("Periodic sync registration failed:",r)),"PushManager"in window&&Notification.permission==="default"&&Notification.requestPermission(),"sync"in i&&i.sync.register("sync-requests").catch(r=>{m.error("Background sync registration failed:",r)})}).catch(i=>m.error("Service Worker registration failed:",i)),navigator.serviceWorker.addEventListener("message",i=>{i.data.type==="UPDATE_AVAILABLE"&&navigator.serviceWorker.getRegistration().then(r=>{r&&(m.info("Update available message received; skipping waiting."),X(r))})})}const e=document.getElementById("install"),t=document.getElementById("manual-install"),o=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);let n=null;const a=document.getElementById("leaderboardNavbarLink");if(t&&(o?t.hidden=!1:t.hidden=!0),e&&(window.addEventListener("beforeinstallprompt",s=>{s.preventDefault(),n=s,e.hidden=!1,e.addEventListener("click",()=>{n&&(n.prompt(),n.userChoice.then(()=>{n=null,e.hidden=!0}))})}),window.beforeinstallprompt||(e.hidden=!0,!o&&t&&(t.hidden=!0)),window.addEventListener("appinstalled",()=>{e.hidden=!0,t&&(t.hidden=!0)}),navigator.getInstalledRelatedApps&&navigator.getInstalledRelatedApps().then(s=>{s.length&&(e.hidden=!0)})),a&&a.addEventListener("click",async s=>{s.preventDefault();const i=a.getAttribute("data-game-id")||0;(await G(()=>import("./chunk-lhdUMYAb.js"),__vite__mapDeps([0,1]))).showLeaderboardModal(i)}),"windowControlsOverlay"in navigator){let s=function(){const i=navigator.windowControlsOverlay.getTitlebarAreaRect();document.body.style.paddingTop=i.height+"px"};navigator.windowControlsOverlay.addEventListener("geometrychange",s),s()}document.querySelectorAll(".modal").forEach(s=>{s.parentNode!==document.body&&document.body.appendChild(s)})}function Ie(e){const t=e.value;t==="join_custom_game"?L("joinCustomGameModal"):window.location.href=t}document.addEventListener("click",e=>{const t=e.target.closest("[data-game-selection]");t&&(e.preventDefault(),Ie({value:t.getAttribute("data-game-selection")}))});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("quest-form");e&&e.addEventListener("submit",t=>{document.getElementById("description").value.trim()||(alert("Description is required."),t.preventDefault())})});function I(e){fetch(`/profile/${e}`).then(t=>t.json()).then(t=>{if(!t.riding_preferences_choices){m.error("Riding preferences choices missing.");return}const o=document.getElementById("userProfileDetails");if(!o){m.error("Profile details containers not found");return}const n=t.current_user_id===t.user.id;o.innerHTML=`
          <!-- XS: native select dropdown -->
          <div class="d-block d-sm-none mb-3">
            <select id="profileTabSelect" class="form-select">
              <option value="profile" selected>Profile</option>
              <option value="bike">Bike</option>
              <option value="badges-earned">Badges Earned</option>
              <option value="games-participated">Games Participated</option>
              <option value="quest-submissions">Quest Submissions</option>
            </select>
          </div>

          <!-- SM+ nav-tabs (will scroll horizontally) -->
          <ul class="nav nav-tabs epic-tabs d-none d-sm-flex" id="profileTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <a class="nav-link active" id="profile-tab" data-bs-toggle="tab"
                href="#profile" role="tab" aria-controls="profile" aria-selected="true">
                <i class="bi bi-person-circle me-2"></i>Profile
              </a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="bike-tab" data-bs-toggle="tab"
                 href="#bike" role="tab" aria-controls="bike" aria-selected="false">
                <i class="bi bi-bicycle me-2"></i>Bike
              </a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="badges-earned-tab" data-bs-toggle="tab"
                 href="#badges-earned" role="tab" aria-controls="badges-earned" aria-selected="false">
                <i class="bi bi-trophy me-2"></i>Badges Earned
              </a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="games-participated-tab" data-bs-toggle="tab"
                 href="#games-participated" role="tab" aria-controls="games-participated" aria-selected="false">
                <i class="bi bi-controller me-2"></i>Games Participated
              </a>
            </li>
            <li class="nav-item" role="presentation">
              <a class="nav-link" id="quest-submissions-tab" data-bs-toggle="tab"
                 href="#quest-submissions" role="tab" aria-controls="quest-submissions" aria-selected="false">
                <i class="bi bi-list-quest me-2"></i>Quest Submissions
              </a>
            </li>
          </ul>

          <div class="tab-content bg-light p-4 rounded shadow-sm" id="profileTabsContent">

            <!-- 1) PROFILE pane -->
            <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
              <section class="profile mb-4">
                ${n?`
                  <div id="profileViewMode">
                    ${t.user.profile_picture?`
                      <div class="profile-picture-container position-relative mx-auto mb-3">
                        <img src="/static/${t.user.profile_picture}"
                            class="profile-picture rounded-circle shadow-lg border border-white border-4"
                            alt="Profile Picture">
                      </div>`:""}
                    <p><strong>Display Name:</strong> ${t.user.display_name||""}</p>
                    <p><strong>Age Group:</strong> ${t.user.age_group||""}</p>
                    <p><strong>Interests:</strong> ${t.user.interests||""}</p>
                    <p><strong>Riding Preferences:</strong> ${t.user.riding_preferences.join(", ")}</p>
                    <p><strong>Ride Description:</strong> ${t.user.ride_description||""}</p>
                    <button class="btn btn-primary" id="editProfileBtn">Edit</button>
                  </div>
                  <div id="profileEditMode" class="d-none">
                    <form id="editProfileForm" method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
                      <div class="form-group mb-3">
                        <label for="profilePictureInput">Profile Picture:</label>
                        <input type="file" class="form-control" id="profilePictureInput"
                                name="profile_picture" accept="image/*">
                      </div>
                      <div class="form-group mb-3">
                        <label for="displayName">Display Name:</label>
                        <input type="text" class="form-control" id="displayName" name="display_name"
                                value="${t.user.display_name||""}" required>
                        <div class="invalid-feedback">Display Name is required.</div>
                      </div>
                      <div class="form-group mb-3">
                        <label for="ageGroup">Age Group:</label>
                        <select class="form-select" id="ageGroup" name="age_group">
                          <option value="teen" ${t.user.age_group==="teen"?"selected":""}>Teen</option>
                          <option value="adult" ${t.user.age_group==="adult"?"selected":""}>Adult</option>
                          <option value="senior" ${t.user.age_group==="senior"?"selected":""}>Senior</option>
                        </select>
                      </div>
                      <div class="form-group mb-3">
                        <label for="interests">Interests:</label>
                        <textarea class="form-control" id="interests" name="interests" rows="3"
                                  placeholder="Describe your interests...">${t.user.interests||""}</textarea>
                      </div>
                      <div class="form-group mb-3">
                        <label><b>Please specify your riding preferences:</b></label>
                        <div id="ridingPreferences">
                          ${t.riding_preferences_choices.map((u,E)=>`
                            <div class="form-check mb-2">
                              <input class="form-check-input" type="checkbox"
                                      id="ridingPref-${E}" name="riding_preferences"
                                      value="${u[0]}"
                                      ${t.user.riding_preferences.includes(u[0])?"checked":""}>
                              <label class="form-check-label" for="ridingPref-${E}">${u[1]}</label>
                            </div>
                          `).join("")}
                        </div>
                      </div>
                      <div class="form-group mb-3">
                        <label for="rideDescription">Describe the type of riding you like to do:</label>
                        <textarea class="form-control" id="rideDescription" name="ride_description" rows="3">${t.user.ride_description||""}</textarea>
                      </div>
                      <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="uploadToSocials" name="upload_to_socials"
                                ${t.user.upload_to_socials?"checked":""}>
                        <label class="form-check-label" for="uploadToSocials">Cross post to game's social media?</label>
                      </div>
                      <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="uploadToMastodon" name="upload_to_mastodon"
                                ${t.user.upload_to_mastodon?"checked":""}>
                        <label class="form-check-label" for="uploadToMastodon">Cross post to your federation server?</label>
                      </div>
                      <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-success" id="saveProfileBtn">
                          <i class="bi bi-save me-2"></i>Save Profile
                        </button>
                        <button class="btn btn-secondary" id="cancelProfileBtn">Cancel</button>
                      </div>
                    </form>
                    <hr>
                    <form id="updatePasswordForm" class="d-flex justify-content-between">
                      <button class="btn btn-primary w-100 me-2" id="updatePasswordBtn">
                        <i class="bi bi-shield-lock-fill me-2"></i>Update Password
                      </button>
                    </form>
                    <hr>
                    <form id="deleteAccountForm">
                      <button class="btn btn-danger w-100">
                        <i class="bi bi-trash-fill me-2"></i>Delete My Account
                      </button>
                    </form>
                  </div>`:`
                  <div id="profileViewMode">
                    <p><img src="/static/${t.user.profile_picture}"
                        class="profile-picture rounded-circle shadow-lg border border-white border-4 w-50"
                        alt="Profile Picture"></p>
                    <p><strong>Display Name:</strong> ${t.user.display_name||""}</p>
                    <p><strong>Age Group:</strong> ${t.user.age_group||""}</p>
                    <p><strong>Interests:</strong> ${t.user.interests||""}</p>
                    <p><strong>Riding Preferences:</strong> ${t.user.riding_preferences.join(", ")}</p>
                    <p><strong>Ride Description:</strong> ${t.user.ride_description||""}</p>
                  </div>
                `}
              </section>
            </div>

            <!-- 2) BIKE pane -->
            <div class="tab-pane fade" id="bike" role="tabpanel" aria-labelledby="bike-tab">
              <section class="bike mb-4">
                <h2 class="h2">Bike Details</h2>
                ${n?`
                  <form id="editBikeForm" class="needs-validation" novalidate>
                    <div class="form-group mb-3">
                      <label for="bikePicture">Upload Your Bicycle Picture:</label>
                      <input type="file" class="form-control" id="bikePicture" name="bike_picture" accept="image/*">
                    </div>
                    ${t.user.bike_picture?`
                      <div class="form-group mb-3">
                        <label>Current Bicycle Picture:</label>
                        <img src="/static/${t.user.bike_picture}" class="img-fluid rounded shadow-sm" alt="Bicycle Picture">
                      </div>`:""}
                    <div class="form-group mb-3">
                      <label for="bikeDescription">Bicycle Description:</label>
                      <textarea class="form-control" id="bikeDescription" name="bike_description" rows="3">${t.user.bike_description||""}</textarea>
                    </div>
                    <div class="d-flex justify-content-between">
                      <button class="btn btn-success" id="saveBikeBtn">
                        <i class="bi bi-save me-2"></i>Save Bike Details
                      </button>
                    </div>
                  </form>`:`
                  <p><strong>Bicycle Description:</strong> ${t.user.bike_description||""}</p>`}
              </section>
            </div>

            <!-- 3) BADGES EARNED pane -->
            <div class="tab-pane fade" id="badges-earned" role="tabpanel" aria-labelledby="badges-earned-tab">
              <section class="badges-earned mb-4">
                <h2 class="h2">Badges Earned</h2>
                <div class="badge-grid">
                  ${t.user.badges&&t.user.badges.length?t.user.badges.map(u=>`
                      <div class="badge-card">
                        <img src="/static/images/badge_images/${u.image}" alt="${u.name}" class="badge-icon" style="width:100px;">
                        <div class="badge-caption">
                          <h3>${u.name}</h3>
                          <p>${u.description}</p>
                          <p><strong>Category:</strong> ${u.category}</p>
                        </div>
                      </div>
                    `).join(""):'<p class="text-muted">No badges earned yet.</p>'}
                </div>
              </section>
            </div>

            <!-- 4) GAMES PARTICIPATED pane -->
            <div class="tab-pane fade" id="games-participated" role="tabpanel" aria-labelledby="games-participated-tab">
              <section class="games-participated mb-4">
                <h2 class="h2">Games Participated</h2>
                <div class="row g-3">
                  ${t.participated_games&&t.participated_games.length?t.participated_games.map(u=>`
                      <div class="game-item col-md-6 p-3 border rounded shadow-sm bg-white">
                        <h3 class="h5">${u.title}</h3>
                        <p class="text-muted">${u.description}</p>
                        <p><strong>Start Date:</strong> ${u.start_date}</p>
                        <p><strong>End Date:</strong> ${u.end_date}</p>
                      </div>
                    `).join(""):'<p class="text-muted">No games participated in yet.</p>'}
                </div>
              </section>
            </div>

            <!-- 5) QUEST SUBMISSIONS pane -->
            <div class="tab-pane fade" id="quest-submissions" role="tabpanel" aria-labelledby="quest-submissions-tab">
              <section class="quest-submissions mb-4">
                <h2 class="h2">Quest Submissions</h2>
                <div class="row g-3">
                  ${t.quest_submissions&&t.quest_submissions.length?t.quest_submissions.map(u=>`
                      <div class="submission-item col-md-6 p-3 border rounded shadow-sm bg-white">
                        ${u.image_url?`<img src="${u.image_url}" alt="Submission Image" class="img-fluid rounded mb-2" style="max-height:200px; object-fit:cover;">`:""}
                        <p><strong>Quest:</strong> ${u.quest.title}</p>
                        <p class="text-muted">${u.comment}</p>
                        <p><strong>Submitted At:</strong> ${u.timestamp}</p>
                        <div class="d-flex gap-2">
                          ${u.twitter_url?`<a href="${u.twitter_url}"   target="_blank" class="btn btn-sm btn-twitter"><i class="bi bi-twitter"></i></a>`:""}
                          ${u.fb_url?`<a href="${u.fb_url}"        target="_blank" class="btn btn-sm btn-facebook"><i class="bi bi-facebook"></i></a>`:""}
                          ${u.instagram_url?`<a href="${u.instagram_url}" target="_blank" class="btn btn-sm btn-instagram"><i class="bi bi-instagram"></i></a>`:""}
                        </div>
                        ${n?`<button class="btn btn-danger btn-sm mt-2" data-delete-submission="${u.id}">Delete</button>`:""}
                      </div>
                    `).join(""):'<p class="text-muted">No quest submissions yet.</p>'}
                </div>
              </section>
            </div>

          </div> <!-- /.tab-content -->
        </div> <!-- /.row -->
      `;const a=document.getElementById("userProfileModalLabel");a.textContent=`${t.user.display_name||t.user.username}'s Profile`;const s=document.getElementById("followBtn");s&&(s.style.display="");const i=document.getElementById("followerCount");let r=t.user.follower_count;function d(){i&&(i.textContent=`${r} follower${r===1?"":"s"}`)}if(d(),!n&&s){let E=function(){u?(s.textContent="Following",s.classList.remove("btn-primary"),s.classList.add("btn-outline-primary")):(s.textContent="Follow",s.classList.remove("btn-outline-primary"),s.classList.add("btn-primary"))};s&&(s.style.display="",s.classList.remove("d-none"));let u=t.current_user_following;E(),s.onclick=async()=>{const w=u?"unfollow":"follow",{status:h}=await v(`/profile/${t.user.username}/${w}`,{method:"POST",headers:{"Content-Type":"application/json"}});if(h!==200){m.error("Follow toggle failed");return}u=!u,r+=u?1:-1,E(),d()}}else{const u=document.getElementById("followBtn");u&&(u.style.display="none")}L("userProfileModal");const c=document.getElementById("editProfileBtn");c&&c.addEventListener("click",Ce);const l=document.getElementById("saveProfileBtn");l&&l.addEventListener("click",()=>$e(e));const f=document.getElementById("cancelProfileBtn");f&&f.addEventListener("click",()=>ke(e));const p=document.getElementById("updatePasswordBtn");p&&p.addEventListener("click",()=>{window.location.href="/auth/update_password"});const y=document.getElementById("saveBikeBtn");y&&y.addEventListener("click",()=>Se(e)),document.querySelectorAll("[data-delete-submission]").forEach(u=>{u.addEventListener("click",()=>{const E=u.getAttribute("data-delete-submission");xe(E,"profileSubmissions",t.user.id)})});const g=document.getElementById("deleteAccountForm");g&&g.addEventListener("submit",u=>{u.preventDefault(),qe()});const b=document.getElementById("profileTabSelect");b&&(b.addEventListener("change",u=>{const E=u.target.value,w=document.querySelector(`#profileTabs a[href="#${E}"]`);w&&new bootstrap.Tab(w).show()}),document.querySelectorAll('#profileTabs a[data-bs-toggle="tab"]').forEach(u=>{u.addEventListener("shown.bs.tab",E=>{b.value=E.target.getAttribute("href").slice(1)})}))}).catch(t=>{m.error("Failed to load profile:",t),alert("Could not load user profile. Please try again.")})}document.querySelectorAll("[data-floating-ui-tooltip]").forEach(e=>{tippy(e,{content:e.getAttribute("data-floating-ui-tooltip"),placement:"top",animation:"scale-subtle"})});document.querySelectorAll(".needs-validation").forEach(e=>{e.addEventListener("submit",t=>{e.checkValidity()||(t.preventDefault(),t.stopPropagation()),e.classList.add("was-validated")},!1)});function Ce(){const e=document.getElementById("profileViewMode"),t=document.getElementById("profileEditMode");if(!e||!t){m.error("Profile edit mode elements missing");return}e.classList.toggle("d-none"),t.classList.toggle("d-none")}function ke(e){I(e)}function $e(e){const t=document.getElementById("editProfileForm");if(!t){m.error("Edit profile form not found");return}const o=new FormData(t),n=document.getElementById("profilePictureInput");n.files.length>0&&o.append("profile_picture",n.files[0]);const a=[];t.querySelectorAll('input[name="riding_preferences"]:checked').forEach(s=>{a.push(s.value)}),o.delete("riding_preferences"),a.forEach(s=>{o.append("riding_preferences",s)}),v(`/profile/${e}/edit`,{method:"POST",body:o}).then(({json:s})=>{if(s.error){let i=`Error: ${s.error}`;if(s.details){const r=[];Object.values(s.details).forEach(d=>{r.push(d.join(", "))}),r.length&&(i+=` - ${r.join("; ")}`)}alert(i)}else alert("Profile updated successfully."),I(e)}).catch(s=>{m.error("Error updating profile:",s),alert("Failed to update profile. Please try again.")})}function Se(e){const t=document.getElementById("editBikeForm");if(!t){m.error("Edit bike form not found");return}const o=new FormData(t),n=document.getElementById("bikePicture");n.files.length>0&&o.append("bike_picture",n.files[0]),v(`/profile/${e}/edit-bike`,{method:"POST",body:o}).then(({json:a})=>{a.error?alert(`Error: ${a.error}`):(alert("Bike details updated successfully."),I(e))}).catch(a=>{m.error("Error updating bike details:",a),alert("Failed to update bike details. Please try again.")})}function xe(e,t,o){v(`/quests/quest/delete_submission/${e}`,{method:"DELETE"}).then(({json:n})=>{if(n.success)alert("Submission deleted successfully."),I(o);else throw new Error(n.message)}).catch(n=>{m.error("Error deleting submission:",n),alert("Error during deletion: "+n.message)})}function qe(){confirm("Are you sure you want to delete your account? This action cannot be undone.")&&v("/auth/delete_account",{method:"POST",headers:{"Content-Type":"application/json"}}).then(()=>{window.location.href="/"}).catch(e=>{m.error("Error deleting account:",e),alert("Failed to delete account. Please try again.")})}document.addEventListener("click",e=>{const t=e.target.closest("[data-user-profile]");if(!t)return;e.preventDefault();const o=t.getAttribute("data-user-profile");o&&I(o)});let q;document.addEventListener("DOMContentLoaded",()=>{const e=r=>document.querySelector(r);if(!e("#submissionDetailModal"))return;const o=document.getElementById("replyLimitMessage"),n=document.querySelector('meta[name="placeholder-image"]').getAttribute("content");q=function(r){const d=e("#submissionDetailModal");d.dataset.submissionId=r.id,d.dataset.questId=r.quest_id||"";const c=Number(d.dataset.currentUserId),l=Number(r.user_id)===c,f=d.dataset.isAdmin==="True"||d.dataset.isAdmin==="true",p=e("#editPhotoBtn"),y=e("#photoEditControls"),g=e("#submissionPhotoInput"),b=e("#savePhotoBtn"),u=e("#cancelPhotoBtn"),E=e("#deleteSubmissionBtn");p.hidden=!l,E.hidden=!(l||f),y.hidden=!0,p.addEventListener("click",()=>{y.hidden=!1,p.hidden=!0}),u.addEventListener("click",()=>{g.value="",y.hidden=!0,p.hidden=!1}),E.addEventListener("click",()=>{if(!confirm("Are you sure you want to delete this submission?"))return;const _=d.dataset.submissionId;v(`/quests/quest/delete_submission/${_}`,{method:"DELETE"}).then(({json:B})=>{if(!B.success)throw new Error(B.message||"Delete failed");M("submissionDetailModal"),se(),d.dataset.questId&&refreshQuestDetailModal(d.dataset.questId),alert("Submission deleted successfully.")}).catch(B=>alert("Error deleting submission: "+B.message))}),b.addEventListener("click",()=>{const _=d.dataset.submissionId,B=g.files[0];if(!B)return alert("Please select an image first.");if(B.type.startsWith("video/")&&B.size>10*1024*1024){alert("Video must be 10 MB or smaller.");return}if(B.type.startsWith("image/")&&B.size>8*1024*1024){alert("Image must be 8 MB or smaller.");return}const N=new FormData;B.type.startsWith("video/")?N.append("video",B):N.append("photo",B),v(`/quests/submission/${_}/photo`,{method:"PUT",body:N}).then(({json:x})=>{if(!x.success)throw new Error(x.message||"Upload failed");x.video_url?(e("#submissionImage").hidden=!0,e("#submissionVideo").hidden=!1,e("#submissionVideoSource").src=x.video_url,e("#submissionVideo").load()):(e("#submissionVideo").hidden=!0,e("#submissionImage").hidden=!1,e("#submissionImage").src=x.image_url),u.click()}).catch(x=>alert(x.message))}),e("#submissionReplyEdit").hidden=l,e("#postReplyBtn").hidden=l,e("#ownerNotice").hidden=!l;const w=e("#submissionRepliesContainer");l?w.hidden=!0:w.hidden=!1;const h={img:e("#submissionImage"),video:e("#submissionVideo"),videoSource:e("#submissionVideoSource"),imgOverlay:e("#submitterProfileImageOverlay"),commentRead:e("#submissionComment"),commentEdit:e("#submissionCommentEdit"),readBox:e("#commentReadButtons"),editBox:e("#commentEditButtons"),editBtn:e("#editCommentBtn"),profileImg:e("#submitterProfileImage"),profileImgOverlay:e("#submitterProfileImageOverlay"),profileCap:e("#submitterProfileCaption"),profileLink:e("#submitterProfileLink"),social:{tw:e("#twitterLink"),fb:e("#facebookLink"),ig:e("#instagramLink")}};h.profileImg.src=r.user_profile_picture||n,h.profileImgOverlay.src=h.profileImg.src,h.profileCap.textContent=r.user_display_name||r.user_username||"â€”",h.profileLink.onclick=_=>{_.preventDefault(),I(r.user_id)},h.imgOverlay.parentElement.onclick=h.profileLink.onclick;const S=n;r.video_url?(h.img.hidden=!0,h.video.hidden=!1,h.videoSource.src=r.video_url,h.video.load()):(h.video.hidden=!0,h.img.hidden=!1,h.img.src=r.url||S),h.commentRead.textContent=r.comment||"No comment provided.",["tw","fb","ig"].forEach(_=>{const B=_==="tw"?"twitter_url":_==="fb"?"fb_url":"instagram_url";try{new URL(r[B]),h.social[_].href=r[B],h.social[_].style.display="inline-block"}catch{h.social[_].style.display="none"}}),l?(h.editBtn.hidden=!1,h.readBox.hidden=!1):h.editBtn.hidden=h.readBox.hidden=h.commentEdit.hidden=h.editBox.hidden=!0,s(),L("submissionDetailModal")},e("#editCommentBtn").addEventListener("click",()=>{e("#submissionCommentEdit").value=e("#submissionComment").textContent.trim(),a(!0)}),e("#saveCommentBtn").addEventListener("click",()=>{const r=e("#submissionDetailModal").dataset.submissionId;v(`/quests/submission/${r}/comment`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({comment:e("#submissionCommentEdit").value.trim()})}).then(({json:d})=>{if(!d.success)throw new Error(d.message||"Save failed");e("#submissionComment").textContent=d.comment||"No comment provided.",a(!1)}).catch(d=>alert(`Could not save comment: ${d.message}`))}),e("#cancelCommentBtn").addEventListener("click",()=>a(!1));function a(r){e("#submissionComment").hidden=r,e("#commentReadButtons").hidden=r,e("#submissionCommentEdit").hidden=!r,e("#commentEditButtons").hidden=!r}function s(){const r=e("#submissionDetailModal").dataset.submissionId;r&&($(`/quests/submissions/${r}`).then(({json:d})=>{e("#submissionLikeCount").textContent=d.like_count||0,e("#submissionLikeBtn").classList.toggle("active",d.liked_by_current_user)}),$(`/quests/submission/${r}/replies`).then(({json:d})=>{const c=e("#submissionRepliesList");c.innerHTML="",d.replies.forEach(p=>{const y=document.createElement("div");y.className="reply mb-1",y.innerHTML=`
            <a href="#" class="reply-user-link" data-user-id="${p.user_id}">
              <strong>${p.user_display}</strong>
            </a>: ${p.content}
          `,y.querySelector(".reply-user-link").addEventListener("click",b=>{b.preventDefault(),I(p.user_id)}),c.appendChild(y)});const l=e("#submissionReplyEdit"),f=e("#postReplyBtn");d.replies.length>=10?(l.disabled=!0,f.disabled=!0,o&&(o.style.display="block")):(l.disabled=!1,f.disabled=!1,o&&(o.style.display="none"))}))}e("#submissionLikeBtn").addEventListener("click",()=>{const r=e("#submissionLikeBtn"),d=e("#submissionDetailModal").dataset.submissionId,c=r.classList.contains("active");v(`/quests/submission/${d}/like`,{method:c?"DELETE":"POST",headers:{"Content-Type":"application/json"}}).then(({json:l})=>{if(!l.success)throw new Error("Like failed");e("#submissionLikeCount").textContent=l.like_count,r.classList.toggle("active",l.liked)}).catch(l=>alert(l.message))}),e("#postReplyBtn").addEventListener("click",()=>{const r=e("#submissionDetailModal").dataset.submissionId,d=e("#submissionReplyEdit"),c=d.value.trim();!r||!c||v(`/quests/submission/${r}/replies`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:c})}).then(({status:l,json:f})=>{if(!f.success){if(f.message==="Reply limit of 10 reached"){i();return}if(l===409&&f.message==="Duplicate reply")return alert("You have already posted that exact reply.");throw new Error(f.message||"Error")}const p=e("#submissionRepliesList"),y=document.createElement("div");y.className="reply mb-1",y.innerHTML=`<strong>${f.reply.user_display}</strong>: ${f.reply.content}`,p.insertBefore(y,p.firstChild),d.value="",p.children.length>=10&&i()}).catch(l=>alert(l.message))});function i(){const r=e("#submissionReplyEdit"),d=e("#postReplyBtn");r.disabled=!0,d.disabled=!0,o&&(o.style.display="block")}});const Te=document.querySelector('meta[name="placeholder-image"]').getAttribute("content");let F=0,re=null,K=!1,Z=!1;function De(e){F=0,re=e;const t=document.getElementById("allSubmissionsContainer");t&&(t.innerHTML=""),L("allSubmissionsModal"),le()}function le(){const e=F*10;$(`/quests/quest/all_submissions?game_id=${re}&offset=${e}&limit=10`).then(({json:t})=>{if(t.error)throw new Error(t.error);K=t.is_admin,Z=t.has_more,Me(t.submissions,K,F>0),Ae(Z),F+=1}).catch(t=>{m.error("Error fetching all submissions:",t),alert("Error fetching all submissions: "+t.message)})}function Me(e,t,o=!1){const n=document.getElementById("allSubmissionsContainer");if(!n){m.error("allSubmissionsContainer element not found.");return}o||(n.innerHTML=""),e.forEach(a=>{const s=document.createElement("div");s.className="submission-card";const i=document.createElement("img");i.src=a.image_url||Te,i.alt="Quest Submission",i.className="submission-image";const r=document.createElement("div");r.className="submission-info";const d=document.createElement("p");d.textContent=`User: ${a.user_display_name||a.user_username}`,d.className="submission-user-details";const c=document.createElement("p"),l=new Date(a.timestamp).toLocaleString("en-US",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit",hour12:!0});c.textContent=`Submitted on: ${l}`,c.className="submission-timestamp";const f=document.createElement("p");f.textContent=`Comment: ${a.comment}`,f.className="submission-comment";const p=document.createElement("p");p.textContent=`Twitter: ${a.twitter_url||"N/A"}`,p.className="submission-comment";const y=document.createElement("p");y.textContent=`Facebook: ${a.fb_url||"N/A"}`,y.className="submission-comment";const g=document.createElement("p");if(g.textContent=`Instagram: ${a.instagram_url||"N/A"}`,g.className="submission-comment",r.appendChild(d),r.appendChild(c),r.appendChild(f),r.appendChild(p),r.appendChild(y),r.appendChild(g),t){const b=document.createElement("button");b.textContent="Delete",b.className="button delete-button",b.addEventListener("click",function(u){u.stopPropagation(),Pe(a.id)}),s.appendChild(b)}s.appendChild(i),s.appendChild(r),s.addEventListener("click",function(){q({id:a.id,quest_id:a.quest_id,url:a.image_url||a.video_url,video_url:a.video_url,comment:a.comment,user_id:a.user_id,user_display_name:a.user_display_name||a.user_username,user_profile_picture:a.user_profile_picture,twitter_url:a.twitter_url,fb_url:a.fb_url,instagram_url:a.instagram_url,verification_type:"image"}),L("submissionDetailModal")}),n.appendChild(s)})}function Pe(e){v(`/quests/quest/delete_submission/${e}`,{method:"DELETE"}).then(({json:t})=>{if(t.success)alert("Submission deleted successfully.");else throw new Error(t.message)}).catch(t=>{m.error("Error deleting submission:",t),alert("Error during deletion: "+t.message)})}function Ae(e){const t=document.getElementById("loadMoreSubmissions");t&&(t.style.display=e?"block":"none")}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("loadMoreSubmissions");e&&e.addEventListener("click",()=>{le()})});document.addEventListener("DOMContentLoaded",()=>{Fe(),document.querySelectorAll("[data-toggle-form]").forEach(e=>{e.addEventListener("click",()=>Ne(e.dataset.toggleForm))})});function Fe(){const e=document.getElementById("badgesBody");e&&fetch("/badges").then(t=>t.json()).then(t=>{e.innerHTML="",t.badges.forEach(o=>{const n=document.createElement("tr");n.dataset.badgeId=o.id;const a=o.image?`<img src="${o.image}" height="50" alt="Badge Image">`:"No Image";n.innerHTML=`
                    <td class="badge-image-manage">${a}</td>
                    <td class="badge-name">${o.name}</td>
                    <td class="badge-description">${o.description}</td>
                    <td class="badge-category">${o.category||"None"}</td>
                    <td>
                        <button class="edit-badge" data-badge-id="${o.id}">Edit</button>
                        <button class="delete-badge" data-badge-id="${o.id}">Delete</button>
                    </td>
                `,n.querySelector(".edit-badge").addEventListener("click",()=>Qe(o.id)),n.querySelector(".delete-badge").addEventListener("click",()=>Ue(o.id)),e.appendChild(n)})}).catch(t=>m.error("Failed to load badges:",t))}function Ne(e){const t=document.getElementById(e);t&&t.classList.toggle("d-none")}function Re(e){return fetch("/badges/categories").then(t=>t.json()).then(t=>{const o=t.categories||[],n=document.createElement("select");n.className="form-control badge-category-select";const a=document.createElement("option");return a.value="none",a.textContent="None",(!e||e==="none")&&(a.selected=!0),n.appendChild(a),o.forEach(s=>{const i=document.createElement("option");i.value=s,i.textContent=s,s===e&&(i.selected=!0),n.appendChild(i)}),n}).catch(t=>{m.error("Error fetching categories:",t);const o=document.createElement("select");o.className="form-control badge-category-select";const n=document.createElement("option");return n.value="none",n.textContent="None",n.selected=!0,o.appendChild(n),o})}function Qe(e){const t=document.querySelector(`tr[data-badge-id='${e}']`);if(!t){m.error(`Badge row with ID ${e} not found.`);return}const o=t.querySelector(".badge-name"),n=t.querySelector(".badge-description"),a=t.querySelector(".badge-category"),s=t.querySelector(".badge-image-manage");o.textContent="";const i=document.createElement("input");i.type="text",i.value=o.innerText.trim(),i.className="form-control badge-name-input",o.appendChild(i),n.textContent="";const r=document.createElement("textarea");if(r.className="form-control badge-description-textarea",r.value=n.innerText.trim(),n.appendChild(r),s){s.textContent="";const d=document.createElement("input");d.type="file",d.className="form-control-file badge-image-input",s.appendChild(d)}else m.error("Could not find badge-image-manage cell");Re(a.innerText.trim()).then(d=>{a.textContent="",a.appendChild(d);const c=t.querySelector("button.edit-badge");c.innerText="Save",c.onclick=()=>Oe(e)})}function Oe(e){const t=document.querySelector(`tr[data-badge-id='${e}']`),o=new FormData;o.append("name",t.querySelector(".badge-name-input").value.trim()),o.append("description",t.querySelector(".badge-description-textarea").value.trim()),o.append("category",t.querySelector(".badge-category-select").value);const n=t.querySelector(".badge-image-input");n&&n.files.length>0&&o.append("image",n.files[0]);const a=document.querySelector("[name=csrf_token]").value;o.append("csrf_token",a),v(`/badges/update/${e}`,{method:"POST",body:o}).then(({json:s})=>{s.success?(alert("Badge updated successfully"),window.location.reload()):alert("Failed to update badge: "+s.message)}).catch(s=>m.error("Error updating badge:",s))}function Ue(e){confirm("Are you sure you want to delete this badge?")&&v(`/badges/delete/${e}`,{method:"DELETE"}).then(({json:t})=>{t.success?window.location.reload():alert(`Failed to delete badge: ${t.message}`)}).catch(t=>{m.error("Error deleting badge:",t),alert("Error deleting badge. Please check console for details.")})}let T=[];const V=document.querySelector('meta[name="placeholder-image"]').getAttribute("content");function Ge(e){try{const t=new URL(e,window.location.origin);if(t.protocol==="http:"||t.protocol==="https:")return e}catch{}return V}async function He(){const e=document.getElementById("game_IdHolder"),t=e?e.getAttribute("data-game-id"):null,n=`/badges${t&&!isNaN(parseInt(t,10))&&t!=="0"?`?game_id=${t}`:""}`,a=await fetch(n,{credentials:"same-origin"});if(!a.ok)throw new Error("Error fetching badges");return T=(await a.json()).badges,T}async function de(){if(!T||T.length===0)try{await He()}catch(e){m.error("Error loading badges:",e),T=[]}}function Ve(e){return e?`<ul>${e.split(",").map(o=>`<li>${A(o.trim())}</li>`).join("")}</ul>`:""}function je(e){return T.find(t=>t.id==e)}function We(e){return{id:e.getAttribute("data-badge-id"),name:e.getAttribute("data-badge-name")||"Badge",description:e.getAttribute("data-badge-description")||"",image:e.getAttribute("data-badge-image")||V}}async function Ye(e){const t=await fetch(`/quests/detail/${e}/user_completion`);if(!t.ok)throw new Error("Failed to fetch user completions");const o=await t.json();return o.userCompletion?o.userCompletion.completions:0}function Je(e,t,o,n,a,s,i){const r=document.getElementById("badgeModalTitle"),d=document.getElementById("badgeModalImage"),c=document.getElementById("badgeModalText");if(!r||!d||!c){m.error("Badge modal elements missing");return}r.textContent=e.name,d.src=Ge(e.image)||V;let l="";if(s){const p=`<a href="#" data-quest-detail="${s}">${A(i)}</a>`;l=`<p>Completion Requirement: ${t>1?t+" times":t+" time"}</p><p>Your Total Completions: ${o}</p><p>${a?"You have earned this badge.":"Complete "+p+" to earn this badge."}</p>`}else l=`<p>Completion Requirements: ${t} (per task)</p><p>Your Total Completions: ${o}</p>${n}<p>${a?"You have earned this badge.":"Complete one of the above tasks to earn this badge."}</p>`;const f=e.description||"No description available.";a?(d.style.filter="none",d.oncontextmenu=null,c.innerHTML=`<p><strong>Awarded!</strong></p>${l}<p>${A(f)}</p>`):(d.style.filter="grayscale(100%) opacity(0.5)",d.oncontextmenu=p=>(p.preventDefault(),!1),c.innerHTML=`<p><strong>Not Awarded Yet</strong></p>${l}<p>${A(f)}</p>`)}async function ce(e){const t=e.getAttribute("data-badge-id"),o=e.getAttribute("data-task-name"),n=e.getAttribute("data-task-id"),a=e.getAttribute("data-badge-awarded-count"),s=e.getAttribute("data-user-completions"),i=parseInt(a,10),r=parseInt(s,10)||0,d=Ve(o),c=n?n.split(",").map(g=>g.trim()).filter(Boolean):[],l=c.length===1?c[0]:null;await de();const f=je(t)||We(e);let p=r;if(l)try{p=await Ye(l)}catch(g){m.error("Error fetching user completions:",g)}const y=p>=i;Je(f,i,p,d,y,l,o),L("badgeModal")}window.openBadgeModal=ce;document.addEventListener("DOMContentLoaded",()=>{de()});document.addEventListener("click",e=>{const t=e.target.closest("[data-open-badge]");t&&(e.preventDefault(),ce(t))});document.addEventListener("DOMContentLoaded",()=>{});let R;function ze(e){const t=document.getElementById("deleteGameModal"),o=document.getElementById("deleteGameForm"),n=document.getElementById("deleteGameConfirmInput"),a=document.getElementById("deleteGameCountdown"),s=document.getElementById("deleteGameTimer"),i=document.getElementById("deleteGameConfirmBtn");if(!t||!o||!n||!a||!s||!i){m.warn("Delete game modal elements missing");return}t.dataset.gameId=e,o.action=`/games/delete_game/${e}`,n.value="",i.disabled=!0,a.hidden=!0,s.textContent="5",L("deleteGameModal")}function ee(){const e=document.getElementById("deleteGameConfirmInput"),t=document.getElementById("deleteGameConfirmBtn"),o=document.getElementById("deleteGameCountdown"),n=document.getElementById("deleteGameTimer"),a=document.getElementById("deleteGameUndo"),s=document.getElementById("deleteGameForm");!e||!t||!o||!n||!a||!s||(e.addEventListener("input",()=>{t.disabled=e.value.trim().toLowerCase()!=="delete"}),t.addEventListener("click",()=>{let i=5;o.hidden=!1,n.textContent=i.toString(),R=setInterval(()=>{i-=1,n.textContent=i.toString(),i<=0&&(clearInterval(R),s.submit())},1e3)}),a.addEventListener("click",()=>{clearInterval(R),o.hidden=!0,n.textContent="5",e.value="",t.disabled=!0}))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ee):ee();document.addEventListener("click",e=>{const t=e.target.closest("[data-delete-game-id]");t&&(e.preventDefault(),ze(t.getAttribute("data-delete-game-id")))});document.addEventListener("DOMContentLoaded",()=>{});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("flash-data");if(!e)return;const t=JSON.parse(e.getAttribute("data-messages")||"[]");if(!t.length)return;const[o,n]=t[0],a=document.getElementById("flash-overlay");a.querySelector(".flash-content").textContent=n,a.querySelector(".flash-modal").classList.add(`flash-${o}`),requestAnimationFrame(()=>{a.classList.add("visible")});function s(){a.classList.remove("visible"),e.removeAttribute("data-messages")}a.querySelector(".flash-close").addEventListener("click",s),a.querySelector(".flash-ok-btn").addEventListener("click",s)});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("forgotForm");if(!e)return;const t=document.getElementById("forgotEmailError"),o=document.getElementById("forgotSuccess"),n=document.getElementById("forgotButton"),a=document.getElementById("forgotEmail"),s=document.getElementById("forgotEmailDisplay"),i=document.getElementById("forgotPasswordModal");new MutationObserver(()=>{i.style.display==="block"&&(s.textContent=a.value)}).observe(i,{attributes:!0,attributeFilter:["style"]}),e.addEventListener("submit",d=>{d.preventDefault(),t.style.display="none",o.style.display="none",H(e).then(({json:c})=>{c.success?(o.textContent=c.message,o.style.display="block",n.disabled=!0):(t.textContent=c.error||"An error occurred.",t.style.display="block")}).catch(()=>{e.submit()})})});document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll("button[data-game-id]").forEach(o=>{o.addEventListener("click",function(){t(this)})});function t(o){const n=document.getElementById("questCreationForm"),a=o.getAttribute("data-game-id");n?n.addEventListener("submit",function(s){s.preventDefault();const i=document.getElementById("questDescription").value;v("/ai/generate_quest",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({description:i,game_id:a})}).then(({json:r})=>{const d=r;if(d.generated_quest_html){document.getElementById("generatedQuestContent").innerHTML=d.generated_quest_html,L("generateAIQuestModal");const c=document.getElementById("generateAIQuestModalForm");c&&c.setAttribute("data-game-id",a),c&&c.addEventListener("submit",function(g){g.preventDefault();const b=new FormData(c);v("/ai/create_quest",{method:"POST",body:b}).then(({json:u})=>{window.location.href="/",m.log(u)}).catch(u=>{m.error("Error:",u)})});const l=document.getElementById("generateAIImage"),f=document.getElementById("badge_description"),p=document.getElementById("aiBadgeImage"),y=document.getElementById("aiBadgeFilename");if(!l||!f||!p||!y){m.error("One or more elements not found in the DOM");return}l.addEventListener("click",function(){m.log("Generate AI Image button clicked");const g=f.value;if(m.log("Badge Description:",g),!g){alert("Please enter a badge description first.");return}v("/ai/generate_badge_image",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({badge_description:g})}).then(({json:b})=>{if(m.log("Response data:",b),b.error)alert("Error generating badge image: "+b.error);else{const u=`${b.filename}`,E=`static/images/badge_images/${b.filename}`;p.src=E,p.style.display="block",y.value=u}}).catch(b=>{m.error("Fetch error:",b),alert("Error: "+b)})})}}).catch(r=>{alert("Error generating quest: "+r.message)})}):m.error("Form '#questCreationForm' not found.")}});const Xe=async()=>{try{const t=await(await fetch("/refresh-csrf")).json();document.querySelector('meta[name="csrf-token"]').setAttribute("content",t.csrf_token)}catch(e){m.error("Error refreshing CSRF token:",e)}};setInterval(Xe,9e5);const Ke=async e=>{try{const o=await(await fetch(`/games/get_game_points/${e}`,{credentials:"same-origin"})).json(),n=o.total_game_points,a=o.game_goal,s=a-n,i=Math.min(n/a*100,100),r=document.getElementById("meterBar"),d=document.querySelector(".meter-label");r&&(r.style.height=`${i}%`),document.documentElement.style.setProperty("--meter-fill-height",`${i}%`),d&&(d.innerText=`Remaining Reduction: ${s} / ${a}`)}catch(t){m.error("Failed to update meter:",t)}};function Ze(){const e=document.getElementById("game_IdHolder"),t=document.getElementById("gameNameHeader");if(!e||!t)return;const o=e.getAttribute("data-game-id");fetch(`/games/get_game/${o}`,{credentials:"same-origin"}).then(n=>{if(!n.ok)throw m.error(`Failed fetching game name; URL returned status ${n.status} (${n.statusText})`),t.textContent="Error Loading Game",new Error(`HTTP ${n.status}: ${n.statusText}`);return n.json()}).then(n=>{t.textContent=n.name||"Game Not Found"}).catch(n=>{m.error("Error retrieving game name:",n),t.textContent="Error Loading Game"})}document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("leaderboardButton");e&&e.addEventListener("click",async()=>{const p=e.getAttribute("data-game-id");(await G(()=>import("./chunk-lhdUMYAb.js"),__vite__mapDeps([0,1]))).showLeaderboardModal(p),Ke(p)});const t=document.getElementById("submissionsButton");t&&t.addEventListener("click",()=>{currentUserId!=="none"&&De(currentUserId)});const o=document.getElementById("contactForm");o&&o.addEventListener("submit",async p=>{p.preventDefault();const y=new FormData(o);Y();try{const g=await fetch(o.action,{method:"POST",body:y,headers:{"X-Requested-With":"XMLHttpRequest"}}),b=await g.json();g.ok&&b.success?(alert("Your message has been sent successfully."),M("contactModal")):alert("Failed to send your message. Please try again.")}catch{alert("Failed to send your message. Please try again.")}finally{J()}}),document.getElementById("message-input")&&(document.querySelector("form").onsubmit=()=>!0),document.querySelectorAll(".activity-message").forEach(p=>{p.innerHTML=p.innerHTML.replace(/<\/?p[^>]*>/g,"")});const a=document.getElementById("questSearchInput"),s=document.getElementById("questCategoryDropdown");a&&a.addEventListener("input",te),s&&s.addEventListener("change",te);const i=document.querySelector("#whats-happening-step");if(i){const p=i.querySelectorAll(".wh-tab-button"),y=i.querySelectorAll(".wh-tab-content");p.forEach(g=>{g.addEventListener("click",()=>{const b=g.getAttribute("data-wh-tab");p.forEach(u=>u.classList.remove("active")),y.forEach(u=>u.classList.remove("active")),g.classList.add("active"),i.querySelector(`#wh-${b}-tab`).classList.add("active")})})}const r=document.querySelectorAll(".quest-tab-navigation .quest-tab-button"),d=document.querySelectorAll(".quest-tab-content"),c=document.getElementById("questSearchInput"),l=document.getElementById("questCategoryGroup");r.length&&d.length&&r.forEach(p=>{p.addEventListener("click",()=>{const y=p.getAttribute("data-quest-tab");r.forEach(g=>g.classList.remove("active")),d.forEach(g=>g.classList.remove("active")),p.classList.add("active"),document.getElementById(`${y}-tab`).classList.add("active"),y==="calendar-quests"?(c&&(c.style.display="none"),l&&(l.style.display="none")):(c&&(c.style.display=""),l&&(l.style.display=""))})}),Ze();const f=document.getElementById("clearCalendarQuestsBtn");f&&f.addEventListener("click",async()=>{if(!confirm("Delete all upcoming calendar quests?"))return;const p=f.getAttribute("data-game-id");Y();try{const{status:y,json:g}=await v(`/quests/game/${p}/clear_calendar`,{method:"DELETE"});y===200&&g.success?window.location.reload():alert(g.message||"Failed to clear quests")}catch(y){m.error("Failed to clear calendar quests",y),alert("Failed to clear calendar quests.")}finally{J()}})});function te(){const e=document.getElementById("questSearchInput").value.trim().toLowerCase(),t=document.getElementById("questCategoryDropdown").value;document.querySelectorAll("#questTableBody tr.quest-row").forEach(n=>{const a=n.querySelector(".quest-title").textContent.toLowerCase(),s=n.dataset.category||"Not Set",i=a.includes(e),r=t==="all"||s===t;n.style.display=i&&r?"":"none"})}document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("joinCustomGameModal");if(!e)return;document.querySelectorAll("#customGameList .list-group-item").forEach(function(a){a.addEventListener("click",function(){const s=this.getAttribute("data-game-code");confirm("Do you want to join â€˜"+this.textContent.trim()+"â€™?")&&(document.getElementById("customGameCodeInput").value=s,document.getElementById("joinCustomGameForm").submit())})});const t=e.dataset.hasJoined==="1",o=e.dataset.joinDemoUrl;let n=!1;document.getElementById("joinCustomGameForm").addEventListener("submit",()=>{n=!0}),e.addEventListener("hidden.bs.modal",function(){!n&&!t&&(window.location.href=o)})});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("loginForm"),t=document.getElementById("loginModal");if(!e||!t)return;const o=document.getElementById("passwordError"),n=document.getElementById("forgotPasswordLink"),a=t.querySelector("[data-register-from-login]"),s=t.dataset.checkUrl;e.addEventListener("submit",l=>{l.preventDefault(),o.style.display="none",n&&(n.style.display="none"),H(e).then(({json:f})=>{f.success?window.location.href=f.redirect:(o.textContent=f.error,o.style.display="block",f.show_forgot&&n&&(n.style.display="block"))}).catch(()=>e.submit())});const i=document.getElementById("loginEmail"),r=document.getElementById("loginButton"),d=document.getElementById("emailError");function c(){r.disabled=!0,d.style.display="none",d.textContent="",n&&(n.style.display="none")}c(),n&&n.addEventListener("click",l=>{l.preventDefault(),we()}),a&&a.addEventListener("click",l=>{l.preventDefault(),ve()}),i.addEventListener("blur",()=>{const l=i.value.trim();if(!l)return c();fetch(`${s}?email=${encodeURIComponent(l)}`).then(f=>f.json()).then(f=>{f.exists?r.disabled=!1:(r.disabled=!0,d.textContent="This email is not registered. Please register first.",d.style.display="block")}).catch(()=>r.disabled=!1)}),i.addEventListener("input",c)});let C=null;const et={qr_code:"QR Code",photo:"Photo Upload",comment:"Comment",photo_comment:"Photo Upload and Comment",video:"Video Upload"};let me=[];function ne(){const e=document.getElementById("game_Data");if(!e)return;C=e.dataset.gameId;const t=document.getElementById("deleteAllQuestsBtn");t&&t.addEventListener("click",nt);const o=document.getElementById("importQuestsBtn");o&&o.addEventListener("click",ut),tt().then(()=>P(C))}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ne):ne();async function tt(){try{const e=await fetch("/badges");if(!e.ok)throw new Error("Failed to fetch badges");me=(await e.json()).badges||[]}catch(e){m.error("Error fetching badges:",e)}}function ue(e){const t=document.querySelector(`#quest-${e}`),o={};t.querySelectorAll(".editable").forEach(n=>{o[n.getAttribute("data-name")]=n.innerHTML}),ot(t),at(t),st(t),it(t),lt(t,e,o)}function nt(){confirm("Are you sure you want to delete all quests? This action cannot be undone.")&&$(`/quests/game/${C}/get_title`).then(({json:e})=>{const t=e.title;confirm(`This will delete all quests for the game: "${t}". Are you absolutely sure? This action cannot be undone.`)&&v(`/quests/game/${C}/delete_all`,{method:"DELETE"}).then(({json:o})=>{o.success?(alert("All quests deleted successfully"),P(C)):alert(`Failed to delete quests: ${o.message}`)}).catch(o=>{m.error("Error:",o),alert("Failed to delete all quests. Please check the console for more details.")})}).catch(e=>{m.error("Error fetching game title:",e),alert("Failed to fetch game title. Please check the console for more details.")})}function ot(e){const t=e.querySelector('.editable[data-name="verification_type"]'),o=t.getAttribute("data-value").toLowerCase();let n='<select name="verification_type" class="editable-select">';Object.entries(et).forEach(([a,s])=>{const i=o===a.toLowerCase()?"selected":"";n+=`<option value="${a}" ${i}>${s}</option>`}),n+="</select>",t.innerHTML=n}function at(e){const t=e.querySelector('.editable[data-name="frequency"]'),o=t.getAttribute("data-value").toLowerCase();let n='<select name="frequency" class="editable-select">';Object.entries({daily:"Daily",weekly:"Weekly",monthly:"Monthly"}).forEach(([s,i])=>{const r=o===s.toLowerCase()?"selected":"";n+=`<option value="${s}" ${r}>${i}</option>`}),n+="</select>",t.innerHTML=n}function st(e){const t=e.querySelector('.editable[data-name="badge_name"]');let o=t.innerText.trim(),n='<select name="badge_id" class="editable-select"><option value="">None</option>';me.forEach(a=>{const s=o===a.name?"selected":"";n+=`<option value="${a.id}" ${s}>${a.name}</option>`}),n+="</select>",t.innerHTML=n}function it(e){[{name:"title",type:"text"},{name:"description",type:"textarea"},{name:"tips",type:"textarea"},{name:"points",type:"number"},{name:"badge_awarded",type:"number"},{name:"completion_limit",type:"number"},{name:"category",type:"text"},{name:"enabled",type:"select",options:["Yes","No"]},{name:"is_sponsored",type:"select",options:["Yes","No"]}].forEach(o=>{const n=e.querySelector(`.editable[data-name="${o.name}"]`);n&&rt(n,o)})}function rt(e,t){let o=e.getAttribute("data-value")||e.innerHTML.trim(),n;t.type==="select"?(n=document.createElement("select"),n.name=t.name,t.options.forEach(a=>{const s=document.createElement("option");s.value=a,s.text=a,o===s.text&&(s.selected=!0),n.appendChild(s)})):t.type==="textarea"?(n=document.createElement("textarea"),n.name=t.name,n.value=o):(n=document.createElement("input"),n.type=t.type,n.name=t.name,n.value=o),e.innerHTML="",e.appendChild(n)}function lt(e,t,o){const n=e.querySelector(".edit-button");n.innerText="Save",n.onclick=()=>ct(t);const a=document.createElement("button");a.innerText="Cancel",a.className="btn btn-secondary ms-2 cancel-button",a.onclick=()=>{dt(e,o,n,t)},n.parentNode.insertBefore(a,n.nextSibling)}function dt(e,t,o,n){Object.entries(t).forEach(([a,s])=>{const i=e.querySelector(`.editable[data-name="${a}"]`);i&&(i.innerHTML=s)}),o.innerText="Edit",o.onclick=()=>ue(n),e.querySelector(".cancel-button").remove()}function ct(e){const t=document.querySelector(`#quest-${e}`);let o={};t.querySelectorAll("input, select, textarea").forEach(n=>{let a=n.value;n.name==="enabled"||n.name==="is_sponsored"?a=n.value==="Yes":n.name==="badge_id"&&a===""&&(a=null),o[n.name]=a}),v(`/quests/quest/${e}/update`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)}).then(({json:n})=>{n.success?(alert("Quest updated successfully."),P(C)):alert("Failed to update quest. Error: "+n.message)}).catch(n=>{m.error("Error updating quest:",n),alert("Error updating quest. Please check console for details.")})}function P(e){$(`/quests/game/${e}/quests`).then(({json:t})=>{const o=document.getElementById("questsBody");o.innerHTML="",t.quests.forEach(n=>{const a=document.createElement("div");a.className="card",a.id=`quest-${n.id}`;const s=n.verification_type.toLowerCase(),i=n.badge_name||"None",r=n.frequency||"Not Set",d=n.category||"Not Set",c=n.badge_awarded||"Not Set";a.innerHTML=`
                    <div class="card-body">
                        <h5 class="card-title editable" data-name="title">${n.title}</h5>
                        <div class="card-text editable" data-name="description">${n.description}</div>
                        <div class="card-text editable" data-name="tips">${n.tips||""}</div>
                        <p class="card-text"><strong>Points:</strong> <span class="editable" data-name="points">${n.points}</span></p>
                        <p class="card-text"><strong>Completion Limit:</strong> <span class="editable" data-name="completion_limit">${n.completion_limit}</span></p>
                        <p class="card-text"><strong>Enabled:</strong> <span class="editable" data-name="enabled">${n.enabled?"Yes":"No"}</span></p>
                        <p class="card-text"><strong>Pinned:</strong> <span class="editable" data-name="is_sponsored">${n.is_sponsored?"Yes":"No"}</span></p>
                        <p class="card-text"><strong>Verification:</strong> <span class="editable" data-name="verification_type" data-value="${n.verification_type}">${s}</span></p>
                        <p class="card-text"><strong>Badge:</strong> <span class="editable" data-name="badge_name">${i}</span></p>
                        <p class="card-text"><strong>Badge Awarded:</strong> <span class="editable" data-name="badge_awarded">${c}</span></p>
                        <p class="card-text"><strong>Frequency:</strong> <span class="editable" data-name="frequency" data-value="${n.frequency}">${r}</span></p>
                        <p class="card-text"><strong>Category:</strong> <span class="editable" data-name="category">${d}</span></p>
                        <p class="card-text"><strong>Quest ID:</strong> ${n.id}</p>
                        <p class="card-text"><strong>Completed:</strong> ${n.completed?"Yes":"No"}</p>
                        <p class="card-text"><strong>User ID:</strong> ${n.user_id??"N/A"}</p>
                        <p class="card-text"><strong>Evidence URL:</strong> ${n.evidence_url||"N/A"}</p>
                        <p class="card-text"><strong>Verification Comment:</strong> ${n.verification_comment||""}</p>
                        <p class="card-text"><strong>Game ID:</strong> ${n.game_id}</p>
                        <p class="card-text"><strong>Badge ID:</strong> ${n.badge_id??"N/A"}</p>
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-warning edit-button" data-quest-id="${n.id}">Edit</button>
                            <button class="btn btn-danger delete-button" data-quest-id="${n.id}">Delete</button>
                            <button class="btn btn-info qr-button" data-quest-id="${n.id}">Generate QR Code</button>
                        </div>
                    </div>
                `,o.appendChild(a);const l=a.querySelector(".edit-button"),f=a.querySelector(".delete-button"),p=a.querySelector(".qr-button");l&&l.addEventListener("click",()=>ue(n.id)),f&&f.addEventListener("click",()=>mt(n.id)),p&&p.addEventListener("click",()=>pt(n.id))})}).catch(t=>m.error("Failed to load quests:",t))}function mt(e){v(`/quests/quest/${e}/delete`,{method:"DELETE"}).then(({json:t})=>{t.success?(alert("Quest deleted successfully"),P(C)):alert(`Failed to delete quest: ${t.message}`)}).catch(t=>{m.error("Error:",t),alert("Failed to delete quest. Please check the console for more details.")})}function ut(){const e=document.getElementById("importQuestsForm"),t=new FormData(e);v(`/quests/game/${C}/import_quests`,{method:"POST",body:t}).then(({json:o})=>{o.success&&o.redirectUrl?(alert("Quests imported successfully"),P(C)):alert("Failed to import quests: "+o.message)}).catch(o=>{m.error("Error importing quests:",o)})}function pt(e){const t=`/quests/generate_qr/${e}`;fetch(t).then(o=>{if(!o.ok)throw new Error("Failed to generate QR code");return o.blob()}).then(o=>{const n=URL.createObjectURL(o);window.open(n,"_blank")}).catch(o=>{m.error("Error generating QR code:",o),alert("Failed to generate QR code. Please check console for more details.")})}document.addEventListener("DOMContentLoaded",()=>{});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("notifMenu");if(!e)return;const t=document.getElementById("notifBellToggle"),o=e.querySelector("#notifLoading"),n=e.querySelector("li.dropdown-footer"),a=n.querySelector("#loadMoreBtn"),s=e.dataset.url;let i=0,r=1;const d=parseInt(e.dataset.perPage,10)||10;let c=0;const l={follow:({from_user_name:g,from_user_id:b})=>({text:`Now following ${g}`,onClick:()=>I(b)}),followed_by:({follower_name:g,follower_id:b})=>({text:`${g} is now following you`,onClick:()=>I(b)}),submission:({actor_name:g,quest_name:b,submission_id:u})=>({text:`${g} submitted a new â€œ${b}â€ quest`,onClick:async()=>{const w=await(await fetch(`/quests/submissions/${u}`)).json();q(w)}}),profile_message:({from_user_name:g,content:b,profile_user_id:u})=>({text:`${g} says â€œ${b}â€`,onClick:()=>I(u)}),profile_reply:({from_user_name:g,content:b,profile_user_id:u})=>({text:`${g} replied â€œ${b}â€`,onClick:()=>I(u)}),submission_like:({liker_name:g,submission_id:b})=>({text:`${g} liked your submission`,onClick:async()=>{const E=await(await fetch(`/quests/submissions/${b}`,{credentials:"same-origin"})).json();q(E)}}),submission_reply:({actor_name:g,content:b,submission_id:u})=>({text:`${g} replied â€œ${b}â€`,onClick:async()=>{const w=await(await fetch(`/quests/submissions/${u}`,{credentials:"same-origin"})).json();q(w)}})};function f(g){const b=l[g.type];let u,E;if(b&&g.payload)try{({text:u,onClick:E}=b(g.payload))}catch(_){m.error(`Error in handler for ${g.type}:`,_)}(!u||!E)&&(u=g.payload.summary||JSON.stringify(g.payload),E=()=>{window.location.href="/notifications/"});const w=g.is_read?"":"fw-bold",h=document.createElement("a");h.href="#",h.className=`dropdown-item ${w}`,h.innerHTML=`
      ${u}
      <small class="text-muted d-block text-center">
        ${new Date(g.when).toLocaleString()}
      </small>`,h.addEventListener("click",async _=>{_.preventDefault();try{await E()}catch(B){m.error(B)}});const S=document.createElement("li");return S.appendChild(h),S}function p(g){g&&g.parentNode===e&&e.removeChild(g)}async function y(g){g===1&&(Array.from(e.children).forEach(w=>{w!==o&&w!==n&&e.removeChild(w)}),i=0,c=0),p(o),p(n),e.appendChild(o),e.appendChild(n),o.style.display="",a.disabled=!0;let b;try{b=await fetch(`${s}?page=${g}&per_page=${d}`,{credentials:"include"})}catch(w){o.textContent="Network error.",m.error(w);return}if(!b.ok){o.textContent="Error loading.",m.error("Status:",b.status,b.statusText);return}const u=await b.json();i=u.page,r=u.total_pages,p(o),p(n);const E=t.querySelector(".badge");E&&E.remove(),u.items.forEach(w=>{if(c>0){const h=document.createElement("li"),S=document.createElement("hr");S.className="dropdown-divider",h.appendChild(S),e.appendChild(h)}e.appendChild(f(w)),c+=1}),e.appendChild(o),e.appendChild(n),o.style.display="none",a.disabled=i>=r}t.addEventListener("show.bs.dropdown",()=>{i===0&&y(1)}),a.addEventListener("click",g=>{g.preventDefault(),g.stopPropagation(),i<r&&y(i+1)})});document.addEventListener("DOMContentLoaded",()=>{typeof window>"u"||typeof navigator>"u"||!("serviceWorker"in navigator)||!("PushManager"in window)||navigator.serviceWorker.ready.then(async e=>{try{const t=await fetch("/push/public_key");if(!t.ok)return;let o;try{({public_key:o}=await t.json())}catch(s){m.error("Push setup failed",s);return}if(!o||await e.pushManager.getSubscription())return;const a=await e.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:gt(o)});await fetch("/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscription:a})})}catch(t){m.error("Push setup failed",t)}})});function gt(e){const t="=".repeat((4-e.length%4)%4),o=(e+t).replace(/-/g,"+").replace(/_/g,"/"),n=atob(o),a=new Uint8Array(n.length);for(let s=0;s<n.length;++s)a[s]=n.charCodeAt(s);return a}function ft(e){const t=document.querySelector(`meta[name="${e}"]`);return t?t.content:""}const bt=Number(ft("current-user-id")||0),yt=ye(),k=document.querySelector('meta[name="placeholder-image"]').getAttribute("content");function j(e){se(),$(`/quests/detail/${e}/user_completion`).then(({json:t})=>{const{quest:o,userCompletion:n,canVerify:a,nextEligibleTime:s}=t;if(!pe(o,n.completions,a,e,s)){m.error("populateQuestDetails â€“ required element missing");return}ge(o,n.completions,s,a),L("questDetailModal"),W(),be(e)}).catch(t=>{m.error("Error opening quest detail modal:",t),alert("Sign in to view quest details.")})}window.openQuestDetailModal=j;function ht(e){$(`/quests/detail/${e}/user_completion`).then(({json:t})=>{const{quest:o,userCompletion:n,canVerify:a,nextEligibleTime:s}=t;if(!pe(o,n.completions,a,e,s)){m.error("populateQuestDetails - required element missing");return}ge(o,n.completions,s,a),W(),be(e)}).catch(t=>{m.error("Failed to refresh quest detail modal:",t)})}function W(){const e=document.querySelectorAll("img.lazyload"),t=new IntersectionObserver((o,n)=>{o.forEach(a=>{if(a.isIntersecting){const s=a.target;s.src=s.getAttribute("data-src"),s.classList.remove("lazyload"),n.unobserve(s)}})});e.forEach(o=>{t.observe(o)})}function pe(e,t,o,n,a){const s=t>=e.completion_limit?" - complete":"",i={modalQuestTitle:document.getElementById("modalQuestTitle"),modalQuestDescription:document.getElementById("modalQuestDescription"),modalQuestTips:document.getElementById("modalQuestTips"),modalQuestPoints:document.getElementById("modalQuestPoints"),modalQuestCompletionLimit:document.getElementById("modalQuestCompletionLimit"),modalQuestBadgeAwarded:document.getElementById("modalQuestBadgeAwarded"),modalQuestCategory:document.getElementById("modalQuestCategory"),modalQuestVerificationType:document.getElementById("modalQuestVerificationType"),modalQuestBadgeImage:document.getElementById("modalQuestBadgeImage"),modalQuestCompletions:document.getElementById("modalQuestCompletions"),modalCountdown:document.getElementById("modalCountdown")};for(let f in i)if(!i[f])return m.error(`Error: Missing element ${f}`),!1;i.modalQuestTitle.innerText=`${e.title}${s}`,i.modalQuestDescription.textContent=e.description,i.modalQuestTips.textContent=e.tips||"No tips available",i.modalQuestPoints.innerText=`${e.points}`,i.modalQuestCategory.innerText=e.category||"No category set";const r=e.completion_limit>1?`${e.completion_limit} times`:`${e.completion_limit} time`;i.modalQuestCompletionLimit.innerText=`${r} ${e.frequency}`;const d=e.badge_awarded>1?`${e.badge_awarded} times`:`${e.badge_awarded} time`;switch(e.badge_awarded!=null?i.modalQuestBadgeAwarded.innerText=`After ${d}`:i.modalQuestBadgeAwarded.innerText="No badge awarded",e.verification_type){case"photo_comment":i.modalQuestVerificationType.innerText="Must upload a photo to earn points! Comment optional.";break;case"photo":i.modalQuestVerificationType.innerText="Must upload a photo to earn points!";break;case"comment":i.modalQuestVerificationType.innerText="Must upload a comment to earn points!";break;case"qr_code":i.modalQuestVerificationType.innerText="Find the QR code and post a photo to earn points!";break;default:i.modalQuestVerificationType.innerText="Not specified";break}const c=e.badge&&e.badge.image?`/static/images/badge_images/${e.badge.image}`:k;i.modalQuestBadgeImage.setAttribute("data-src",c),i.modalQuestBadgeImage.src=k,i.modalQuestBadgeImage.classList.add("lazyload"),i.modalQuestBadgeImage.alt=e.badge&&e.badge.name?`Badge: ${e.badge.name}`:"Default Badge",i.modalQuestCompletions.innerText=`Total Completions: ${t}`;const l=a&&new Date(a);return!o&&l&&l>new Date?(i.modalCountdown.innerText=`Next eligible time: ${l.toLocaleString()}`,i.modalCountdown.style.color="red"):(i.modalCountdown.innerText="You are currently eligible to verify!",i.modalCountdown.style.color="green"),wt(n,o,e.verification_type),!0}function ge(e,t,o,n){const a=document.querySelector(".user-quest-data");if(!a){m.error("Parent element .user-quest-data not found");return}[{id:"modalQuestCompletions",value:`${t||0}`},{id:"modalCountdown",value:""}].forEach(i=>{let r=document.getElementById(i.id);r||(r=document.createElement("p"),r.id=i.id,a.appendChild(r)),r.innerText=i.value}),Et(document.getElementById("modalCountdown"),o,n)}function Et(e,t,o){if(!o&&t){const n=new Date(t),a=new Date;if(n>a){const s=n-a;e.innerText=`Next eligible time: ${vt(s)}`}else e.innerText="You are currently eligible to verify!"}else e.innerText="You are currently eligible to verify!"}function vt(e){const t=Math.floor(e/1e3%60),o=Math.floor(e/(1e3*60)%60),n=Math.floor(e/(1e3*60*60)%24);return`${Math.floor(e/(1e3*60*60*24))}d ${n}h ${o}m ${t}s`}function wt(e,t,o){const n=document.querySelector(".user-quest-data");if(!n){m.error("Parent element .user-quest-data not found");return}if(n.innerHTML="",t){const a=document.createElement("div");a.id=`verifyQuestForm-${e}`,a.className="verify-quest-form",a.style.display="block";const s=Bt(o.trim().toLowerCase(),e);a.innerHTML=s,n.appendChild(a),Lt(e)}}function Bt(e,t){let o=`
    <form enctype="multipart/form-data" class="epic-form" method="post" action="/quests/quest/${t}/submit">
      <input type="hidden" name="csrf_token" value="${yt}">
      <h2 style="text-align:center;">Verify Your Quest</h2>
  `;switch(e){case"photo":o+=`
        <div class="form-group">
          <label for="image" class="epic-label">Upload a Photo</label>
          <input type="file" id="image" name="image"
                 class="epic-input" accept="image/*" required>
        </div>
        <div class="form-group">
          <button type="submit">Submit Verification</button>
        </div>
      `;break;case"comment":o+=`
        <div class="form-group">
          <label for="verificationComment" class="epic-label">Enter a Comment</label>
          <textarea id="verificationComment" name="verificationComment"
                    class="epic-textarea" placeholder="Enter a comment..." required></textarea>
        </div>
        <div class="form-group">
          <button type="submit">Submit Verification</button>
        </div>
      `;break;case"photo_comment":o+=`
        <div class="form-group">
          <label for="image" class="epic-label">Upload a Photo</label>
          <input type="file" id="image" name="image"
                 class="epic-input" accept="image/*" required>
        </div>
        <div class="form-group">
          <label for="verificationComment" class="epic-label">Enter a Comment (optional)</label>
          <textarea id="verificationComment" name="verificationComment"
                    class="epic-textarea" placeholder="Enter a comment..."></textarea>
        </div>
        <div class="form-group">
          <button type="submit">Submit Verification</button>
        </div>
      `;break;case"video":o+=`
        <div class="form-group">
          <label for="video" class="epic-label">Upload a Video</label>
          <input type="file" id="video" name="video"
                 class="epic-input" accept="video/*" required>
        </div>
        <div class="form-group">
          <label for="verificationComment" class="epic-label">Add a Comment (optional)</label>
          <textarea id="verificationComment" name="verificationComment"
                    class="epic-textarea" placeholder="Enter an optional comment..."></textarea>
        </div>
        <div class="form-group">
          <button type="submit">Submit Verification</button>
        </div>
      `;break;case"qr_code":o+='<p class="epic-message">Find and scan the QR code. No submission required here.</p>';break;case"pause":o+='<p class="epic-message">Quest is currently paused.</p>';break;default:o+='<p class="epic-message">Submission requirements are not set correctly.</p>';break}return o+="</form>",o}function Lt(e){const t=document.getElementById(`verifyQuestForm-${e}`);if(!t){m.error("Form container not found for quest ID:",e);return}const o=t.querySelector("form");if(!o){m.error("Form element missing for quest ID:",e);return}o.addEventListener("submit",function(n){Ct(n,e)})}function Q(e,t){e&&(t&&t.trim()?(e.href=t,e.style.display="inline"):e.style.display="none")}function _t(e){if(!e)return;const t=document.getElementById("total-points");t&&(t.innerText=`Total Completed Points: ${e}`)}function It(e,t,o){const n=document.querySelector(`#questTableBody tr[data-quest-id="${e}"]`);if(!n)return;const a=n.querySelectorAll(".quest-stats-cell");a.length>=2&&(a[0].innerText=t,a[1].innerText=o)}function fe(e){Q(document.getElementById("twitterLink"),e.twitter_url),Q(document.getElementById("facebookLink"),e.fb_url),Q(document.getElementById("instagramLink"),e.instagram_url)}let O=!1;async function Ct(e,t){if(e.preventDefault(),O)return;O=!0;const o=e.target.querySelector('[type="submit"]');o&&(o.disabled=!0);try{const n=e.target.querySelector('input[type="file"]'),a=n?n.files[0]:null;if(a&&a.type.startsWith("video/")&&a.size>10*1024*1024){alert("Video must be 10 MB or smaller.");return}if(a&&a.type.startsWith("image/")&&a.size>8*1024*1024){alert("Image must be 8 MB or smaller.");return}const s=new FormData(e.target);s.append("user_id",bt);const{status:i,json:r}=await v(`/quests/quest/${t}/submit`,{method:"POST",body:s});if(i!==200)throw i===403&&r.message==="This quest cannot be completed outside of the game dates"?new Error("The game has ended and you can no longer submit quests. Join a new game in the game dropdown menu."):new Error(r.message||`Server responded with status ${i}`);if(!r.success)throw new Error(r.message);if(!r.success)throw new Error(r.message);_t(r.total_points),fe(r),It(t,r.new_completion_count,r.total_completion_count),ht(t),e.target.reset()}catch(n){m.error("Submission error:",n),alert(`Error during submission: ${n.message}`)}finally{O=!1,o&&(o.disabled=!1)}}async function be(e){try{const{json:t}=await $(`/quests/quest/${e}/submissions`),o=document.getElementById("twitterLink"),n=document.getElementById("facebookLink"),a=document.getElementById("instagramLink");if(t&&t.length){const i=t[0],r=document.getElementById("submissionImage"),d=document.getElementById("submissionVideo"),c=document.getElementById("submissionVideoSource"),l=document.getElementById("submissionComment"),f=document.getElementById("submitterProfileLink"),p=document.getElementById("submitterProfileImage"),y=document.getElementById("submitterProfileCaption");i.video_url?(r.hidden=!0,d.hidden=!1,c.src=i.video_url,d.load()):(d.hidden=!0,r.hidden=!1,r.src=i.image_url||k),l.textContent=i.comment||"No comment provided.",f.href=`/profile/${i.user_id}`,p.src=i.user_profile_picture||k,y.textContent=i.user_display_name||i.user_username||`User ${i.user_id}`,fe(i)}else[o,n,a].forEach(i=>{i&&(i.style.display="none")});const s=t.slice().reverse().map(i=>({id:i.id,url:i.image_url||(i.video_url?null:k),video_url:i.video_url,alt:"Submission Image",comment:i.comment,user_id:i.user_id,user_display_name:i.user_display_name,user_username:i.user_username,user_profile_picture:i.user_profile_picture,twitter_url:i.twitter_url,fb_url:i.fb_url,instagram_url:i.instagram_url,quest_id:e}));kt(s)}catch(t){m.error("Failed to fetch submissions:",t),alert("Could not load submissions. Please try again.")}}function oe(e){if(!e)return m.error(`Invalid URL detected: ${e}`),!1;try{if(e.startsWith("/"))return!0;const t=new URL(e);if(t.protocol==="http:"||t.protocol==="https:")return[".jpg",".jpeg",".png",".gif",".webp"].some(n=>t.pathname.toLowerCase().endsWith(n))}catch{return m.error(`Invalid URL detected: ${e}`),!1}return!1}function kt(e){var d;const t=document.getElementById("submissionBoard");if(!t){m.error("submissionBoard element not found");return}t.innerHTML="";const o=((d=document.getElementById("questDetailModal"))==null?void 0:d.getAttribute("data-placeholder-url"))||k,n=oe(o)?o:k,a=c=>c.startsWith("/static/"),s=c=>c.replace(/^\/static\//,""),i=window.innerWidth<=480?70:100,r=Math.round(i*(window.devicePixelRatio||2));e.forEach(c=>{let l;if(c.video_url)l=document.createElement("video"),l.src=c.video_url,l.preload="metadata",l.muted=!0,l.playsInline=!0,l.style.objectFit="cover";else{l=document.createElement("img");const f=oe(c.url)?c.url:n,p=a(f)?`/resize_image?path=${encodeURIComponent(s(f))}&width=${r}`:f;l.src=k,l.setAttribute("data-src",p),l.classList.add("lazyload"),l.alt=c.alt||"Submission Image"}l.style.width=`${i}px`,l.style.height="auto",l.style.marginRight="10px",c.video_url||(l.onerror=()=>{a(n)?l.src=`/resize_image?path=${encodeURIComponent(s(n))}&width=${r}`:l.src=n}),l.onclick=()=>q(c),t.appendChild(l)}),W()}function $t(e){e.querySelectorAll("span, img").forEach(o=>{o.classList.toggle("hidden")})}document.addEventListener("click",e=>{const t=e.target.closest("[data-quest-detail]");if(t){e.preventDefault(),j(t.getAttribute("data-quest-detail"));return}const o=e.target.closest("[data-toggle-content]");o&&o.closest("#questDetailModal")&&(e.preventDefault(),$t(o))});const St=Object.freeze(Object.defineProperty({__proto__:null,openQuestDetailModal:j},Symbol.toStringTag,{value:"Module"}));document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("registerEmail");if(!e)return;const t=document.getElementById("registerModal"),o=(t==null?void 0:t.dataset.checkUrl)||"/auth/check_email",n=document.getElementById("existingUserLogin");n&&(e.addEventListener("blur",()=>{const a=e.value.trim();a&&fetch(`${o}?email=${encodeURIComponent(a)}`).then(s=>s.json()).then(s=>{s.exists?n.style.display="block":n.style.display="none"}).catch(s=>{m.error("Error checking email:",s),n.style.display="none"})}),document.getElementById("loginWithExistingBtn").addEventListener("click",()=>{const a=e.value.trim(),s=document.getElementById("existingUserPassword").value,i=document.getElementById("loginError"),r=document.getElementById("gameIdField").value,d=document.getElementById("questIdField").value,c=document.getElementById("nextField").value,l=new FormData;l.append("email",a),l.append("password",s),l.append("remember_me","true"),r&&l.append("game_id",r),d&&l.append("quest_id",d),c&&l.append("next",c),fetch('{{ url_for("auth.login") }}',{method:"POST",headers:{"X-Requested-With":"XMLHttpRequest"},body:l,credentials:"same-origin"}).then(f=>f.json().then(p=>({payload:p}))).then(({payload:f})=>{f.success?window.location.href=f.redirect:(i.textContent=f.error,i.style.display="block")}).catch(f=>{m.error("Login error:",f),i.textContent="An error occurred. Please try again.",i.style.display="block"})}),e.addEventListener("input",()=>{n.style.display="none",document.getElementById("loginError").style.display="none"}))});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("resetForm");if(!e)return;const t=document.getElementById("resetError"),o=document.getElementById("resetSuccess"),n=document.getElementById("resetButton");e.addEventListener("submit",a=>{a.preventDefault(),t.style.display="none",o.style.display="none",H(e).then(({json:s})=>{s.success?(o.textContent=s.message,o.style.display="block",n.disabled=!0,s.redirect&&setTimeout(()=>{window.location.href=s.redirect},1200)):(t.textContent=s.error||"Unable to reset password.",t.style.display="block")}).catch(s=>{m.error("Reset-password AJAX error:",s),e.submit()})})});document.addEventListener("DOMContentLoaded",()=>{const e="shoutBoardModal",t=document.getElementById("shoutBoardForm"),o=document.getElementById("shoutSubmitBtn"),n=document.getElementById("shoutMessageInput");window.addEventListener("openModal",a=>{a.detail===e&&n&&(n.value="")}),o.addEventListener("click",()=>{const a=n?n.value.trim():"";if(!a){alert("Please enter a message.");return}if(a.length>500){alert("Message must be 500 characters or fewer.");return}const s=new FormData(t);fetch(t.action,{method:"POST",body:s,credentials:"same-origin"}).then(i=>{if(!i.ok)throw new Error(`Server responded ${i.status}`);return i.text()}).then(()=>{M(e),location.reload()}).catch(i=>{m.error("Failed to post shout:",i),alert("Could not post. Please try again.")})})});var ae;(ae=document.getElementById("gameFilter"))==null||ae.addEventListener("change",function(){const e=this.value;e?window.location.href=`/admin/user_management/game/${e}`:window.location.href="/admin/user_management"});document.addEventListener("DOMContentLoaded",()=>{_e()});export{I as a,L as o,De as s};
