const u="1.2.1-9665ee0",d=`questbycycle-${u}`,h=["/offline.html",`/static/dist/style.css?v=${u}`,`/static/dist/main.js?v=${u}`,`/static/dist/submitPhoto.js?v=${u}`,"/static/icons/icon_48x48.webp","/static/icons/icon_96x96.webp","/static/icons/icon_192x192.webp","/static/icons/icon_512x512.webp","/static/icons/apple-touch-icon-180x180.png","/static/images/welcomeQuestByCycle.webp"],y="questbycycle-sync",c="queued";function f(){return new Promise((e,t)=>{const s=indexedDB.open(y,1);s.onupgradeneeded=i=>{i.target.result.createObjectStore(c,{autoIncrement:!0})},s.onsuccess=()=>e(s.result),s.onerror=()=>t(s.error)})}async function p(e){const t=await f();return new Promise((s,i)=>{const n=t.transaction(c,"readwrite");n.objectStore(c).add(e),n.oncomplete=()=>s(),n.onerror=()=>i(n.error)})}async function w(e){const t=await f();return new Promise((s,i)=>{const o=t.transaction(c,"readonly").objectStore(c).openCursor();o.onsuccess=async r=>{const l=r.target.result;l?(await e(l.value,l.key),l.continue()):s()},o.onerror=()=>i(o.error)})}async function g(e){const t=await f();return new Promise((s,i)=>{const n=t.transaction(c,"readwrite");n.objectStore(c).delete(e),n.oncomplete=()=>s(),n.onerror=()=>i(n.error)})}async function m(){await w(async(e,t)=>{try{await fetch(e.url,{method:e.method,headers:e.headers,body:e.body}),await g(t)}catch(s){console.error("Background sync failed for",e.url,s)}})}self.addEventListener("install",e=>{e.waitUntil((async()=>{const t=await caches.open(d);try{await t.addAll(h),console.log("Resources cached successfully!")}catch(s){console.error("Failed to cache resources:",s)}})()),self.skipWaiting()});self.addEventListener("activate",e=>{e.waitUntil((async()=>{const t=await caches.keys();let s=!1;await Promise.all(t.map(i=>{if(i!==d)return console.log(`Deleting old cache: ${i}`),s=!0,caches.delete(i)})),await self.clients.claim(),s&&q()})())});function q(){self.clients.matchAll().then(e=>{e.forEach(t=>{t.postMessage({type:"UPDATE_AVAILABLE"})})})}function b(e){return e.method!=="GET"||!["style","script","image","font"].includes(e.destination)?!1:new URL(e.url).origin===self.location.origin}self.addEventListener("fetch",e=>{if(new URL(e.request.url).origin!==self.location.origin)return;const s=["video","audio"].includes(e.request.destination),i=e.request.headers.has("range");if(s||i){e.respondWith(fetch(e.request));return}if(["POST","PUT","DELETE"].includes(e.request.method)&&e.request.mode!=="navigate"){e.respondWith((async()=>{try{return await fetch(e.request.clone())}catch{const n={};for(const[o,r]of e.request.headers.entries())n[o]=r;const a=await e.request.clone().text();return await p({url:e.request.url,method:e.request.method,headers:n,body:a}),"sync"in self.registration&&await self.registration.sync.register("sync-requests"),new Response(JSON.stringify({queued:!0}),{status:202,headers:{"Content-Type":"application/json"}})}})());return}if(e.request.mode==="navigate"){e.respondWith(fetch(e.request).catch(()=>caches.match("/offline.html")));return}e.respondWith((async()=>{try{const n=await caches.open(d),a=await n.match(e.request);if(a)return a;const o=await fetch(e.request);if(b(e.request)&&o.status!==206)try{n.put(e.request,o.clone())}catch(r){console.error("Cache put failed:",r)}return o}catch(n){return console.error("Fetch failed; returning offline page instead.",n),await caches.match("/offline.html")||Response.error()}})())});self.addEventListener("sync",e=>{e.tag==="sync-requests"&&e.waitUntil(m())});self.addEventListener("message",e=>{e.data.type==="SKIP_WAITING"&&self.skipWaiting()});self.addEventListener("sync",e=>{e.tag==="sync-notifications"&&e.waitUntil(fetch("/notifications/unread_count"))});self.addEventListener("periodicsync",e=>{e.tag==="periodic-notifications"&&e.waitUntil(fetch("/notifications/unread_count"))});self.addEventListener("push",e=>{let t={};if(e.data)try{t=e.data.json()}catch{t={body:e.data.text()}}const s=t.title||"QuestByCycle",i={body:t.body||"",icon:"/static/icons/icon_96x96.webp",data:t};e.waitUntil(self.registration.showNotification(s,i))});self.addEventListener("notificationclick",e=>{e.notification.close(),e.waitUntil(clients.openWindow("/notifications/"));const t=e.notification.data&&e.notification.data.url;t&&e.waitUntil(clients.openWindow(t))});
