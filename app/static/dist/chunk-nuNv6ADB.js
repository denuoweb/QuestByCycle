import{o as C,s as b,a as E}from"./main.js";import{l as u}from"./chunk-bAx52a36.js";let m=null,p="points",i;async function L(l){const t=document.getElementById("leaderboardModalContent");if(!t){u.error("Leaderboard modal content element not found. Cannot proceed with displaying leaderboard."),alert("Leaderboard modal content element not found. Please ensure the page has loaded completely and the correct ID is used.");return}try{const e=await fetch(`/leaderboard_partial?game_id=${l}`,{headers:{"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(e.redirected&&e.url.includes("/auth/login")){window.location.href=e.url;return}if(e.status===401){window.location.href="/auth/login?next="+encodeURIComponent(window.location.pathname);return}if(!e.ok)throw new Error("Failed to fetch leaderboard data");const n=e.headers.get("content-type");if(!n||!n.includes("application/json"))throw u.error("Unexpected content type for leaderboard:",n),new Error("Invalid server response");let o;try{o=await e.json()}catch(a){throw u.error("Invalid JSON in leaderboard response",a),new Error("Invalid server response")}t.innerHTML="",m=o,p="points",y(t,o,l),v(t,o,l),_(t),w(t,o),x(t),f(),C("leaderboardModal")}catch(e){u.error("Failed to load leaderboard:",e),alert("Failed to load leaderboard data. Please try again.")}}function y(l,t,e){if(t.games&&t.games.length>1){const n=document.createElement("form");n.method="get",n.action="#";const o=document.createElement("label");o.for="game_Select",o.textContent="Select Game:",n.appendChild(o);const a=document.createElement("select");a.name="game_id",a.id="game_Select",a.className="form-control",a.onchange=()=>n.submit(),t.games.forEach(r=>{const d=document.createElement("option");d.value=r.id,d.textContent=r.title,d.selected=r.id===e,a.appendChild(d)}),n.appendChild(a),l.appendChild(n)}}function _(l){const t=document.createElement("div");t.className="form-check form-switch my-3";const e=document.createElement("input");e.className="form-check-input",e.type="checkbox",e.id="metricToggle";const n=document.createElement("label");n.className="form-check-label",n.htmlFor="metricToggle",n.textContent="Show Completed Quests",e.addEventListener("change",()=>{p=e.checked?"quests":"points",f()}),t.appendChild(e),t.appendChild(n),l.appendChild(t)}function w(l,t){if(!t.secondary_stats||t.secondary_stats.length===0)return;const e=document.createElement("ul");e.className="list-group my-3",t.secondary_stats.forEach(n=>{const o=document.createElement("li");o.className="list-group-item d-flex justify-content-between align-items-center",o.textContent=n.label;const a=document.createElement("span");a.className="badge bg-primary rounded-pill",a.textContent=n.value,o.appendChild(a),e.appendChild(o)}),l.appendChild(e)}function x(l){const t=document.createElement("table");t.className="table table-striped";const e=document.createElement("thead"),n=document.createElement("tr");["Rank","Player","Points"].forEach((o,a)=>{const r=document.createElement("th");a===2&&(r.id="leaderboardMetricHeader"),r.textContent=o,n.appendChild(r)}),e.appendChild(n),t.appendChild(e),i=document.createElement("tbody"),t.appendChild(i),l.appendChild(t)}function g(l,t,e=!1,n=null){const o=document.createElement("td");if(e){const a=document.createElement("a");a.href="javascript:void(0)",a.onclick=()=>E(n),a.textContent=t,o.appendChild(a)}else o.textContent=t;l.appendChild(o)}function v(l,t,e){if(t.total_game_points&&t.game_goal){const n=document.createElement("div");n.className="completion-meter-container";const o=document.createElement("div");o.className="inspirational-text",o.textContent="It takes a village to enact changeâ€¦",n.appendChild(o);const a=t.game_goal-t.total_game_points,r=Math.min(t.total_game_points/t.game_goal*100,100),d=document.createElement("div");d.className="meter-label",d.textContent=`Carbon Reduction Points: ${t.total_game_points} / ${t.game_goal} (Remaining: ${a})`,n.appendChild(d);const s=document.createElement("div");s.className="completion-meter",s.id="completionMeter",s.addEventListener("click",()=>b(e));const h=document.createElement("div");h.className="click-text",h.textContent="Click to view all game submissions!",s.appendChild(h);const c=document.createElement("div");c.className="meter-bar",c.id="meterBar",c.style.height="0%",c.style.opacity="1",c.dataset.label=`${r.toFixed(1)}% Reduced`,s.appendChild(c),n.appendChild(s),l.appendChild(n),setTimeout(()=>{c.style.height=`${r}%`,c.style.opacity=`${1-r/100}`,M(r,e)},100)}}function M(l,t){const e=document.getElementById("completionMeter"),n=9-Math.min(Math.floor(l/10),9);e.style.backgroundImage=`url('/static/images/leaderboard/smoggy_skyline_${t}_${n}.png')`}function f(){if(!m||!i)return;if(!m.top_users||m.top_users.length===0){i.innerHTML="";const e=document.createElement("tr"),n=document.createElement("td");n.colSpan=3,n.textContent="Join a game to see the leaderboard!",e.appendChild(n),i.appendChild(e);return}i.innerHTML="";const l=document.getElementById("leaderboardMetricHeader");l&&(l.textContent=p==="quests"?"Quests Completed":"Points");const t=[...m.top_users];t.sort((e,n)=>p==="quests"?n.completed_quests-e.completed_quests:n.total_points-e.total_points),t.forEach((e,n)=>{const o=document.createElement("tr");g(o,n+1);const a=e.display_name||e.username;g(o,a,!0,e.user_id);const r=p==="quests"?e.completed_quests:e.total_points;g(o,r),i.appendChild(o)})}export{L as showLeaderboardModal};
