import{o as b,s as f,a as E}from"./main.js";import{l as h}from"./chunk-Bu8AA3up.js";let m=null,p="points",i;async function L(l){const e=document.getElementById("leaderboardModalContent");if(!e){h.error("Leaderboard modal content element not found. Cannot proceed with displaying leaderboard."),alert("Leaderboard modal content element not found. Please ensure the page has loaded completely and the correct ID is used.");return}try{const n=await fetch(`/leaderboard_partial?game_id=${l}`,{headers:{"X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(n.status===401){window.location.href="/auth/login?next="+encodeURIComponent(window.location.pathname);return}if(!n.ok)throw new Error("Failed to fetch leaderboard data");let t;try{t=await n.json()}catch(o){throw h.error("Invalid JSON in leaderboard response",o),new Error("Invalid server response")}e.innerHTML="",m=t,p="points",_(e,t,l),w(e,t,l),y(e),x(e,t),M(e),C(),b("leaderboardModal")}catch(n){h.error("Failed to load leaderboard:",n),alert("Failed to load leaderboard data. Please try again.")}}function _(l,e,n){if(e.games&&e.games.length>1){const t=document.createElement("form");t.method="get",t.action="#";const o=document.createElement("label");o.for="game_Select",o.textContent="Select Game:",t.appendChild(o);const a=document.createElement("select");a.name="game_id",a.id="game_Select",a.className="form-control",a.onchange=()=>t.submit(),e.games.forEach(r=>{const d=document.createElement("option");d.value=r.id,d.textContent=r.title,d.selected=r.id===n,a.appendChild(d)}),t.appendChild(a),l.appendChild(t)}}function y(l){const e=document.createElement("div");e.className="form-check form-switch my-3";const n=document.createElement("input");n.className="form-check-input",n.type="checkbox",n.id="metricToggle";const t=document.createElement("label");t.className="form-check-label",t.htmlFor="metricToggle",t.textContent="Show Completed Quests",n.addEventListener("change",()=>{p=n.checked?"quests":"points",C()}),e.appendChild(n),e.appendChild(t),l.appendChild(e)}function x(l,e){if(!e.secondary_stats||e.secondary_stats.length===0)return;const n=document.createElement("ul");n.className="list-group my-3",e.secondary_stats.forEach(t=>{const o=document.createElement("li");o.className="list-group-item d-flex justify-content-between align-items-center",o.textContent=t.label;const a=document.createElement("span");a.className="badge bg-primary rounded-pill",a.textContent=t.value,o.appendChild(a),n.appendChild(o)}),l.appendChild(n)}function M(l){const e=document.createElement("table");e.className="table table-striped";const n=document.createElement("thead"),t=document.createElement("tr");["Rank","Player","Points"].forEach((o,a)=>{const r=document.createElement("th");a===2&&(r.id="leaderboardMetricHeader"),r.textContent=o,t.appendChild(r)}),n.appendChild(t),e.appendChild(n),i=document.createElement("tbody"),e.appendChild(i),l.appendChild(e)}function g(l,e,n=!1,t=null){const o=document.createElement("td");if(n){const a=document.createElement("a");a.href="javascript:void(0)",a.onclick=()=>E(t),a.textContent=e,o.appendChild(a)}else o.textContent=e;l.appendChild(o)}function w(l,e,n){if(e.total_game_points&&e.game_goal){const t=document.createElement("div");t.className="completion-meter-container";const o=document.createElement("div");o.className="inspirational-text",o.textContent="It takes a village to enact changeâ€¦",t.appendChild(o);const a=e.game_goal-e.total_game_points,r=Math.min(e.total_game_points/e.game_goal*100,100),d=document.createElement("div");d.className="meter-label",d.textContent=`Carbon Reduction Points: ${e.total_game_points} / ${e.game_goal} (Remaining: ${a})`,t.appendChild(d);const s=document.createElement("div");s.className="completion-meter",s.id="completionMeter",s.addEventListener("click",()=>f(n));const u=document.createElement("div");u.className="click-text",u.textContent="Click to view all game submissions!",s.appendChild(u);const c=document.createElement("div");c.className="meter-bar",c.id="meterBar",c.style.height="0%",c.style.opacity="1",c.dataset.label=`${r.toFixed(1)}% Reduced`,s.appendChild(c),t.appendChild(s),l.appendChild(t),setTimeout(()=>{c.style.height=`${r}%`,c.style.opacity=`${1-r/100}`,v(r,n)},100)}}function v(l,e){const n=document.getElementById("completionMeter"),t=9-Math.min(Math.floor(l/10),9);n.style.backgroundImage=`url('/static/images/leaderboard/smoggy_skyline_${e}_${t}.png')`}function C(){if(!m||!i)return;if(!m.top_users||m.top_users.length===0){i.innerHTML="";const n=document.createElement("tr"),t=document.createElement("td");t.colSpan=3,t.textContent="Join a game to see the leaderboard!",n.appendChild(t),i.appendChild(n);return}i.innerHTML="";const l=document.getElementById("leaderboardMetricHeader");l&&(l.textContent=p==="quests"?"Quests Completed":"Points");const e=[...m.top_users];e.sort((n,t)=>p==="quests"?t.completed_quests-n.completed_quests:t.total_points-n.total_points),e.forEach((n,t)=>{const o=document.createElement("tr");g(o,t+1);const a=n.display_name||n.username;g(o,a,!0,n.user_id);const r=p==="quests"?n.completed_quests:n.total_points;g(o,r),i.appendChild(o)})}export{L as showLeaderboardModal};
